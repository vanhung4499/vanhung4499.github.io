<!doctype html>
<html lang="en-US" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.12" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.46" />
    <style>
      html {
        background: var(--bg-color, #fff);
      }

      html[data-theme="dark"] {
        background: var(--bg-color, #1d1e1f);
      }

      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <meta property="og:url" content="https://vanhung4499.github.io/database/redis/persistence.html"><meta property="og:site_name" content="VanHung4499"><meta property="og:title" content="Redis Persistence"><meta property="og:description" content="Lưu trữ bền vững trong Redis Redis là cơ sở dữ liệu trong bộ nhớ (in-memory). Để đảm bảo dữ liệu không bị mất sau khi xảy ra sự cố, dữ liệu trong bộ nhớ cần phải được lưu vào đĩ..."><meta property="og:type" content="article"><meta property="og:image" content="https://raw.githubusercontent.com/vanhung4499/images/master/snap/redis-rdb-structure.png"><meta property="og:locale" content="en-US"><meta property="og:updated_time" content="2024-06-28T15:54:38.000Z"><meta property="article:author" content="Hung Nguyen"><meta property="article:tag" content="redis"><meta property="article:tag" content="nosql"><meta property="article:modified_time" content="2024-06-28T15:54:38.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"Redis Persistence","image":["https://raw.githubusercontent.com/vanhung4499/images/master/snap/redis-rdb-structure.png"],"dateModified":"2024-06-28T15:54:38.000Z","author":[{"@type":"Person","name":"Hung Nguyen","url":"https://vanhung4499.github.io"}]}</script><meta name="referrer" content="no-referrer-when-downgrade"><link rel="alternate" type="application/rss+xml" href="https://vanhung4499.github.io/rss.xml" title="VanHung4499 RSS Feed"><title>Redis Persistence | VanHung4499</title><meta name="description" content="Lưu trữ bền vững trong Redis Redis là cơ sở dữ liệu trong bộ nhớ (in-memory). Để đảm bảo dữ liệu không bị mất sau khi xảy ra sự cố, dữ liệu trong bộ nhớ cần phải được lưu vào đĩ...">
    <link rel="preload" href="/assets/style-BqjKxtxe.css" as="style"><link rel="stylesheet" href="/assets/style-BqjKxtxe.css">
    <link rel="modulepreload" href="/assets/app-eD31-AQ-.js"><link rel="modulepreload" href="/assets/persistence.html-aVI5pmCN.js">
    
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">Skip to main content</a><!--]--><div class="theme-container external-link-icon has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!----><!--[--><a class="route-link vp-brand" href="/"><img class="vp-nav-logo" src="/logo.svg" alt><!----><span class="vp-site-name hide-in-pad">VanHung4499</span></a><!--]--><!----></div><div class="vp-navbar-center"><!----><!--[--><nav class="vp-nav-links"><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/" aria-label="Home"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="mdi:home" width="1em" height="1em"></iconify-icon><!--]-->Home<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/wiki.html" aria-label="Wiki"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="carbon:wikis" width="1em" height="1em"></iconify-icon><!--]-->Wiki<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/dsa/" aria-label="Algorithms"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="hugeicons:algorithm" width="1em" height="1em"></iconify-icon><!--]-->Algorithms<!----></a></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="Programming"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="mdi:code" width="1em" height="1em"></iconify-icon>Programming<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/programming/java/" aria-label="Java"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:java" width="1em" height="1em"></iconify-icon><!--]-->Java<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/programming/golang/" aria-label="Golang"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:go" width="1em" height="1em"></iconify-icon><!--]-->Golang<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/programming/js/" aria-label="JavaScript"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:javascript" width="1em" height="1em"></iconify-icon><!--]-->JavaScript<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/programming/ts/" aria-label="TypeScript"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:typescript" width="1em" height="1em"></iconify-icon><!--]-->TypeScript<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/programming/python/" aria-label="Python"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:python" width="1em" height="1em"></iconify-icon><!--]-->Python<!----></a></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="Database"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="mdi:database" width="1em" height="1em"></iconify-icon>Database<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/database/sql/" aria-label="SQL"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="mdi:sql-query" width="1em" height="1em"></iconify-icon><!--]-->SQL<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/database/mysql/" aria-label="MySQL"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:mysql" width="1em" height="1em"></iconify-icon><!--]-->MySQL<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/database/mongodb/" aria-label="MongoDB"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:mongodb" width="1em" height="1em"></iconify-icon><!--]-->MongoDB<!----></a></li><li class="vp-dropdown-item"><a class="route-link route-link-active auto-link" href="/database/redis/" aria-label="Redis"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:redis" width="1em" height="1em"></iconify-icon><!--]-->Redis<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/database/elasticsearch/" aria-label="Elasticsearch"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:elasticsearch" width="1em" height="1em"></iconify-icon><!--]-->Elasticsearch<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/database/elastic/" aria-label="Elastic Stack"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="cib:elastic-stack" width="1em" height="1em"></iconify-icon><!--]-->Elastic Stack<!----></a></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="Framework"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="simple-icons:framework" width="1em" height="1em"></iconify-icon>Framework<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/framework/spring/" aria-label="Spring"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:spring" width="1em" height="1em"></iconify-icon><!--]-->Spring<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/framework/spring-boot/" aria-label="Spring Boot"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:spring" width="1em" height="1em"></iconify-icon><!--]-->Spring Boot<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/framework/nestjs/" aria-label="NestJS"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:nestjs" width="1em" height="1em"></iconify-icon><!--]-->NestJS<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/framework/gin/" aria-label="Gin"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="logos:gin" width="1em" height="1em"></iconify-icon><!--]-->Gin<!----></a></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="DevOps"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon-plain:azuredevops" width="1em" height="1em"></iconify-icon>DevOps<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/devops/docker/" aria-label="Docker"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:docker" width="1em" height="1em"></iconify-icon><!--]-->Docker<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/devops/kubernetes/" aria-label="Kubernetes"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:kubernetes" width="1em" height="1em"></iconify-icon><!--]-->Kubernetes<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/devops/jenkins/" aria-label="Jenkins"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:jenkins" width="1em" height="1em"></iconify-icon><!--]-->Jenkins<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/devops/git/" aria-label="Git"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:git" width="1em" height="1em"></iconify-icon><!--]-->Git<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/devops/linux/" aria-label="Linux"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:linux" width="1em" height="1em"></iconify-icon><!--]-->Linux<!----></a></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="Design"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="tdesign:system-sum" width="1em" height="1em"></iconify-icon>Design<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/design/design-pattern/" aria-label="Design Pattern"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="tabler:grid-pattern" width="1em" height="1em"></iconify-icon><!--]-->Design Pattern<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/design/system-design/" aria-label="System Design"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="icon-park-outline:system" width="1em" height="1em"></iconify-icon><!--]-->System Design<!----></a></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/project/" aria-label="Project"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="ant-design:project-outlined" width="1em" height="1em"></iconify-icon><!--]-->Project<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/interview/" aria-label="Interview"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="mdi:account-tie" width="1em" height="1em"></iconify-icon><!--]-->Interview<!----></a></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="About"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="mdi:about" width="1em" height="1em"></iconify-icon>About<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/about-me.html" aria-label="About me"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="cib:about-me" width="1em" height="1em"></iconify-icon><!--]-->About me<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/about.html" aria-label="About"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="mdi:about" width="1em" height="1em"></iconify-icon><!--]-->About<!----></a></li></ul></button></div></div></nav><!--]--><!----></div><div class="vp-navbar-end"><!----><!--[--><!----><div class="vp-nav-item vp-action"><a class="vp-action-link" href="https://github.com/vanhung4499/my-wiki" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" name="github" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="vp-nav-item hide-in-mobile"><button type="button" class="vp-outlook-button" tabindex="-1" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon outlook-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="outlook icon" name="outlook"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4 38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32 51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0 102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2 6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4 0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2 9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224 419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4 470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0 22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6 12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128 505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2 16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8 86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4 80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6 6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg><div class="vp-outlook-dropdown"><!----></div></button></div><!--[--><button type="button" class="search-pro-button" aria-label="Search"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon" name="search"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="search-pro-placeholder">Search</div><div class="search-pro-key-hints"><kbd class="search-pro-key">Ctrl</kbd><kbd class="search-pro-key">K</kbd></div></button><!--]--><!--]--><!----><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!----><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><iconify-icon class="font-icon icon" style="" mode="style" inline icon="mdi:sql-query" width="1em" height="1em"></iconify-icon><span class="vp-sidebar-title">SQL</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:mysql" width="1em" height="1em"></iconify-icon><span class="vp-sidebar-title">MySQL</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable active" type="button"><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:redis" width="1em" height="1em"></iconify-icon><span class="vp-sidebar-title">Redis</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/database/redis/overview.html" aria-label="Redis Overview"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:redis" width="1em" height="1em"></iconify-icon><!--]-->Redis Overview<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/database/redis/guide.html" aria-label="Redis Guide"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:redis" width="1em" height="1em"></iconify-icon><!--]-->Redis Guide<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/database/redis/basic-data-types.html" aria-label="Redis Basic Data Types"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:redis" width="1em" height="1em"></iconify-icon><!--]-->Redis Basic Data Types<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/database/redis/advanced-data-types.html" aria-label="Redis Advanced Data Types"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:redis" width="1em" height="1em"></iconify-icon><!--]-->Redis Advanced Data Types<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/database/redis/data-structures.html" aria-label="Redis Data Structures"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:redis" width="1em" height="1em"></iconify-icon><!--]-->Redis Data Structures<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/database/redis/expire.html" aria-label="Redis Expire Delete"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:redis" width="1em" height="1em"></iconify-icon><!--]-->Redis Expire Delete<!----></a></li><li><a class="route-link route-link-active auto-link vp-sidebar-link vp-sidebar-page active" href="/database/redis/persistence.html" aria-label="Redis Persistence"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:redis" width="1em" height="1em"></iconify-icon><!--]-->Redis Persistence<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/database/redis/event.html" aria-label="Redis Event"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:redis" width="1em" height="1em"></iconify-icon><!--]-->Redis Event<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/database/redis/replication.html" aria-label="Redis Replication"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:redis" width="1em" height="1em"></iconify-icon><!--]-->Redis Replication<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/database/redis/sentinel.html" aria-label="Redis Sentinel"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:redis" width="1em" height="1em"></iconify-icon><!--]-->Redis Sentinel<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/database/redis/cluster.html" aria-label="Redis Cluster"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:redis" width="1em" height="1em"></iconify-icon><!--]-->Redis Cluster<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/database/redis/pub-sub.html" aria-label="Redis Publish and Subcribe"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:redis" width="1em" height="1em"></iconify-icon><!--]-->Redis Publish and Subcribe<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/database/redis/transaction.html" aria-label="Redis Transaction"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:redis" width="1em" height="1em"></iconify-icon><!--]-->Redis Transaction<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/database/redis/pipeline.html" aria-label="Redis Pipeline"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:redis" width="1em" height="1em"></iconify-icon><!--]-->Redis Pipeline<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/database/redis/operations.html" aria-label="Redis Operations"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:redis" width="1em" height="1em"></iconify-icon><!--]-->Redis Operations<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/database/redis/action.html" aria-label="Redis In Action"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:redis" width="1em" height="1em"></iconify-icon><!--]-->Redis In Action<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/database/redis/interview.html" aria-label="Redis Interview"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:redis" width="1em" height="1em"></iconify-icon><!--]-->Redis Interview<!----></a></li></ul></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:mongodb" width="1em" height="1em"></iconify-icon><span class="vp-sidebar-title">MongoDB</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:elasticsearch" width="1em" height="1em"></iconify-icon><span class="vp-sidebar-title">Elasticsearch</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><iconify-icon class="font-icon icon" style="" mode="style" inline icon="cib:elastic-stack" width="1em" height="1em"></iconify-icon><span class="vp-sidebar-title">Elastic Stack</span><span class="vp-arrow end"></span></button><!----></section></li></ul><!----></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:redis" width="1em" height="1em"></iconify-icon>Redis Persistence</h1><div class="page-info"><span class="page-author-info" aria-label="Author🖊" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon" name="author"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="page-author-item" href="https://vanhung4499.github.io" target="_blank" rel="noopener noreferrer">Hung Nguyen</a></span><span property="author" content="Hung Nguyen"></span></span><!----><span class="page-date-info" aria-label="Writing Date📅" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon" name="calendar"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2024-06-28T15:54:38.000Z"></span><!----><span class="page-reading-time-info" aria-label="Reading Time⌛" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon" name="timer"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>About 21 min</span><meta property="timeRequired" content="PT21M"></span><span class="page-category-info" aria-label="Category🌈" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon" name="category"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><!--[--><span class="page-category-item color8 clickable" role="navigation">redis</span><span class="page-category-item color7 clickable" role="navigation">nosql</span><!--]--><meta property="articleSection" content="redis,nosql"></span><span class="page-tag-info" aria-label="Tag🏷" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon" name="tag"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><!--[--><span class="page-tag-item color8 clickable" role="navigation">redis</span><span class="page-tag-item color7 clickable" role="navigation">nosql</span><!--]--><meta property="keywords" content="redis,nosql"></span></div><hr></div><div class="vp-toc-placeholder"><aside id="toc"><!----><div class="vp-toc-header">On This Page<button type="button" class="print-button" title="Print"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon" name="print"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button><div class="arrow end"></div></div><div class="vp-toc-wrapper"><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#rdb">RDB</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#gioi-thieu-ve-rdb">Giới thiệu về RDB</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#uu-điem-va-nhuoc-điem-cua-rdb">Ưu điểm và Nhược điểm của RDB</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#tao-tep-rdb">Tạo tệp RDB</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#tai-tep-rdb">Tải tệp RDB</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#tu-đong-sao-luu-đinh-ki">Tự động sao lưu định kì</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#cau-truc-cua-tep-rdb">Cấu trúc của tệp RDB</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#cau-hinh-rdb">Cấu hình RDB</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_2-aof">2. AOF</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#gioi-thieu-ve-aof">Giới thiệu về AOF</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#uu-điem-va-nhuoc-điem-cua-aof">Ưu điểm và nhược điểm của AOF</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#tao-aof">Tạo AOF</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#tai-lai-aof">Tải lại AOF</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#viet-lai-aof">Viết lại AOF</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#aof-đong-bo-hoa-nen">AOF Đồng Bộ Hóa Nền</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#cau-hinh-aof">Cấu hình AOF</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_3-rdb-vs-aof">3. RDB vs AOF</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#lua-chon-co-che-luu-tru">Lựa chọn cơ chế lưu trữ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#chuyen-tu-rdb-sang-aof">Chuyển từ RDB sang AOF</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#tuong-tac-giua-aof-va-rdb">Tương tác giữa AOF và RDB</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#luu-tru-ket-hop">Lưu trữ kết hợp</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_4-sao-luu-redis">4. Sao lưu Redis</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#loi-khuyen-ve-sao-luu">Lời khuyên về sao lưu</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#quy-trinh-sao-luu">Quy trình sao lưu</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#sao-luu-phong-chong-tham-hoa">Sao lưu phòng chống thảm họa</a></li><!----><!--]--></ul></li><!--]--></ul><div class="vp-toc-marker" style="top:-1.7rem;"></div></div><!----></aside></div><!----><div class="theme-hope-content"><h1 id="luu-tru-ben-vung-trong-redis" tabindex="-1"><a class="header-anchor" href="#luu-tru-ben-vung-trong-redis"><span>Lưu trữ bền vững trong Redis</span></a></h1><blockquote><p>Redis là cơ sở dữ liệu trong bộ nhớ (in-memory). Để đảm bảo dữ liệu không bị mất sau khi xảy ra sự cố, dữ liệu trong bộ nhớ cần phải được lưu vào đĩa cứng.</p><p>Redis hỗ trợ hai phương pháp kiên trì: RDB và AOF. Hai phương pháp kiên trì này có thể được sử dụng đồng thời hoặc riêng biệt.</p></blockquote><h2 id="rdb" tabindex="-1"><a class="header-anchor" href="#rdb"><span>RDB</span></a></h2><h3 id="gioi-thieu-ve-rdb" tabindex="-1"><a class="header-anchor" href="#gioi-thieu-ve-rdb"><span>Giới thiệu về RDB</span></a></h3><p><strong>RDB (Redis Database Backup)</strong> hay còn gọi là &quot;bản snapshot&quot;, là quá trình lưu trữ tất cả các cặp khóa-giá trị của cơ sở dữ liệu Redis vào một tệp nhị phân nén gọi là &quot;tệp RDB&quot; vào một thời điểm cụ thể trong quá trình hoạt động.</p><p><strong>Lưu trữ RDB</strong> có thể được thực hiện &quot;thủ công&quot; hoặc &quot;tự động&quot; theo định kỳ.</p><p><strong>Tệp RDB</strong> được tải khi máy chủ Redis được &quot;khởi động&quot; làm việc &quot;tự động&quot;.</p><p>Với từng loại cặp khóa-giá trị khác nhau, tệp RDB sẽ sử dụng cách lưu trữ khác nhau.</p><p>Sau khi tạo tệp RDB, người dùng có thể sao lưu RDB, sao chép RDB sang các máy chủ khác để tạo bản sao của máy chủ có cùng dữ liệu, hoặc sử dụng khi khởi động lại máy chủ. Tóm lại, <strong>RDB thích hợp cho việc &quot;sao lưu lạnh&quot;</strong>.</p><h3 id="uu-điem-va-nhuoc-điem-cua-rdb" tabindex="-1"><a class="header-anchor" href="#uu-điem-va-nhuoc-điem-cua-rdb"><span>Ưu điểm và Nhược điểm của RDB</span></a></h3><p><strong>Ưu điểm của RDB</strong></p><ul><li><p><strong>Kích thước nhỏ và phù hợp cho việc sao lưu “lạnh”</strong>: Tệp RDB rất gọn nhẹ và thích hợp để sử dụng làm sao lưu định kỳ. Bạn có thể lên lịch sao lưu theo nhu cầu, ví dụ mỗi giờ lưu trữ dữ liệu trong vòng 24 giờ qua, và mỗi ngày lưu trữ dữ liệu trong vòng 30 ngày qua. Như vậy, ngay cả khi xảy ra sự cố, bạn cũng có thể khôi phục dữ liệu thành các phiên bản khác nhau theo nhu cầu.</p></li><li><p><strong>Tối ưu hiệu năng</strong>: Khi tạo tệp RDB, quá trình chỉ yêu cầu tiến trình cha của Redis fork ra một tiến trình con, và toàn bộ công việc sau đó được tiến trình con thực hiện. Tiến trình cha không cần thực hiện thêm thao tác IO nào, do đó phương pháp lưu trữ bằng RDB có thể tối đa hóa hiệu suất của Redis.</p></li><li><p><strong>Phục hồi nhanh chóng với tập dữ liệu lớn</strong>: Khi phục hồi dữ liệu từ RDB, quá trình này thường nhanh hơn so với AOF.</p></li></ul><p><strong>Nhược điểm của RDB</strong></p><ul><li><p><strong>Rủi ro mất dữ liệu</strong>: Nếu hệ thống gặp sự cố, dữ liệu sau lần tạo bản sao RDB cuối cùng sẽ bị mất đi. Nếu bạn muốn giảm thiểu mất dữ liệu trong trường hợp Redis dừng đột ngột (ví dụ như mất điện), thì phương pháp lưu trữ bằng RDB không phù hợp. Mặc dù bạn có thể cấu hình các điểm lưu trữ khác nhau (ví dụ, mỗi 5 phút và có 100 thao tác ghi vào tập dữ liệu), việc lưu trữ toàn bộ dữ liệu hoàn chỉnh của Redis là một công việc tương đối nặng nề. Thông thường, bạn sẽ thực hiện lưu trữ đầy đủ mỗi 5 phút hoặc lâu hơn, và nếu Redis ngừng hoạt động đột ngột, bạn có thể mất vài phút dữ liệu.</p></li><li><p><strong>Thời gian lưu trữ dài khi tập dữ liệu lớn</strong>: Khi tập dữ liệu lớn, quá trình fork để lưu trữ RDB có thể tốn nhiều thời gian. Điều này có thể dẫn đến việc Redis không thể phản hồi yêu cầu từ người dùng trong vài mili giây. Nếu tập dữ liệu quá lớn và hiệu suất CPU không tốt, tình trạng này có thể kéo dài lên đến 1 giây. AOF cũng cần phải fork, nhưng bạn có thể điều chỉnh tần suất viết lại tệp nhật ký để tăng tính bền bỉ của tập dữ liệu.</p></li></ul><h3 id="tao-tep-rdb" tabindex="-1"><a class="header-anchor" href="#tao-tep-rdb"><span>Tạo tệp RDB</span></a></h3><p>Redis cung cấp hai lệnh để tạo tệp RDB: <a href="https://redis.io/commands/save" target="_blank" rel="noopener noreferrer"><strong><code>SAVE</code></strong></a> và <a href="https://redis.io/commands/bgsave" target="_blank" rel="noopener noreferrer"><strong><code>BGSAVE</code></strong></a>.</p><p><strong>Lệnh <code>SAVE</code></strong> được thực thi bởi tiến trình máy chủ trực tiếp và sẽ chặn (block) máy chủ cho đến khi tệp RDB được tạo xong. Trong thời gian chặn này, máy chủ sẽ không thể phản hồi bất kỳ yêu cầu lệnh nào khác.</p><div class="language-shell" data-ext="shell" data-title="shell"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">&gt; SAVE</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">&quot;OK&quot;</span></span></code></pre></div><p><strong>Lệnh <code>BGSAVE</code></strong> khởi động một tiến trình con (fork) để tạo tệp RDB, do đó máy chủ tiếp tục xử lý các yêu cầu lệnh trong khi quá trình tạo tệp RDB diễn ra. Vì vậy, lệnh này không làm chặn máy chủ.</p><div class="language-shell" data-ext="shell" data-title="shell"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">&gt; BGSAVE</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">&quot;Background saving started&quot;</span></span></code></pre></div><blockquote><p>🔔 <strong>【Chú ý】</strong></p><p><code>BGSAVE</code> sử dụng công nghệ sao chép khi ghi (Copy-On-Write, viết khi sao chép).</p><p>Trong quá trình thực thi <code>BGSAVE</code>, các lệnh <code>SAVE</code>, <code>BGSAVE</code>, và <code>BGREWRITEAOF</code> sẽ bị từ chối để tránh xung đột đua ra giữa <code>BGSAVE</code> hiện tại và các hoạt động khác, nhằm tối ưu hóa hiệu suất.</p></blockquote><p>Quá trình tạo tệp RDB được thực hiện bởi hàm <code>rdb.c/rdbSave</code> trong mã nguồn Redis.</p><h3 id="tai-tep-rdb" tabindex="-1"><a class="header-anchor" href="#tai-tep-rdb"><span>Tải tệp RDB</span></a></h3><p>Redis thực hiện việc tải tệp RDB khi máy chủ khởi động mà không cần lệnh đặc biệt để thực hiện điều này.</p><p><strong>Việc tải tệp RDB xảy ra tự động khi máy chủ Redis khởi động</strong>. Trong quá trình này, máy chủ sẽ ở trạng thái chặn (block) cho đến khi quá trình tải RDB hoàn tất.</p><p>Quá trình tải RDB được thực hiện bởi hàm <code>rdb.c/rdbLoad</code> trong mã nguồn Redis.</p><blockquote><p>🔔 <strong>【Chú ý】</strong></p><p>Do tần suất cập nhật của AOF thường cao hơn so với RDB:</p><ul><li>Nếu máy chủ có AOF được kích hoạt, máy chủ sẽ ưu tiên sử dụng AOF để khôi phục dữ liệu.</li><li>Chỉ khi AOF bị tắt, máy chủ mới sử dụng tệp RDB để khôi phục dữ liệu.</li></ul></blockquote><p>Điều này đảm bảo rằng Redis luôn sử dụng cơ chế lưu trữ phù hợp nhất để đảm bảo an toàn và khôi phục dữ liệu một cách hiệu quả khi khởi động lại.</p><h3 id="tu-đong-sao-luu-đinh-ki" tabindex="-1"><a class="header-anchor" href="#tu-đong-sao-luu-đinh-ki"><span>Tự động sao lưu định kì</span></a></h3><p>Redis hỗ trợ tự động thực hiện lệnh <code>BGSAVE</code> theo khoảng thời gian được cấu hình trong tệp <code>redis.conf</code> bằng cách sử dụng tùy chọn <code>save</code>. Tùy chọn <code>save</code> cho phép thiết lập nhiều điều kiện lưu trữ, và khi bất kỳ điều kiện nào được đáp ứng, máy chủ Redis sẽ thực hiện lệnh <code>BGSAVE</code>.</p><p><strong>Ví dụ cấu hình tự động lưu trữ trong <code>redis.conf</code>:</strong></p><div class="language-shell" data-ext="shell" data-title="shell"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;--shiki-dark:#7F848E;font-style:italic;--shiki-dark-font-style:italic;"># Trong vòng 900 giây, ít nhất có 1 lần thay đổi cơ sở dữ liệu</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">save</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 900</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 1</span></span>
<span class="line"><span style="color:#7F848E;--shiki-dark:#7F848E;font-style:italic;--shiki-dark-font-style:italic;"># Trong vòng 300 giây, ít nhất có 10 lần thay đổi cơ sở dữ liệu</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">save</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 300</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 10</span></span>
<span class="line"><span style="color:#7F848E;--shiki-dark:#7F848E;font-style:italic;--shiki-dark-font-style:italic;"># Trong vòng 60 giây, ít nhất có 10000 lần thay đổi cơ sở dữ liệu</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">save</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 60</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 10000</span></span></code></pre></div><p>Khi bất kỳ điều kiện nào được đáp ứng, Redis sẽ thực hiện lệnh <code>BGSAVE</code>.</p><p><strong>Định nghĩa các điều kiện lưu trữ trong <code>redis.h/redisServer</code>:</strong></p><div class="language-c line-numbers-mode" data-ext="c" data-title="c"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">struct</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> redisServer {</span></span>
<span class="line"><span style="color:#7F848E;--shiki-dark:#7F848E;font-style:italic;--shiki-dark-font-style:italic;">    // Mảng lưu trữ các điều kiện lưu trữ</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    struct</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> saveparam </span><span style="color:#C678DD;--shiki-dark:#C678DD;">*</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">saveparams;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;--shiki-dark:#7F848E;font-style:italic;--shiki-dark-font-style:italic;">    // Số lần thay đổi cơ sở dữ liệu kể từ lần SAVE cuối cùng</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    long</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> long</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> dirty;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;--shiki-dark:#7F848E;font-style:italic;--shiki-dark-font-style:italic;">    // Thời điểm thực hiện SAVE lần cuối</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    time_t</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> lastsave;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;--shiki-dark:#7F848E;font-style:italic;--shiki-dark-font-style:italic;">// Cấu trúc điều kiện lưu trữ của máy chủ (các điều kiện tự động thực hiện BGSAVE)</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">struct</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> saveparam {</span></span>
<span class="line"><span style="color:#7F848E;--shiki-dark:#7F848E;font-style:italic;--shiki-dark-font-style:italic;">    // Thời gian giới hạn (seconds)</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    time_t</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> seconds;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;--shiki-dark:#7F848E;font-style:italic;--shiki-dark-font-style:italic;">    // Số lần thay đổi</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    int</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> changes;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">};</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Mảng <code>saveparams</code> trong <code>redisServer</code> duy trì các điều kiện lưu trữ tự động.</p><p>Mỗi khi thành công thực hiện một lệnh chỉnh sửa, biến <code>dirty</code> sẽ tăng lên 1 đơn vị; <code>lastsave</code> ghi lại thời điểm lần SAVE cuối cùng được thực hiện. Redis sử dụng hàm <code>serverCron</code> để định kỳ kiểm tra xem các điều kiện được cấu hình trong <code>save</code> có được đáp ứng không. Nếu đáp ứng, Redis sẽ thực hiện lệnh <code>BGSAVE</code>.</p><h3 id="cau-truc-cua-tep-rdb" tabindex="-1"><a class="header-anchor" href="#cau-truc-cua-tep-rdb"><span>Cấu trúc của tệp RDB</span></a></h3><p><strong>Tệp RDB là một tệp nhị phân được nén</strong> và được chia thành nhiều phần khác nhau tùy thuộc vào loại dữ liệu (STRING, HASH, LIST, SET, SORTED SET).</p><figure><img src="https://raw.githubusercontent.com/vanhung4499/images/master/snap/redis-rdb-structure.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>Redis cung cấp công cụ <code>redis-check-dump</code> để kiểm tra tệp RDB.</p><h3 id="cau-hinh-rdb" tabindex="-1"><a class="header-anchor" href="#cau-hinh-rdb"><span>Cấu hình RDB</span></a></h3><p>Mặc định, Redis cấu hình RDB như sau:</p><div class="language-" data-ext="" data-title=""><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span>save 900 1</span></span>
<span class="line"><span>save 300 10</span></span>
<span class="line"><span>save 60 10000</span></span>
<span class="line"><span>stop-writes-on-bgsave-error yes</span></span>
<span class="line"><span>rdbcompression yes</span></span>
<span class="line"><span>rdbchecksum yes</span></span>
<span class="line"><span>dbfilename dump.rdb</span></span>
<span class="line"><span>dir ./</span></span></code></pre></div><p>Các tùy chọn liên quan đến RDB trong tệp cấu hình <code>redis.conf</code> của Redis:</p><ul><li><code>save</code>: Redis sẽ tự động thực hiện lệnh <code>BGSAVE</code> theo các điều kiện được cấu hình trong <code>save</code>.</li><li><code>stop-writes-on-bgsave-error</code>: Dừng ghi khi có lỗi trong quá trình <code>BGSAVE</code>.</li><li><code>rdbcompression</code>: Bật/tắt nén RDB.</li><li><code>rdbchecksum</code>: Kiểm tra dữ liệu RDB.</li><li><code>dbfilename</code>: Tên tệp RDB.</li><li><code>dir</code>: Thư mục lưu trữ tệp RDB và AOF.</li></ul><h2 id="_2-aof" tabindex="-1"><a class="header-anchor" href="#_2-aof"><span>2. AOF</span></a></h2><h3 id="gioi-thieu-ve-aof" tabindex="-1"><a class="header-anchor" href="#gioi-thieu-ve-aof"><span>Giới thiệu về AOF</span></a></h3><p><code>AOF (Append Only File)</code> là một tệp ghi log mà Redis sử dụng để lưu trữ tất cả các lệnh ghi vào cơ sở dữ liệu. Khi máy chủ khởi động lại, Redis sẽ nạp và thực thi các lệnh từ tệp AOF này để khôi phục dữ liệu gốc. AOF được coi là phương pháp &quot;sao lưu nóng&quot;.</p><p>AOF có thể được bật bằng cách đặt cấu hình <code>appendonly yes</code>.</p><h3 id="uu-điem-va-nhuoc-điem-cua-aof" tabindex="-1"><a class="header-anchor" href="#uu-điem-va-nhuoc-điem-cua-aof"><span>Ưu điểm và nhược điểm của AOF</span></a></h3><p><strong>Ưu điểm của AOF</strong></p><ul><li><strong>Giảm thiểu mất mát dữ liệu so với RDB</strong>: Khi hệ thống gặp sự cố, AOF thường mất ít dữ liệu hơn RDB. Bạn có thể cấu hình các chiến lược fsync khác nhau như không có fsync, fsync mỗi giây, hoặc fsync mỗi lần ghi. Với chiến lược mặc định fsync mỗi giây, Redis vẫn duy trì hiệu suất tốt và chỉ mất tối đa 1 giây dữ liệu khi có sự cố.</li><li><strong>Khả năng sửa chữa tệp AOF</strong>: Tệp AOF là một tệp log chỉ thêm vào (append-only), do đó không cần phải thực hiện seek khi ghi. Ngay cả khi một số lệnh ghi không được hoàn thành do lý do nào đó (ví dụ như không gian ổ đĩa đầy), bạn vẫn có thể sửa chữa vấn đề này bằng công cụ <code>redis-check-aof</code>.</li><li><strong>Nén tệp AOF</strong>: Redis có thể tự động tái viết (rewrite) tệp AOF khi nó trở nên quá lớn. Tệp AOF mới sau khi tái viết chỉ chứa các lệnh tối thiểu cần thiết để khôi phục dữ liệu hiện tại. Quá trình tái viết hoàn toàn an toàn vì Redis vẫn tiếp tục ghi các lệnh vào tệp AOF hiện có trong khi tạo ra tệp AOF mới. Khi tệp AOF mới được tạo xong, Redis sẽ chuyển sang sử dụng tệp AOF mới và tiếp tục ghi vào đó.</li><li><strong>Dễ đọc và phân tích</strong>: Tệp AOF lưu trữ tất cả các lệnh ghi vào cơ sở dữ liệu theo đúng thứ tự. Do đó, nội dung của tệp AOF rất dễ đọc và phân tích. Bạn có thể dễ dàng xuất tệp AOF hoặc phân tích nó. Ví dụ, nếu bạn vô tình thực hiện lệnh FLUSHALL, nhưng tệp AOF chưa bị tái viết, bạn có thể dừng máy chủ, loại bỏ lệnh FLUSHALL cuối cùng từ tệp AOF và khởi động lại Redis để khôi phục dữ liệu trước khi thực hiện FLUSHALL.</li></ul><p><strong>Nhược điểm của AOF</strong></p><ul><li><strong>Kích thước tệp AOF thường lớn hơn RDB</strong>: Đối với cùng một bộ dữ liệu, tệp AOF thường có kích thước lớn hơn tệp RDB.</li><li><strong>Khôi phục bộ dữ liệu lớn từ AOF có thể chậm hơn RDB</strong>: Tùy thuộc vào chiến lược fsync được sử dụng, AOF có thể chậm hơn so với RDB trong quá trình khôi phục dữ liệu lớn. Tuy nhiên, với fsync mỗi giây, hiệu suất của AOF vẫn rất cao và có thể xứng đáng với tốc độ của RDB. Tuy nhiên, trong các tải ghi lớn, RDB có thể cung cấp thời gian đáp ứng tối đa đáng tin cậy hơn.</li></ul><h3 id="tao-aof" tabindex="-1"><a class="header-anchor" href="#tao-aof"><span>Tạo AOF</span></a></h3><p><strong>Các yêu cầu lệnh Redis sẽ được lưu vào vùng đệm AOF, sau đó được ghi và đồng bộ hóa định kỳ vào tệp AOF.</strong></p><p>Việc triển khai AOF có thể chia thành ba bước: ghi lệnh (append), ghi tệp và đồng bộ hóa tệp (sync).</p><ul><li><p><strong>Ghi lệnh (append)</strong> - Khi chức năng AOF của máy chủ Redis được bật, máy chủ sẽ thêm lệnh ghi sẽ thực thi vào cuối vùng đệm AOF dưới dạng giao thức lệnh Redis.</p></li><li><p><strong>Ghi tệp và đồng bộ hóa tệp</strong></p><ul><li>Quá trình sự kiện của máy chủ Redis là một vòng lặp sự kiện, trong đó sự kiện tệp chịu trách nhiệm nhận yêu cầu lệnh từ khách hàng và gửi phản hồi lệnh cho khách hàng. Trong khi đó, sự kiện thời gian chịu trách nhiệm thực hiện các chức năng chạy định kỳ như <code>serverCron</code>.</li><li>Vì máy chủ có thể thực hiện lệnh ghi khi xử lý sự kiện tệp, các lệnh ghi này sẽ được thêm vào vùng đệm AOF. Trước khi kết thúc vòng lặp sự kiện, máy chủ sẽ kiểm tra nội dung vùng đệm AOF dựa trên tùy chọn <code>appendfsync</code> để quyết định xem liệu nội dung này có cần được ghi vào và đồng bộ hóa với tệp AOF hay không.</li></ul></li></ul><p>Tùy chọn <code>appendfsync</code> quyết định hành vi bền vững của AOF như sau:</p><ul><li><strong><code>always</code></strong> - Ghi tất cả nội dung từ vùng đệm AOF vào và đồng bộ hóa với tệp AOF. Phương pháp này đảm bảo an toàn dữ liệu nhất nhưng hiệu suất thấp nhất.</li><li><strong><code>no</code></strong> - Ghi tất cả nội dung từ vùng đệm AOF vào tệp AOF nhưng không đồng bộ hóa, thời điểm đồng bộ hóa phụ thuộc vào hệ điều hành. Đây là phương pháp dữ liệu không an toàn nhất, mọi dữ liệu chưa kịp đồng bộ hóa khi gặp sự cố sẽ bị mất.</li><li><strong><code>everysec</code></strong> - Tùy chọn mặc định của <code>appendfsync</code>. Ghi tất cả nội dung từ vùng đệm AOF vào tệp AOF, và nếu thời gian từ lần đồng bộ hóa AOF trước đó đã quá 1 giây, sẽ tiếp tục đồng bộ hóa. Thao tác này được thực hiện bởi một luồng đặc biệt, đảm bảo hiệu suất đủ tốt và chỉ mất dữ liệu trong vòng một giây nếu có sự cố.</li></ul><p>Lựa chọn của <code>appendfsync</code> ảnh hưởng đáng kể đến tính bảo mật của chức năng bền vững của AOF và hiệu suất của máy chủ Redis.</p><h3 id="tai-lai-aof" tabindex="-1"><a class="header-anchor" href="#tai-lai-aof"><span>Tải lại AOF</span></a></h3><p>AOF (Append Only File) là một phương pháp lưu trữ dữ liệu trong Redis bằng cách ghi tất cả các lệnh ghi vào một tệp log. Khi máy chủ Redis khởi động lại sau một sự cố hoặc tái khởi động, AOF được sử dụng để tái tạo lại trạng thái cơ sở dữ liệu trước khi máy chủ tắt.</p><p>Quá trình tải lại AOF được thực hiện như sau:</p><ol><li><p><strong>Khởi động chương trình tải lại của máy chủ</strong>: Khi Redis bắt đầu, nó khởi động một quy trình đặc biệt để tải lại dữ liệu từ tệp AOF.</p></li><li><p><strong>Tạo một khách hàng giả</strong>: Do lệnh Redis chỉ có thể thực thi trong ngữ cảnh khách hàng, Redis cần tạo ra một khách hàng giả để thực hiện và thực thi các lệnh trong tệp AOF.</p></li><li><p><strong>Phân tích và đọc lệnh ghi từ tệp AOF</strong>: Chương trình tải lại sẽ bắt đầu đọc và phân tích các lệnh ghi trong tệp AOF. Mỗi lệnh được lưu trong tệp AOF dưới định dạng giao thức lệnh Redis.</p></li><li><p><strong>Thực thi lệnh bằng khách hàng giả</strong>: Sau khi phân tích, chương trình tải lại sẽ sử dụng khách hàng giả để thực thi mỗi lệnh ghi từ tệp AOF. Điều này có nghĩa là Redis sẽ thực hiện mọi thay đổi dữ liệu được lưu trong các lệnh ghi này.</p></li><li><p><strong>Lặp lại quá trình đọc và thực thi lệnh</strong>: Quá trình đọc và thực thi lệnh sẽ tiếp tục cho đến khi tất cả các lệnh ghi từ tệp AOF được xử lý hoàn tất.</p></li><li><p><strong>Hoàn thành quá trình tải lại</strong>: Sau khi tất cả các lệnh đã được thực thi từ tệp AOF, quá trình tải lại sẽ kết thúc và Redis sẵn sàng hoạt động với dữ liệu được phục hồi từ tệp AOF.</p></li></ol><h3 id="viet-lai-aof" tabindex="-1"><a class="header-anchor" href="#viet-lai-aof"><span>Viết lại AOF</span></a></h3><p>Dưới sự hoạt động liên tục của Redis, kích thước của tệp AOF cũng sẽ không ngừng tăng lên, điều này gây ra hai vấn đề chính:</p><ul><li>AOF có thể làm đầy không gian lưu trữ trên đĩa.</li><li>Khi Redis khởi động lại, tất cả các lệnh ghi trong tệp AOF phải được thực thi để khôi phục lại tập dữ liệu. Nếu kích thước của AOF quá lớn, thời gian để thực hiện quá trình khôi phục cũng sẽ rất lâu.</li></ul><p>Để giải quyết vấn đề về kích thước của tệp AOF phình ra, Redis cung cấp tính năng ghi lại AOF (AOF rewrite) để nén tệp AOF. <strong>Quá trình ghi lại AOF tạo ra một tệp AOF mới, tệp này giữ nguyên trạng thái cơ sở dữ liệu như trong tệp AOF ban đầu, nhưng kích thước nhỏ hơn</strong>.</p><p>Quá trình ghi lại AOF không phải là đọc và phân tích nội dung của tệp AOF hiện tại, mà là trực tiếp đọc trạng thái cơ sở dữ liệu hiện tại từ Redis. Nghĩa là từng giá trị hiện tại của các khóa trong cơ sở dữ liệu được đọc và ghi vào tệp mới bằng một lệnh duy nhất, thay thế cho những lệnh có thể đã trùng lặp từ trước.</p><h3 id="aof-đong-bo-hoa-nen" tabindex="-1"><a class="header-anchor" href="#aof-đong-bo-hoa-nen"><span>AOF Đồng Bộ Hóa Nền</span></a></h3><p>Là một tính năng hỗ trợ, rõ ràng Redis không muốn khi thực hiện việc ghi lại AOF làm ảnh hưởng đến việc nhận các lệnh Redis dịch vụ khác. Do đó, Redis quyết định sử dụng lệnh <code>BGREWRITEAOF</code> để tạo một tiến trình con để chịu trách nhiệm tái viết tệp AOF, tương tự như cách làm của <code>BGSAVE</code>.</p><ul><li>Khi thực hiện lệnh <code>BGREWRITEAOF</code>, máy chủ Redis duy trì một vùng đệm tái viết AOF. Khi tiến trình con tái viết AOF bắt đầu làm việc, Redis sau mỗi lần thực hiện một lệnh ghi, cả hai gửi lệnh này đến vùng đệm ghi AOF và vùng đệm tái viết AOF.</li><li>Vì tiến trình con và tiến trình chính không hoạt động trong cùng một tiến trình, do đó quá trình tái viết AOF không ảnh hưởng đến quá trình ghi và đồng bộ hóa AOF. Khi tiến trình con hoàn thành công việc tạo tệp AOF mới, máy chủ sẽ thêm tất cả nội dung từ vùng đệm tái viết vào cuối tệp AOF mới, đảm bảo rằng trạng thái cơ sở dữ liệu được lưu trữ trong hai tệp AOF cũ và mới là như nhau.</li></ul><blockquote><p>Quá trình thực hiện lệnh <code>BGREWRITEAOF</code> sử dụng kỹ thuật sao chép khi ghi (Copy-On-Write, viết tắt là CoW).</p></blockquote><p>Bạn có thể thiết lập <code>auto-aof-rewrite-percentage</code> và <code>auto-aof-rewrite-min-size</code> để Redis tự động thực hiện <code>BGREWRITEAOF</code> khi đạt điều kiện nhất định.</p><p>Ví dụ cấu hình như sau:</p><div class="language-" data-ext="" data-title=""><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span>auto-aof-rewrite-percentage 100</span></span>
<span class="line"><span>auto-aof-rewrite-min-size 64mb</span></span></code></pre></div><p>Điều này chỉ ra rằng khi AOF lớn hơn <code>64MB</code>, và kích thước AOF lớn hơn ít nhất <code>100%</code> so với lần tái viết trước đó, Redis sẽ thực hiện lệnh <code>BGREWRITEAOF</code>.</p><h3 id="cau-hinh-aof" tabindex="-1"><a class="header-anchor" href="#cau-hinh-aof"><span>Cấu hình AOF</span></a></h3><p>Cấu hình mặc định của AOF trong Redis:</p><div class="language-plaintext" data-ext="plaintext" data-title="plaintext"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span>appendonly no</span></span>
<span class="line"><span>appendfsync everysec</span></span>
<span class="line"><span>no-appendfsync-on-rewrite no</span></span>
<span class="line"><span>auto-aof-rewrite-percentage 100</span></span>
<span class="line"><span>auto-aof-rewrite-min-size 64mb</span></span></code></pre></div><p>Các cài đặt mặc định này có thể được điều chỉnh trong tệp cấu hình Redis (<code>redis.conf</code>). Dưới đây là các tùy chọn cấu hình AOF và ý nghĩa của chúng:</p><ul><li><p><strong><code>appendonly</code></strong> - Mở tính năng AOF (append-only file). Khi được thiết lập thành <code>yes</code>, Redis sẽ bắt đầu ghi lại các câu lệnh vào tệp AOF để bảo vệ dữ liệu khi Redis khởi động lại.</p></li><li><p><strong><code>appendfsync</code></strong> - Xác định tần suất đồng bộ hóa AOF với đĩa. Các giá trị có thể là:</p><ul><li><strong><code>always</code></strong> - Mỗi lệnh ghi vào Redis sẽ được đồng bộ hóa ngay lập tức với đĩa. Tuy nhiên, điều này có thể làm giảm hiệu suất của Redis do tần suất ghi đĩa cao.</li><li><strong><code>everysec</code></strong> - Redis sẽ đồng bộ hóa AOF với đĩa mỗi giây một lần. Đây là tùy chọn được khuyến khích vì nó cân bằng giữa hiệu suất và an toàn dữ liệu. Khi sử dụng tùy chọn này, Redis sẽ ghi vào AOF một lần mỗi giây, giúp bảo vệ dữ liệu mà không ảnh hưởng quá nhiều đến hiệu suất.</li><li><strong><code>no</code></strong> - Hệ điều hành quyết định khi nào cần đồng bộ hóa với đĩa. Đây là tùy chọn ít an toàn vì dữ liệu có thể bị mất nếu hệ thống gặp sự cố.</li></ul></li><li><p><strong><code>no-appendfsync-on-rewrite</code></strong> - Khi thực hiện quá trình tái viết AOF, Redis sẽ không đồng bộ hóa AOF với đĩa để tránh làm gián đoạn hoạt động ghi mới. Tùy chọn này giúp duy trì hiệu suất cao trong khi tái viết AOF.</p></li><li><p><strong><code>auto-aof-rewrite-percentage</code></strong> - Độ lớn tệp AOF hiện tại so với tệp AOF gần nhất sau khi thực hiện tái viết. Nếu tệp AOF hiện tại lớn hơn mức này, Redis sẽ tự động thực hiện tái viết AOF để nén tệp AOF. Giá trị mặc định là 100%, nghĩa là khi tệp AOF hiện tại lớn hơn hoặc bằng tệp tái viết gần đây nhất, Redis sẽ tái viết AOF.</p></li><li><p><strong><code>auto-aof-rewrite-min-size</code></strong> - Kích thước tối thiểu mà tệp AOF phải đạt được để Redis tự động thực hiện tái viết. Giá trị mặc định là <code>64mb</code>, nghĩa là Redis sẽ tự động tái viết AOF nếu kích thước tệp AOF hiện tại lớn hơn hoặc bằng <code>64MB</code>.</p></li><li><p><strong><code>dir</code></strong> - Đường dẫn nơi lưu trữ tệp RDB và AOF.</p></li></ul><h2 id="_3-rdb-vs-aof" tabindex="-1"><a class="header-anchor" href="#_3-rdb-vs-aof"><span>3. RDB vs AOF</span></a></h2><blockquote><p>Khi Redis khởi động, nếu cả RDB và AOF đều được kích hoạt, chương trình sẽ ưu tiên sử dụng tập tin AOF để khôi phục tập dữ liệu, vì tập tin AOF thường chứa dữ liệu hoàn chỉnh nhất.</p></blockquote><h3 id="lua-chon-co-che-luu-tru" tabindex="-1"><a class="header-anchor" href="#lua-chon-co-che-luu-tru"><span>Lựa chọn cơ chế lưu trữ</span></a></h3><ul><li>Nếu không quan tâm đến mất dữ liệu, bạn có thể không cần lưu trữ.</li><li>Nếu chấp nhận mất dữ liệu trong vài phút, chỉ cần sử dụng RDB.</li><li>Nếu không thể chấp nhận mất dữ liệu trong vài phút, hãy sử dụng cả RDB và AOF.</li></ul><p>Nhiều người dùng chỉ sử dụng AOF cho lưu trữ, nhưng điều này không được khuyến khích vì việc tạo snapshot RDB định kỳ rất thuận tiện cho sao lưu cơ sở dữ liệu và khôi phục nhanh chóng hơn so với AOF. Ngoài ra, việc sử dụng snapshot cũng giúp tránh được những lỗi chương trình của AOF.</p><h3 id="chuyen-tu-rdb-sang-aof" tabindex="-1"><a class="header-anchor" href="#chuyen-tu-rdb-sang-aof"><span>Chuyển từ RDB sang AOF</span></a></h3><p>Trong Redis phiên bản 2.2 trở lên, bạn có thể chuyển từ RDB sang AOF mà không cần khởi động lại Redis:</p><ul><li>Sao lưu tệp dump.rdb mới nhất.</li><li>Đặt sao lưu vào một vị trí an toàn.</li><li>Thực hiện hai lệnh sau: <ul><li>redis-cli config set appendonly yes</li><li>redis-cli config set save</li></ul></li><li>Đảm bảo rằng các lệnh ghi sẽ được ghi đúng vào cuối tệp AOF.</li><li>Lệnh đầu tiên được thực hiện để bật chức năng AOF: Redis sẽ chặn cho đến khi tệp AOF ban đầu được tạo xong, sau đó Redis sẽ tiếp tục xử lý các yêu cầu lệnh và bắt đầu ghi các lệnh ghi vào cuối tệp AOF.</li></ul><p>Lệnh thứ hai được sử dụng để tắt chức năng snapshot. Bước này là tùy chọn, nếu bạn muốn, bạn cũng có thể sử dụng cả snapshot và AOF cùng một lúc.</p><blockquote><p>🔔 Quan trọng: Đừng quên mở chức năng AOF trong <code>redis.conf</code>! Nếu không, sau khi khởi động lại máy chủ, các cấu hình được thiết lập trước đó thông qua CONFIG SET sẽ bị mất và chương trình sẽ khởi động máy chủ theo cấu hình ban đầu.</p></blockquote><h3 id="tuong-tac-giua-aof-va-rdb" tabindex="-1"><a class="header-anchor" href="#tuong-tac-giua-aof-va-rdb"><span>Tương tác giữa AOF và RDB</span></a></h3><p>Lệnh <code>BGSAVE</code> và <code>BGREWRITEAOF</code> không thể được thực thi cùng lúc. Điều này nhằm tránh hai tiến trình Redis nền cùng thực hiện nhiều hoạt động I/O trên đĩa cùng một lúc.</p><p>Nếu lệnh <code>BGSAVE</code> đang được thực thi và người dùng gọi lệnh <code>BGREWRITEAOF</code> một cách rõ ràng, máy chủ sẽ trả lời người dùng với trạng thái OK và thông báo rằng <code>BGREWRITEAOF</code> đã được đặt lịch để thực thi. Sau khi <code>BGSAVE</code> hoàn thành, <code>BGREWRITEAOF</code> sẽ bắt đầu chính thức.</p><h3 id="luu-tru-ket-hop" tabindex="-1"><a class="header-anchor" href="#luu-tru-ket-hop"><span>Lưu trữ kết hợp</span></a></h3><p>Redis 4.0 đưa ra <strong>lưu trữ kết hợp AOF và snapshot trong bộ nhớ</strong>, hay còn gọi là lưu trữ kết hợp, để cân bằng tốc độ khởi động lại Redis và giảm rủi ro mất dữ liệu.</p><p>Trong lưu trữ kết hợp, trong quá trình tái viết AOF, tiến trình con tái viết sẽ đầu tiên ghi dữ liệu bộ nhớ chia sẻ với tiến trình chính dưới dạng snapshot RDB vào tệp AOF. Sau đó, các lệnh hoạt động được ghi trong bộ đệm tái viết sẽ được ghi vào tệp AOF dưới dạng tăng dần AOF. Khi việc ghi kết thúc, tiến trình chính sẽ thay thế tệp AOF cũ bằng tệp AOF mới có định dạng RDB và AOF.</p><p>Nói cách khác, khi sử dụng lưu trữ kết hợp, <strong>phần đầu của tệp AOF là dữ liệu đầy đủ định dạng RDB và phần cuối cùng là dữ liệu tăng dần định dạng AOF</strong>.</p><h2 id="_4-sao-luu-redis" tabindex="-1"><a class="header-anchor" href="#_4-sao-luu-redis"><span>4. Sao lưu Redis</span></a></h2><p>Đảm bảo rằng dữ liệu Redis được sao lưu đầy đủ là rất quan trọng.</p><h3 id="loi-khuyen-ve-sao-luu" tabindex="-1"><a class="header-anchor" href="#loi-khuyen-ve-sao-luu"><span>Lời khuyên về sao lưu</span></a></h3><p>Đề xuất sử dụng RDB để sao lưu dữ liệu Redis.</p><h3 id="quy-trinh-sao-luu" tabindex="-1"><a class="header-anchor" href="#quy-trinh-sao-luu"><span>Quy trình sao lưu</span></a></h3><ol><li><p><strong>Thiết lập công việc định kỳ (cron job)</strong>: Tạo một công việc định kỳ, sao lưu một tập tin RDB vào một thư mục mỗi giờ và sao lưu một tập tin RDB vào một thư mục khác mỗi ngày.</p></li><li><p><strong>Giữ lại sao lưu và thêm dấu thời gian</strong>: Đảm bảo rằng các tập tin sao lưu chứa thông tin về ngày và giờ tương ứng. Khi thực hiện công việc định kỳ, sử dụng lệnh <code>find</code> để xóa các bản sao lưu cũ. Ví dụ, có thể giữ lại các bản sao lưu mỗi giờ trong vòng 48 giờ qua và giữ lại các bản sao lưu mỗi ngày trong vòng một đến hai tháng qua.</p></li><li><p><strong>Sao lưu ngoại tuyến</strong>: Ít nhất mỗi ngày một lần, sao lưu RDB ra khỏi trung tâm dữ liệu hoặc ít nhất là sao lưu ra khỏi máy chủ vật lý đang chạy Redis.</p></li></ol><h3 id="sao-luu-phong-chong-tham-hoa" tabindex="-1"><a class="header-anchor" href="#sao-luu-phong-chong-tham-hoa"><span>Sao lưu phòng chống thảm họa</span></a></h3><p>Sao lưu phòng chống thảm họa Redis chủ yếu là sao lưu dữ liệu và truyền sao lưu đó đến nhiều trung tâm dữ liệu bên ngoài khác nhau.</p><p>Sao lưu phòng chống thảm họa cho phép dữ liệu vẫn an toàn khi trung tâm dữ liệu chính sản xuất vấn đề nghiêm trọng.</p></div><!----><footer class="vp-page-meta"><div class="vp-meta-item edit-link"><a class="auto-link external-link vp-meta-label" href="https://github.com/vanhung4499/my-wiki/edit/main/src/database/redis/persistence.md" aria-label="Edit this page on GitHub" rel="noopener noreferrer" target="_blank"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon" name="edit"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->Edit this page on GitHub<!----></a></div><div class="vp-meta-item git-info"><div class="update-time"><span class="vp-meta-label">Last update: </span><!----></div><div class="contributors"><span class="vp-meta-label">Contributors: </span><!--[--><!--[--><span class="vp-meta-info" title="email: vanhung4499@gmail.com">Hung Nguyen Van</span><!--]--><!--]--></div></div></footer><nav class="vp-page-nav"><a class="route-link auto-link prev" href="/database/redis/expire.html" aria-label="Redis Expire Delete"><div class="hint"><span class="arrow start"></span>Prev</div><div class="link"><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:redis" width="1em" height="1em"></iconify-icon>Redis Expire Delete</div></a><a class="route-link auto-link next" href="/database/redis/event.html" aria-label="Redis Event"><div class="hint">Next<span class="arrow end"></span></div><div class="link">Redis Event<iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:redis" width="1em" height="1em"></iconify-icon></div></a></nav><!----><!----><!--]--></main><!--]--><footer class="footer-wrapper" style="display:none;--1ea755b8:;"><div class="footer-content"><div class="footer">Made with ❤️ by Hung Nguyen</div><div class="copyright">Copyright © 2016-2024 Hung Nguyen</div></div><span id="runtime_span"></span></footer></div><!--]--><!--[--><!----><!----><!----><!----><!--]--><!--]--></div>
    <script type="module" src="/assets/app-eD31-AQ-.js" defer></script>
  </body>
</html>
