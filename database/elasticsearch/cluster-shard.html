<!doctype html>
<html lang="en-US" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.12" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.46" />
    <style>
      html {
        background: var(--bg-color, #fff);
      }

      html[data-theme="dark"] {
        background: var(--bg-color, #1d1e1f);
      }

      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <meta property="og:url" content="https://vanhung4499.github.io/database/elasticsearch/cluster-shard.html"><meta property="og:site_name" content="VanHung4499"><meta property="og:title" content="Elasticsearch Cluster and Shard"><meta property="og:description" content="Elasticsearch Clusters và Shards Clusters Cluster trống Nếu chúng ta khởi động một nút đơn lẻ không chứa bất kỳ dữ liệu hay chỉ mục nào, cluster của chúng ta sẽ trông như một cl..."><meta property="og:type" content="article"><meta property="og:image" content="https://raw.githubusercontent.com/vanhung4499/images/master/snap/elas_0201.png"><meta property="og:locale" content="en-US"><meta property="og:updated_time" content="2024-06-28T15:54:38.000Z"><meta property="article:author" content="Hung Nguyen"><meta property="article:tag" content="elasticssearch"><meta property="article:modified_time" content="2024-06-28T15:54:38.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"Elasticsearch Cluster and Shard","image":["https://raw.githubusercontent.com/vanhung4499/images/master/snap/elas_0201.png","https://raw.githubusercontent.com/vanhung4499/images/master/snap/elas_0202.png","https://raw.githubusercontent.com/vanhung4499/images/master/snap/elas_0203.png","https://raw.githubusercontent.com/vanhung4499/images/master/snap/elas_0204.png","https://raw.githubusercontent.com/vanhung4499/images/master/snap/elas_1101.png","https://raw.githubusercontent.com/vanhung4499/images/master/snap/elas_1102.png","https://raw.githubusercontent.com/vanhung4499/images/master/snap/elas_1103.png","https://raw.githubusercontent.com/vanhung4499/images/master/snap/elas_1104.png","https://raw.githubusercontent.com/vanhung4499/images/master/snap/elas_1105.png","https://raw.githubusercontent.com/vanhung4499/images/master/snap/elas_1106.png","https://raw.githubusercontent.com/vanhung4499/images/master/snap/elas_1107.png","https://raw.githubusercontent.com/vanhung4499/images/master/snap/elas_1108.png","https://raw.githubusercontent.com/vanhung4499/images/master/snap/elas_1109.png","https://raw.githubusercontent.com/vanhung4499/images/master/snap/elas_1110.png"],"dateModified":"2024-06-28T15:54:38.000Z","author":[{"@type":"Person","name":"Hung Nguyen","url":"https://vanhung4499.github.io"}]}</script><meta name="referrer" content="no-referrer-when-downgrade"><link rel="alternate" type="application/rss+xml" href="https://vanhung4499.github.io/rss.xml" title="VanHung4499 RSS Feed"><title>Elasticsearch Cluster and Shard | VanHung4499</title><meta name="description" content="Elasticsearch Clusters và Shards Clusters Cluster trống Nếu chúng ta khởi động một nút đơn lẻ không chứa bất kỳ dữ liệu hay chỉ mục nào, cluster của chúng ta sẽ trông như một cl...">
    <link rel="preload" href="/assets/style-ChamnO2s.css" as="style"><link rel="stylesheet" href="/assets/style-ChamnO2s.css">
    <link rel="modulepreload" href="/assets/app-B9pwkC50.js"><link rel="modulepreload" href="/assets/cluster-shard.html-BCQbDySn.js">
    
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">Skip to main content</a><!--]--><div class="theme-container external-link-icon has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!----><!--[--><a class="route-link vp-brand" href="/"><img class="vp-nav-logo" src="/logo.svg" alt><!----><span class="vp-site-name hide-in-pad">VanHung4499</span></a><!--]--><!----></div><div class="vp-navbar-center"><!----><!--[--><nav class="vp-nav-links"><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/" aria-label="Home"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="mdi:home" width="1em" height="1em"></iconify-icon><!--]-->Home<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/wiki.html" aria-label="Wiki"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="carbon:wikis" width="1em" height="1em"></iconify-icon><!--]-->Wiki<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/dsa/" aria-label="Algorithms"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="hugeicons:algorithm" width="1em" height="1em"></iconify-icon><!--]-->Algorithms<!----></a></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="Programming"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="mdi:code" width="1em" height="1em"></iconify-icon>Programming<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/programming/java/" aria-label="Java"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:java" width="1em" height="1em"></iconify-icon><!--]-->Java<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/programming/golang/" aria-label="Golang"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:go" width="1em" height="1em"></iconify-icon><!--]-->Golang<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/programming/js/" aria-label="JavaScript"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:javascript" width="1em" height="1em"></iconify-icon><!--]-->JavaScript<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/programming/ts/" aria-label="TypeScript"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:typescript" width="1em" height="1em"></iconify-icon><!--]-->TypeScript<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/programming/python/" aria-label="Python"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:python" width="1em" height="1em"></iconify-icon><!--]-->Python<!----></a></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="Database"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="mdi:database" width="1em" height="1em"></iconify-icon>Database<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/database/sql/" aria-label="SQL"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="mdi:sql-query" width="1em" height="1em"></iconify-icon><!--]-->SQL<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/database/mysql/" aria-label="MySQL"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:mysql" width="1em" height="1em"></iconify-icon><!--]-->MySQL<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/database/mongodb/" aria-label="MongoDB"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:mongodb" width="1em" height="1em"></iconify-icon><!--]-->MongoDB<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/database/redis/" aria-label="Redis"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:redis" width="1em" height="1em"></iconify-icon><!--]-->Redis<!----></a></li><li class="vp-dropdown-item"><a class="route-link route-link-active auto-link" href="/database/elasticsearch/" aria-label="Elasticsearch"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:elasticsearch" width="1em" height="1em"></iconify-icon><!--]-->Elasticsearch<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/database/elastic/" aria-label="Elastic Stack"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="cib:elastic-stack" width="1em" height="1em"></iconify-icon><!--]-->Elastic Stack<!----></a></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="Framework"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="simple-icons:framework" width="1em" height="1em"></iconify-icon>Framework<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/framework/spring/" aria-label="Spring"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:spring" width="1em" height="1em"></iconify-icon><!--]-->Spring<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/framework/spring-boot/" aria-label="Spring Boot"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:spring" width="1em" height="1em"></iconify-icon><!--]-->Spring Boot<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/framework/nestjs/" aria-label="NestJS"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:nestjs" width="1em" height="1em"></iconify-icon><!--]-->NestJS<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/framework/gin/" aria-label="Gin"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="logos:gin" width="1em" height="1em"></iconify-icon><!--]-->Gin<!----></a></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="DevOps"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon-plain:azuredevops" width="1em" height="1em"></iconify-icon>DevOps<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/devops/docker/" aria-label="Docker"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:docker" width="1em" height="1em"></iconify-icon><!--]-->Docker<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/devops/kubernetes/" aria-label="Kubernetes"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:kubernetes" width="1em" height="1em"></iconify-icon><!--]-->Kubernetes<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/devops/jenkins/" aria-label="Jenkins"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:jenkins" width="1em" height="1em"></iconify-icon><!--]-->Jenkins<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/devops/git/" aria-label="Git"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:git" width="1em" height="1em"></iconify-icon><!--]-->Git<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/devops/linux/" aria-label="Linux"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:linux" width="1em" height="1em"></iconify-icon><!--]-->Linux<!----></a></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="Design"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="tdesign:system-sum" width="1em" height="1em"></iconify-icon>Design<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/design/design-pattern/" aria-label="Design Pattern"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="tabler:grid-pattern" width="1em" height="1em"></iconify-icon><!--]-->Design Pattern<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/design/system-design/" aria-label="System Design"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="icon-park-outline:system" width="1em" height="1em"></iconify-icon><!--]-->System Design<!----></a></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/project/" aria-label="Project"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="ant-design:project-outlined" width="1em" height="1em"></iconify-icon><!--]-->Project<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/interview/" aria-label="Interview"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="mdi:account-tie" width="1em" height="1em"></iconify-icon><!--]-->Interview<!----></a></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="About"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="mdi:about" width="1em" height="1em"></iconify-icon>About<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/about-me.html" aria-label="About me"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="cib:about-me" width="1em" height="1em"></iconify-icon><!--]-->About me<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/about.html" aria-label="About"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="mdi:about" width="1em" height="1em"></iconify-icon><!--]-->About<!----></a></li></ul></button></div></div></nav><!--]--><!----></div><div class="vp-navbar-end"><!----><!--[--><!----><div class="vp-nav-item vp-action"><a class="vp-action-link" href="https://github.com/vanhung4499/my-wiki" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" name="github" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="vp-nav-item hide-in-mobile"><button type="button" class="vp-outlook-button" tabindex="-1" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon outlook-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="outlook icon" name="outlook"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4 38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32 51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0 102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2 6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4 0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2 9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224 419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4 470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0 22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6 12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128 505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2 16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8 86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4 80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6 6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg><div class="vp-outlook-dropdown"><!----></div></button></div><!--[--><button type="button" class="search-pro-button" aria-label="Search"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon" name="search"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="search-pro-placeholder">Search</div><div class="search-pro-key-hints"><kbd class="search-pro-key">Ctrl</kbd><kbd class="search-pro-key">K</kbd></div></button><!--]--><!--]--><!----><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!----><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><iconify-icon class="font-icon icon" style="" mode="style" inline icon="mdi:sql-query" width="1em" height="1em"></iconify-icon><span class="vp-sidebar-title">SQL</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:mysql" width="1em" height="1em"></iconify-icon><span class="vp-sidebar-title">MySQL</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:redis" width="1em" height="1em"></iconify-icon><span class="vp-sidebar-title">Redis</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:mongodb" width="1em" height="1em"></iconify-icon><span class="vp-sidebar-title">MongoDB</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable active" type="button"><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:elasticsearch" width="1em" height="1em"></iconify-icon><span class="vp-sidebar-title">Elasticsearch</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/database/elasticsearch/overview.html" aria-label="Elasticsearch Overview"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:elasticsearch" width="1em" height="1em"></iconify-icon><!--]-->Elasticsearch Overview<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/database/elasticsearch/quick-start.html" aria-label="Elasticsearch Quick Start"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:elasticsearch" width="1em" height="1em"></iconify-icon><!--]-->Elasticsearch Quick Start<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/database/elasticsearch/intro.html" aria-label="Elasticsearch Intro"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:elasticsearch" width="1em" height="1em"></iconify-icon><!--]-->Elasticsearch Intro<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/database/elasticsearch/es-index.html" aria-label="Elasticsearch Index"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:elasticsearch" width="1em" height="1em"></iconify-icon><!--]-->Elasticsearch Index<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/database/elasticsearch/mapping.html" aria-label="Elasticsearch Mapping"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:elasticsearch" width="1em" height="1em"></iconify-icon><!--]-->Elasticsearch Mapping<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/database/elasticsearch/highlight-search-display.html" aria-label="Elasticsearch Highlight Search and Display"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:elasticsearch" width="1em" height="1em"></iconify-icon><!--]-->Elasticsearch Highlight Search and Display<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/database/elasticsearch/query.html" aria-label="Elasticsearch Query"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:elasticsearch" width="1em" height="1em"></iconify-icon><!--]-->Elasticsearch Query<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/database/elasticsearch/sorting.html" aria-label="Elasticsearch Sorting"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:elasticsearch" width="1em" height="1em"></iconify-icon><!--]-->Elasticsearch Sorting<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/database/elasticsearch/aggregation.html" aria-label="Elasticsearch Aggregation"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:elasticsearch" width="1em" height="1em"></iconify-icon><!--]-->Elasticsearch Aggregation<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/database/elasticsearch/analyzer.html" aria-label="Elasticsearch Analyzer"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:elasticsearch" width="1em" height="1em"></iconify-icon><!--]-->Elasticsearch Analyzer<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/database/elasticsearch/optimization.html" aria-label="Elasticsearch performance optimization"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:elasticsearch" width="1em" height="1em"></iconify-icon><!--]-->Elasticsearch performance optimization<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/database/elasticsearch/rest-api.html" aria-label="Elasticsearch REST API"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:elasticsearch" width="1em" height="1em"></iconify-icon><!--]-->Elasticsearch REST API<!----></a></li><li><a class="route-link route-link-active auto-link vp-sidebar-link vp-sidebar-page active" href="/database/elasticsearch/cluster-shard.html" aria-label="Elasticsearch Cluster and Shard"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:elasticsearch" width="1em" height="1em"></iconify-icon><!--]-->Elasticsearch Cluster and Shard<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/database/elasticsearch/operation.html" aria-label="Elasticsearch Operation"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:elasticsearch" width="1em" height="1em"></iconify-icon><!--]-->Elasticsearch Operation<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/database/elasticsearch/interview.html" aria-label="Elasticsearch Interview"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:elasticsearch" width="1em" height="1em"></iconify-icon><!--]-->Elasticsearch Interview<!----></a></li></ul></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><iconify-icon class="font-icon icon" style="" mode="style" inline icon="cib:elastic-stack" width="1em" height="1em"></iconify-icon><span class="vp-sidebar-title">Elastic Stack</span><span class="vp-arrow end"></span></button><!----></section></li></ul><!----></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:elasticsearch" width="1em" height="1em"></iconify-icon>Elasticsearch Cluster and Shard</h1><div class="page-info"><span class="page-author-info" aria-label="Author🖊" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon" name="author"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="page-author-item" href="https://vanhung4499.github.io" target="_blank" rel="noopener noreferrer">Hung Nguyen</a></span><span property="author" content="Hung Nguyen"></span></span><!----><span class="page-date-info" aria-label="Writing Date📅" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon" name="calendar"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2024-06-28T15:54:38.000Z"></span><!----><span class="page-reading-time-info" aria-label="Reading Time⌛" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon" name="timer"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>About 30 min</span><meta property="timeRequired" content="PT30M"></span><span class="page-category-info" aria-label="Category🌈" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon" name="category"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><!--[--><span class="page-category-item color4 clickable" role="navigation">elasticssearch</span><!--]--><meta property="articleSection" content="elasticssearch"></span><span class="page-tag-info" aria-label="Tag🏷" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon" name="tag"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><!--[--><span class="page-tag-item color4 clickable" role="navigation">elasticssearch</span><!--]--><meta property="keywords" content="elasticssearch"></span></div><hr></div><div class="vp-toc-placeholder"><aside id="toc"><!----><div class="vp-toc-header">On This Page<button type="button" class="print-button" title="Print"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon" name="print"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button><div class="arrow end"></div></div><div class="vp-toc-wrapper"><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#clusters">Clusters</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#cluster-trong">Cluster trống</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#cluster-health">Cluster Health</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#them-chi-muc">Thêm chỉ mục</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#them-kha-nang-chuyen-đoi-khi-gap-su-co">Thêm khả năng chuyển đổi khi gặp sự cố</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#mo-rong-ngang">Mở rộng ngang</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#shard">Shard</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#lam-cho-van-ban-co-the-tim-kiem">Làm cho văn bản có thể tìm kiếm</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#bat-bien">Bất biến</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#cap-nhat-chi-muc-đong">Cập nhật chỉ mục động</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#xoa-va-cap-nhat">Xóa và cập nhật</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#tim-kiem-gan-thoi-gian-thuc">Tìm kiếm gần thời gian thực</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#refresh-api">refresh API</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#luu-tru-thay-đoi">Lưu trữ thay đổi</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#flush-api">flush API</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#shard-hop-nhat">shard hợp nhất</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#optimize-api">optimize API</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#tai-lieu-tham-khao">Tài liệu tham khảo</a></li><!----><!--]--></ul><div class="vp-toc-marker" style="top:-1.7rem;"></div></div><!----></aside></div><!----><div class="theme-hope-content"><h1 id="elasticsearch-clusters-va-shards" tabindex="-1"><a class="header-anchor" href="#elasticsearch-clusters-va-shards"><span>Elasticsearch Clusters và Shards</span></a></h1><h2 id="clusters" tabindex="-1"><a class="header-anchor" href="#clusters"><span>Clusters</span></a></h2><h3 id="cluster-trong" tabindex="-1"><a class="header-anchor" href="#cluster-trong"><span>Cluster trống</span></a></h3><p>Nếu chúng ta khởi động một nút đơn lẻ không chứa bất kỳ dữ liệu hay chỉ mục nào, cluster của chúng ta sẽ trông như một cluster với một nút nội dung trống.</p><p><strong>Hình 1. Cluster với nút nội dung trống</strong></p><figure><img src="https://raw.githubusercontent.com/vanhung4499/images/master/snap/elas_0201.png" alt="Cluster với nút nội dung trống" tabindex="0" loading="lazy"><figcaption>Cluster với nút nội dung trống</figcaption></figure><p>Hình 1: Cluster chỉ có một nút trống</p><p>Một thực thể Elasticsearch đang chạy được gọi là một <strong>nút</strong>, và một <strong>cluster</strong> bao gồm một hoặc nhiều nút với cấu hình <code>cluster.name</code> giống nhau. Chúng cùng nhau chịu áp lực của dữ liệu và tải. Khi các nút được thêm vào hoặc loại bỏ khỏi cluster, cluster sẽ phân phối lại tất cả dữ liệu một cách đều.</p><p>Khi một nút được bầu làm <strong>nút chính</strong>, nó chịu trách nhiệm quản lý <strong>tất cả các thay đổi</strong> trong phạm vi cluster, chẳng hạn như thêm hoặc xóa chỉ mục, hoặc thêm hoặc xóa các nút, v.v. Nút chính không cần tham gia vào các thay đổi cấp độ tài liệu và tìm kiếm, vì vậy ngay cả khi lưu lượng tăng lên, nó sẽ không trở thành một nút cổ chai khi cluster chỉ có một nút chính. Bất kỳ nút nào cũng có thể trở thành nút chính. Cluster mẫu của chúng ta chỉ có một nút, vì vậy nó cũng trở thành nút chính.</p><p>Là người dùng, chúng ta có thể gửi yêu cầu đến bất kỳ nút nào trong cluster, bao gồm cả nút chính. Mỗi nút đều biết vị trí của bất kỳ tài liệu nào và có thể chuyển tiếp yêu cầu của chúng ta trực tiếp đến nút lưu trữ tài liệu mà chúng ta cần. Không quan trọng chúng ta gửi yêu cầu đến nút nào, nút đó có thể chịu trách nhiệm thu thập dữ liệu từ tất cả các nút chứa tài liệu mà chúng ta cần và trả kết quả cuối cùng cho máy khách. Elasticsearch quản lý tất cả mọi thứ này một cách trong suốt.</p><h3 id="cluster-health" tabindex="-1"><a class="header-anchor" href="#cluster-health"><span>Cluster Health</span></a></h3><p>Thông tin giám sát cluster của Elasticsearch chứa nhiều dữ liệu thống kê, trong đó quan trọng nhất là <em>sức khỏe của cluster</em>, được hiển thị là <code>green</code>, <code>yellow</code>, hoặc <code>red</code> trong trường <code>status</code>.</p><div class="language-bash" data-ext="bash" data-title="bash"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">GET</span><span style="color:#98C379;--shiki-dark:#98C379;"> /_cluster/health</span></span></code></pre></div><p>Trong một cluster trống không chứa bất kỳ chỉ mục nào, nó sẽ có nội dung trả về tương tự như sau:</p><div class="language-json" data-ext="json" data-title="json"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">  &quot;cluster_name&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;elasticsearch&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">  &quot;status&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;green&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">  &quot;timed_out&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="color:#D19A66;--shiki-dark:#D19A66;">false</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">  &quot;number_of_nodes&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">  &quot;number_of_data_nodes&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">  &quot;active_primary_shards&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">  &quot;active_shards&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">  &quot;relocating_shards&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">  &quot;initializing_shards&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">  &quot;unassigned_shards&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">}</span></span></code></pre></div><p>Trường <code>status</code> chỉ ra liệu cluster hiện tại có hoạt động bình thường tổng thể hay không. Ba màu của nó có ý nghĩa như sau:</p><ul><li><strong><code>green</code></strong>: Tất cả các shard chính và shard phụ đều hoạt động bình thường.</li><li><strong><code>yellow</code></strong>: Tất cả các shard chính đều hoạt động bình thường, nhưng không phải tất cả các shard phụ đều hoạt động bình thường.</li><li><strong><code>red</code></strong>: Có shard chính không hoạt động bình thường.</li></ul><h3 id="them-chi-muc" tabindex="-1"><a class="header-anchor" href="#them-chi-muc"><span>Thêm chỉ mục</span></a></h3><p>Khi chúng ta thêm dữ liệu vào Elasticsearch, chúng ta cần sử dụng <em>chỉ mục</em> - nơi lưu trữ dữ liệu liên quan. Chỉ mục thực ra là không gian tên logic trỏ đến một hoặc nhiều shard vật lý.</p><p>Một <em>shard</em> là một <em>đơn vị công việc</em> cơ bản, nó chỉ lưu trữ một phần của tất cả dữ liệu. Bây giờ chúng ta chỉ cần biết một shard là một thể hiện của Lucene, và nó chính là một công cụ tìm kiếm hoàn chỉnh. Tài liệu của chúng ta được lưu trữ và chỉ mục trong shard, nhưng ứng dụng thực hiện tương tác trực tiếp với chỉ mục chứ không phải với shard.</p><p>Elasticsearch sử dụng shard để phân phối dữ liệu đến các nơi khác nhau trong cluster. shard là bộ chứa dữ liệu, tài liệu được lưu trữ trong shard, và shard được phân bổ đến các nút khác nhau trong cluster. Khi kích thước của cluster của bạn mở rộng hoặc thu hẹp, Elasticsearch sẽ tự động di chuyển shard giữa các nút, để dữ liệu vẫn được phân phối đều trong cluster.</p><p>Một shard có thể là shard <em>chính</em> hoặc shard <em>sao lưu</em>. Bất kỳ tài liệu nào trong chỉ mục đều thuộc về một shard chính, vì vậy số lượng shard chính quyết định lượng dữ liệu tối đa mà chỉ mục có thể lưu trữ.</p><blockquote><p>Kỹ thuật, một shard chính có thể lưu trữ tối đa <code>Integer.MAX_VALUE - 128</code> tài liệu, nhưng giá trị tối đa thực tế còn phụ thuộc vào tình huống sử dụng của bạn: bao gồm phần cứng bạn sử dụng, kích thước và độ phức tạp của tài liệu, cách chỉ mục và truy vấn tài liệu cũng như thời gian phản hồi mong đợi của bạn.</p></blockquote><p>Một shard sao lưu chỉ là một bản sao của shard chính. shard sao lưu đóng vai trò là bản sao dự phòng dư thừa để bảo vệ dữ liệu không bị mất khi xảy ra lỗi phần cứng, và cung cấp dịch vụ cho các hoạt động đọc như tìm kiếm và trả về tài liệu.</p><p>Số shard chính đã được xác định khi tạo chỉ mục, nhưng số shard sao lưu có thể được thay đổi bất cứ lúc nào.</p><p>Hãy tạo một chỉ mục có tên <code>blogs</code> trong một cluster với một nút trống. Theo mặc định, chỉ mục sẽ được phân bổ 5 shard chính, nhưng vì mục đích minh họa, chúng tôi sẽ phân bổ 3 shard chính và một bản sao (mỗi shard chính có một shard sao lưu):</p><div class="language-json" data-ext="json" data-title="json"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">PUT /blogs</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">   &quot;settings&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> : {</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">      &quot;number_of_shards&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> : </span><span style="color:#D19A66;--shiki-dark:#D19A66;">3</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">      &quot;number_of_replicas&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> : </span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   }</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">}</span></span></code></pre></div><p>Cluster của chúng ta hiện tại là <em>một cluster đơn nút có một chỉ mục</em>. Tất cả 3 shard chính đều được phân bổ tại <code>Node 1</code>.</p><p><strong>Hình 2. Cluster đơn nút có một chỉ mục</strong></p><figure><img src="https://raw.githubusercontent.com/vanhung4499/images/master/snap/elas_0202.png" alt="Cluster đơn nút có một chỉ mục" tabindex="0" loading="lazy"><figcaption>Cluster đơn nút có một chỉ mục</figcaption></figure><p>Nếu chúng ta kiểm tra sức khỏe của cluster ngay bây giờ, chúng ta sẽ thấy nội dung sau:</p><div class="language-json line-numbers-mode" data-ext="json" data-title="json"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">  &quot;cluster_name&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;elasticsearch&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">  &quot;status&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;yellow&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">  &quot;timed_out&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="color:#D19A66;--shiki-dark:#D19A66;">false</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">  &quot;number_of_nodes&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">  &quot;number_of_data_nodes&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">  &quot;active_primary_shards&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="color:#D19A66;--shiki-dark:#D19A66;">3</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">  &quot;active_shards&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="color:#D19A66;--shiki-dark:#D19A66;">3</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">  &quot;relocating_shards&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">  &quot;initializing_shards&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">  &quot;unassigned_shards&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="color:#D19A66;--shiki-dark:#D19A66;">3</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">  &quot;delayed_unassigned_shards&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">  &quot;number_of_pending_tasks&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">  &quot;number_of_in_flight_fetch&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">  &quot;task_max_waiting_in_queue_millis&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">  &quot;active_shards_percent_as_number&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="color:#D19A66;--shiki-dark:#D19A66;">50</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>Giá trị status của cluster là yellow</li><li>Số lượng shard sao lưu không được phân bổ cho bất kỳ nút nào</li></ul><p>Sức khỏe của cluster ở trạng thái <code>yellow</code> có nghĩa là tất cả các shard <em>chính</em> đều hoạt động bình thường (cluster có thể phục vụ tất cả các yêu cầu), nhưng không phải tất cả các shard <em>sao lưu</em> đều ở trạng thái bình thường. Thực tế, tất cả 3 shard sao lưu đều là <code>unassigned</code> - chúng không được phân bổ cho bất kỳ nút nào. Việc lưu trữ dữ liệu gốc và bản sao trên cùng một nút không có ý nghĩa, bởi vì một khi chúng ta mất nút đó, chúng ta cũng sẽ mất tất cả dữ liệu bản sao trên nút đó.</p><p>Hiện tại, cluster của chúng ta đang hoạt động bình thường, nhưng có nguy cơ mất dữ liệu khi xảy ra lỗi phần cứng.</p><h3 id="them-kha-nang-chuyen-đoi-khi-gap-su-co" tabindex="-1"><a class="header-anchor" href="#them-kha-nang-chuyen-đoi-khi-gap-su-co"><span>Thêm khả năng chuyển đổi khi gặp sự cố</span></a></h3><p>Khi chỉ có một nút đang hoạt động trong cluster, điều này có nghĩa là sẽ có một vấn đề về điểm lỗi đơn - không có sự dự phòng. May mắn thay, chúng ta chỉ cần khởi động thêm một nút nữa để ngăn chặn mất dữ liệu.</p><blockquote><p>Để kiểm tra tình hình sau khi khởi động nút thứ hai, bạn có thể khởi động một nút mới trong cùng một thư mục, hoàn toàn tuân theo cách khởi động nút đầu tiên (xem Cài đặt và chạy Elasticsearch). Nhiều nút có thể chia sẻ cùng một thư mục.</p><p>Khi bạn khởi động nút thứ hai trên cùng một máy, miễn là nó có cấu hình <code>cluster.name</code> giống với nút đầu tiên, nó sẽ tự động phát hiện cluster và tham gia vào đó. Tuy nhiên, khi khởi động nút trên các máy khác nhau, để tham gia vào cùng một cluster, bạn cần cấu hình danh sách host unicast có thể kết nối.</p></blockquote><p>Nếu chúng ta khởi động một nút thứ hai, cluster của chúng ta sẽ trở thành một cluster với hai nút - tất cả các shard chính và shard sao lưu đều đã được phân bổ.</p><p><strong>Hình 3. Cluster với hai nút - tất cả các shard chính và shard sao lưu đều đã được phân bổ</strong></p><figure><img src="https://raw.githubusercontent.com/vanhung4499/images/master/snap/elas_0203.png" alt="Cluster với hai nút" tabindex="0" loading="lazy"><figcaption>Cluster với hai nút</figcaption></figure><p>Khi nút thứ hai tham gia vào cluster, 3 shard <em>sao lưu</em> sẽ được phân bổ cho nút này - mỗi shard chính có một shard sao lưu tương ứng. Điều này có nghĩa là khi bất kỳ nút nào trong cluster gặp sự cố, dữ liệu của chúng ta vẫn còn nguyên vẹn.</p><p>Tất cả các tài liệu mới được chỉ mục sẽ được lưu trữ trong shard chính, sau đó được sao chép song song đến shard sao lưu tương ứng. Điều này đảm bảo rằng chúng ta có thể lấy tài liệu từ shard chính cũng như từ shard sao lưu.</p><p><code>cluster-health</code> hiện tại hiển thị trạng thái là <code>green</code>, điều này cho thấy tất cả 6 shard (bao gồm 3 shard chính và 3 shard sao lưu) đều đang hoạt động bình thường.</p><div class="language-json line-numbers-mode" data-ext="json" data-title="json"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">  &quot;cluster_name&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;elasticsearch&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">  &quot;status&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;green&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">  &quot;timed_out&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="color:#D19A66;--shiki-dark:#D19A66;">false</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">  &quot;number_of_nodes&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">  &quot;number_of_data_nodes&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">  &quot;active_primary_shards&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="color:#D19A66;--shiki-dark:#D19A66;">3</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">  &quot;active_shards&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="color:#D19A66;--shiki-dark:#D19A66;">6</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">  &quot;relocating_shards&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">  &quot;initializing_shards&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">  &quot;unassigned_shards&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">  &quot;delayed_unassigned_shards&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">  &quot;number_of_pending_tasks&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">  &quot;number_of_in_flight_fetch&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">  &quot;task_max_waiting_in_queue_millis&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="color:#D19A66;--shiki-dark:#D19A66;">0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">  &quot;active_shards_percent_as_number&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="color:#D19A66;--shiki-dark:#D19A66;">100</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>Trạng thái <code>status</code> của cluster là <code>green</code></li></ul><p>Cluster của chúng ta hiện tại không chỉ đang hoạt động bình thường, mà còn ở trạng thái <em>luôn sẵn sàng</em>.</p><h3 id="mo-rong-ngang" tabindex="-1"><a class="header-anchor" href="#mo-rong-ngang"><span>Mở rộng ngang</span></a></h3><p>Làm thế nào để chúng ta mở rộng theo nhu cầu cho ứng dụng đang phát triển của chúng ta? Khi khởi động một nút thứ ba, cluster của chúng ta sẽ trở thành một cluster với ba nút - phân phối lại các shard để phân tán tải.</p><p><strong>Hình 4. Cluster với ba nút - phân phối lại các shard để phân tán tải</strong></p><figure><img src="https://raw.githubusercontent.com/vanhung4499/images/master/snap/elas_0204.png" alt="Cluster với ba nút" tabindex="0" loading="lazy"><figcaption>Cluster với ba nút</figcaption></figure><p>Một shard từ <code>Node 1</code> và <code>Node 2</code> đã được di chuyển đến nút mới <code>Node 3</code>, bây giờ mỗi nút đều có 2 shard, thay vì 3 như trước. Điều này có nghĩa là tài nguyên phần cứng (CPU, RAM, I/O) của mỗi nút sẽ được chia sẻ cho ít shard hơn, hiệu suất của mỗi shard sẽ được cải thiện.</p><p>Một shard là một công cụ tìm kiếm hoàn chỉnh, nó có khả năng sử dụng tất cả các tài nguyên trên một nút. Chỉ mục của chúng ta có 6 shard (3 shard chính và 3 shard sao lưu) có thể mở rộng tối đa lên đến 6 nút, mỗi nút có một shard, và mỗi shard có toàn bộ tài nguyên của nút nơi nó đặt.</p><h2 id="shard" tabindex="-1"><a class="header-anchor" href="#shard"><span>Shard</span></a></h2><blockquote><ul><li>Tại sao tìm kiếm là <em>gần</em> thời gian thực?</li><li>Tại sao các hoạt động CRUD (Tạo - Đọc - Cập nhật - Xóa) trên tài liệu là <em>thời gian thực</em>?</li><li>Elasticsearch làm thế nào để đảm bảo các cập nhật được lưu trữ một cách bền vững mà không mất dữ liệu khi mất điện?</li><li>Tại sao việc xóa tài liệu không giải phóng không gian ngay lập tức?</li><li>API <code>refresh</code>, <code>flush</code>, và <code>optimize</code> làm gì và khi nào bạn nên sử dụng chúng?</li></ul></blockquote><h3 id="lam-cho-van-ban-co-the-tim-kiem" tabindex="-1"><a class="header-anchor" href="#lam-cho-van-ban-co-the-tim-kiem"><span>Làm cho văn bản có thể tìm kiếm</span></a></h3><p>Thách thức đầu tiên cần giải quyết là làm thế nào để làm cho văn bản có thể tìm kiếm. Các cơ sở dữ liệu truyền thống lưu trữ một giá trị duy nhất cho mỗi trường, nhưng điều này không đủ cho tìm kiếm toàn văn. Mỗi từ trong trường văn bản cần được tìm kiếm, điều này đối với cơ sở dữ liệu có nghĩa là cần có khả năng lập chỉ mục nhiều giá trị (ở đây là từ) cho một trường duy nhất.</p><p>Cấu trúc dữ liệu phù hợp nhất để hỗ trợ yêu cầu <em>nhiều giá trị cho một trường</em> là <em>chỉ mục đảo ngược</em> mà chúng ta đã giới thiệu trong chương <a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/inverted-index.html" target="_blank" rel="noopener noreferrer">Chỉ mục đảo ngược</a>. Chỉ mục đảo ngược bao gồm một danh sách đã sắp xếp, chứa tất cả các cá thể không trùng lặp xuất hiện trong tài liệu, hoặc được gọi là <em>cụm từ</em>, và cho mỗi cụm từ, chứa danh sách tất cả các tài liệu mà nó đã xuất hiện.</p><div class="language-" data-ext="" data-title=""><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span>Term  | Doc 1 | Doc 2 | Doc 3 | ...</span></span>
<span class="line"><span>------------------------------------</span></span>
<span class="line"><span>brown |   X   |       |  X    | ...</span></span>
<span class="line"><span>fox   |   X   |   X   |  X    | ...</span></span>
<span class="line"><span>quick |   X   |   X   |       | ...</span></span>
<span class="line"><span>the   |   X   |       |  X    | ...</span></span></code></pre></div><blockquote><p>Khi thảo luận về chỉ mục đảo ngược, chúng ta sẽ nói về <em>tài liệu</em> được lập chỉ mục, bởi vì lịch sử, chỉ mục đảo ngược đã được sử dụng để lập chỉ mục cho toàn bộ tài liệu văn bản không cấu trúc. Trong Elasticsearch, một <em>tài liệu</em> là một tài liệu JSON có cấu trúc với trường và giá trị. Thực tế, trong tài liệu JSON, mỗi trường được lập chỉ mục đều có chỉ mục đảo ngược riêng của mình.</p></blockquote><p>Chỉ mục đảo ngược này so với danh sách tài liệu mà một cụm từ cụ thể đã xuất hiện, sẽ chứa thông tin khác nhiều hơn. Nó sẽ lưu tổng số tài liệu mà mỗi cụm từ đã xuất hiện, tổng số lần một cụm từ cụ thể xuất hiện trong tài liệu, thứ tự của cụm từ trong tài liệu, độ dài của mỗi tài liệu, độ dài trung bình của tất cả các tài liệu, v.v. Thông tin thống kê này cho phép Elasticsearch quyết định từ nào quan trọng hơn từ khác, tài liệu nào quan trọng hơn tài liệu khác, những nội dung này được mô tả trong <a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/relevance-intro.html" target="_blank" rel="noopener noreferrer">Độ liên quan là gì?</a>.</p><p>Để có thể thực hiện như mong đợi, chỉ mục đảo ngược cần biết <em>tất cả</em> các tài liệu trong tập hợp, đây là vấn đề quan trọng cần nhận biết.</p><p>Tìm kiếm toàn văn ban đầu sẽ tạo một chỉ mục đảo ngược lớn cho toàn bộ tập hợp tài liệu và ghi nó vào đĩa. Một khi chỉ mục mới đã sẵn sàng, nó sẽ thay thế chỉ mục cũ, do đó, các thay đổi gần đây có thể được tìm kiếm.</p><h3 id="bat-bien" tabindex="-1"><a class="header-anchor" href="#bat-bien"><span>Bất biến</span></a></h3><p>Chỉ mục đảo ngược sau khi được ghi vào đĩa là <em>bất biến</em>: nó sẽ không bao giờ được sửa đổi. Sự bất biến có giá trị quan trọng:</p><ul><li>Không cần khóa. Nếu bạn không bao giờ cập nhật chỉ mục, bạn không cần phải lo lắng về vấn đề nhiều quy trình cùng lúc sửa đổi dữ liệu.</li><li>Một khi chỉ mục được đọc vào bộ nhớ đệm hệ thống tệp tin của hạt nhân, nó sẽ ở đó, do tính bất biến của nó. Miễn là bộ nhớ đệm hệ thống tệp tin còn đủ không gian, hầu hết các yêu cầu đọc sẽ trực tiếp yêu cầu bộ nhớ, không phải đĩa. Điều này mang lại một cải tiến lớn về hiệu suất.</li><li>Bộ nhớ đệm khác (như bộ nhớ đệm bộ lọc) luôn hợp lệ trong suốt vòng đời của chỉ mục. Chúng không cần được xây dựng lại mỗi khi dữ liệu thay đổi, bởi vì dữ liệu không thay đổi.</li><li>Viết một chỉ mục đảo ngược lớn duy nhất cho phép dữ liệu được nén, giảm I/O đĩa và số lượng chỉ mục cần được lưu vào bộ nhớ đệm.</li></ul><p>Tất nhiên, một chỉ mục không thay đổi cũng có nhược điểm. Điểm chính là nó không thể thay đổi! Bạn không thể sửa đổi nó. Nếu bạn cần để một tài liệu mới có thể tìm kiếm, bạn cần xây dựng lại toàn bộ chỉ mục. Điều này hoặc đặt giới hạn lớn về số lượng dữ liệu mà một chỉ mục có thể chứa, hoặc đặt giới hạn về tần suất mà chỉ mục có thể được cập nhật.</p><h3 id="cap-nhat-chi-muc-đong" tabindex="-1"><a class="header-anchor" href="#cap-nhat-chi-muc-đong"><span>Cập nhật chỉ mục động</span></a></h3><p>Vấn đề tiếp theo cần giải quyết là làm thế nào để cập nhật chỉ mục đảo ngược trong khi vẫn giữ tính bất biến? Câu trả lời là: sử dụng nhiều chỉ mục hơn.</p><p>Thay vì ghi đè toàn bộ chỉ mục đảo ngược, ta thêm các chỉ mục bổ sung mới để phản ánh các thay đổi gần đây. Mỗi chỉ mục đảo ngược sẽ được truy vấn theo lượt - bắt đầu từ cái cũ nhất - và sau đó kết quả sẽ được hợp nhất.</p><p>Elasticsearch dựa trên Lucene, thư viện Java này đã giới thiệu khái niệm tìm kiếm theo shard. Mỗi shard là một chỉ mục đảo ngược, nhưng chỉ mục trong Lucene ngoài việc là tập hợp của tất cả các shard, còn thêm khái niệm điểm commit - một tệp liệt kê tất cả các shard đã biết, giống như trong Hình 16, &quot;Một chỉ mục Lucene bao gồm một điểm commit và ba shard&quot;. Như Hình 17, &quot;Một chỉ mục Lucene trong bộ đệm bộ nhớ chứa các tài liệu mới&quot; cho thấy, tài liệu mới đầu tiên được thêm vào bộ đệm chỉ mục trong bộ nhớ, sau đó được ghi vào một shard dựa trên đĩa, như Hình 18, &quot;Sau một lần commit, một shard mới được thêm vào điểm commit và bộ đệm được xóa sạch.&quot;.</p><p><strong>Hình 16. Một chỉ mục Lucene bao gồm một điểm commit và ba shard</strong></p><figure><img src="https://raw.githubusercontent.com/vanhung4499/images/master/snap/elas_1101.png" alt="A Lucene index with a commit point and three segments" tabindex="0" loading="lazy"><figcaption>A Lucene index with a commit point and three segments</figcaption></figure><blockquote><p>Khái niệm gây nhầm lẫn là một <em>chỉ mục Lucene</em> mà chúng ta gọi là <em>shard</em> trong Elasticsearch. Một <em>chỉ mục Elasticsearch</em> là một tập hợp các shard. Khi Elasticsearch tìm kiếm trong một chỉ mục, nó gửi truy vấn đến mỗi shard thuộc về chỉ mục (chỉ mục Lucene), sau đó hợp nhất kết quả từ mỗi shard thành một tập kết quả toàn cầu, như đã mô tả trong <a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/distributed-search.html" target="_blank" rel="noopener noreferrer"><em>Thực hiện tìm kiếm phân tán</em></a>.</p></blockquote><p>Tìm kiếm theo shard sẽ hoạt động theo quy trình sau:</p><ol><li>Tài liệu mới được thu thập vào bộ đệm chỉ mục trong bộ nhớ, xem Hình 17, &quot;Một chỉ mục Lucene trong bộ đệm bộ nhớ chứa các tài liệu mới&quot;.</li><li>Thỉnh thoảng, bộ đệm được <em>commit</em>: <ul><li>Một shard mới - một chỉ mục đảo ngược bổ sung - được ghi vào đĩa.</li><li>Một điểm <em>commit</em> mới chứa tên shard mới được ghi vào đĩa.</li><li>Đĩa được <em>đồng bộ hóa</em> - tất cả các ghi chờ trong bộ đệm hệ thống tệp tin được đẩy xuống đĩa để đảm bảo rằng chúng được ghi vào tệp vật lý.</li></ul></li><li>shard mới được mở, làm cho tài liệu bên trong có thể tìm kiếm.</li><li>Bộ đệm trong bộ nhớ được xóa sạch, sẵn sàng để nhận tài liệu mới.</li></ol><p><strong>Hình 17. Một chỉ mục Lucene trong bộ đệm bộ nhớ chứa các tài liệu mới</strong></p><figure><img src="https://raw.githubusercontent.com/vanhung4499/images/master/snap/elas_1102.png" alt="A Lucene index with new documents in the in-memory buffer, ready to commit" tabindex="0" loading="lazy"><figcaption>A Lucene index with new documents in the in-memory buffer, ready to commit</figcaption></figure><p><strong>Hình 18. Sau một lần commit, một shard mới được thêm vào chỉ mục và bộ đệm được xóa sạch.</strong></p><figure><img src="https://raw.githubusercontent.com/vanhung4499/images/master/snap/elas_1103.png" alt="After a commit, a new segment is added to the index and the buffer is cleared" tabindex="0" loading="lazy"><figcaption>After a commit, a new segment is added to the index and the buffer is cleared</figcaption></figure><p>Khi một truy vấn được kích hoạt, tất cả các shard đã biết sẽ được truy vấn theo thứ tự. Thống kê từ sẽ được tổng hợp từ kết quả của tất cả các shard, để đảm bảo rằng mỗi từ và mỗi tài liệu được tính toán chính xác. Cách này cho phép thêm tài liệu mới vào chỉ mục với chi phí tương đối thấp.</p><h3 id="xoa-va-cap-nhat" tabindex="-1"><a class="header-anchor" href="#xoa-va-cap-nhat"><span>Xóa và cập nhật</span></a></h3><p>shard là bất biến, vì vậy không thể xóa tài liệu từ shard cũ, cũng không thể sửa đổi shard cũ để phản ánh việc cập nhật tài liệu. Thay vào đó, mỗi điểm commit sẽ chứa một tệp <code>.del</code>, liệt kê các shard của tài liệu đã bị xóa.</p><p>Khi một tài liệu bị &quot;xóa&quot;, thực tế là nó chỉ được <em>đánh dấu</em> xóa trong tệp <code>.del</code>. Một tài liệu đã bị đánh dấu xóa vẫn có thể khớp với một truy vấn, nhưng nó sẽ bị xóa khỏi tập kết quả trước khi kết quả cuối cùng được trả về.</p><p>Cập nhật tài liệu cũng hoạt động theo cách tương tự: khi một tài liệu được cập nhật, phiên bản cũ của tài liệu được đánh dấu xóa, và phiên bản mới của tài liệu được lập chỉ mục vào một shard mới. Cả hai phiên bản của tài liệu có thể khớp với một truy vấn, nhưng phiên bản đã bị xóa sẽ bị loại bỏ khỏi kết quả trước khi kết quả cuối cùng được trả về.</p><p>Trong <a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/merge-process.html" target="_blank" rel="noopener noreferrer">Hợp nhất shard</a>, chúng tôi thảo luận về cách một tài liệu đã bị xóa được loại bỏ khỏi hệ thống tệp.</p><h3 id="tim-kiem-gan-thoi-gian-thuc" tabindex="-1"><a class="header-anchor" href="#tim-kiem-gan-thoi-gian-thuc"><span>Tìm kiếm gần thời gian thực</span></a></h3><p>Với sự phát triển của tìm kiếm theo shard, độ trễ từ khi một tài liệu mới được lập chỉ mục đến khi nó có thể tìm kiếm đã giảm đáng kể. Tài liệu mới có thể được tìm kiếm trong vòng vài phút, nhưng điều này vẫn chưa đủ nhanh.</p><p>Đĩa ở đây trở thành nút thắt. Để commit một shard mới vào đĩa, cần một lệnh <a href="http://en.wikipedia.org/wiki/Fsync" target="_blank" rel="noopener noreferrer"><code>fsync</code></a> để đảm bảo rằng shard được ghi vào đĩa vật lý, do đó dữ liệu sẽ không bị mất khi mất điện. Nhưng lệnh <code>fsync</code> tốn kém; nếu thực hiện mỗi lần lập chỉ mục một tài liệu sẽ gây ra vấn đề về hiệu suất.</p><p>Chúng ta cần một cách nhẹ nhàng hơn để làm cho một tài liệu có thể tìm kiếm, điều này có nghĩa là <code>fsync</code> cần được loại bỏ khỏi toàn bộ quy trình.</p><p>Giữa Elasticsearch và đĩa là bộ đệm hệ thống tệp. Như đã mô tả trước đó, tài liệu trong bộ đệm chỉ mục trong bộ nhớ (<a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/near-real-time.html#img-pre-refresh" target="_blank" rel="noopener noreferrer">Hình 19, &quot;Một chỉ mục Lucene trong bộ đệm bộ nhớ chứa các tài liệu mới&quot;</a>) sẽ được ghi vào một shard mới (<a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/near-real-time.html#img-post-refresh" target="_blank" rel="noopener noreferrer">Hình 20, &quot;Nội dung bộ đệm đã được ghi vào một shard, có thể tìm kiếm, nhưng chưa được commit&quot;</a>). Tuy nhiên, ở đây shard mới sẽ được ghi vào bộ đệm hệ thống tệp trước - bước này tốn ít chi phí hơn, sau đó mới được đẩy xuống đĩa - bước này tốn chi phí cao hơn. Nhưng chỉ cần tệp đã ở trong bộ đệm, nó có thể được mở và đọc như bất kỳ tệp nào khác.</p><p><strong>Hình 19. Một chỉ mục Lucene trong bộ đệm bộ nhớ chứa các tài liệu mới</strong></p><figure><img src="https://raw.githubusercontent.com/vanhung4499/images/master/snap/elas_1104.png" alt="A Lucene index with new documents in the in-memory buffer" tabindex="0" loading="lazy"><figcaption>A Lucene index with new documents in the in-memory buffer</figcaption></figure><p>Lucene cho phép shard mới được ghi và mở - làm cho tài liệu bên trong có thể tìm kiếm mà không cần một lần commit đầy đủ. Cách này tốn ít chi phí hơn rất nhiều so với việc commit và có thể thực hiện thường xuyên mà không ảnh hưởng đến hiệu suất.</p><p><strong>Hình 20. Nội dung bộ đệm đã được ghi vào một shard, có thể tìm kiếm, nhưng chưa được commit</strong></p><figure><img src="https://raw.githubusercontent.com/vanhung4499/images/master/snap/elas_1105.png" alt="The buffer contents have been written to a segment, which is searchable, but is not yet commited" tabindex="0" loading="lazy"><figcaption>The buffer contents have been written to a segment, which is searchable, but is not yet commited</figcaption></figure><h3 id="refresh-api" tabindex="-1"><a class="header-anchor" href="#refresh-api"><span>refresh API</span></a></h3><p>Trong Elasticsearch, quy trình nhẹ để viết và mở một shard mới được gọi là <em>refresh</em>. Mặc định, mỗi shard sẽ tự động làm mới mỗi giây. Đây là lý do tại sao chúng ta nói Elasticsearch là <em>gần</em> thời gian thực: thay đổi tài liệu không ngay lập tức có thể tìm kiếm, nhưng sẽ có thể tìm kiếm trong vòng một giây.</p><p>Hành vi này có thể gây nhầm lẫn cho người dùng mới: họ lập chỉ mục cho một tài liệu và sau đó cố gắng tìm kiếm nó, nhưng không tìm thấy. Cách giải quyết vấn đề này là sử dụng API <code>refresh</code> để thực hiện một lần làm mới thủ công:</p><div class="language-bash" data-ext="bash" data-title="bash"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">POST</span><span style="color:#98C379;--shiki-dark:#98C379;"> /_refresh</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">POST</span><span style="color:#98C379;--shiki-dark:#98C379;"> /blogs/_refresh</span></span></code></pre></div><p>Làm mới tất cả các chỉ mục</p><p>Chỉ làm mới chỉ mục <code>blogs</code></p><blockquote><p>Mặc dù việc làm mới là một thao tác nhẹ hơn rất nhiều so với việc commit, nó vẫn gây ra chi phí hiệu suất. Khi viết các bài kiểm tra, việc làm mới thủ công rất hữu ích, nhưng không nên trong môi trường sản xuất mỗi lần lập chỉ mục cho một tài liệu đều thực hiện làm mới thủ công. Thay vào đó, ứng dụng của bạn cần nhận biết tính chất gần thời gian thực của Elasticsearch và chấp nhận những hạn chế của nó.</p></blockquote><p>Không phải tất cả các trường hợp đều cần làm mới mỗi giây. Có thể bạn đang sử dụng Elasticsearch để lập chỉ mục cho một lượng lớn tệp nhật ký, bạn có thể muốn tối ưu hóa tốc độ lập chỉ mục hơn là tìm kiếm gần thời gian thực, bạn có thể giảm tần suất làm mới cho mỗi chỉ mục bằng cách đặt <code>refresh_interval</code>:</p><div class="language-json" data-ext="json" data-title="json"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">PUT /my_logs</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">  &quot;settings&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">: {</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">    &quot;refresh_interval&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;30s&quot;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">}</span></span></code></pre></div><blockquote><p>Làm mới chỉ mục <code>my_logs</code> mỗi 30 giây.</p></blockquote><p><code>refresh_interval</code> có thể được cập nhật động trên các chỉ mục hiện có. Trong môi trường sản xuất, khi bạn đang xây dựng một chỉ mục mới lớn, bạn có thể tắt làm mới tự động trước, sau đó bật lại khi bắt đầu sử dụng chỉ mục đó:</p><div class="language-" data-ext="" data-title=""><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span>PUT /my_logs/_settings</span></span>
<span class="line"><span>{ &quot;refresh_interval&quot;: -1 }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>PUT /my_logs/_settings</span></span>
<span class="line"><span>{ &quot;refresh_interval&quot;: &quot;1s&quot; }</span></span></code></pre></div><ul><li>Tắt làm mới tự động.</li><li>Tự động làm mới mỗi giây.</li></ul><blockquote><p><code>refresh_interval</code> cần một giá trị <em>khoảng thời gian</em>, ví dụ <code>1s</code> (1 giây) hoặc <code>2m</code> (2 phút). Một giá trị tuyệt đối <em>1</em> biểu thị <em>1 millisecond</em> - chắc chắn sẽ làm cho cụm của bạn trở nên tê liệt.</p></blockquote><h3 id="luu-tru-thay-đoi" tabindex="-1"><a class="header-anchor" href="#luu-tru-thay-đoi"><span>Lưu trữ thay đổi</span></a></h3><p>Nếu không sử dụng <code>fsync</code> để đẩy dữ liệu từ bộ đệm hệ thống tệp lên ổ đĩa, chúng ta không thể đảm bảo dữ liệu sẽ vẫn còn sau khi mất điện hoặc thậm chí là khi chương trình thoát bình thường. Để đảm bảo tính đáng tin cậy của Elasticsearch, chúng ta cần đảm bảo rằng thay đổi dữ liệu được lưu trữ trên ổ đĩa.</p><p>Trong <a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/dynamic-indices.html" target="_blank" rel="noopener noreferrer">Cập nhật chỉ mục động</a>, chúng ta đã nói rằng một lần commit hoàn chỉnh sẽ đẩy shard lên ổ đĩa và viết một điểm commit chứa danh sách tất cả các shard. Elasticsearch sử dụng điểm commit này khi khởi động hoặc mở lại một chỉ mục để xác định shard nào thuộc về shard hiện tại.</p><p>Mặc dù đã thực hiện tìm kiếm gần thời gian thực thông qua làm mới mỗi giây, chúng ta vẫn cần thực hiện commit hoàn chỉnh thường xuyên để đảm bảo có thể phục hồi từ lỗi. Nhưng về những tài liệu đã thay đổi giữa hai lần commit thì sao? Chúng ta cũng không muốn mất những dữ liệu này.</p><p>Elasticsearch đã thêm một <em>translog</em>, hoặc gọi là nhật ký giao dịch, ghi lại mọi thao tác được thực hiện trên Elasticsearch. Với translog, toàn bộ quá trình như sau:</p><p>Sau khi một tài liệu được lập chỉ mục, nó sẽ được thêm vào bộ đệm trong bộ nhớ, <em>và</em> được thêm vào translog, như mô tả trong <a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/translog.html#img-xlog-pre-refresh" target="_blank" rel="noopener noreferrer">Hình 21, &quot;Tài liệu mới được thêm vào bộ đệm trong bộ nhớ và được thêm vào nhật ký giao dịch&quot;</a>.</p><p><strong>Hình 21. Tài liệu mới được thêm vào bộ đệm trong bộ nhớ và được thêm vào nhật ký giao dịch</strong></p><figure><img src="https://raw.githubusercontent.com/vanhung4499/images/master/snap/elas_1106.png" alt="Tài liệu mới được thêm vào bộ đệm trong bộ nhớ và được thêm vào nhật ký giao dịch" tabindex="0" loading="lazy"><figcaption>Tài liệu mới được thêm vào bộ đệm trong bộ nhớ và được thêm vào nhật ký giao dịch</figcaption></figure><p>Việc làm mới (refresh) đưa shard vào trạng thái mô tả trong <a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/translog.html#img-xlog-post-refresh" target="_blank" rel="noopener noreferrer">Hình 22, &quot;Sau khi làm mới, bộ đệm được xóa nhưng nhật ký giao dịch không&quot;</a>, shard được làm mới mỗi giây:</p><ul><li>Tất cả tài liệu trong bộ đệm được viết vào một shard mới, không có thao tác <code>fsync</code>.</li><li>shard được mở, cho phép tìm kiếm.</li><li>Bộ đệm được xóa sạch.</li></ul><p><strong>Hình 22. Sau khi làm mới, bộ đệm được xóa nhưng nhật ký giao dịch không</strong></p><figure><img src="https://raw.githubusercontent.com/vanhung4499/images/master/snap/elas_1107.png" alt="Sau khi làm mới, bộ đệm được xóa nhưng nhật ký giao dịch không" tabindex="0" loading="lazy"><figcaption>Sau khi làm mới, bộ đệm được xóa nhưng nhật ký giao dịch không</figcaption></figure><p>Quy trình này tiếp tục, thêm nhiều tài liệu hơn vào bộ đệm và thêm vào nhật ký giao dịch (xem <a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/translog.html#img-xlog-pre-flush" target="_blank" rel="noopener noreferrer">Hình 23, &quot;Nhật ký giao dịch tiếp tục tích lũy tài liệu&quot;</a>).</p><p><strong>Hình 23. Nhật ký giao dịch tiếp tục tích lũy tài liệu</strong></p><figure><img src="https://raw.githubusercontent.com/vanhung4499/images/master/snap/elas_1108.png" alt="Nhật ký giao dịch tiếp tục tích lũy tài liệu" tabindex="0" loading="lazy"><figcaption>Nhật ký giao dịch tiếp tục tích lũy tài liệu</figcaption></figure><ol><li>Mỗi khoảng thời gian - ví dụ như khi translog trở nên rất lớn - chỉ mục được làm mới (flush); một translog mới được tạo và một lần commit hoàn chỉnh được thực hiện (xem <a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/translog.html#img-xlog-post-flush" target="_blank" rel="noopener noreferrer">Hình 24, &quot;Sau khi làm mới, shard được commit hoàn chỉnh và nhật ký giao dịch được xóa sạch&quot;</a>): <ul><li>Tất cả tài liệu trong bộ đệm được viết vào một shard mới.</li><li>Bộ đệm được xóa sạch.</li><li>Một điểm commit được viết vào ổ đĩa.</li><li>Bộ đệm hệ thống tệp được làm mới (flush) thông qua <code>fsync</code>.</li><li>Nhật ký giao dịch cũ được xóa.</li></ul></li></ol><p>Translog cung cấp một bản ghi vĩnh viễn cho tất cả các thao tác chưa được đẩy lên ổ đĩa. Khi Elasticsearch khởi động, nó sẽ sử dụng điểm commit cuối cùng từ ổ đĩa để khôi phục các shard đã biết và sẽ chơi lại tất cả các thao tác thay đổi trong translog sau lần commit cuối cùng.</p><p>Translog cũng được sử dụng để cung cấp CRUD thời gian thực. Khi bạn cố gắng truy vấn, cập nhật, xóa một tài liệu theo ID, nó sẽ kiểm tra bất kỳ thay đổi gần đây nào trong translog trước khi cố gắng lấy từ các shard tương ứng. Điều này có nghĩa là nó luôn có thể lấy được phiên bản mới nhất của tài liệu một cách thời gian thực.</p><p><strong>Hình 24. Sau khi làm mới, shard được commit hoàn chỉnh và nhật ký giao dịch được xóa sạch</strong></p><figure><img src="https://raw.githubusercontent.com/vanhung4499/images/master/snap/elas_1109.png" alt="Sau khi làm mới, shard được commit hoàn chỉnh và nhật ký giao dịch được xóa sạch" tabindex="0" loading="lazy"><figcaption>Sau khi làm mới, shard được commit hoàn chỉnh và nhật ký giao dịch được xóa sạch</figcaption></figure><h3 id="flush-api" tabindex="-1"><a class="header-anchor" href="#flush-api"><span>flush API</span></a></h3><p>Hành động thực hiện một commit và cắt translog tại Elasticsearch được gọi là một <em>flush</em>. Mỗi 30 phút, một shard sẽ được tự động flush, hoặc khi translog trở nên quá lớn. Hãy xem <a href="https://www.elastic.co/guide/en/elasticsearch/reference/2.4/index-modules-translog.html#_translog_settings" target="_blank" rel="noopener noreferrer">tài liệu <code>translog</code></a> để thiết lập, nó có thể được sử dụng để kiểm soát các ngưỡng này:</p><p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.6/indices-flush.html" target="_blank" rel="noopener noreferrer"><code>flush</code> API</a> có thể được sử dụng để thực hiện một flush thủ công:</p><div class="language-" data-ext="" data-title=""><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span>POST /blogs/_flush</span></span>
<span class="line"><span>POST /_flush?wait_for_ongoing</span></span></code></pre></div><ul><li>Flush chỉ mục blogs.</li><li>Flush tất cả các chỉ mục và chờ tất cả các flush hoàn thành trước khi trả về.</li></ul><p>Bạn ít khi cần thực hiện <code>flush</code> thủ công; thường thì flush tự động là đủ.</p><p>Tuy nhiên, thực hiện <a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/translog.html#flush-api" target="_blank" rel="noopener noreferrer">flush</a> trước khi khởi động lại nút hoặc đóng chỉ mục có lợi cho chỉ mục của bạn. Khi Elasticsearch cố gắng khôi phục hoặc mở lại một chỉ mục, nó cần phải chơi lại tất cả các hoạt động trong translog, vì vậy nếu log càng ngắn, thì khôi phục càng nhanh.</p><blockquote><p>Mục đích của translog là đảm bảo không có hoạt động nào bị mất. Điều này đặt ra câu hỏi: Translog an toàn đến mức nào?</p><p>Các tệp được ghi trước khi được <code>fsync</code> lên ổ đĩa sẽ bị mất sau khi khởi động lại. Mặc định, translog được <code>fsync</code> lên ổ cứng mỗi 5 giây, hoặc sau mỗi yêu cầu ghi hoàn tất (ví dụ: index, delete, update, bulk). Quá trình này xảy ra trên cả shard chính và shard sao chép. Cuối cùng, cơ bản là, trước khi yêu cầu hoàn toàn được <code>fsync</code> lên translog của shard chính và sao chép, client của bạn sẽ không nhận được phản hồi 200 OK.</p><p>Việc thực hiện một fsync sau mỗi yêu cầu sẽ dẫn đến một số mất mát hiệu suất, mặc dù thực tế cho thấy mất mát này tương đối nhỏ (đặc biệt là khi nhập bulk, nơi mà chi phí của một lượng lớn tài liệu được phân phối trong một yêu cầu).</p><p>Tuy nhiên, đối với một số cụm có dung lượng lớn, việc mất đi một số dữ liệu trong vài giây cũng không quá nghiêm trọng, việc sử dụng fsync không đồng bộ có thể rất hữu ích. Ví dụ, dữ liệu được ghi được lưu trữ trong bộ nhớ cache, sau đó <code>fsync</code> mỗi 5 giây.</p><p>Hành vi này có thể được kích hoạt bằng cách đặt tham số <code>durability</code> thành <code>async</code>:</p><div class="language-js" data-ext="js" data-title="js"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#E5C07B;--shiki-dark:#E5C07B;">PUT</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> /</span><span style="color:#E06C75;--shiki-dark:#E06C75;">my_index</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">_settings</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    &quot;index.translog.durability&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;async&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    &quot;index.translog.sync_interval&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;5s&quot;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">}</span></span></code></pre></div><p>Tùy chọn này có thể được đặt riêng lẻ cho mỗi chỉ mục và có thể được thay đổi một cách động. Nếu bạn quyết định sử dụng translog không đồng bộ, bạn cần <em>đảm bảo</em> rằng, trong trường hợp xảy ra lỗi, việc mất dữ liệu trong khoảng thời gian <code>sync_interval</code> là không quan trọng. Hãy hiểu rõ tính năng này trước khi quyết định.</p><p>Nếu bạn không chắc chắn về hậu quả của hành vi này, tốt nhất là sử dụng tham số mặc định (<code>&quot;index.translog.durability&quot;: &quot;request&quot;</code>) để tránh mất dữ liệu.</p></blockquote><h3 id="shard-hop-nhat" tabindex="-1"><a class="header-anchor" href="#shard-hop-nhat"><span>shard hợp nhất</span></a></h3><p>Do quá trình làm mới tự động tạo ra một shard mới mỗi giây, số lượng shard trong một khoảng thời gian ngắn có thể tăng lên rất nhanh. Tuy nhiên, nếu có quá nhiều shard, điều này có thể gây ra rắc rối. Mỗi shard sẽ tiêu tốn cơ sở dữ liệu tệp, bộ nhớ và chu kỳ CPU. Điều quan trọng hơn là mỗi yêu cầu tìm kiếm phải kiểm tra từng shard; vì vậy, càng nhiều shard, tìm kiếm càng chậm.</p><p>Elasticsearch giải quyết vấn đề này bằng cách thực hiện shard hợp nhất ở phía sau. Các shard nhỏ được hợp nhất thành các shard lớn hơn, sau đó các shard lớn hơn này lại được hợp nhất thành các shard còn lớn hơn.</p><p>Trong quá trình hợp nhất shard, những tài liệu đã xóa cũ (hoặc các phiên bản cũ của tài liệu đã được cập nhật) sẽ được loại bỏ khỏi hệ thống tệp. Các tài liệu đã bị xóa (hoặc các phiên bản cũ của tài liệu đã được cập nhật) sẽ không được sao chép vào shard lớn mới.</p><p>Không cần phải thực hiện bất kỳ hành động nào để kích hoạt hợp nhất shard. Nó sẽ tự động thực hiện khi bạn đang tiến hành chỉ mục và tìm kiếm. Quá trình này hoạt động như mô tả trong <a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/merge-process.html#img-merge" target="_blank" rel="noopener noreferrer">Hình 25, &quot;Hai shard đã commit và một shard chưa commit đang được hợp nhất thành một shard lớn hơn&quot;</a>:</p><ol><li>Khi đang chỉ mục, quá trình làm mới sẽ tạo ra shard mới và mở shard để tìm kiếm.</li><li>Quá trình hợp nhất chọn một số lượng nhỏ các shard có kích thước tương tự và hợp nhất chúng thành một shard lớn hơn ở phía sau. Điều này không làm gián đoạn việc chỉ mục và tìm kiếm.</li></ol><p><strong>Hình 25. Hai shard đã commit và một shard chưa commit đang được hợp nhất thành một shard lớn hơn</strong></p><figure><img src="https://raw.githubusercontent.com/vanhung4499/images/master/snap/elas_1110.png" alt="Hai shard đã commit và một shard chưa commit đang được hợp nhất thành một shard lớn hơn" tabindex="0" loading="lazy"><figcaption>Hai shard đã commit và một shard chưa commit đang được hợp nhất thành một shard lớn hơn</figcaption></figure><p><a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/merge-process.html#img-post-merge" target="_blank" rel="noopener noreferrer">Hình 26, &quot;Một khi quá trình hợp nhất hoàn tất, các shard cũ sẽ bị xóa&quot;</a> mô tả hoạt động khi quá trình hợp nhất hoàn tất:</p><ul><li>shard mới được làm mới (flush) lên ổ đĩa. ** Viết một điểm commit mới chứa shard mới và loại bỏ các shard cũ và nhỏ hơn.</li><li>shard mới được mở để tìm kiếm.</li><li>Các shard cũ bị xóa.</li></ul><p>Hợp nhất shard lớn cần tiêu tốn rất nhiều tài nguyên I/O và CPU, nếu để mặc sẽ ảnh hưởng đến hiệu suất tìm kiếm. Elasticsearch mặc định sẽ hạn chế tài nguyên cho quá trình hợp nhất, vì vậy tìm kiếm vẫn có đủ tài nguyên để thực hiện tốt.</p><h3 id="optimize-api" tabindex="-1"><a class="header-anchor" href="#optimize-api"><span>optimize API</span></a></h3><p><code>optimize</code> API có thể coi là <em>hợp nhất cưỡng bức</em> API. Nó sẽ hợp nhất một shard thành số lượng shard mà tham số <code>max_num_segments</code> chỉ định. Mục đích là giảm số lượng shard (thường giảm xuống còn một) để cải thiện hiệu suất tìm kiếm.</p><blockquote><p><code>optimize</code> API <em>không nên</em> được sử dụng trên một chỉ mục đang hoạt động - một chỉ mục đang được cập nhật một cách tích cực. Quá trình hợp nhất nền tảng đã làm việc rất tốt. Optimize sẽ cản trở quá trình này. Đừng can thiệp vào nó!</p></blockquote><p>Trong một số trường hợp cụ thể, việc sử dụng <code>optimize</code> API rất hữu ích. Ví dụ, trong trường hợp nhật ký, các nhật ký hàng ngày, hàng tuần, hàng tháng được lưu trữ trong một chỉ mục. Các chỉ mục cũ về cơ bản là chỉ đọc; chúng không có khả năng thay đổi nhiều.</p><p>Trong trường hợp này, việc sử dụng optimize để tối ưu các chỉ mục cũ, hợp nhất mỗi shard thành một shard đơn lẻ rất hữu ích; điều này không chỉ tiết kiệm tài nguyên mà còn làm cho việc tìm kiếm nhanh hơn:</p><div class="language-bash" data-ext="bash" data-title="bash"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">POST</span><span style="color:#98C379;--shiki-dark:#98C379;"> /logstash-2014-10/_optimize?max_num_segments=</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span></span></code></pre></div><p>Hợp nhất mỗi shard trong chỉ mục thành một shard đơn lẻ</p><blockquote><p>Xin lưu ý, việc kích hoạt hợp nhất shard bằng <code>optimize</code> API sẽ không bị giới hạn bởi bất kỳ tài nguyên nào. Điều này có thể tiêu thụ toàn bộ tài nguyên I/O của nút của bạn, không còn đủ nguồn lực để xử lý các yêu cầu tìm kiếm, do đó có thể khiến cụm không phản hồi. Nếu bạn muốn <code>optimize</code> một chỉ mục, bạn cần di chuyển chỉ mục đến một nút an toàn trước bằng cách sử dụng phân phối shard (xem <a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/retiring-data.html#migrate-indices" target="_blank" rel="noopener noreferrer">Di chuyển chỉ mục cũ</a>), sau đó thực hiện.</p></blockquote><h2 id="tai-lieu-tham-khao" tabindex="-1"><a class="header-anchor" href="#tai-lieu-tham-khao"><span>Tài liệu tham khảo</span></a></h2><ul><li><a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/distributed-cluster.html" target="_blank" rel="noopener noreferrer">Elasticsearch Hướng dẫn chính thức - Nguyên lý trong cụm</a></li></ul></div><!----><footer class="vp-page-meta"><div class="vp-meta-item edit-link"><a class="auto-link external-link vp-meta-label" href="https://github.com/vanhung4499/my-wiki/edit/main/src/database/elasticsearch/cluster-shard.md" aria-label="Edit this page on GitHub" rel="noopener noreferrer" target="_blank"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon" name="edit"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->Edit this page on GitHub<!----></a></div><div class="vp-meta-item git-info"><div class="update-time"><span class="vp-meta-label">Last update: </span><!----></div><div class="contributors"><span class="vp-meta-label">Contributors: </span><!--[--><!--[--><span class="vp-meta-info" title="email: vanhung4499@gmail.com">Hung Nguyen Van</span><!--]--><!--]--></div></div></footer><nav class="vp-page-nav"><a class="route-link auto-link prev" href="/database/elasticsearch/rest-api.html" aria-label="Elasticsearch REST API"><div class="hint"><span class="arrow start"></span>Prev</div><div class="link"><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:elasticsearch" width="1em" height="1em"></iconify-icon>Elasticsearch REST API</div></a><a class="route-link auto-link next" href="/database/elasticsearch/operation.html" aria-label="Elasticsearch Operation"><div class="hint">Next<span class="arrow end"></span></div><div class="link">Elasticsearch Operation<iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:elasticsearch" width="1em" height="1em"></iconify-icon></div></a></nav><!----><!----><!--]--></main><!--]--><footer class="footer-wrapper" style="display:none;--1ea755b8:;"><div class="footer-content"><div class="footer">Made with ❤️ by Hung Nguyen</div><div class="copyright">Copyright © 2016-2024 Hung Nguyen</div></div><span id="runtime_span"></span></footer></div><!--]--><!--[--><!----><!----><!----><!----><!--]--><!--]--></div>
    <script type="module" src="/assets/app-B9pwkC50.js" defer></script>
  </body>
</html>
