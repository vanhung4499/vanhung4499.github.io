<!doctype html>
<html lang="en-US" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.15" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.52" />
    <style>
      html {
        background: var(--bg-color, #fff);
      }

      html[data-theme="dark"] {
        background: var(--bg-color, #1d1e1f);
      }

      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <meta property="og:url" content="https://vanhung4499.github.io/programming/java/JVM/JVM%20Memory%20Managment.html"><meta property="og:site_name" content="VanHung4499"><meta property="og:title" content="JVM Memory Managment"><meta property="og:description" content="Quản lý bộ nhớ trong JVM Giới thiệu về bộ nhớ Bộ nhớ vật lý và bộ nhớ ảo Bộ nhớ vật lý là RAM (Random Access Memory) mà chúng ta thường nói đến. Bộ nhớ ảo cho phép nhiều tiến tr..."><meta property="og:type" content="article"><meta property="og:image" content="https://raw.githubusercontent.com/vanhung4499/images/master/snap/JVM-memory-runtime-area.png"><meta property="og:locale" content="en-US"><meta property="og:updated_time" content="2024-07-04T09:37:15.000Z"><meta property="article:author" content="Hung Nguyen"><meta property="article:tag" content="java"><meta property="article:tag" content="javase"><meta property="article:tag" content="jvm"><meta property="article:modified_time" content="2024-07-04T09:37:15.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"JVM Memory Managment","image":["https://raw.githubusercontent.com/vanhung4499/images/master/snap/JVM-memory-runtime-area.png","https://raw.githubusercontent.com/vanhung4499/images/master/snap/20230718105750.png","https://raw.githubusercontent.com/vanhung4499/images/master/snap/20230718110417.png","https://raw.githubusercontent.com/vanhung4499/images/master/snap/20230718110822.png","https://raw.githubusercontent.com/vanhung4499/images/master/snap/20230718134850.png","https://raw.githubusercontent.com/vanhung4499/images/master/snap/jvm-process-4.png","https://raw.githubusercontent.com/vanhung4499/images/master/snap/jvm-process-5.png","https://raw.githubusercontent.com/vanhung4499/images/master/snap/jvm-process-6.png"],"dateModified":"2024-07-04T09:37:15.000Z","author":[{"@type":"Person","name":"Hung Nguyen","url":"https://vanhung4499.github.io"}]}</script><meta name="referrer" content="no-referrer-when-downgrade"><link rel="alternate" type="application/rss+xml" href="https://vanhung4499.github.io/rss.xml" title="VanHung4499 RSS Feed"><title>JVM Memory Managment | VanHung4499</title><meta name="description" content="Quản lý bộ nhớ trong JVM Giới thiệu về bộ nhớ Bộ nhớ vật lý và bộ nhớ ảo Bộ nhớ vật lý là RAM (Random Access Memory) mà chúng ta thường nói đến. Bộ nhớ ảo cho phép nhiều tiến tr...">
    <link rel="preload" href="/assets/style-DFXXOFfS.css" as="style"><link rel="stylesheet" href="/assets/style-DFXXOFfS.css">
    <link rel="modulepreload" href="/assets/app-CmlOSuIY.js"><link rel="modulepreload" href="/assets/JVM Memory Managment.html-vjKppeNs.js">
    
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">Skip to main content</a><!--]--><div class="theme-container external-link-icon has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!----><!--[--><a class="route-link vp-brand" href="/"><img class="vp-nav-logo" src="/logo.svg" alt><!----><span class="vp-site-name hide-in-pad">VanHung4499</span></a><!--]--><!----></div><div class="vp-navbar-center"><!----><!--[--><nav class="vp-nav-links"><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/" aria-label="Home"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="mdi:home" width="1em" height="1em"></iconify-icon><!--]-->Home<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/wiki.html" aria-label="Wiki"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="carbon:wikis" width="1em" height="1em"></iconify-icon><!--]-->Wiki<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/dsa/" aria-label="Algorithms"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="hugeicons:algorithm" width="1em" height="1em"></iconify-icon><!--]-->Algorithms<!----></a></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="Programming"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="mdi:code" width="1em" height="1em"></iconify-icon>Programming<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link route-link-active auto-link" href="/programming/java/" aria-label="Java"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:java" width="1em" height="1em"></iconify-icon><!--]-->Java<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/programming/golang/" aria-label="Golang"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:go" width="1em" height="1em"></iconify-icon><!--]-->Golang<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/programming/js/" aria-label="JavaScript"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:javascript" width="1em" height="1em"></iconify-icon><!--]-->JavaScript<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/programming/ts/" aria-label="TypeScript"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:typescript" width="1em" height="1em"></iconify-icon><!--]-->TypeScript<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/programming/python/" aria-label="Python"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:python" width="1em" height="1em"></iconify-icon><!--]-->Python<!----></a></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="Database"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="mdi:database" width="1em" height="1em"></iconify-icon>Database<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/database/sql/" aria-label="SQL"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="mdi:sql-query" width="1em" height="1em"></iconify-icon><!--]-->SQL<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/database/mysql/" aria-label="MySQL"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:mysql" width="1em" height="1em"></iconify-icon><!--]-->MySQL<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/database/mongodb/" aria-label="MongoDB"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:mongodb" width="1em" height="1em"></iconify-icon><!--]-->MongoDB<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/database/redis/" aria-label="Redis"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:redis" width="1em" height="1em"></iconify-icon><!--]-->Redis<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/database/elasticsearch/" aria-label="Elasticsearch"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:elasticsearch" width="1em" height="1em"></iconify-icon><!--]-->Elasticsearch<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/database/elastic/" aria-label="Elastic Stack"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="cib:elastic-stack" width="1em" height="1em"></iconify-icon><!--]-->Elastic Stack<!----></a></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="Framework"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="simple-icons:framework" width="1em" height="1em"></iconify-icon>Framework<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/framework/spring/" aria-label="Spring"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:spring" width="1em" height="1em"></iconify-icon><!--]-->Spring<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/framework/spring-boot/" aria-label="Spring Boot"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:spring" width="1em" height="1em"></iconify-icon><!--]-->Spring Boot<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/framework/nestjs/" aria-label="NestJS"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:nestjs" width="1em" height="1em"></iconify-icon><!--]-->NestJS<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/framework/gin/" aria-label="Gin"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="logos:gin" width="1em" height="1em"></iconify-icon><!--]-->Gin<!----></a></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="DevOps"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon-plain:azuredevops" width="1em" height="1em"></iconify-icon>DevOps<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/devops/docker/" aria-label="Docker"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:docker" width="1em" height="1em"></iconify-icon><!--]-->Docker<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/devops/kubernetes/" aria-label="Kubernetes"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:kubernetes" width="1em" height="1em"></iconify-icon><!--]-->Kubernetes<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/devops/jenkins/" aria-label="Jenkins"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:jenkins" width="1em" height="1em"></iconify-icon><!--]-->Jenkins<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/devops/git/" aria-label="Git"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:git" width="1em" height="1em"></iconify-icon><!--]-->Git<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/devops/linux/" aria-label="Linux"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:linux" width="1em" height="1em"></iconify-icon><!--]-->Linux<!----></a></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="Design"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="tdesign:system-sum" width="1em" height="1em"></iconify-icon>Design<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/design/design-pattern/" aria-label="Design Pattern"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="tabler:grid-pattern" width="1em" height="1em"></iconify-icon><!--]-->Design Pattern<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/design/system-design/" aria-label="System Design"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="icon-park-outline:system" width="1em" height="1em"></iconify-icon><!--]-->System Design<!----></a></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="Project"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="ant-design:project-outlined" width="1em" height="1em"></iconify-icon>Project<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/project/rouyi-vue-pro/" aria-label="Rouyi Vue Pro"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:spring" width="1em" height="1em"></iconify-icon><!--]-->Rouyi Vue Pro<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/project/yudao-cloud/" aria-label="Yudao Cloud"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:spring" width="1em" height="1em"></iconify-icon><!--]-->Yudao Cloud<!----></a></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/interview/" aria-label="Interview"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="mdi:account-tie" width="1em" height="1em"></iconify-icon><!--]-->Interview<!----></a></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="About"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="mdi:about" width="1em" height="1em"></iconify-icon>About<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/about-me.html" aria-label="About me"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="cib:about-me" width="1em" height="1em"></iconify-icon><!--]-->About me<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/about.html" aria-label="About"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="mdi:about" width="1em" height="1em"></iconify-icon><!--]-->About<!----></a></li></ul></button></div></div></nav><!--]--><!----></div><div class="vp-navbar-end"><!----><!--[--><!----><div class="vp-nav-item vp-action"><a class="vp-action-link" href="https://github.com/vanhung4499/my-wiki" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" name="github" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="vp-nav-item hide-in-mobile"><button type="button" class="vp-outlook-button" tabindex="-1" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon outlook-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="outlook icon" name="outlook"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4 38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32 51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0 102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2 6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4 0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2 9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224 419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4 470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0 22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6 12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128 505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2 16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8 86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4 80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6 6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg><div class="vp-outlook-dropdown"><!----></div></button></div><!--[--><button type="button" class="search-pro-button" aria-label="Search"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon" name="search"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="search-pro-placeholder">Search</div><div class="search-pro-key-hints"><kbd class="search-pro-key">Ctrl</kbd><kbd class="search-pro-key">K</kbd></div></button><!--]--><!--]--><!----><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!----><ul class="vp-sidebar-links"><li><a class="route-link auto-link vp-sidebar-link" href="/programming/java/" aria-label="Java"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:java" width="1em" height="1em"></iconify-icon><!--]-->Java<!----></a></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Basic</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Array</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">String</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">OOP</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Extra</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Collection</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Common Tools</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">IO</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Exception</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">New Features</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">NIO</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Advanced</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Concurrency</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable active" type="button"><!----><span class="vp-sidebar-title">JVM</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><a class="route-link auto-link vp-sidebar-link" href="/programming/java/JVM/Java%20Bytecode.html" aria-label="Java Bytecode"><!---->Java Bytecode<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/programming/java/JVM/JVM%20Architecture.html" aria-label="JVM Architecture"><!---->JVM Architecture<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/programming/java/JVM/JVM%20Class%20Loader.html" aria-label="JVM Class Loader"><!---->JVM Class Loader<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/programming/java/JVM/JVM%20Command%20Line%20Tools.html" aria-label="JVM Command Line Tools"><!---->JVM Command Line Tools<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/programming/java/JVM/JVM%20Garbage%20Collection.html" aria-label="JVM Garbage Collection"><!---->JVM Garbage Collection<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/programming/java/JVM/JVM%20GUI%20Tools.html" aria-label="JVM GUI Tools"><!---->JVM GUI Tools<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/programming/java/JVM/JVM%20In%20Action.html" aria-label="JVM In Action"><!---->JVM In Action<!----></a></li><li><a class="route-link route-link-active auto-link vp-sidebar-link active" href="/programming/java/JVM/JVM%20Memory%20Managment.html" aria-label="JVM Memory Managment"><!---->JVM Memory Managment<!----></a></li></ul></section></li></ul><!----></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->JVM Memory Managment</h1><div class="page-info"><span class="page-author-info" aria-label="Author🖊" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon" name="author"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="page-author-item" href="https://vanhung4499.github.io" target="_blank" rel="noopener noreferrer">Hung Nguyen</a></span><span property="author" content="Hung Nguyen"></span></span><!----><span class="page-date-info" aria-label="Writing Date📅" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon" name="calendar"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2024-06-28T15:54:38.000Z"></span><!----><span class="page-reading-time-info" aria-label="Reading Time⌛" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon" name="timer"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>About 28 min</span><meta property="timeRequired" content="PT28M"></span><span class="page-category-info" aria-label="Category🌈" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon" name="category"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><!--[--><span class="page-category-item color8 clickable" role="navigation">java</span><span class="page-category-item color1 clickable" role="navigation">javase</span><span class="page-category-item color5 clickable" role="navigation">jvm</span><!--]--><meta property="articleSection" content="java,javase,jvm"></span><span class="page-tag-info" aria-label="Tag🏷" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon" name="tag"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><!--[--><span class="page-tag-item color8 clickable" role="navigation">java</span><span class="page-tag-item color1 clickable" role="navigation">javase</span><span class="page-tag-item color5 clickable" role="navigation">jvm</span><!--]--><meta property="keywords" content="java,javase,jvm"></span></div><hr></div><div class="vp-toc-placeholder"><aside id="toc"><!----><div class="vp-toc-header">On This Page<button type="button" class="print-button" title="Print"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon" name="print"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button><div class="arrow end"></div></div><div class="vp-toc-wrapper"><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#gioi-thieu-ve-bo-nho">Giới thiệu về bộ nhớ</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#bo-nho-vat-ly-va-bo-nho-ao">Bộ nhớ vật lý và bộ nhớ ảo</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#khong-gian-kernel-va-khong-gian-nguoi-dung">Không gian kernel và không gian người dùng</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#cac-thanh-phan-java-su-dung-bo-nho">Các thành phần Java sử dụng bộ nhớ</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#cac-khu-vuc-du-lieu-thoi-gian-chay">Các khu vực dữ liệu thời gian chạy</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#bo-đem-chuong-trinh">Bộ đếm chương trình</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#jvm-stack">JVM Stack</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ngan-xep-phuong-thuc-native">Ngăn xếp phương thức Native</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#java-heap">Java Heap</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#khu-vuc-phuong-thuc">Khu vực phương thức</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#bang-hang-so-thoi-gian-chay">Bảng hằng số thời gian chạy</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#bo-nho-truc-tiep">Bộ nhớ trực tiếp</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#so-sanh-cac-khu-vuc-bo-nho-trong-java">So sánh các khu vực bộ nhớ trong Java</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#nguyen-ly-hoat-đong-cua-jvm">Nguyên lý hoạt động của JVM</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#outofmemoryerror">OutOfMemoryError</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#outofmemoryerror-la-gi">OutOfMemoryError là gì</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#tran-bo-nho-heap">Tràn bộ nhớ Heap</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#chi-phi-gc-vuot-qua-gioi-han">Chi phí GC vượt quá giới hạn</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#khong-đu-khong-gian-permgen">Không đủ không gian PermGen</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#khong-đu-khong-gian-metaspace">Không đủ không gian Metaspace</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#khong-the-tao-luong-native-moi">Không thể tạo luồng native mới</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#tran-bo-nho-truc-tiep">Tràn bộ nhớ trực tiếp</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#stackoverflowerror">StackOverflowError</a></li><!----><!--]--></ul><div class="vp-toc-marker" style="top:-1.7rem;"></div></div><!----></aside></div><!----><div class="theme-hope-content"><h1 id="quan-ly-bo-nho-trong-jvm" tabindex="-1"><a class="header-anchor" href="#quan-ly-bo-nho-trong-jvm"><span>Quản lý bộ nhớ trong JVM</span></a></h1><h2 id="gioi-thieu-ve-bo-nho" tabindex="-1"><a class="header-anchor" href="#gioi-thieu-ve-bo-nho"><span>Giới thiệu về bộ nhớ</span></a></h2><h3 id="bo-nho-vat-ly-va-bo-nho-ao" tabindex="-1"><a class="header-anchor" href="#bo-nho-vat-ly-va-bo-nho-ao"><span>Bộ nhớ vật lý và bộ nhớ ảo</span></a></h3><p>Bộ nhớ vật lý là RAM (Random Access Memory) mà chúng ta thường nói đến.</p><p>Bộ nhớ ảo cho phép nhiều tiến trình chạy đồng thời có thể chia sẻ bộ nhớ vật lý, tuy nhiên, việc chia sẻ chỉ diễn ra trên mặt không gian, các tiến trình vẫn được cô lập logic với nhau.</p><h3 id="khong-gian-kernel-va-khong-gian-nguoi-dung" tabindex="-1"><a class="header-anchor" href="#khong-gian-kernel-va-khong-gian-nguoi-dung"><span>Không gian kernel và không gian người dùng</span></a></h3><p>Một máy tính thông thường thường có một không gian bộ nhớ cố định, nhưng các chương trình không thể sử dụng toàn bộ không gian này. Vì không gian này được chia thành không gian kernel và không gian người dùng, và các chương trình chỉ có thể sử dụng bộ nhớ trong không gian người dùng.</p><h3 id="cac-thanh-phan-java-su-dung-bo-nho" tabindex="-1"><a class="header-anchor" href="#cac-thanh-phan-java-su-dung-bo-nho"><span>Các thành phần Java sử dụng bộ nhớ</span></a></h3><p>Sau khi Java được khởi động, nó chạy như một tiến trình trong hệ điều hành.</p><p>Các thành phần Java nào sử dụng bộ nhớ?</p><ul><li>Bộ nhớ Heap: Java Heap, lớp và trình tải lớp</li><li>Bộ nhớ Stack: luồng</li><li>Bộ nhớ cục bộ: NIO, JNI</li></ul><h2 id="cac-khu-vuc-du-lieu-thoi-gian-chay" tabindex="-1"><a class="header-anchor" href="#cac-khu-vuc-du-lieu-thoi-gian-chay"><span>Các khu vực dữ liệu thời gian chạy</span></a></h2><p>JVM trong quá trình thực thi chương trình Java sẽ chia bộ nhớ mà nó quản lý thành nhiều khu vực dữ liệu khác nhau. Các khu vực này có mục đích và thời gian tạo và hủy khác nhau, một số khu vực tồn tại khi quá trình JVM khởi động, trong khi một số khu vực khác được tạo và hủy bởi các luồng người dùng. Hình sau đây mô tả các khu vực dữ liệu thời gian chạy:</p><figure><img src="https://raw.githubusercontent.com/vanhung4499/images/master/snap/JVM-memory-runtime-area.png" alt="JVM-memory-runtime-area.png" tabindex="0" loading="lazy"><figcaption>JVM-memory-runtime-area.png</figcaption></figure><h3 id="bo-đem-chuong-trinh" tabindex="-1"><a class="header-anchor" href="#bo-đem-chuong-trinh"><span>Bộ đếm chương trình</span></a></h3><p><strong>Bộ đếm chương trình (Program Counter Register)</strong> là một vùng nhớ nhỏ, nó có thể coi là chỉ số dòng lệnh hiện tại đang được thực thi bởi luồng. Ví dụ, các nhánh, vòng lặp, nhảy, ngoại lệ, khôi phục luồng, v.v. đều phụ thuộc vào bộ đếm chương trình.</p><p>Khi số lượng luồng đang chạy vượt quá số lượng CPU, các luồng sẽ cạnh tranh với nhau để lấy tài nguyên CPU theo chu kỳ thời gian. Nếu một luồng hết thời gian, hoặc tài nguyên CPU của nó bị cướp trước khi hoàn thành, luồng này cần một bộ đếm chương trình riêng để ghi lại chỉ thị thực thi tiếp theo, từ đó có thể phục hồi đúng vị trí thực thi sau khi chuyển luồng. Các bộ đếm chương trình giữa các luồng không ảnh hưởng lẫn nhau, chúng được lưu trữ riêng biệt, chúng ta gọi khu vực bộ nhớ này là &quot;riêng tư của luồng&quot;.</p><ul><li>Nếu luồng đang thực thi một phương thức Java, bộ đếm chương trình ghi lại địa chỉ của chỉ thị bytecode đang thực thi;</li><li>Nếu luồng đang thực thi một phương thức Native, giá trị bộ đếm chương trình sẽ không xác định (Undefined).</li></ul><blockquote><p>🔔 Lưu ý: Khu vực này là duy nhất trong JVM mà không có trường hợp <code>OutOfMemoryError</code> nào được xác định.</p></blockquote><h3 id="jvm-stack" tabindex="-1"><a class="header-anchor" href="#jvm-stack"><span>JVM Stack</span></a></h3><p><strong>JVM Stack (Java Virtual Machine Stack)</strong> cũng là riêng tư của luồng và có tuổi thọ bằng với luồng.</p><p>Mỗi phương thức Java được thực thi sẽ tạo ra một khung ngăn xếp (stack frame) thông tin như <strong>bảng biến cục bộ</strong>, <strong>ngăn xếp toán hạng</strong>, <strong>tham chiếu hằng số</strong> và nhiều thông tin khác. Mỗi phương thức từ cuộc gọi đến khi hoàn thành tương ứng với một khung ngăn xếp được thêm vào và loại bỏ khỏi JVM Stack.</p><figure><img src="https://raw.githubusercontent.com/vanhung4499/images/master/snap/20230718105750.png" alt="image.png" tabindex="0" loading="lazy"><figcaption>image.png</figcaption></figure><ul><li><strong>Bảng biến cục bộ</strong> - Dùng để lưu trữ các biến cục bộ, tham chiếu đối tượng, kiểu dữ liệu cơ bản, <code>ReturnAddress</code> và nhiều loại khác.</li><li>**Ngăn xếp toán hạng - Được sử dụng bởi bộ máy thực thi dựa trên ngăn xếp, JVM sử dụng ngăn xếp toán hạng như một không gian làm việc, hầu hết các chỉ thị đều phải lấy dữ liệu từ đây, thực hiện phép tính và đẩy kết quả trở lại ngăn xếp.</li><li><strong>Liên kết động</strong> - Mỗi khung ngăn xếp chứa một tham chiếu đến phương thức mà khung ngăn xếp này thuộc về trong không gian hằng số thời gian chạy (một phần của không gian phương thức). Việc giữ tham chiếu này để hỗ trợ quá trình liên kết động trong quá trình gọi phương thức. Hằng số thời gian chạy của tệp lớp chứa rất nhiều tham chiếu biểu tượng, chỉ thị gọi phương thức trong bytecode sẽ có tham số là tham chiếu biểu tượng trong không gian hằng số. Một số tham chiếu biểu tượng sẽ được chuyển thành tham chiếu trực tiếp trong quá trình tải lớp hoặc khi sử dụng lần đầu tiên, quá trình này được gọi là phân giải tĩnh. Một số tham chiếu sẽ được chuyển thành tham chiếu trực tiếp trong mỗi lần chạy, quá trình này được gọi là liên kết động.</li><li><strong>Điểm thoát khỏi phương thức</strong> - Trả về vị trí phương thức đã được gọi, khôi phục biến cục bộ và ngăn xếp hoạt động của phương thức gọi. Nếu không có giá trị trả về, nó sẽ được đẩy vào ngăn xếp hoạt động của người gọi.</li></ul><blockquote><p>🔔 Lưu ý:</p><p>Khu vực này có thể gây ra các ngoại lệ sau:</p><ul><li>Nếu độ sâu ngăn xếp yêu cầu của luồng vượt quá giá trị tối đa, nó sẽ gây ra ngoại lệ <code>StackOverflowError</code>.</li><li>Nếu không thể mở rộng ngăn xếp Java Virtual Machine, không thể cấp phát đủ bộ nhớ, nó sẽ gây ra ngoại lệ <code>OutOfMemoryError</code>.</li></ul></blockquote><blockquote><p>💡 Mẹo:</p><p>Bạn có thể sử dụng tham số máy ảo <code>-Xss</code> để chỉ định kích thước ngăn xếp Java Virtual Machine của chương trình:</p><div class="language-java" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#abb2bf;--shiki-dark:#abb2bf;--shiki-light-bg:#282c34;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">java </span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;">-</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">Xss</span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">512M </span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">HackTheJava</span></span></code></pre></div></blockquote><h3 id="ngan-xep-phuong-thuc-native" tabindex="-1"><a class="header-anchor" href="#ngan-xep-phuong-thuc-native"><span>Ngăn xếp phương thức Native</span></a></h3><p><strong>Ngăn xếp phương thức Native (Native Method Stack)</strong> có chức năng tương tự như ngăn xếp Java Virtual Machine.</p><p>Sự khác biệt giữa hai ngăn xếp này là: <strong>Ngăn xếp Java Virtual Machine phục vụ cho các phương thức Java, trong khi Ngăn xếp phương thức Native phục vụ cho các phương thức Native</strong>. Phương thức Native không được viết bằng Java, mà được viết bằng ngôn ngữ C.</p><figure><img src="https://raw.githubusercontent.com/vanhung4499/images/master/snap/20230718110417.png" alt="image.png" tabindex="0" loading="lazy"><figcaption>image.png</figcaption></figure><blockquote><p>🔔 Lưu ý: Ngăn xếp phương thức Native cũng có thể gây ra ngoại lệ <code>StackOverflowError</code> và <code>OutOfMemoryError</code>.</p></blockquote><h3 id="java-heap" tabindex="-1"><a class="header-anchor" href="#java-heap"><span>Java Heap</span></a></h3><p><strong>Java Heap</strong> được sử dụng để lưu trữ các đối tượng. Hầu hết các đối tượng trong Java đều được cấp phát bộ nhớ ở đây.</p><p>Java Heap là khu vực chính để thu gom rác (do đó còn được gọi là &quot;GC Heap&quot;). Hầu hết các bộ thu gom rác hiện đại đều sử dụng thuật toán thu gom theo thế hệ, trong đó mỗi đối tượng được xem xét bằng các thuật toán thu gom rác khác nhau.</p><p>Vì vậy, JVM chia Java Heap thành ba phần sau:</p><ul><li><strong>Thế hệ trẻ (Young Generation)</strong><ul><li><code>Eden</code> - Tỷ lệ giữa Eden và Survivor là 8:1</li><li><code>From Survivor</code></li><li><code>To Survivor</code></li></ul></li><li><strong>Thế hệ già (Old Generation)</strong></li><li><strong>Thế hệ vĩnh viễn (Permanent Generation)</strong></li></ul><p>Khi một đối tượng được tạo ra, nó sẽ được đưa vào thế hệ mới, sau đó có thể được chuyển sang thế hệ già. Thế hệ mới chứa nhiều đối tượng có tuổi thọ ngắn, do đó tần suất thu gom rác ở đây cao nhất.</p><figure><img src="https://raw.githubusercontent.com/vanhung4499/images/master/snap/20230718110822.png" alt="image.png" tabindex="0" loading="lazy"><figcaption>image.png</figcaption></figure><blockquote><p>🔔 Lưu ý: Java Heap không yêu cầu bộ nhớ liên tục và có thể mở rộng động, nếu mở rộng không thành công, nó sẽ gây ra ngoại lệ <code>OutOfMemoryError</code>.</p><p>💡 Mẹo: Bạn có thể sử dụng hai tham số máy ảo <code>-Xms</code> và <code>-Xmx</code> để chỉ định kích thước Java Heap của chương trình, tham số đầu tiên đặt giá trị khởi tạo, tham số thứ hai đặt giá trị tối đa.</p><div class="language-java" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#abb2bf;--shiki-dark:#abb2bf;--shiki-light-bg:#282c34;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">java </span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;">-</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">Xms</span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">1M </span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;">-</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">Xmx</span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">2M </span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">HackTheJava</span></span></code></pre></div></blockquote><h3 id="khu-vuc-phuong-thuc" tabindex="-1"><a class="header-anchor" href="#khu-vuc-phuong-thuc"><span>Khu vực phương thức</span></a></h3><p>Khu vực phương thức (Method Area) còn được gọi là vùng vĩnh viễn. <strong>Khu vực phương thức được sử dụng để lưu trữ thông tin lớp đã được tải, hằng số, biến tĩnh, mã đã được biên dịch bởi trình biên dịch JIT và các dữ liệu khác</strong>.</p><p>Mục tiêu chính của việc thu gom rác trong khu vực này là thu gom rác trong bộ nhớ hằng số và gỡ bỏ các lớp không cần thiết, nhưng thường khá khó thực hiện.</p><blockquote><p>🔔 Lưu ý: Giống như Java Heap, khu vực này không yêu cầu bộ nhớ liên tục và có thể mở rộng động, nếu mở rộng không thành công, nó sẽ gây ra ngoại lệ <code>OutOfMemoryError</code>.</p><p>💡 Mẹo:</p><ul><li>Trước JDK 1.7, HotSpot JVM xem khu vực này là vùng vĩnh viễn và thu gom rác. Bạn có thể sử dụng các tham số <code>-XX:PermSize</code> và <code>-XX:MaxPermSize</code> để đặt kích thước.</li><li>Sau JDK 1.8, khu vực vĩnh viễn đã bị loại bỏ và được thay thế bằng <strong><code>metaspace (vùng dữ liệu)</code></strong>. Bạn có thể sử dụng tham số <code>-XX:MaxMetaspaceSize</code> để đặt kích thước.</li></ul></blockquote><h3 id="bang-hang-so-thoi-gian-chay" tabindex="-1"><a class="header-anchor" href="#bang-hang-so-thoi-gian-chay"><span>Bảng hằng số thời gian chạy</span></a></h3><p><strong><code>Bảng hằng số thời gian chạy (Runtime Constant Pool)</code> là một phần của khu vực phương thức</strong> trong không gian phương thức. Trong tệp Class, ngoài thông tin về phiên bản lớp, trường, phương thức, interface, còn có một mục thông tin khác là bảng hằng số (Constant Pool Table), <strong>được sử dụng để lưu trữ các literal và tham chiếu tượng trưng được tạo bởi trình biên dịch</strong>. Nội dung này sẽ được đưa vào khu vực này sau khi lớp được tải.</p><ul><li><strong>Literal</strong> - Chuỗi văn bản, giá trị hằng số được khai báo là <code>final</code>, v.v.</li><li><strong>Tham chiếu tượng trưng</strong> - Tên đầy đủ của lớp và interface (Fully Qualified Name), tên và mô tả của trường (Descriptor), tên và mô tả của phương thức.</li></ul><p>Ngoài các hằng số được tạo ra trong quá trình biên dịch, còn cho phép tạo ra động, ví dụ như <code>intern()</code> của lớp <code>String</code>. Các hằng số này cũng sẽ được đưa vào bảng hằng số thời chạy.</p><blockquote><p>🔔 Lưu ý: Khi không gian hằng số không thể cấp phát thêm bộ nhớ, nó sẽ gây ra ngoại lệ <code>OutOfMemoryError</code>.</p></blockquote><h3 id="bo-nho-truc-tiep" tabindex="-1"><a class="header-anchor" href="#bo-nho-truc-tiep"><span>Bộ nhớ trực tiếp</span></a></h3><p>Bộ nhớ trực tiếp (Direct Memory) không phải là một phần của các khu vực dữ liệu thời gian chạy của JVM và không được định nghĩa trong quy tắc JVM.</p><p>Trong JDK 1.4, NIO được giới thiệu, cho phép sử dụng thư viện hàm Native để cấp phát bộ nhớ ngoài Heap, sau đó sử dụng một đối tượng <code>DirectByteBuffer</code> được lưu trữ trong Java Heap để tham chiếu đến bộ nhớ này và thực hiện các thao tác. Điều này có thể cải thiện đáng kể hiệu suất trong một số tình huống, vì tránh sao chép dữ liệu giữa Java Heap và Native Heap.</p><blockquote><p>🔔 Lưu ý: Bộ nhớ trực tiếp cũng được sử dụng một cách thường xuyên và cũng có thể gây ra ngoại lệ <code>OutOfMemoryError</code>.</p><p>💡 Mẹo: Bạn có thể sử dụng tham số <code>-XX:MaxDirectMemorySize</code> để chỉ định kích thước bộ nhớ trực tiếp. Nếu không chỉ định, nó sẽ mặc định giống với kích thước tối đa của Java Heap (<code>-Xmx</code> đã chỉ định).</p></blockquote><h3 id="so-sanh-cac-khu-vuc-bo-nho-trong-java" tabindex="-1"><a class="header-anchor" href="#so-sanh-cac-khu-vuc-bo-nho-trong-java"><span>So sánh các khu vực bộ nhớ trong Java</span></a></h3><table><thead><tr><th>Khu vực bộ nhớ</th><th>Phạm vi bộ nhớ</th><th>Ngoại lệ</th></tr></thead><tbody><tr><td>Bộ đếm chương trình</td><td>Riêng tư của luồng</td><td>Không có</td></tr><tr><td>Ngăn xếp JVM</td><td>Riêng tư của luồng</td><td><code>StackOverflowError</code> và <code>OutOfMemoryError</code></td></tr><tr><td>Ngăn xếp phương thức Native</td><td>Riêng tư của luồng</td><td><code>StackOverflowError</code> và <code>OutOfMemoryError</code></td></tr><tr><td>Java Heap</td><td>Chia sẻ giữa các luồng</td><td><code>OutOfMemoryError</code></td></tr><tr><td>Khu vực phương thức</td><td>Chia sẻ giữa các luồng</td><td><code>OutOfMemoryError</code></td></tr><tr><td>Bảng hằng số thời gian chạy</td><td>Chia sẻ giữa các luồng</td><td><code>OutOfMemoryError</code></td></tr><tr><td>Bộ nhớ trực tiếp</td><td>Không phải là khu vực dữ liệu thời gian chạy</td><td><code>OutOfMemoryError</code></td></tr></tbody></table><h2 id="nguyen-ly-hoat-đong-cua-jvm" tabindex="-1"><a class="header-anchor" href="#nguyen-ly-hoat-đong-cua-jvm"><span>Nguyên lý hoạt động của JVM</span></a></h2><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#abb2bf;--shiki-dark:#abb2bf;--shiki-light-bg:#282c34;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> JVMCase</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">	// Hằng số</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">	public</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> final</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> static</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> String</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;"> MAN_SEX_TYPE </span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#98C379;--shiki-dark:#98C379;"> &quot;man&quot;</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">	// Biến tĩnh</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">	public</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> static</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> String</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;"> WOMAN_SEX_TYPE </span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#98C379;--shiki-dark:#98C379;"> &quot;woman&quot;</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">	public</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> static</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> main</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">[] </span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">args</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">		Student</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;"> stu</span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> Student</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">		stu</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">setName</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#98C379;--shiki-dark:#98C379;">&quot;nick&quot;</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">		stu</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">setSexType</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(MAN_SEX_TYPE);</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">		stu</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">setAge</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#D19A66;--shiki-dark:#D19A66;">20</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">		JVMCase</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;"> jvmcase</span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> JVMCase</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">		// Gọi phương thức tĩnh</span></span>
<span class="line"><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">		print</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(stu);</span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">		// Gọi phương thức không tĩnh</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">		jvmcase</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">sayHello</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(stu);</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">	}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">	// Phương thức tĩnh thông thường</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">	public</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> static</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> print</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">Student</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> stu</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">		System</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">out</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">println</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#98C379;--shiki-dark:#98C379;">&quot;name: &quot;</span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;"> +</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> stu</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">getName</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">() </span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;">+</span><span style="--shiki-light:#98C379;--shiki-dark:#98C379;"> &quot;; sex:&quot;</span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;"> +</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> stu</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">getSexType</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">() </span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;">+</span><span style="--shiki-light:#98C379;--shiki-dark:#98C379;"> &quot;; age:&quot;</span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;"> +</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> stu</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">getAge</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">());</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">	}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">	// Phương thức không tĩnh</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">	public</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> sayHello</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">Student</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> stu</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">		System</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">out</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">println</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">stu</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">getName</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">() </span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;">+</span><span style="--shiki-light:#98C379;--shiki-dark:#98C379;"> &quot;say: hello&quot;</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">	}</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">class</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> Student</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">	String</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;"> name</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">	String</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;"> sexType</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">	int</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;"> age</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">	public</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> String</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> getName</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">()</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">		return</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> name;</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">	}</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">	public</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> setName</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> name</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">		this</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">name</span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> name;</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">	public</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> String</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> getSexType</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">()</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">		return</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> sexType;</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">	}</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">	public</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> setSexType</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> sexType</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">		this</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">sexType</span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> sexType;</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">	}</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">	public</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> getAge</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">()</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">		return</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> age;</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">	}</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">	public</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> setAge</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> age</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">		this</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">age</span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> age;</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">	}</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Khi chạy mã trên, quá trình xử lý của JVM như sau:</p><p>（1）JVM yêu cầu bộ nhớ từ hệ điều hành, bước đầu tiên của JVM là yêu cầu bộ nhớ từ hệ điều hành thông qua cấu hình tham số hoặc cấu hình mặc định, JVM sẽ yêu cầu một không gian bộ nhớ cụ thể từ hệ điều hành và sau đó phân bổ nó trong JVM.</p><p>（2）Sau khi có không gian bộ nhớ, JVM sẽ phân bổ kích thước bộ nhớ cho heap, stack và phần không gian phương thức dựa trên cấu hình tham số.</p><p>（3）Tải lớp, xác minh, chuẩn bị và phân tích cú pháp của tệp class, trong đó giai đoạn chuẩn bị sẽ phân bổ bộ nhớ cho các biến tĩnh của lớp và khởi tạo chúng với giá trị khởi tạo mặc định (phần này sẽ được giải thích chi tiết sau).</p><figure><img src="https://raw.githubusercontent.com/vanhung4499/images/master/snap/20230718134850.png" alt="image.png" tabindex="0" loading="lazy"><figcaption>image.png</figcaption></figure><p>（4）Sau khi hoàn thành bước trước, JVM sẽ thực hiện giai đoạn khởi tạo cuối cùng. Trong giai đoạn này, JVM sẽ thực hiện phương thức <code>&lt;clinit&gt;</code> (phương thức khởi tạo lớp) đầu tiên. Trình biên dịch sẽ thu thập tất cả mã khởi tạo lớp, bao gồm các câu lệnh gán biến tĩnh, khối mã tĩnh và phương thức tĩnh, và tổng hợp chúng thành phương thức <code>&lt;clinit&gt;()</code>.</p><figure><img src="https://raw.githubusercontent.com/vanhung4499/images/master/snap/jvm-process-4.png" alt="jvm-process-4.png" tabindex="0" loading="lazy"><figcaption>jvm-process-4.png</figcaption></figure><p>（5）Thực hiện phương thức. Khởi động luồng chính (main thread), thực hiện phương thức main, bắt đầu thực hiện dòng mã đầu tiên. Lúc này, một đối tượng student sẽ được tạo trong heap, và tham chiếu đến student sẽ được lưu trữ trong stack.</p><figure><img src="https://raw.githubusercontent.com/vanhung4499/images/master/snap/jvm-process-5.png" alt="jvm-process-5.png" tabindex="0" loading="lazy"><figcaption>jvm-process-5.png</figcaption></figure><p>（6）Sau đó, tạo một đối tượng JVMCase và gọi phương thức không tĩnh sayHello. Phương thức sayHello thuộc về đối tượng JVMCase, nó được đưa vào stack và gọi đối tượng student trong heap thông qua tham chiếu student; sau đó, gọi phương thức tĩnh print, phương thức print thuộc về lớp JVMCase, được lấy từ phương thức tĩnh và gọi đối tượng student trong heap thông qua tham chiếu student.</p><figure><img src="https://raw.githubusercontent.com/vanhung4499/images/master/snap/jvm-process-6.png" alt="jvm-process-6.png" tabindex="0" loading="lazy"><figcaption>jvm-process-6.png</figcaption></figure><h2 id="outofmemoryerror" tabindex="-1"><a class="header-anchor" href="#outofmemoryerror"><span>OutOfMemoryError</span></a></h2><h3 id="outofmemoryerror-la-gi" tabindex="-1"><a class="header-anchor" href="#outofmemoryerror-la-gi"><span>OutOfMemoryError là gì</span></a></h3><p><code>OutOfMemoryError</code> (viết tắt là OOM) là một lỗi trong Java, nghĩa là không còn bộ nhớ trống và bộ thu gom rác không thể cung cấp thêm bộ nhớ. Đơn giản hơn, OOM có nghĩa là không đủ bộ nhớ trong JVM.</p><p>Theo quy tắc JVM, <strong>ngoại trừ vùng bộ đếm chương trình (Program COunter), các vùng dữ liệu thời gian chạy khác đều có thể gây ra ngoại lệ <code>OutOfMemoryError</code> (viết tắt là OOM)</strong>.</p><p>Dưới đây là các tình huống có thể gây ra OOM.</p><h3 id="tran-bo-nho-heap" tabindex="-1"><a class="header-anchor" href="#tran-bo-nho-heap"><span>Tràn bộ nhớ Heap</span></a></h3><p><code>java.lang.OutOfMemoryError: Java heap space</code> là một lỗi chỉ ra rằng: <strong>tràn bộ nhớ Heap</strong>.</p><p>Cụ thể hơn, đó là khi bộ nhớ Heap của Java đã đạt đến giới hạn tối đa được đặt bởi <code>-Xmx</code>. Bộ nhớ Heap được sử dụng để lưu trữ các đối tượng, và nếu liên tục tạo ra các đối tượng và đảm bảo rằng các đối tượng này không bị thu gom bởi bộ thu gom rác, thì khi bộ nhớ Heap đạt đến giới hạn tối đa, sẽ xảy ra OOM.</p><p>Tràn bộ nhớ Heap có thể là kết quả của <strong><code>rò rỉ bộ nhớ (Memory Leak)</code></strong> hoặc <strong><code>tràn bộ nhớ (Memory Overflow)</code></strong>. Cần sử dụng jstack và jmap để tạo ra threaddump và heapdump, sau đó sử dụng các công cụ phân tích bộ nhớ (như MAT) để phân tích.</p><h4 id="buoc-phan-tich-tran-bo-nho-heap" tabindex="-1"><a class="header-anchor" href="#buoc-phan-tich-tran-bo-nho-heap"><span>Bước phân tích tràn bộ nhớ Heap</span></a></h4><ol><li>Sử dụng <code>jmap</code> hoặc <code>-XX:+HeapDumpOnOutOfMemoryError</code> để lấy bản chụp nhanh Heap.</li><li>Sử dụng công cụ phân tích bộ nhớ (visualvm, mat, jProfile, v.v.) để phân tích tệp chụp nhanh Heapdump.</li><li>Dựa trên biểu đồ phân tích, tập trung vào xác định xem các đối tượng trong bộ nhớ có cần thiết hay không, và xác định xem có phải là rò rỉ bộ nhớ (Memory Leak) hay tràn bộ nhớ (Memory Overflow).</li></ol><h4 id="ro-ri-bo-nho-memory-leak" tabindex="-1"><a class="header-anchor" href="#ro-ri-bo-nho-memory-leak"><span>Rò rỉ bộ nhớ (Memory Leak)</span></a></h4><p><strong>Rò rỉ bộ nhớ là khi chương trình không giải phóng bộ nhớ không còn sử dụng được do sơ suất hoặc lỗi</strong>.</p><p>Rò rỉ bộ nhớ không phải là việc mất mát vật lý của bộ nhớ, mà là khi ứng dụng cấp phát một phần bộ nhớ nhưng do sai sót thiết kế, nó mất đi sự kiểm soát của đoạn bộ nhớ đó, dẫn đến lãng phí bộ nhớ. Rò rỉ bộ nhớ tăng lên theo số lần thực thi và cuối cùng sẽ gây ra tràn bộ nhớ.</p><p>Các tình huống rò rỉ bộ nhớ phổ biến:</p><ul><li>Collection tĩnh <ul><li>Các collection như <code>HashMap</code>, <code>Vector</code> được khai báo là tĩnh (<code>static</code>)</li><li>Nói một cách đơn giản, nếu A chứa B, chỉ cần đặt B thành null, A không được đặt thành null, khi thu gom rác, B không thể thu hồi vì nó được tham chiếu bởi A.</li></ul></li><li>Trình nghe <ul><li>Đăng ký trình nghe nhưng không xóa trình nghe khi giải phóng đối tượng</li></ul></li><li>Kết nối vật lý <ul><li>Các kết nối được tạo bởi các bể kết nối, phải đóng kết nối bằng <code>close()</code></li></ul></li><li>Tham chiếu đến các lớp nội bộ và mô-đun bên ngoài <ul><li>Tìm cách phát hiện nó giống như tràn bộ nhớ, có thể thêm quan sát thời gian thực</li><li><code>jstat -gcutil 7362 2500 70</code></li></ul></li></ul><p>Chú ý đặc biệt:</p><ul><li><code>FGC</code> - Số lần Full GC xảy ra từ khi ứng dụng được khởi động đến thời điểm lấy mẫu.</li><li><code>FGCT</code> - Thời gian (tính bằng giây) mà Full GC đã sử dụng từ khi ứng dụng được khởi động đến thời điểm lấy mẫu.</li><li>Số lần <code>FGC</code> càng nhiều, thời gian <code>FGCT</code> càng lâu, càng có khả năng có rò rỉ bộ nhớ.</li></ul><p>Nếu là rò rỉ bộ nhớ, bạn có thể xem xét chuỗi tham chiếu từ đối tượng rò rỉ đến GC Roots. Điều này sẽ giúp bạn tìm ra cách mà đối tượng rò rỉ liên quan và dẫn đến GC không thể thu hồi chúng. Khi bạn hiểu được nguyên nhân này, bạn có thể xác định chính xác mã gây ra rò rỉ bộ nhớ.</p><p>Nguyên nhân phổ biến gây ra rò rỉ bộ nhớ là sử dụng các collection và không ngừng thêm phần tử vào collection mà không xóa chúng, dẫn đến sự mở rộng không ngừng của collection trong bộ nhớ.</p><p>【Ví dụ】</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#abb2bf;--shiki-dark:#abb2bf;--shiki-light-bg:#282c34;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">/**</span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> * Ví dụ rò rỉ bộ nhớ</span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> * Hiện tượng lỗi: java.lang.OutOfMemoryError: Java heap space</span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> * VM Args: -verbose:gc -Xms10M -Xmx10M -XX:+HeapDumpOnOutOfMemoryError</span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> */</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> HeapOutOfMemoryDemo</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> static</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> main</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">[] </span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">args</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">        List</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">OomObject</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">&gt; </span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">list</span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> ArrayList</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">&lt;&gt;();</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">        while</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#D19A66;--shiki-dark:#D19A66;">true</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">            list</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">add</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">new</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> OomObject</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">());</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">    static</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> OomObject</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> {}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="tran-bo-nho-memory-overflow" tabindex="-1"><a class="header-anchor" href="#tran-bo-nho-memory-overflow"><span>Tràn bộ nhớ (Memory Overflow)</span></a></h4><p>Nếu không có rò rỉ bộ nhớ, có nghĩa là các đối tượng trong bộ nhớ thực sự cần tồn tại, bạn nên kiểm tra các tham số heap của máy ảo Java (<code>-Xmx</code> và <code>-Xms</code>) và so sánh với bộ nhớ vật lý của máy tính để xem liệu có thể tăng kích thước heap hay không. Đồng thời, kiểm tra mã nguồn để xem có tồn tại các đối tượng có tuổi thọ dài, thời gian giữ chúng quá lâu không, và thử giảm tiêu thụ bộ nhớ trong quá trình chạy chương trình.</p><p>【Ví dụ】</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#abb2bf;--shiki-dark:#abb2bf;--shiki-light-bg:#282c34;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">/**</span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> * Ví dụ tràn bộ nhớ Heap</span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> * &lt;p&gt;</span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> * Hiện tượng lỗi: java.lang.OutOfMemoryError: Java heap space</span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> * &lt;p&gt;</span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> * VM Args：-verbose:gc -Xms10M -Xmx10M</span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> */</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> HeapOutOfMemoryDemo</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> static</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> main</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">[] </span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">args</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">        Double</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">[] </span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">array</span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> Double</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#D19A66;--shiki-dark:#D19A66;">999999999</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">];</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">        System</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">out</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">println</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#98C379;--shiki-dark:#98C379;">&quot;array length = [&quot;</span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;"> +</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> array</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">length</span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;"> +</span><span style="--shiki-light:#98C379;--shiki-dark:#98C379;"> &quot;]&quot;</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Chạy lệnh <code>java -verbose:gc -Xms10M -Xmx10M -XX:+HeapDumpOnOutOfMemoryError io.github.dunwu.javacore.jvm.memory.HeapMemoryLeakMemoryErrorDemo</code></p><p>Trong ví dụ trên, đây là một ví dụ cực đoan, cố gắng tạo ra một mảng có kích thước rất lớn, bộ nhớ heap không đủ để cấp phát, dẫn đến lỗi: <code>Java heap space</code>.</p><p>Tuy nhiên, trong thực tế, nếu mã nguồn không có vấn đề, chỉ là do bộ nhớ heap không đủ, bạn có thể điều chỉnh kích thước heap một cách phù hợp bằng cách sử dụng <code>-Xms</code> và <code>-Xmx</code>.</p><h3 id="chi-phi-gc-vuot-qua-gioi-han" tabindex="-1"><a class="header-anchor" href="#chi-phi-gc-vuot-qua-gioi-han"><span>Chi phí GC vượt quá giới hạn</span></a></h3><p><code>java.lang.OutOfMemoryError: GC overhead limit exceeded</code> là một lỗi, theo định nghĩa của Java, xảy ra khi <strong>hơn <code>98%</code> thời gian được sử dụng để thực hiện GC và chỉ thu được dưới <code>2%</code> bộ nhớ heap</strong>. Điều này xảy ra khi GC mất nhiều thời gian để giải phóng một lượng bộ nhớ nhỏ, đây là một cơ chế bảo vệ. Nguyên nhân gây ra lỗi này thường là do heap quá nhỏ và không đủ bộ nhớ.</p><p>【Ví dụ】</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#abb2bf;--shiki-dark:#abb2bf;--shiki-light-bg:#282c34;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">/**</span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> * Ví dụ vượt quá giới hạn chi phí GC</span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> * Hiện tượng lỗi: java.lang.OutOfMemoryError: GC overhead limit exceeded</span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> * Lỗi xảy ra khi GC mất nhiều thời gian để giải phóng một lượng bộ nhớ nhỏ, đây là một cơ chế bảo vệ. Nguyên nhân gây ra lỗi này thường là do heap quá nhỏ và không đủ bộ nhớ.</span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> * Định nghĩa chính thức của Java: Khi hơn 98% thời gian được sử dụng để thực hiện GC và chỉ thu được dưới 2% bộ nhớ heap, lỗi này sẽ được ném ra.</span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> * VM Args: -Xms10M -Xmx10M</span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> */</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> GcOverheadLimitExceededDemo</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> static</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> main</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">[] </span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">args</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">        List</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">Double</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">&gt; </span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">list</span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> ArrayList</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">&lt;&gt;();</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">        double</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;"> d</span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#D19A66;--shiki-dark:#D19A66;"> 0.0</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">        while</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#D19A66;--shiki-dark:#D19A66;">true</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">            list</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">add</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(d++);</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>【Xử lý】</p><p>Xử lý lỗi này tương tự như xử lý lỗi <strong>Tràn bộ nhớ Heap</strong>, trước tiên hãy kiểm tra xem có rò rỉ bộ nhớ không. Nếu có, hãy sửa mã nguồn. Nếu không, hãy điều chỉnh kích thước heap bằng cách sử dụng <code>-Xms</code> và <code>-Xmx</code> một cách phù hợp.</p><h3 id="khong-đu-khong-gian-permgen" tabindex="-1"><a class="header-anchor" href="#khong-đu-khong-gian-permgen"><span>Không đủ không gian PermGen</span></a></h3><p>【Lỗi】</p><div class="language-" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#abb2bf;--shiki-dark:#abb2bf;--shiki-light-bg:#282c34;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code"><code><span class="line"><span>java.lang.OutOfMemoryError: PermGen space</span></span></code></pre></div><p>【Nguyên nhân】</p><p>Không gian PermGen (Permanent Generation) chủ yếu được sử dụng để lưu trữ thông tin về <code>Class</code> và Meta, bao gồm tên lớp, trường, phương thức được biên dịch thành mã bytecode, thông tin hằng số, mảng đối tượng và mảng kiểu liên quan đến lớp, và tối ưu hóa bởi trình biên dịch JIT. GC không thực hiện việc dọn dẹp không gian PermGen trong quá trình chạy chương trình và mặc định có kích thước là 64M.</p><p>Dựa trên định nghĩa trên, có thể kết luận rằng <strong>kích thước PermGen phụ thuộc vào số lượng lớp được tải và kích thước của các lớp đó</strong>. Do đó, nguyên nhân chính gây ra lỗi này là có quá nhiều lớp được tải vào PermGen hoặc có lớp quá lớn trong đó.</p><p>Trong các phiên bản JDK trước JDK8, có thể sử dụng các tham số <code>-XX:PermSize</code> và <code>-XX:MaxPermSize</code> để đặt kích thước không gian PermGen, từ đó giới hạn kích thước của vùng phương thức và vùng hằng số trong đó.</p><h4 id="khong-đu-khong-gian-permgen-khi-khoi-tao" tabindex="-1"><a class="header-anchor" href="#khong-đu-khong-gian-permgen-khi-khoi-tao"><span>Không đủ không gian PermGen khi khởi tạo</span></a></h4><p>【Ví dụ】</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#abb2bf;--shiki-dark:#abb2bf;--shiki-light-bg:#282c34;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">/**</span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> * Ví dụ không đủ không gian PermGen khi khởi tạo</span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> * &lt;p&gt;</span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> * Hiện tượng lỗi:</span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> * &lt;ul&gt;</span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> * &lt;li&gt;java.lang.OutOfMemoryError: PermGen space (Phiên bản JDK trước JDK8)&lt;/li&gt;</span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> * &lt;li&gt;java.lang.OutOfMemoryError: Metaspace (Phiên bản JDK8 trở lên)&lt;/li&gt;</span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> * &lt;/ul&gt;</span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> * VM Args:</span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> * &lt;ul&gt;</span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> * &lt;li&gt;-Xmx100M -XX:MaxPermSize=16M (Phiên bản JDK trước JDK8)&lt;/li&gt;</span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> * &lt;li&gt;-Xmx100M -XX:MaxMetaspaceSize=16M (Phiên bản JDK8 trở lên)&lt;/li&gt;</span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> * &lt;/ul&gt;</span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> */</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> PermOutOfMemoryErrorDemo</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> static</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> main</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">[] </span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">args</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> throws</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> Exception</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">        for</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;"> i</span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#D19A66;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">; i </span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;">&lt;</span><span style="--shiki-light:#D19A66;--shiki-dark:#D19A66;"> 100_000_000</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">; i++) {</span></span>
<span class="line"><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">            generate</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#98C379;--shiki-dark:#98C379;">&quot;eu.plumbr.demo.Generated&quot;</span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;"> +</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> i);</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> static</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> Class</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> generate</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> name</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> throws</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> Exception</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">        ClassPool</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;"> pool</span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> ClassPool</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">getDefault</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> pool</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">makeClass</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(name).</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">toClass</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Trong ví dụ này, đoạn mã lặp qua và tạo ra các lớp trong thời gian chạy. Thư viện javassist được sử dụng để xử lý sự phức tạp của việc tạo lớp.</p><h4 id="khong-đu-khong-gian-permgen-khi-trien-khai-lai" tabindex="-1"><a class="header-anchor" href="#khong-đu-khong-gian-permgen-khi-trien-khai-lai"><span>Không đủ không gian PermGen khi triển khai lại</span></a></h4><p>Đối với ví dụ phức tạp và thực tế hơn, hãy xem xét từng bước xảy ra lỗi không gian Permgen trong quá trình triển khai lại ứng dụng. Khi triển khai lại ứng dụng, bạn mong muốn garbage collector sẽ giải phóng các lớp đã tải trước đó bằng cách thay thế chúng bằng classloader mới tải các lớp mới.</p><p>Tuy nhiên, nhiều thư viện bên thứ ba và cách xử lý tài nguyên như luồng, trình điều khiển JDBC hoặc handle hệ thống tệ hại đã ngăn không cho classloader cũ bị hủy bỏ. Nhưng ngược lại, điều này có nghĩa là trong mỗi lần triển khai lại, tất cả các phiên bản trước của lớp vẫn còn tồn tại trong PermGen, dẫn đến việc tạo ra hàng chục megabyte rác trong mỗi lần triển khai lại.</p><p>Hãy tưởng tượng một ứng dụng ví dụ kết nối đến cơ sở dữ liệu quan hệ bằng trình điều khiển JDBC. Khi ứng dụng khởi động, mã khởi tạo sẽ tải trình điều khiển JDBC để kết nối đến cơ sở dữ liệu. Theo quy định, trình điều khiển JDBC đăng ký với java.sql.DriverManager. Đăng ký này bao gồm việc lưu trữ một tham chiếu đến một phiên bản trình điều khiển trong các trường tĩnh của DriverManager.</p><p>Bây giờ, khi hủy triển khai ứng dụng từ máy chủ ứng dụng, java.sql.DriverManager vẫn giữ tham chiếu đó. Chúng ta đã có một tham chiếu thời gian thực đến lớp trình điều khiển, và lớp trình điều khiển giữ tham chiếu đến java.lang.Classloader được sử dụng để tải ứng dụng. Ngược lại, điều này có nghĩa là thuật toán thu gom rác không thể thu hồi không gian này.</p><p>Và lớp java.lang.Classloader này vẫn giữ tham chiếu đến tất cả các lớp của ứng dụng, thường chiếm đến hàng chục megabyte trong PermGen. Điều này có nghĩa là chỉ cần một số triển khai lại nhỏ để điền vào PermGen với kích thước thông thường.</p><h4 id="giai-phap-cho-khong-gian-permgen" tabindex="-1"><a class="header-anchor" href="#giai-phap-cho-khong-gian-permgen"><span>Giải pháp cho không gian PermGen</span></a></h4><p>(1) Giải quyết <code>OutOfMemoryError</code> khi khởi tạo</p><p>Khi gặp <code>OutOfMemoryError</code> do hết không gian PermGen trong quá trình khởi động ứng dụng, giải pháp đơn giản là tăng kích thước không gian PermGen. Ứng dụng chỉ cần thêm không gian để tải tất cả các lớp vào PermGen, vì vậy chúng ta chỉ cần tăng kích thước của nó. Để làm điều này, chỉnh sửa cấu hình khởi động của ứng dụng và thêm (hoặc tăng nếu đã tồn tại) tham số <code>-XX:MaxPermSize</code>, tương tự như ví dụ sau:</p><div class="language-" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#abb2bf;--shiki-dark:#abb2bf;--shiki-light-bg:#282c34;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code"><code><span class="line"><span>java -XX:MaxPermSize=512m com.yourcompany.YourClass</span></span></code></pre></div><p>Cấu hình trên sẽ cho JVM biết rằng PermGen có thể tăng lên đến 512MB.</p><p>Xóa các tệp jar không cần thiết trong thư mục <code>WEB-INF/lib</code> của ứng dụng, di chuyển các tệp jar chung cho nhiều ứng dụng vào thư mục <code>lib</code> của Tomcat để giảm việc tải lặp lại.</p><p>🔔 Lưu ý: <code>-XX:PermSize</code> thường được đặt là 64M.</p><p>(2) Giải quyết <code>OutOfMemoryError</code> khi triển khai lại</p><p>Khi gặp <code>OutOfMemoryError</code> khi triển khai lại ứng dụng ngay lập tức, ứng dụng đang gặp vấn đề với việc rò rỉ classloader. Trong trường hợp này, giải pháp đầu tiên là tiếp tục phân tích heap dump - sử dụng lệnh tạo heap dump như sau:</p><div class="language-" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#abb2bf;--shiki-dark:#abb2bf;--shiki-light-bg:#282c34;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code"><code><span class="line"><span>jmap -dump:format=b,file=dump.hprof &lt;process-id&gt;</span></span></code></pre></div><p>Sau đó, sử dụng trình phân tích heap dump ưa thích của bạn (ví dụ: Eclipse MAT) để mở dump và tìm các lớp trùng lặp, đặc biệt là các lớp đang tải lớp ứng dụng. Từ đó, bạn cần tìm tất cả các classloader và tìm đường dẫn ngắn nhất từ GC root thu thập từ classloader không hoạt động để xác định các tham chiếu ngăn chúng bị thu gom rác. Có được thông tin này, bạn sẽ tìm ra nguyên nhân cốt lõi. Nếu nguyên nhân nằm trong thư viện bên thứ ba, bạn có thể tìm kiếm trên Google/StackOverflow để xem liệu có phải là vấn đề đã biết và có bản vá/giải pháp không.</p><p>(3) Giải quyết <code>OutOfMemoryError</code> trong quá trình chạy</p><p>Bước đầu tiên là kiểm tra xem GC có được phép gỡ bỏ các lớp khỏi PermGen hay không. Trong mặc định, JVM khá thận trọng với việc gỡ bỏ lớp - lớp được sinh ra để tồn tại mãi mãi. Do đó, ngay cả khi không có mã nào sử dụng chúng, lớp vẫn được giữ trong bộ nhớ. Khi ứng dụng tạo ra nhiều lớp động và lớp này không cần tạo mã trong thời gian dài, điều này có thể trở thành vấn đề. Trong trường hợp này, cho phép JVM gỡ bỏ các định nghĩa lớp có thể giúp ích. Điều này có thể được thực hiện bằng cách thêm cấu hình sau vào tập lệnh khởi động:</p><div class="language-" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#abb2bf;--shiki-dark:#abb2bf;--shiki-light-bg:#282c34;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code"><code><span class="line"><span>-XX:+CMSClassUnloadingEnabled</span></span></code></pre></div><p>Mặc định, tùy chọn này được đặt thành false, vì vậy để bật tính năng này, bạn cần đặt nó một cách rõ ràng trong các tùy chọn Java. Nếu CMSClassUnloadingEnabled được bật, GC cũng sẽ quét PermGen và loại bỏ các lớp không còn sử dụng. Hãy nhớ rằng tùy chọn này chỉ có tác dụng khi sử dụng UseConcMarkSweepGC.</p><div class="language-" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#abb2bf;--shiki-dark:#abb2bf;--shiki-light-bg:#282c34;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code"><code><span class="line"><span>-XX:+UseConcMarkSweepGC</span></span></code></pre></div><p>Sau khi đảm bảo rằng lớp có thể được gỡ bỏ và vẫn còn vấn đề, bạn nên tiếp tục phân tích heap dump - sử dụng lệnh tạo heap dump như sau:</p><div class="language-" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#abb2bf;--shiki-dark:#abb2bf;--shiki-light-bg:#282c34;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code"><code><span class="line"><span>jmap -dump:file=dump.hprof,format=b &lt;process-id&gt;</span></span></code></pre></div><p>Sau đó, sử dụng trình phân tích heap dump ưa thích của bạn (ví dụ: Eclipse MAT) để mở dump và tìm các lớp đã tải, sau đó sắp xếp theo số lượng thể hiện để đặt các đối tượng nghi ngờ ở đầu danh sách.</p><p>Sau đó, đối với mỗi đối tượng nghi ngờ, bạn cần theo dõi ngược lại để xác định nguyên nhân cốt lõi từ mã ứng dụng tạo ra lớp này.</p><h3 id="khong-đu-khong-gian-metaspace" tabindex="-1"><a class="header-anchor" href="#khong-đu-khong-gian-metaspace"><span>Không đủ không gian Metaspace</span></a></h3><p>【Lỗi】</p><div class="language-" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#abb2bf;--shiki-dark:#abb2bf;--shiki-light-bg:#282c34;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code"><code><span class="line"><span>Exception in thread &quot;main&quot; java.lang.OutOfMemoryError: Metaspace</span></span></code></pre></div><p>【Nguyên nhân】</p><p>Từ Java 8 trở đi, không gian bộ nhớ JVM đã trải qua nhiều thay đổi đáng kể. Không còn sử dụng vùng Permanent Generation (PermGen), thay vào đó là không gian Metaspace.</p><p><strong>Lỗi không đủ không gian Metaspace xảy ra khi không đủ không gian trong vùng phương thức (method area) và hằng số thời gian chạy (runtime constant pool)</strong>.</p><p>Vùng phương thức được sử dụng để lưu trữ thông tin liên quan đến Class, bao gồm tên lớp, các quyền truy cập, hằng số thời gian chạy, mô tả trường, mô tả phương thức, v.v.</p><p>Một lớp chỉ được thu gom rác khi đáp ứng điều kiện khá nghiêm ngặt. Trong các ứng dụng tạo động nhiều lớp, và những lớp này không cần mã trong thời gian dài, điều này có thể trở thành một vấn đề. Đặc biệt là trong các trường hợp sử dụng CGLib để tăng cường bytecode và các ngôn ngữ động khác, cũng như các ứng dụng tạo ra nhiều tệp JSP hoặc tạo động tệp JSP (JSP cần được biên dịch thành lớp Java khi chạy lần đầu tiên), hoặc các ứng dụng dựa trên OSGi (đối với cùng một tệp lớp, nếu nó được tải bởi các classloader khác nhau, nó sẽ được coi là các lớp khác nhau).</p><p>【Ví dụ】Lỗi không đủ không gian Metaspace trong vùng phương thức</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#abb2bf;--shiki-dark:#abb2bf;--shiki-light-bg:#282c34;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> MethodAreaOutOfMemoryDemo</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> static</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> main</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">[] </span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">args</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">        while</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#D19A66;--shiki-dark:#D19A66;">true</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">            Enhancer</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;"> enhancer</span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> Enhancer</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">            enhancer</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">setSuperclass</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">Bean</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">class</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">            enhancer</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">setUseCache</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#D19A66;--shiki-dark:#D19A66;">false</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">            enhancer</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">setCallback</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">new</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> MethodInterceptor</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">() {</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">                @</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">Override</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">                public</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> Object</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> intercept</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">Object</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> obj</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">Method</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> method</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">Object</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">[] </span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">args</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">MethodProxy</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> proxy</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> throws</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> Throwable</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">                    return</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> proxy</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">invokeSuper</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(obj, args);</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">                }</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">            });</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">            enhancer</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">create</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">    static</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> Bean</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> {}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>【Giải pháp】</p><p>Khi gặp <code>OutOfMemoryError</code> do không đủ không gian Metaspace, giải pháp đầu tiên là tăng kích thước Metaspace. Thay đổi cấu hình khởi động của ứng dụng và thêm (hoặc tăng nếu đã tồn tại) tham số <code>-XX:MaxMetaspaceSize</code>, tương tự như ví dụ sau:</p><div class="language-" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#abb2bf;--shiki-dark:#abb2bf;--shiki-light-bg:#282c34;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code"><code><span class="line"><span>-XX:MaxMetaspaceSize=512m</span></span></code></pre></div><p>Cấu hình trên cho JVM biết rằng Metaspace có thể tăng lên đến 512MB.</p><p>Một giải pháp khác đơn giản hơn là loại bỏ tham số này để không giới hạn kích thước của Metaspace. JVM mặc định không giới hạn kích thước của Metaspace. Tuy nhiên, hãy lưu ý rằng việc làm này có thể dẫn đến việc sử dụng bộ nhớ trao đổi nhiều hoặc đạt đến giới hạn bộ nhớ vật lý của máy tính.</p><h3 id="khong-the-tao-luong-native-moi" tabindex="-1"><a class="header-anchor" href="#khong-the-tao-luong-native-moi"><span>Không thể tạo luồng native mới</span></a></h3><p><code>java.lang.OutOfMemoryError: Unable to create new native thread</code> là một lỗi có nghĩa là: <strong>Ứng dụng Java đã đạt đến giới hạn số lượng luồng mà nó có thể khởi tạo</strong>.</p><p>【Nguyên nhân】</p><p>Khi tạo một luồng, máy ảo Java (JVM) tạo một đối tượng <code>Thread</code> trong bộ nhớ JVM và tạo một luồng hệ điều hành tương ứng trong bộ nhớ hệ điều hành. Bộ nhớ mà luồng hệ điều hành sử dụng không phải là bộ nhớ JVM, mà là bộ nhớ còn lại trong hệ thống.</p><p>Vậy số lượng luồng mà chúng ta có thể tạo được là bao nhiêu? Có một công thức để tính toán:</p><div class="language-" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#abb2bf;--shiki-dark:#abb2bf;--shiki-light-bg:#282c34;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code"><code><span class="line"><span>Số lượng luồng = (MaxProcessMemory - JVMMemory - ReservedOsMemory) / (ThreadStackSize)</span></span></code></pre></div><p>【Tham số】</p><ul><li><code>MaxProcessMemory</code> - Bộ nhớ tối đa của một tiến trình</li><li><code>JVMMemory</code> - Bộ nhớ JVM</li><li><code>ReservedOsMemory</code> - Bộ nhớ dành riêng cho hệ điều hành</li><li><code>ThreadStackSize</code> - Kích thước ngăn xếp của luồng</li></ul><p><strong>Khi chúng ta cấp phát nhiều bộ nhớ cho JVM, bộ nhớ có thể sử dụng để tạo luồng hệ điều hành càng ít, càng dễ xảy ra lỗi <code>unable to create new native thread</code></strong>. Vì vậy, việc cấp phát quá nhiều bộ nhớ cho JVM không phải lúc nào cũng tốt.</p><p>Tuy nhiên, thông thường các tình huống gây ra lỗi <code>java.lang.OutOfMemoryError</code> là do không thể tạo ra luồng mới, và điều này xảy ra theo các bước sau:</p><ol><li>Ứng dụng chạy trong JVM gửi yêu cầu tạo luồng Java mới.</li><li>Mã native trong JVM đại diện cho yêu cầu tạo luồng hệ điều hành.</li><li>Hệ điều hành cố gắng tạo một luồng hệ điều hành mới, cần phải cấp phát bộ nhớ cho luồng này.</li><li>Hệ điều hành từ chối cấp phát bộ nhớ cho luồng hệ điều hành mới vì không gian địa chỉ của quá trình Java 32 bit đã hết (ví dụ: đã đạt đến giới hạn kích thước quá trình 2-4 GB) hoặc bộ nhớ ảo của hệ điều hành đã hết.</li><li>Gây ra lỗi <code>java.lang.OutOfMemoryError: Unable to create new native thread</code>.</li></ol><p>【Ví dụ】</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#abb2bf;--shiki-dark:#abb2bf;--shiki-light-bg:#282c34;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> UnableCreateNativeThreadErrorDemo</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> static</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> main</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">[] </span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">args</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">        while</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#D19A66;--shiki-dark:#D19A66;">true</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">            new</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> Thread</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">new</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> Runnable</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">() {</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">                @</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">Override</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">                public</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> run</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">()</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">                    try</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">                        TimeUnit</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">MINUTES</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">sleep</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#D19A66;--shiki-dark:#D19A66;">5</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">                    } </span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">catch</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">InterruptedException</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> e</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">                        e</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">printStackTrace</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">                    }</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">                }</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">            }).</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">start</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>【Giải pháp】</p><p>Có thể vượt qua vấn đề không thể tạo luồng hệ điều hành mới bằng cách tăng giới hạn số lượng tiến trình mà JVM có thể tạo ra. Ví dụ, nếu giới hạn số lượng tiến trình mà JVM có thể tạo ra trong không gian người dùng đã bị hạn chế, bạn nên kiểm tra và có thể tăng giới hạn đó:</p><div class="language-shell" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#abb2bf;--shiki-dark:#abb2bf;--shiki-light-bg:#282c34;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">[root@dev ~]# ulimit -a</span></span>
<span class="line"><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">core</span><span style="--shiki-light:#98C379;--shiki-dark:#98C379;"> file</span><span style="--shiki-light:#98C379;--shiki-dark:#98C379;"> size</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">          (blocks, </span><span style="--shiki-light:#D19A66;--shiki-dark:#D19A66;">-c</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">) 0</span></span>
<span class="line"><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">---</span><span style="--shiki-light:#98C379;--shiki-dark:#98C379;"> cut</span><span style="--shiki-light:#98C379;--shiki-dark:#98C379;"> for</span><span style="--shiki-light:#98C379;--shiki-dark:#98C379;"> brevity</span><span style="--shiki-light:#D19A66;--shiki-dark:#D19A66;"> ---</span></span>
<span class="line"><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">max</span><span style="--shiki-light:#98C379;--shiki-dark:#98C379;"> user</span><span style="--shiki-light:#98C379;--shiki-dark:#98C379;"> processes</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">              (-u) 1800</span></span></code></pre></div><p>Thường thì <code>OutOfMemoryError</code> do không thể tạo luồng hệ điều hành mới chỉ ra một lỗi lập trình. Rất ít ứng dụng có thể hưởng lợi từ một số lượng lớn luồng như vậy.</p><p>Một cách tiếp cận để giải quyết vấn đề này là bắt đầu thực hiện thread dump để tìm hiểu tình hình.</p><h3 id="tran-bo-nho-truc-tiep" tabindex="-1"><a class="header-anchor" href="#tran-bo-nho-truc-tiep"><span>Tràn bộ nhớ trực tiếp</span></a></h3><p>Lỗi tràn bộ nhớ do tràn bộ nhớ trực tiếp (Direct Memory) là một đặc điểm rõ ràng là không có lỗi rõ ràng trong tệp Head Dump. Nếu bạn phát hiện rằng tệp Dump sau khi xảy ra OOM rất nhỏ, trong khi chương trình sử dụng trực tiếp hoặc gián tiếp NIO, bạn có thể xem xét kiểm tra xem có phải là nguyên nhân từ phía này.</p><p>【Ví dụ】Lỗi tràn bộ nhớ trực tiếp</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#abb2bf;--shiki-dark:#abb2bf;--shiki-light-bg:#282c34;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">/**</span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> * Ví dụ tràn bộ nhớ trực tiếp</span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> * Hiện tượng lỗi: java.lang.OutOfMemoryError</span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> * VM Args：-Xmx20M -XX:MaxDirectMemorySize=10M</span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> */</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> DirectOutOfMemoryDemo</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> static</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> final</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;"> _1MB </span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#D19A66;--shiki-dark:#D19A66;"> 1024</span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;"> *</span><span style="--shiki-light:#D19A66;--shiki-dark:#D19A66;"> 1024</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> static</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> main</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">[] </span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">args</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> throws</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> IllegalAccessException</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">        Field</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;"> unsafeField</span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> Unsafe</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">class</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">getDeclaredFields</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">()[</span><span style="--shiki-light:#D19A66;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">];</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">        unsafeField</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">setAccessible</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#D19A66;--shiki-dark:#D19A66;">true</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">        Unsafe</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;"> unsafe</span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> (Unsafe) </span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">unsafeField</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">get</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#D19A66;--shiki-dark:#D19A66;">null</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">        while</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#D19A66;--shiki-dark:#D19A66;">true</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">            unsafe</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">allocateMemory</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(_1MB);</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>【Xử lý】</p><p>Để xử lý lỗi tràn bộ nhớ trực tiếp, bạn có thể thử tăng kích thước bộ nhớ trực tiếp (<code>-XX:MaxDirectMemorySize</code>) hoặc giảm bộ nhớ heap (<code>-Xmx</code>) để giải phóng bộ nhớ cho bộ nhớ trực tiếp. Ngoài ra, bạn cũng có thể kiểm tra xem có sử dụng trực tiếp NIO không cần thiết và giải phóng bộ nhớ trực tiếp sau khi sử dụng xong.</p><h2 id="stackoverflowerror" tabindex="-1"><a class="header-anchor" href="#stackoverflowerror"><span>StackOverflowError</span></a></h2><p>Đối với máy ảo HotSpot, dung lượng của ngăn xếp chỉ được quyết định bởi tham số <code>-Xss</code>. Nếu một luồng yêu cầu độ sâu của ngăn xếp lớn hơn giới hạn tối đa cho phép của máy ảo, nó sẽ gây ra ngoại lệ <code>StackOverflowError</code>.</p><p>Trong thực tế, nguyên nhân phổ biến gây ra lỗi tràn ngăn xếp bao gồm:</p><ul><li><strong>Số lượng lời gọi hàm đệ quy quá nhiều</strong></li><li><strong>Vòng lặp lớn hoặc vòng lặp vô hạn</strong></li></ul><p>【Ví dụ】Lỗi StackOverflowError do số lượng lời gọi hàm đệ quy quá nhiều</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#abb2bf;--shiki-dark:#abb2bf;--shiki-light-bg:#282c34;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> StackOverflowDemo</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;"> stackLength </span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#D19A66;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> recursion</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">()</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">        stackLength++;</span></span>
<span class="line"><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">        recursion</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> static</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> main</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">[] </span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">args</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">        StackOverflowDemo</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;"> obj</span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> StackOverflowDemo</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">        try</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">            obj</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">recursion</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">        } </span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">catch</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">Throwable</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> e</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">            System</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">out</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">println</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#98C379;--shiki-dark:#98C379;">&quot;Độ sâu ngăn xếp: &quot;</span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;"> +</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> obj</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">stackLength</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">            e</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">printStackTrace</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><!----><footer class="vp-page-meta"><div class="vp-meta-item edit-link"><a class="auto-link external-link vp-meta-label" href="https://github.com/vanhung4499/my-wiki/edit/main/src/programming/java/JVM/JVM Memory Managment.md" aria-label="Edit this page on GitHub" rel="noopener noreferrer" target="_blank"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon" name="edit"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->Edit this page on GitHub<!----></a></div><div class="vp-meta-item git-info"><div class="update-time"><span class="vp-meta-label">Last update: </span><!----></div><div class="contributors"><span class="vp-meta-label">Contributors: </span><!--[--><!--[--><span class="vp-meta-info" title="email: vanhung4499@gmail.com">Hung Nguyen</span>,<!--]--><!--[--><span class="vp-meta-info" title="email: vanhung4499@gmail.com">Hung Nguyen Van</span><!--]--><!--]--></div></div></footer><nav class="vp-page-nav"><a class="route-link auto-link prev" href="/programming/java/JVM/JVM%20In%20Action.html" aria-label="JVM In Action"><div class="hint"><span class="arrow start"></span>Prev</div><div class="link"><!---->JVM In Action</div></a><!----></nav><!----><!----><!--]--></main><!--]--><footer class="footer-wrapper" style="display:none;--1ea755b8:;"><div class="footer-content"><div class="footer">Made with ❤️ by Hung Nguyen</div><div class="copyright">Copyright © 2016-2024 Hung Nguyen</div></div><span id="runtime_span"></span></footer></div><!--]--><!--[--><!----><!----><!----><!----><!--]--><!--]--></div>
    <script type="module" src="/assets/app-CmlOSuIY.js" defer></script>
  </body>
</html>
