<!doctype html>
<html lang="en-US" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.15" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.52" />
    <style>
      html {
        background: var(--bg-color, #fff);
      }

      html[data-theme="dark"] {
        background: var(--bg-color, #1d1e1f);
      }

      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <meta property="og:url" content="https://vanhung4499.github.io/programming/java/Concurency/synchronized.html"><meta property="og:site_name" content="VanHung4499"><meta property="og:title" content="Synchronized States"><meta property="og:description" content="Bốn trạng thái của synchronized Trong bài trước, chúng ta đã tìm hiểu về cách sử dụng cơ bản của từ khóa synchronized. Nó có thể được sử dụng để đồng bộ hóa phương thức và khối ..."><meta property="og:type" content="article"><meta property="og:image" content="https://cdn.tobebetterjavaer.com/stutymore/synchronized-20230728110319.png"><meta property="og:locale" content="en-US"><meta property="og:updated_time" content="2024-10-02T17:20:50.000Z"><meta property="article:author" content="Hung Nguyen"><meta property="article:tag" content="java"><meta property="article:modified_time" content="2024-10-02T17:20:50.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"Synchronized States","image":["https://cdn.tobebetterjavaer.com/stutymore/synchronized-20230728110319.png","https://cdn.tobebetterjavaer.com/stutymore/synchronized-20230728112620.png","https://cdn.tobebetterjavaer.com/stutymore/synchronized-20230728114101.png"],"dateModified":"2024-10-02T17:20:50.000Z","author":[{"@type":"Person","name":"Hung Nguyen","url":"https://vanhung4499.github.io"}]}</script><meta name="referrer" content="no-referrer-when-downgrade"><link rel="alternate" type="application/rss+xml" href="https://vanhung4499.github.io/rss.xml" title="VanHung4499 RSS Feed"><title>Synchronized States | VanHung4499</title><meta name="description" content="Bốn trạng thái của synchronized Trong bài trước, chúng ta đã tìm hiểu về cách sử dụng cơ bản của từ khóa synchronized. Nó có thể được sử dụng để đồng bộ hóa phương thức và khối ...">
    <link rel="preload" href="/assets/style-DFXXOFfS.css" as="style"><link rel="stylesheet" href="/assets/style-DFXXOFfS.css">
    <link rel="modulepreload" href="/assets/app-5QVbWi7Z.js"><link rel="modulepreload" href="/assets/synchronized.html-C4rITUKL.js">
    
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">Skip to main content</a><!--]--><div class="theme-container external-link-icon has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!----><!--[--><a class="route-link vp-brand" href="/"><img class="vp-nav-logo" src="/logo.svg" alt><!----><span class="vp-site-name hide-in-pad">VanHung4499</span></a><!--]--><!----></div><div class="vp-navbar-center"><!----><!--[--><nav class="vp-nav-links"><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/" aria-label="Home"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="mdi:home" width="1em" height="1em"></iconify-icon><!--]-->Home<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/wiki.html" aria-label="Wiki"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="carbon:wikis" width="1em" height="1em"></iconify-icon><!--]-->Wiki<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/dsa/" aria-label="Algorithms"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="hugeicons:algorithm" width="1em" height="1em"></iconify-icon><!--]-->Algorithms<!----></a></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="Programming"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="mdi:code" width="1em" height="1em"></iconify-icon>Programming<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link route-link-active auto-link" href="/programming/java/" aria-label="Java"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:java" width="1em" height="1em"></iconify-icon><!--]-->Java<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/programming/golang/" aria-label="Golang"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:go" width="1em" height="1em"></iconify-icon><!--]-->Golang<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/programming/js/" aria-label="JavaScript"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:javascript" width="1em" height="1em"></iconify-icon><!--]-->JavaScript<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/programming/ts/" aria-label="TypeScript"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:typescript" width="1em" height="1em"></iconify-icon><!--]-->TypeScript<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/programming/python/" aria-label="Python"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:python" width="1em" height="1em"></iconify-icon><!--]-->Python<!----></a></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="Database"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="mdi:database" width="1em" height="1em"></iconify-icon>Database<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/database/sql/" aria-label="SQL"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="mdi:sql-query" width="1em" height="1em"></iconify-icon><!--]-->SQL<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/database/mysql/" aria-label="MySQL"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:mysql" width="1em" height="1em"></iconify-icon><!--]-->MySQL<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/database/mongodb/" aria-label="MongoDB"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:mongodb" width="1em" height="1em"></iconify-icon><!--]-->MongoDB<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/database/redis/" aria-label="Redis"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:redis" width="1em" height="1em"></iconify-icon><!--]-->Redis<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/database/elasticsearch/" aria-label="Elasticsearch"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:elasticsearch" width="1em" height="1em"></iconify-icon><!--]-->Elasticsearch<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/database/elastic/" aria-label="Elastic Stack"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="cib:elastic-stack" width="1em" height="1em"></iconify-icon><!--]-->Elastic Stack<!----></a></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="Framework"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="simple-icons:framework" width="1em" height="1em"></iconify-icon>Framework<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/framework/spring/" aria-label="Spring"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:spring" width="1em" height="1em"></iconify-icon><!--]-->Spring<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/framework/spring-boot/" aria-label="Spring Boot"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:spring" width="1em" height="1em"></iconify-icon><!--]-->Spring Boot<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/framework/nestjs/" aria-label="NestJS"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:nestjs" width="1em" height="1em"></iconify-icon><!--]-->NestJS<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/framework/gin/" aria-label="Gin"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="logos:gin" width="1em" height="1em"></iconify-icon><!--]-->Gin<!----></a></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="DevOps"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon-plain:azuredevops" width="1em" height="1em"></iconify-icon>DevOps<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/devops/docker/" aria-label="Docker"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:docker" width="1em" height="1em"></iconify-icon><!--]-->Docker<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/devops/kubernetes/" aria-label="Kubernetes"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:kubernetes" width="1em" height="1em"></iconify-icon><!--]-->Kubernetes<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/devops/jenkins/" aria-label="Jenkins"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:jenkins" width="1em" height="1em"></iconify-icon><!--]-->Jenkins<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/devops/git/" aria-label="Git"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:git" width="1em" height="1em"></iconify-icon><!--]-->Git<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/devops/linux/" aria-label="Linux"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:linux" width="1em" height="1em"></iconify-icon><!--]-->Linux<!----></a></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="Design"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="tdesign:system-sum" width="1em" height="1em"></iconify-icon>Design<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/design/design-pattern/" aria-label="Design Pattern"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="tabler:grid-pattern" width="1em" height="1em"></iconify-icon><!--]-->Design Pattern<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/design/system-design/" aria-label="System Design"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="icon-park-outline:system" width="1em" height="1em"></iconify-icon><!--]-->System Design<!----></a></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="Project"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="ant-design:project-outlined" width="1em" height="1em"></iconify-icon>Project<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/project/rouyi-vue-pro/" aria-label="Rouyi Vue Pro"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:spring" width="1em" height="1em"></iconify-icon><!--]-->Rouyi Vue Pro<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/project/yudao-cloud/" aria-label="Yudao Cloud"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:spring" width="1em" height="1em"></iconify-icon><!--]-->Yudao Cloud<!----></a></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/interview/" aria-label="Interview"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="mdi:account-tie" width="1em" height="1em"></iconify-icon><!--]-->Interview<!----></a></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="About"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="mdi:about" width="1em" height="1em"></iconify-icon>About<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/about-me.html" aria-label="About me"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="cib:about-me" width="1em" height="1em"></iconify-icon><!--]-->About me<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/about.html" aria-label="About"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="mdi:about" width="1em" height="1em"></iconify-icon><!--]-->About<!----></a></li></ul></button></div></div></nav><!--]--><!----></div><div class="vp-navbar-end"><!----><!--[--><!----><div class="vp-nav-item vp-action"><a class="vp-action-link" href="https://github.com/vanhung4499/my-wiki" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" name="github" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="vp-nav-item hide-in-mobile"><button type="button" class="vp-outlook-button" tabindex="-1" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon outlook-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="outlook icon" name="outlook"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4 38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32 51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0 102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2 6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4 0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2 9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224 419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4 470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0 22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6 12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128 505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2 16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8 86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4 80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6 6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg><div class="vp-outlook-dropdown"><!----></div></button></div><!--[--><button type="button" class="search-pro-button" aria-label="Search"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon" name="search"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="search-pro-placeholder">Search</div><div class="search-pro-key-hints"><kbd class="search-pro-key">Ctrl</kbd><kbd class="search-pro-key">K</kbd></div></button><!--]--><!--]--><!----><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!----><ul class="vp-sidebar-links"><li><a class="route-link auto-link vp-sidebar-link" href="/programming/java/" aria-label="Java"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:java" width="1em" height="1em"></iconify-icon><!--]-->Java<!----></a></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Basic</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Array</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">String</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">OOP</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Extra</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Collection</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Common Tools</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">IO</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Exception</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">New Features</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">NIO</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Advanced</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable active" type="button"><!----><span class="vp-sidebar-title">Concurrency</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><a class="route-link auto-link vp-sidebar-link" href="/programming/java/Concurency/multi-threading.html" aria-label="Multi Threading Intro"><!---->Multi Threading Intro<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/programming/java/Concurency/callable-future-futuretask.html" aria-label="Callable Future FutureTask"><!---->Callable Future FutureTask<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/programming/java/Concurency/thread-group-and-thread-priority.html" aria-label="Thread Group and Thread Priority"><!---->Thread Group and Thread Priority<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/programming/java/Concurency/why-need-thread.html" aria-label="Why Need Thread"><!---->Why Need Thread<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/programming/java/Concurency/thread-state.html" aria-label="Thread State and Method"><!---->Thread State and Method<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/programming/java/Concurency/thread-problems.html" aria-label="Thread Problems"><!---->Thread Problems<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/programming/java/Concurency/jmm.html" aria-label="Java Memory Model"><!---->Java Memory Model<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/programming/java/Concurency/volatile.html" aria-label="Volatile"><!---->Volatile<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/programming/java/Concurency/synchronized-1.html" aria-label="Synchronized"><!---->Synchronized<!----></a></li><li><a class="route-link route-link-active auto-link vp-sidebar-link active" href="/programming/java/Concurency/synchronized.html" aria-label="Synchronized States"><!---->Synchronized States<!----></a></li></ul></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">JVM</span><span class="vp-arrow end"></span></button><!----></section></li></ul><!----></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->Synchronized States</h1><div class="page-info"><span class="page-author-info" aria-label="Author🖊" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon" name="author"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="page-author-item" href="https://vanhung4499.github.io" target="_blank" rel="noopener noreferrer">Hung Nguyen</a></span><span property="author" content="Hung Nguyen"></span></span><!----><span class="page-date-info" aria-label="Writing Date📅" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon" name="calendar"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2024-10-02T17:20:50.000Z"></span><!----><span class="page-reading-time-info" aria-label="Reading Time⌛" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon" name="timer"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>About 19 min</span><meta property="timeRequired" content="PT19M"></span><span class="page-category-info" aria-label="Category🌈" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon" name="category"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><!--[--><span class="page-category-item color8 clickable" role="navigation">java</span><!--]--><meta property="articleSection" content="java"></span><span class="page-tag-info" aria-label="Tag🏷" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon" name="tag"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><!--[--><span class="page-tag-item color8 clickable" role="navigation">java</span><!--]--><meta property="keywords" content="java"></span></div><hr></div><div class="vp-toc-placeholder"><aside id="toc"><!----><div class="vp-toc-header">On This Page<button type="button" class="print-button" title="Print"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon" name="print"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button><div class="arrow end"></div></div><div class="vp-toc-wrapper"><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#cach-su-dung-co-ban-cua-khoa">Cách sử dụng cơ bản của khóa</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#bon-trang-thai-cua-khoa-va-ha-cap-khoa">Bốn trạng thái của khóa và hạ cấp khóa</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#khoa-cua-đoi-tuong-đuoc-luu-o-đau">Khóa của đối tượng được lưu ở đâu?</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#khoa-thien-vi">Khoá thiên vị</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#nguyen-ly-thuc-hien-khoa-thien-vi">Nguyên lý thực hiện khoá thiên vị</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#huy-bo-khoa-thien-vi">Hủy bỏ khoá thiên vị</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#khoa-nhe">Khóa nhẹ</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#giai-phong-khoa-nhe">Giải phóng khóa nhẹ</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#khoa-nang">Khóa nặng</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#quy-trinh-nang-cap-khoa">Quy trình nâng cấp khóa</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#tom-tat">Tóm tắt</a></li><!----><!--]--></ul><div class="vp-toc-marker" style="top:-1.7rem;"></div></div><!----></aside></div><!----><div class="theme-hope-content"><h1 id="bon-trang-thai-cua-synchronized" tabindex="-1"><a class="header-anchor" href="#bon-trang-thai-cua-synchronized"><span>Bốn trạng thái của synchronized</span></a></h1><p>Trong bài trước, chúng ta đã tìm hiểu về cách sử dụng cơ bản của từ khóa synchronized. Nó có thể được sử dụng để đồng bộ hóa phương thức và khối mã. Vậy <code>synchronized</code> thực sự khóa cái gì? Khi phiên bản JDK nâng cấp, <code>synchronized</code> đã có những thay đổi gì? Liệu có đúng không rằng &quot;hiệu suất của synchronized rất kém&quot;?</p><p>Tôi nghĩ đây là câu hỏi mà nhiều bạn quan tâm.</p><p>Điều đầu tiên cần làm rõ là: <strong>Khóa trong Java đa luồng đều dựa trên đối tượng</strong>, mỗi đối tượng trong Java đều có thể làm khóa.</p><p>Một điểm nữa cần chú ý là, cái mà chúng ta thường nghe là <strong>khóa lớp</strong> thực chất cũng là khóa đối tượng, như đã nói ở <a class="route-link" href="/programming/java/Concurency/synchronized-1.html">bài trước</a>, chắc hẳn nhiều bạn đã nhận ra.</p><p>Hãy nói thêm một chút về điều này. Đối tượng <code>Class</code> là một đối tượng đặc biệt trong Java, đại diện cho các lớp và giao diện trong chương trình. Mỗi kiểu trong Java (bao gồm lớp, giao diện, mảng và kiểu nguyên thủy) đều có một đối tượng <code>Class</code> duy nhất trong JVM tương ứng với nó. Đối tượng <code>Class</code> này được tạo ra khi JVM tải lớp, và quá trình này được thực hiện tự động bởi JVM.</p><p>Đối tượng <code>Class</code> chứa nhiều thông tin liên quan đến lớp, chẳng hạn như tên lớp, lớp cha, các giao diện mà lớp thực hiện, các phương thức, trường của lớp,... Những thông tin này thường được gọi là &quot;metadata&quot; (siêu dữ liệu).</p><p>Chúng ta có thể sử dụng đối tượng <code>Class</code> để lấy siêu dữ liệu của lớp, thậm chí có thể tạo động các phiên bản của lớp, gọi phương thức của lớp, truy cập vào các trường của lớp, v.v. Đây chính là cơ chế phản xạ của Java (Reflection).</p><p>Vì vậy, cái gọi là khóa lớp thực chất là khóa đối tượng <code>Class</code>.</p><h2 id="cach-su-dung-co-ban-cua-khoa" tabindex="-1"><a class="header-anchor" href="#cach-su-dung-co-ban-cua-khoa"><span>Cách sử dụng cơ bản của khóa</span></a></h2><p>Từ khóa <code>synchronized</code> có nghĩa là &quot;đồng bộ hóa&quot;.</p><p>Chúng ta thường sử dụng từ khóa <code>synchronized</code> để khóa một đoạn mã hoặc một phương thức. Như đã đề cập trong <a class="route-link" href="/programming/java/Concurency/synchronized-1.html">bài trước</a>, chúng ta hãy điểm qua nhanh lại, vì <code>synchronized</code> rất quan trọng và thường được hỏi trong các cuộc phỏng vấn cũng như khi lập trình. Nó thường có ba hình thức sau:</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#abb2bf;--shiki-dark:#abb2bf;--shiki-light-bg:#282c34;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// Từ khóa trong phương thức instance, khóa là đối tượng hiện tại</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> synchronized</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> instanceLock</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">() {</span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // code</span></span>
<span class="line"><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// Từ khóa trong phương thức static, khóa là đối tượng Class hiện tại</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> static</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> synchronized</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> classLock</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">() {</span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // code</span></span>
<span class="line"><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// Từ khóa trong khối mã, khóa là đối tượng bên trong dấu ngoặc</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> blockLock</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">() {</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">    Object</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;"> o </span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> Object</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">()</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">    synchronized</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;"> (o) {</span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // code</span></span>
<span class="line"><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">    }</span></span>
<span class="line"><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Ở đây, khái niệm critical section được giới thiệu. critical section là một khu vực mã mà chỉ một luồng có thể thực thi tại một thời điểm. Trong các ví dụ trên, nếu từ khóa <code>synchronized</code> được sử dụng trong phương thức, thì critical section chính là toàn bộ phương thức. Nếu nó là một khối mã <code>synchronized</code>, thì critical section chỉ là khu vực mã bên trong khối mã đó.</p><p>Nhìn vào các ví dụ trên, chúng ta có thể thấy hai cách viết sau thực chất có tác dụng tương đương:</p><div class="language-java" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#abb2bf;--shiki-dark:#abb2bf;--shiki-light-bg:#282c34;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// Từ khóa trong phương thức instance, khóa là đối tượng hiện tại</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> synchronized</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> instanceLock</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">() {</span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // code</span></span>
<span class="line"><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// Từ khóa trong khối mã, khóa là đối tượng hiện tại</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> blockLock</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">() {</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">    synchronized</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;"> (</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">this</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">) {</span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // code</span></span>
<span class="line"><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">    }</span></span>
<span class="line"><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">}</span></span></code></pre></div><p>Tương tự, hai phương thức dưới đây cũng có tác dụng tương đương:</p><div class="language-java" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#abb2bf;--shiki-dark:#abb2bf;--shiki-light-bg:#282c34;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// Từ khóa trong phương thức static, khóa là đối tượng Class hiện tại</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> static</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> synchronized</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> classLock</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">() {</span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // code</span></span>
<span class="line"><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// Từ khóa trong khối mã, khóa là đối tượng Class hiện tại</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> blockLock</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">() {</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">    synchronized</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;"> (</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">this</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">getClass</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">()</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">) {</span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // code</span></span>
<span class="line"><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">    }</span></span>
<span class="line"><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">}</span></span></code></pre></div><h2 id="bon-trang-thai-cua-khoa-va-ha-cap-khoa" tabindex="-1"><a class="header-anchor" href="#bon-trang-thai-cua-khoa-va-ha-cap-khoa"><span>Bốn trạng thái của khóa và hạ cấp khóa</span></a></h2><p>Trước JDK 1.6, tất cả các khóa đều là &quot;khóa nặng&quot; vì sử dụng khóa của hệ điều hành, khi một luồng giữ khóa thì các luồng khác cố gắng truy cập vào khối <code>synchronized</code> sẽ bị chặn cho đến khi khóa được giải phóng. Điều này liên quan đến việc chuyển đổi ngữ cảnh luồng và chuyển đổi giữa người dùng và chế độ lõi của hệ điều hành, dẫn đến hiệu suất thấp.</p><p>Đây là lý do tại sao nhiều lập trình viên nghĩ rằng hiệu suất của <code>synchronized</code> rất kém.</p><p>Để giảm thiểu chi phí hiệu suất khi lấy và giải phóng khóa, JDK 1.6 đã giới thiệu khái niệm &quot;khóa thiên vị&quot; và &quot;khóa nhẹ&quot;, làm cho <code>synchronized</code> có một bước cải tiến lớn về hiệu suất. Kể từ JDK 1.6 trở đi, một đối tượng thực sự có bốn trạng thái khóa, xếp theo thứ tự từ thấp đến cao như sau:</p><ol><li>Trạng thái không khóa</li><li>Trạng thái khóa thiên vị</li><li>Trạng thái khóa nhẹ</li><li>Trạng thái khóa nặng</li></ol><p>Không khóa nghĩa là không có bất kỳ khóa nào trên tài nguyên, bất kỳ luồng nào cũng có thể cố gắng sửa đổi nó, điều này rất dễ hiểu.</p><p>Các loại khóa này có thể nâng cấp dần dần tùy theo mức độ cạnh tranh, quá trình nâng cấp khóa rất dễ xảy ra, nhưng việc hạ cấp khóa lại ít xảy ra hơn. Hạ cấp khóa thường xảy ra trong quá trình <a href="../jvm/gc">Stop The World</a> (một khái niệm quan trọng trong thu gom rác của Java, chúng ta sẽ đề cập sâu hơn trong phần JVM), khi JVM vào điểm an toàn và kiểm tra xem có khóa nào không được sử dụng để thực hiện hạ cấp.</p><p>Về hạ cấp khóa, có một điều cần làm rõ:</p><p>Khác với phần lớn các bài viết cho rằng không thể hạ cấp khóa, thực tế là HotSpot JVM hỗ trợ hạ cấp khóa. Trong <a href="https://openjdk.org/jeps/8183909" target="_blank" rel="noopener noreferrer">bài đăng này</a>, có một luận điểm quan trọng mà bài viết đưa ra, do tác giả nổi tiếng R-Giải trình bày.</p><blockquote><p>In its current implementation, monitor deflation is performed during every STW pause, while all Java threads are waiting at a safepoint. We have seen safepoint cleanup stalls up to 200ms on monitor-heavy-applications。</p></blockquote><p>Điều này có nghĩa rằng hạ cấp khóa nặng xảy ra trong giai đoạn STW, và chỉ áp dụng cho các đối tượng chỉ có thể được truy cập bởi VMThread mà không có JavaThread nào khác truy cập.</p><p>So sánh ưu nhược điểm của các loại khóa:</p><table><thead><tr><th>Loại khóa</th><th>Ưu điểm</th><th>Nhược điểm</th><th>Tình huống sử dụng</th></tr></thead><tbody><tr><td>Khóa thiên vị</td><td>Việc lấy và thả khóa không tốn nhiều tài nguyên, gần như không khác so với việc thực hiện phương thức không đồng bộ.</td><td>Nếu có sự cạnh tranh giữa các luồng, sẽ có chi phí hủy bỏ khóa.</td><td>Dùng trong tình huống chỉ có một luồng truy cập khối đồng bộ.</td></tr><tr><td>Khóa nhẹ</td><td>Các luồng cạnh tranh không bị chặn, giúp cải thiện tốc độ phản hồi của chương trình.</td><td>Nếu không lấy được khóa, các luồng quay vòng sẽ tiêu tốn CPU.</td><td>Ưu tiên tốc độ phản hồi. Khối đồng bộ thực thi nhanh.</td></tr><tr><td>Khóa nặng</td><td>Luồng cạnh tranh không quay vòng, không tiêu tốn CPU.</td><td>Các luồng bị chặn, tốc độ phản hồi chậm.</td><td>Ưu tiên thông lượng. Khối đồng bộ thực thi lâu dài.</td></tr></tbody></table><h2 id="khoa-cua-đoi-tuong-đuoc-luu-o-đau" tabindex="-1"><a class="header-anchor" href="#khoa-cua-đoi-tuong-đuoc-luu-o-đau"><span>Khóa của đối tượng được lưu ở đâu?</span></a></h2><p>Như đã nói ở phần trước, khóa trong Java đều dựa trên đối tượng.</p><p>Đầu tiên, hãy xem khóa của một đối tượng được lưu trữ ở đâu.</p><p>Mỗi đối tượng Java đều có một &quot;tiêu đề đối tượng&quot; (object header). Nếu là loại không phải mảng, đầu đối tượng chiếm 2 word; nếu là mảng, nó chiếm 3 word. Trong bộ xử lý 32-bit, một word là 32 bit; trong JVM 64-bit, một word là 64 bit. Nội dung của đầu đối tượng như sau:</p><table><thead><tr><th>Chiều dài</th><th>Nội dung</th><th>Mô tả</th></tr></thead><tbody><tr><td>32/64 bit</td><td>Mark Word</td><td>Lưu trữ hashCode của đối tượng hoặc thông tin về khóa</td></tr><tr><td>32/64 bit</td><td>Class Metadata Address</td><td>Con trỏ đến dữ liệu loại của đối tượng</td></tr><tr><td>32/64 bit</td><td>Array length</td><td>Độ dài của mảng (nếu là mảng)</td></tr></tbody></table><p>Hãy cùng xem định dạng của <code>Mark Word</code>:</p><table><thead><tr><th>Trạng thái khóa</th><th>29 bit hoặc 61 bit</th><th>1 bit Khóa thiên vị?</th><th>2 bit Trạng thái khóa</th></tr></thead><tbody><tr><td>Không khóa</td><td></td><td>0</td><td>01</td></tr><tr><td>Khóa thiên vị</td><td>ID của luồng</td><td>1</td><td>01</td></tr><tr><td>Khóa nhẹ</td><td>Con trỏ tới bản ghi khóa trong ngăn xếp</td><td>Bit này không dùng để đánh dấu khóa thiên vị</td><td>00</td></tr><tr><td>Khóa nặng</td><td>Con trỏ tới khóa nặng</td><td>Bit này không dùng để đánh dấu khóa thiên vị</td><td>10</td></tr><tr><td>Đánh dấu GC</td><td></td><td>Bit này không dùng để đánh dấu khóa thiên vị</td><td>11</td></tr></tbody></table><p>Khi trạng thái của đối tượng là khóa thiên vị, <code>Mark Word</code> lưu trữ ID của luồng đang sở hữu khóa; khi là khóa nhẹ, <code>Mark Word</code> lưu trữ con trỏ tới <code>Lock Record</code> trong ngăn xếp của luồng; khi là khóa nặng, <code>Mark Word</code> là con trỏ tới đối tượng monitor (giám sát) trong bộ nhớ heap.</p><blockquote><p>Trong Java, &quot;monitor&quot; là một công cụ đồng bộ hóa được sử dụng để bảo vệ dữ liệu chia sẻ, tránh việc truy cập không đồng bộ của nhiều luồng gây ra sự không nhất quán trong dữ liệu. Mỗi đối tượng trong Java đều có một monitor tích hợp sẵn.</p></blockquote><p>Monitor bao gồm hai phần quan trọng, một là khóa, và phần còn lại là cơ chế chờ/thông báo, được thực hiện thông qua các phương thức <code>wait()</code>, <code>notify()</code>, <code>notifyAll()</code> của lớp <code>Object</code> (chúng ta sẽ tìm hiểu chi tiết khi nói về <a class="route-link" href="/programming/java/Concurency/condition.html">Condition</a> và <a href="./producer-consumer">mô hình sản xuất-tiêu thụ</a>).</p><p>Bây giờ, chúng ta sẽ lần lượt giới thiệu các loại khóa này và cách chúng được nâng cấp.</p><p>Dưới đây là bản dịch tiếng Việt của đoạn văn bạn cung cấp:</p><h2 id="khoa-thien-vi" tabindex="-1"><a class="header-anchor" href="#khoa-thien-vi"><span>Khoá thiên vị</span></a></h2><p>Tác giả của Hotspot đã nhận thấy rằng trong hầu hết các trường hợp, <strong>khóa không chỉ không có sự cạnh tranh giữa các luồng, mà còn luôn được cùng một luồng nắm giữ nhiều lần</strong>, vì vậy đã giới thiệu khoá thiên vị.</p><p>khoá thiên vị sẽ thiên về luồng đầu tiên truy cập khóa; nếu trong quá trình chạy tiếp theo, khóa đó không bị truy cập bởi các luồng khác, thì luồng nắm giữ khoá thiên vị sẽ không cần kích hoạt đồng bộ hóa. Nói cách khác, <strong>khoá thiên vị trong trường hợp không có cạnh tranh tài nguyên đã loại bỏ câu lệnh đồng bộ hóa</strong>, không cần thực hiện thao tác <a href="./cas">CAS</a> (sẽ được nói chi tiết hơn sau, nhấn vào liên kết để đến). Điều này đã cải thiện hiệu suất chạy của chương trình một cách đáng kể.</p><p>Nói đơn giản, đó là việc thiết lập một biến cho khóa. Nếu biến này là true, nghĩa là không có cạnh tranh tài nguyên, thì không cần thực hiện các quy trình khóa/mở khóa. Nếu biến này là false, nghĩa là có luồng khác đang cạnh tranh tài nguyên, thì sẽ chuyển sang quy trình sau.</p><h3 id="nguyen-ly-thuc-hien-khoa-thien-vi" tabindex="-1"><a class="header-anchor" href="#nguyen-ly-thuc-hien-khoa-thien-vi"><span>Nguyên lý thực hiện khoá thiên vị</span></a></h3><p>Khi một luồng lần đầu tiên vào khối đồng bộ, nó sẽ lưu trữ ThreadId thiên về khóa trong đầu đối tượng và bản ghi khóa trong khung ngăn xếp. Khi lần sau luồng này vào khối đồng bộ này, nó sẽ kiểm tra xem ThreadId trong Mark Word của khóa có phải là ID của chính nó hay không.</p><p>Nếu đúng, điều đó có nghĩa là luồng này đã nắm giữ khóa, và sau đó luồng này không cần thực hiện thao tác CAS để khóa và mở khóa khi vào và ra khỏi khối đồng bộ; nếu không, điều đó có nghĩa là có một luồng khác đang cạnh tranh khoá thiên vị này. Lúc này, nó sẽ cố gắng sử dụng CAS để thay thế ThreadId trong Mark Word bằng ID của luồng mới. Lúc này, sẽ có hai trường hợp xảy ra:</p><ul><li>Thành công, có nghĩa là luồng trước đó không còn tồn tại, ThreadId trong Mark Word sẽ là ID của luồng mới, khóa sẽ không được nâng cấp, vẫn là khoá thiên vị.</li><li>Thất bại, có nghĩa là luồng trước đó vẫn tồn tại, vì vậy sẽ tạm dừng luồng trước đó, đặt cờ hiệu khoá thiên vị thành 0 và đặt cờ khóa thành 00, nâng cấp thành khóa nhẹ, sẽ cạnh tranh khóa theo cách của khóa nhẹ.</li></ul><p><a href="./cas">CAS: So sánh và Hoán đổi</a> sẽ được nói chi tiết hơn sau, nhưng ở đây chỉ cần biết sơ lược.</p><p>CAS có nghĩa là so sánh và thiết lập, được sử dụng để cung cấp thao tác nguyên tử ở cấp độ phần cứng. Trong một số kiến trúc bộ xử lý (như x86), việc so sánh và hoán đổi được thực hiện thông qua lệnh CMPXCHG (Compare and Exchange), một lệnh nguyên tử, thông qua việc so sánh xem có khớp với giá trị đã cho hay không; nếu có thì sẽ sửa đổi, nếu không khớp thì sẽ không sửa đổi.</p><p>Quá trình cạnh tranh khoá thiên vị của các luồng như sau:</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/synchronized-20230728110319.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>Hình ảnh trên liên quan đến con trỏ bản ghi khóa trỏ đến bản ghi khóa gần nhất trong ngăn xếp hiện tại, khóa nhẹ được thực hiện theo kiểu phục vụ theo thứ tự đến.</p><h3 id="huy-bo-khoa-thien-vi" tabindex="-1"><a class="header-anchor" href="#huy-bo-khoa-thien-vi"><span>Hủy bỏ khoá thiên vị</span></a></h3><p>khoá thiên vị sử dụng một <strong>cơ chế giải phóng khóa khi có sự cạnh tranh xảy ra</strong>, vì vậy khi các luồng khác cố gắng cạnh tranh khoá thiên vị, thì luồng đang giữ khoá thiên vị mới giải phóng khóa.</p><p>Khi khoá thiên vị nâng cấp thành khóa nhẹ, sẽ tạm dừng luồng đang nắm giữ khoá thiên vị và thiết lập lại cờ khoá thiên vị. Quá trình này nhìn có vẻ đơn giản, nhưng thực tế tiêu tốn chi phí rất lớn, quá trình tổng quát như sau:</p><ol><li>Tại một điểm an toàn (tại thời điểm này không có mã byte nào đang thực thi), tạm dừng luồng đang nắm giữ khóa.</li><li>Duyệt qua ngăn xếp luồng, nếu có bản ghi khóa, cần sửa chữa bản ghi khóa và Mark Word để chúng trở thành trạng thái không khóa.</li><li>Đánh thức luồng đã bị tạm dừng và nâng cấp khóa hiện tại thành khóa nhẹ.</li></ol><p>Vì vậy, nếu trong ứng dụng của bạn, tất cả các khóa thường ở trong trạng thái cạnh tranh, thì khoá thiên vị sẽ trở thành một gánh nặng. Trong trường hợp này, chúng ta có thể tắt tính năng khoá thiên vị mặc định ngay từ đầu:</p><div class="language-java" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#abb2bf;--shiki-dark:#abb2bf;--shiki-light-bg:#282c34;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;">-</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">XX</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">:</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">UseBiasedLocking</span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#D19A66;--shiki-dark:#D19A66;">false</span></span></code></pre></div><p>Hình ảnh dưới đây tóm tắt việc nhận và hủy bỏ khoá thiên vị:</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/synchronized-20230728112620.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h2 id="khoa-nhe" tabindex="-1"><a class="header-anchor" href="#khoa-nhe"><span>Khóa nhẹ</span></a></h2><p>Khi nhiều luồng nhận cùng một khóa tại các thời điểm khác nhau, tức là không có sự cạnh tranh khóa, cũng không có luồng nào bị chặn. Để xử lý tình huống này, JVM áp dụng khóa nhẹ nhằm tránh việc chặn và đánh thức luồng.</p><p>JVM sẽ tạo ra một không gian để lưu trữ bản ghi khóa cho mỗi luồng trong khung ngăn xếp của luồng hiện tại, chúng ta gọi là Displaced Mark Word. Nếu một luồng khi nhận khóa thấy đó là khóa nhẹ, nó sẽ sao chép Mark Word của khóa vào Displaced Mark Word của chính nó.</p><p>Sau đó, luồng sẽ cố gắng sử dụng CAS để thay thế Mark Word của khóa bằng con trỏ trỏ đến bản ghi khóa. Nếu thành công, luồng hiện tại sẽ nắm giữ khóa; nếu thất bại, điều đó có nghĩa là Mark Word đã được thay thế bằng bản ghi khóa của luồng khác, tức là luồng hiện tại đang cạnh tranh khóa với luồng khác, và sẽ cố gắng sử dụng vòng lặp để nhận khóa.</p><blockquote><p>Vòng lặp: liên tục cố gắng để nhận khóa, thường được thực hiện bằng vòng lặp.</p></blockquote><p>Vòng lặp tiêu tốn CPU, nếu không thể nhận khóa liên tục, thì luồng đó sẽ ở trong trạng thái vòng lặp, lãng phí tài nguyên CPU. Cách đơn giản nhất để giải quyết vấn đề này là chỉ định số lần vòng lặp, ví dụ như cho nó lặp lại 10 lần, nếu vẫn không nhận được khóa, thì sẽ chuyển vào trạng thái bị chặn.</p><p>Tuy nhiên, JDK đã áp dụng một cách tiếp cận thông minh hơn—vòng lặp thích ứng, đơn giản mà nói, nếu luồng đã thành công trong vòng lặp, số lần vòng lặp tiếp theo sẽ nhiều hơn; nếu vòng lặp thất bại, số lần vòng lặp sẽ giảm đi.</p><p>Vòng lặp cũng không phải diễn ra mãi mãi. Nếu sau một mức độ nhất định (liên quan đến JVM và hệ điều hành), mà vẫn không thể nhận khóa, được gọi là vòng lặp thất bại, thì luồng đó sẽ bị chặn. Đồng thời, khóa này sẽ <strong>nâng cấp thành khóa nặng</strong>.</p><h3 id="giai-phong-khoa-nhe" tabindex="-1"><a class="header-anchor" href="#giai-phong-khoa-nhe"><span>Giải phóng khóa nhẹ</span></a></h3><p>Khi giải phóng khóa, luồng hiện tại sẽ sử dụng thao tác CAS để sao chép nội dung của Displaced Mark Word trở lại Mark Word của khóa. Nếu không xảy ra cạnh tranh, thì thao tác sao chép này sẽ thành công. Nếu có luồng khác đã nhiều lần vòng lặp và dẫn đến việc khóa nhẹ nâng cấp thành khóa nặng, thì thao tác CAS sẽ thất bại. Lúc này, khóa sẽ được giải phóng và đánh thức luồng đã bị chặn.</p><p>Một hình ảnh minh họa quá trình khóa và giải phóng khóa:</p><figure><img src="https://cdn.tobebetterjavaer.com/stutymore/synchronized-20230728114101.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h2 id="khoa-nang" tabindex="-1"><a class="header-anchor" href="#khoa-nang"><span>Khóa nặng</span></a></h2><p>Khóa nặng phụ thuộc vào mutex (khóa tương hỗ, được sử dụng để đảm bảo rằng tại bất kỳ thời điểm nào, chỉ có một luồng có thể thực thi một đoạn mã cụ thể) của hệ điều hành để thực hiện, và việc chuyển đổi trạng thái giữa các luồng trong hệ điều hành cần một khoảng thời gian tương đối dài, vì vậy khóa nặng có hiệu suất rất thấp, nhưng luồng bị chặn sẽ không tiêu tốn CPU.</p><p>Như đã nói trước đó, mỗi đối tượng có thể được coi là một khóa. Khi nhiều luồng đồng thời yêu cầu khóa của một đối tượng nào đó, khóa đối tượng sẽ thiết lập một số trạng thái để phân biệt các luồng yêu cầu:</p><ul><li>Contention List: Tất cả các luồng yêu cầu khóa sẽ được đưa vào hàng đợi cạnh tranh này trước tiên.</li><li>Entry List：Các luồng đủ điều kiện trở thành ứng cử viên từ Connection List sẽ được chuyển vào Entry List.</li><li>Wait Set: Những luồng bị chặn vì gọi phương thức wait sẽ được đặt vào Wait Set.</li><li>OnDeck: Mỗi thời điểm chỉ có một luồng đang cạnh tranh khóa, luồng đó được gọi là OnDeck.</li><li>Owner: Luồng đã nhận khóa được gọi là Owner.</li><li>!Owner: Luồng đã giải phóng khóa.</li></ul><p>Khi một luồng cố gắng nhận khóa, nếu khóa đó đã bị chiếm, luồng đó sẽ được bao gói thành một đối tượng <code>ObjectWaiter</code> và chèn vào đầu danh sách Cạnh tranh, sau đó gọi phương thức <code>park</code> để tạm dừng luồng hiện tại.</p><p>Khi luồng giải phóng khóa, nó sẽ chọn một luồng từ Danh sách Cạnh tranh hoặc Danh sách Nhập để đánh thức, luồng được chọn gọi là <code>Heir presumptive</code> (người thừa kế giả định), người thừa kế giả định sẽ được đánh thức và sẽ cố gắng nhận khóa, nhưng <code>synchronized</code> là không công bằng, vì vậy người thừa kế giả định không nhất thiết phải nhận được khóa.</p><p>Điều này là bởi vì đối với khóa nặng, nếu luồng cố gắng nhận khóa mà thất bại, nó sẽ trực tiếp vào trạng thái bị chặn, chờ đợi sự điều phối của hệ điều hành.</p><p>Nếu luồng đã nhận khóa gọi phương thức <code>Object.wait</code>, thì sẽ đặt luồng đó vào Wait Set. Khi được <code>Object.notify</code> đánh thức, luồng sẽ được di chuyển từ Wait Set đến Danh sách Cạnh tranh hoặc Danh sách Nhập. Cần lưu ý rằng khi gọi phương thức <code>wait</code> hoặc <code>notify</code> của một đối tượng khóa, <strong>nếu trạng thái hiện tại của khóa là khoá thiên vị hoặc khóa nhẹ thì sẽ nâng cấp thành khóa nặng</strong>.</p><h2 id="quy-trinh-nang-cap-khoa" tabindex="-1"><a class="header-anchor" href="#quy-trinh-nang-cap-khoa"><span>Quy trình nâng cấp khóa</span></a></h2><p>Mỗi luồng khi chuẩn bị nhận tài nguyên chia sẻ sẽ thực hiện các bước sau:</p><ol><li><p>Bước đầu tiên, kiểm tra xem Mark Word có chứa ThreadId của chính mình không, nếu có, điều đó có nghĩa là luồng hiện tại đang ở trạng thái &quot;khoá thiên vị&quot;.</p></li><li><p>Bước thứ hai, nếu Mark Word không phải là ThreadId của chính mình, khóa sẽ được nâng cấp. Lúc này, sẽ sử dụng CAS để thực hiện việc chuyển đổi. Luồng mới sẽ thông báo cho luồng trước đó tạm dừng theo ThreadId hiện có trong Mark Word, luồng trước đó sẽ đặt nội dung của Mark Word thành rỗng.</p></li><li><p>Bước thứ ba, cả hai luồng sẽ sao chép HashCode của đối tượng khóa vào không gian bản ghi khóa mà họ mới tạo ra, sau đó bắt đầu cạnh tranh Mark Word bằng cách sửa đổi nội dung của Mark Word của đối tượng khóa thành địa chỉ của không gian bản ghi mà họ vừa tạo.</p></li><li><p>Bước thứ tư, luồng nào thực hiện thành công CAS trong bước ba sẽ nhận được tài nguyên; luồng thất bại sẽ vào trạng thái vòng lặp.</p></li><li><p>Bước thứ năm, luồng trong quá trình vòng lặp, nếu thành công nhận được tài nguyên (tức là luồng trước đó đã hoàn thành và giải phóng tài nguyên chia sẻ), thì trạng thái sẽ vẫn ở trạng thái khóa nhẹ. Nếu vòng lặp thất bại.</p></li><li><p>Bước thứ sáu, sẽ vào trạng thái khóa nặng, lúc này, luồng trong trạng thái vòng lặp sẽ bị chặn, chờ luồng trước đó thực hiện xong và đánh thức mình.</p></li></ol><h2 id="tom-tat" tabindex="-1"><a class="header-anchor" href="#tom-tat"><span>Tóm tắt</span></a></h2><ul><li>Mỗi đối tượng trong Java đều có thể hoạt động như một khóa, và các khóa trong Java đều dựa trên đối tượng.</li><li>Từ khóa synchronized có thể được sử dụng để sửa đổi phương thức và khối mã, đảm bảo rằng tại cùng một thời điểm chỉ có một luồng thực thi đoạn mã đó.</li><li>Từ khóa synchronized khi sửa đổi phương thức sẽ khóa đối tượng hiện tại; khi sửa đổi phương thức tĩnh, khóa sẽ là đối tượng Class hiện tại; khi sửa đổi khối mã, khóa sẽ là đối tượng trong dấu ngoặc đơn.</li><li>Java 6 đã giới thiệu &quot;khoá thiên vị&quot; và &quot;khóa nhẹ&quot; để giảm thiểu chi phí hiệu suất do việc nhận và giải phóng khóa. Trước Java 6, tất cả các khóa đều là &quot;khóa nặng&quot;. Do đó, trong Java 6 và sau đó, mỗi đối tượng thực sự có bốn trạng thái khóa, từ thấp đến cao: trạng thái không khóa, trạng thái khoá thiên vị, trạng thái khóa nhẹ và trạng thái khóa nặng.</li><li>khoá thiên vị thiên về luồng đầu tiên truy cập khóa; nếu trong quá trình chạy tiếp theo, khóa đó không bị truy cập bởi các luồng khác, thì luồng nắm giữ khoá thiên vị sẽ không bao giờ cần kích hoạt đồng bộ hóa. Nói cách khác, khoá thiên vị trong trường hợp không có cạnh tranh tài nguyên đã loại bỏ câu lệnh đồng bộ hóa, không cần thực hiện cả thao tác CAS, và cải thiện hiệu suất chạy của chương trình.</li><li>Khóa nhẹ được thực hiện thông qua thao tác CAS và vòng lặp; nếu vòng lặp thất bại, khóa sẽ nâng cấp thành khóa nặng.</li><li>Khóa nặng phụ thuộc vào mutex của hệ điều hành để thực hiện, và việc chuyển đổi trạng thái giữa các luồng trong hệ điều hành cần một khoảng thời gian tương đối dài, vì vậy khóa nặng có hiệu suất rất thấp, nhưng luồng bị chặn sẽ không tiêu tốn CPU.</li></ul></div><!----><footer class="vp-page-meta"><div class="vp-meta-item edit-link"><a class="auto-link external-link vp-meta-label" href="https://github.com/vanhung4499/my-wiki/edit/main/src/programming/java/Concurency/synchronized.md" aria-label="Edit this page on GitHub" rel="noopener noreferrer" target="_blank"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon" name="edit"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->Edit this page on GitHub<!----></a></div><div class="vp-meta-item git-info"><div class="update-time"><span class="vp-meta-label">Last update: </span><!----></div><div class="contributors"><span class="vp-meta-label">Contributors: </span><!--[--><!--[--><span class="vp-meta-info" title="email: vanhung4499@gmail.com">Hung Nguyen Van</span><!--]--><!--]--></div></div></footer><nav class="vp-page-nav"><a class="route-link auto-link prev" href="/programming/java/Concurency/synchronized-1.html" aria-label="Synchronized"><div class="hint"><span class="arrow start"></span>Prev</div><div class="link"><!---->Synchronized</div></a><!----></nav><!----><!----><!--]--></main><!--]--><footer class="footer-wrapper" style="display:none;--1ea755b8:;"><div class="footer-content"><div class="footer">Made with ❤️ by Hung Nguyen</div><div class="copyright">Copyright © 2016-2024 Hung Nguyen</div></div><span id="runtime_span"></span></footer></div><!--]--><!--[--><!----><!----><!----><!----><!--]--><!--]--></div>
    <script type="module" src="/assets/app-5QVbWi7Z.js" defer></script>
  </body>
</html>
