<!doctype html>
<html lang="en-US" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.15" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.52" />
    <style>
      html {
        background: var(--bg-color, #fff);
      }

      html[data-theme="dark"] {
        background: var(--bg-color, #1d1e1f);
      }

      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <meta property="og:url" content="https://vanhung4499.github.io/project/pmhub/degrade.html"><meta property="og:site_name" content="VanHung4499"><meta property="og:title" content="Degrade with OpenFeign & Sentinel"><meta property="og:description" content="PmHub - Degrade with OpenFeign & Sentinel Bài viết này chủ yếu nói về cách tích hợp OpenFeign và Sentinel trong PmHub để thực hiện dịch vụ fallback tùy chỉnh khi hạ cấp dịch vụ,..."><meta property="og:type" content="article"><meta property="og:image" content="https://user-images.githubusercontent.com/9434884/62410811-cd871680-b61d-11e9-9df7-3ee41c618644.png"><meta property="og:locale" content="en-US"><meta property="og:updated_time" content="2024-10-02T17:20:50.000Z"><meta property="article:author" content="Hung Nguyen"><meta property="article:tag" content="java"><meta property="article:tag" content="microservice"><meta property="article:modified_time" content="2024-10-02T17:20:50.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"Degrade with OpenFeign & Sentinel","image":["https://user-images.githubusercontent.com/9434884/62410811-cd871680-b61d-11e9-9df7-3ee41c618644.png","https://user-images.githubusercontent.com/9434884/69955207-1e5d3c00-1538-11ea-9ab2-297efff32809.png","https://raw.githubusercontent.com/vanhung4499/images/master/snap/20240918203157.png","https://user-images.githubusercontent.com/9434884/70883552-4ce61700-200e-11ea-8324-e803d0753a20.png","https://cdn.nlark.com/yuque/0/2024/png/29495295/1718927860066-b10632b1-ad29-4e48-8f84-3c4db5a27471.png","https://cdn.nlark.com/yuque/0/2024/png/29495295/1718929039666-f0de17a3-66dd-447f-9382-6329a6737b7e.png","https://raw.githubusercontent.com/vanhung4499/images/master/snap/pmhub-login-flow.png","https://cdn.nlark.com/yuque/0/2024/png/29495295/1718934610770-55fa2bc1-99e6-4eef-9c13-4fabe5a486bb.png","https://raw.githubusercontent.com/vanhung4499/images/master/snap/pmhub-login-degrade.drawio.png"],"dateModified":"2024-10-02T17:20:50.000Z","author":[{"@type":"Person","name":"Hung Nguyen","url":"https://vanhung4499.github.io"}]}</script><meta name="referrer" content="no-referrer-when-downgrade"><link rel="alternate" type="application/rss+xml" href="https://vanhung4499.github.io/rss.xml" title="VanHung4499 RSS Feed"><title>Degrade with OpenFeign & Sentinel | VanHung4499</title><meta name="description" content="PmHub - Degrade with OpenFeign & Sentinel Bài viết này chủ yếu nói về cách tích hợp OpenFeign và Sentinel trong PmHub để thực hiện dịch vụ fallback tùy chỉnh khi hạ cấp dịch vụ,...">
    <link rel="preload" href="/assets/style-DFXXOFfS.css" as="style"><link rel="stylesheet" href="/assets/style-DFXXOFfS.css">
    <link rel="modulepreload" href="/assets/app-CIGQMwlz.js"><link rel="modulepreload" href="/assets/degrade.html-uAgIl5Ul.js">
    
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">Skip to main content</a><!--]--><div class="theme-container no-sidebar external-link-icon has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!----><!--[--><a class="route-link vp-brand" href="/"><img class="vp-nav-logo" src="/logo.svg" alt><!----><span class="vp-site-name hide-in-pad">VanHung4499</span></a><!--]--><!----></div><div class="vp-navbar-center"><!----><!--[--><nav class="vp-nav-links"><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/" aria-label="Home"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="mdi:home" width="1em" height="1em"></iconify-icon><!--]-->Home<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/wiki.html" aria-label="Wiki"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="carbon:wikis" width="1em" height="1em"></iconify-icon><!--]-->Wiki<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/dsa/" aria-label="Algorithms"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="hugeicons:algorithm" width="1em" height="1em"></iconify-icon><!--]-->Algorithms<!----></a></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="Programming"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="mdi:code" width="1em" height="1em"></iconify-icon>Programming<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/programming/java/" aria-label="Java"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:java" width="1em" height="1em"></iconify-icon><!--]-->Java<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/programming/golang/" aria-label="Golang"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:go" width="1em" height="1em"></iconify-icon><!--]-->Golang<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/programming/js/" aria-label="JavaScript"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:javascript" width="1em" height="1em"></iconify-icon><!--]-->JavaScript<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/programming/ts/" aria-label="TypeScript"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:typescript" width="1em" height="1em"></iconify-icon><!--]-->TypeScript<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/programming/python/" aria-label="Python"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:python" width="1em" height="1em"></iconify-icon><!--]-->Python<!----></a></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="Database"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="mdi:database" width="1em" height="1em"></iconify-icon>Database<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/database/sql/" aria-label="SQL"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="mdi:sql-query" width="1em" height="1em"></iconify-icon><!--]-->SQL<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/database/mysql/" aria-label="MySQL"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:mysql" width="1em" height="1em"></iconify-icon><!--]-->MySQL<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/database/mongodb/" aria-label="MongoDB"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:mongodb" width="1em" height="1em"></iconify-icon><!--]-->MongoDB<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/database/redis/" aria-label="Redis"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:redis" width="1em" height="1em"></iconify-icon><!--]-->Redis<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/database/elasticsearch/" aria-label="Elasticsearch"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:elasticsearch" width="1em" height="1em"></iconify-icon><!--]-->Elasticsearch<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/database/elastic/" aria-label="Elastic Stack"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="cib:elastic-stack" width="1em" height="1em"></iconify-icon><!--]-->Elastic Stack<!----></a></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="Framework"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="simple-icons:framework" width="1em" height="1em"></iconify-icon>Framework<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/framework/spring/" aria-label="Spring"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:spring" width="1em" height="1em"></iconify-icon><!--]-->Spring<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/framework/spring-boot/" aria-label="Spring Boot"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:spring" width="1em" height="1em"></iconify-icon><!--]-->Spring Boot<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/framework/nestjs/" aria-label="NestJS"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:nestjs" width="1em" height="1em"></iconify-icon><!--]-->NestJS<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/framework/gin/" aria-label="Gin"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="logos:gin" width="1em" height="1em"></iconify-icon><!--]-->Gin<!----></a></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="DevOps"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon-plain:azuredevops" width="1em" height="1em"></iconify-icon>DevOps<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/devops/docker/" aria-label="Docker"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:docker" width="1em" height="1em"></iconify-icon><!--]-->Docker<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/devops/kubernetes/" aria-label="Kubernetes"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:kubernetes" width="1em" height="1em"></iconify-icon><!--]-->Kubernetes<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/devops/jenkins/" aria-label="Jenkins"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:jenkins" width="1em" height="1em"></iconify-icon><!--]-->Jenkins<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/devops/git/" aria-label="Git"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:git" width="1em" height="1em"></iconify-icon><!--]-->Git<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/devops/linux/" aria-label="Linux"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:linux" width="1em" height="1em"></iconify-icon><!--]-->Linux<!----></a></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="Design"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="tdesign:system-sum" width="1em" height="1em"></iconify-icon>Design<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/design/design-pattern/" aria-label="Design Pattern"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="tabler:grid-pattern" width="1em" height="1em"></iconify-icon><!--]-->Design Pattern<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/design/system-design/" aria-label="System Design"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="icon-park-outline:system" width="1em" height="1em"></iconify-icon><!--]-->System Design<!----></a></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="Project"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="ant-design:project-outlined" width="1em" height="1em"></iconify-icon>Project<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/project/rouyi-vue-pro/" aria-label="Rouyi Vue Pro"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:spring" width="1em" height="1em"></iconify-icon><!--]-->Rouyi Vue Pro<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/project/yudao-cloud/" aria-label="Yudao Cloud"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="devicon:spring" width="1em" height="1em"></iconify-icon><!--]-->Yudao Cloud<!----></a></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/interview/" aria-label="Interview"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="mdi:account-tie" width="1em" height="1em"></iconify-icon><!--]-->Interview<!----></a></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="About"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="mdi:about" width="1em" height="1em"></iconify-icon>About<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/about-me.html" aria-label="About me"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="cib:about-me" width="1em" height="1em"></iconify-icon><!--]-->About me<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/about.html" aria-label="About"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="mdi:about" width="1em" height="1em"></iconify-icon><!--]-->About<!----></a></li></ul></button></div></div></nav><!--]--><!----></div><div class="vp-navbar-end"><!----><!--[--><!----><div class="vp-nav-item vp-action"><a class="vp-action-link" href="https://github.com/vanhung4499/my-wiki" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" name="github" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="vp-nav-item hide-in-mobile"><button type="button" class="vp-outlook-button" tabindex="-1" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon outlook-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="outlook icon" name="outlook"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4 38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32 51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0 102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2 6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4 0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2 9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224 419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4 470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0 22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6 12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128 505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2 16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8 86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4 80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6 6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg><div class="vp-outlook-dropdown"><!----></div></button></div><!--[--><button type="button" class="search-pro-button" aria-label="Search"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon" name="search"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="search-pro-placeholder">Search</div><div class="search-pro-key-hints"><kbd class="search-pro-key">Ctrl</kbd><kbd class="search-pro-key">K</kbd></div></button><!--]--><!--]--><!----><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!----><ul class="vp-sidebar-links"></ul><!----></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->Degrade with OpenFeign &amp; Sentinel</h1><div class="page-info"><span class="page-author-info" aria-label="Author🖊" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon" name="author"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="page-author-item" href="https://vanhung4499.github.io" target="_blank" rel="noopener noreferrer">Hung Nguyen</a></span><span property="author" content="Hung Nguyen"></span></span><!----><span class="page-date-info" aria-label="Writing Date📅" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon" name="calendar"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2024-10-02T17:20:50.000Z"></span><!----><span class="page-reading-time-info" aria-label="Reading Time⌛" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon" name="timer"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>About 18 min</span><meta property="timeRequired" content="PT18M"></span><span class="page-category-info" aria-label="Category🌈" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon" name="category"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><!--[--><span class="page-category-item color6 clickable" role="navigation">project</span><!--]--><meta property="articleSection" content="project"></span><span class="page-tag-info" aria-label="Tag🏷" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon" name="tag"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><!--[--><span class="page-tag-item color8 clickable" role="navigation">java</span><span class="page-tag-item color2 clickable" role="navigation">microservice</span><!--]--><meta property="keywords" content="java,microservice"></span></div><hr></div><div class="vp-toc-placeholder"><aside id="toc"><!----><div class="vp-toc-header">On This Page<button type="button" class="print-button" title="Print"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon" name="print"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button><div class="arrow end"></div></div><div class="vp-toc-wrapper"><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#cat-giam-dich-vu-khi-qua-tai">Cắt giảm dịch vụ khi quá tải</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#tong-quan">Tổng quan</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#cat-giam-va-ha-cap-trong-sentinel">Cắt giảm và hạ cấp trong Sentinel</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#nguyen-ly-sentinel">Nguyên lý Sentinel</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#tai-va-cai-đat-sentinel">Tải và cài đặt Sentinel</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#su-dung-sentinel-ket-hop-gateway-va-sentinel-đe-gioi-han-luu-luong-truy-cap-gateway">Sử dụng Sentinel - Kết hợp Gateway và Sentinel để giới hạn lưu lượng truy cập Gateway</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#them-cac-dependency">Thêm các dependency</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#chinh-sua-tep-yml">Chỉnh sửa tệp yml</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#cau-hinh-luu-tru-nacos">Cấu hình lưu trữ Nacos</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#xem-bang-đieu-khien-sentinel">Xem bảng điều khiển Sentinel</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#gioi-thieu-ve-quy-tac-kiem-soat-luu-luong">Giới thiệu về quy tắc kiểm soát lưu lượng</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#tich-hop-openfeign-va-sentinel-đe-thuc-hien-fallback-tuy-chinh-khi-ha-cap-dich-vu">Tích hợp OpenFeign và Sentinel để thực hiện fallback tùy chỉnh khi hạ cấp dịch vụ</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#annotation-sentinelresource">Annotation @SentinelResource</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#giai-thich-nghiep-vu">Giải thích nghiệp vụ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#pmhub-thuc-chien">PmHub Thực Chiến</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#cau-hoi-phong-van">Câu hỏi phỏng vấn</a></li><!----><!--]--></ul><div class="vp-toc-marker" style="top:-1.7rem;"></div></div><!----></aside></div><!----><div class="theme-hope-content"><h1 id="pmhub-degrade-with-openfeign-sentinel" tabindex="-1"><a class="header-anchor" href="#pmhub-degrade-with-openfeign-sentinel"><span>PmHub - Degrade with OpenFeign &amp; Sentinel</span></a></h1><p>Bài viết này chủ yếu nói về cách tích hợp OpenFeign và Sentinel trong PmHub để thực hiện dịch vụ <strong>fallback</strong> tùy chỉnh khi hạ cấp dịch vụ, cũng như cách sử dụng Sentinel và Gateway để giới hạn tốc độ trên cổng.</p><div class="hint-container info"><p class="hint-container-title">Info</p><ul><li>Tích hợp OpenFeign và Sentinel để thực hiện <strong>hạ cấp dịch vụ</strong> thông qua fallback tùy chỉnh, giúp giảm tải cho dịch vụ. Tích hợp Sentinel và Gateway để giới hạn lưu lượng trên cổng.</li></ul></div><h2 id="cat-giam-dich-vu-khi-qua-tai" tabindex="-1"><a class="header-anchor" href="#cat-giam-dich-vu-khi-qua-tai"><span>Cắt giảm dịch vụ khi quá tải</span></a></h2><h3 id="tong-quan" tabindex="-1"><a class="header-anchor" href="#tong-quan"><span>Tổng quan</span></a></h3><p>Ngoài việc kiểm soát lưu lượng, việc cắt giảm và hạ cấp các tài nguyên không ổn định trong chuỗi gọi cũng là một biện pháp quan trọng để đảm bảo tính khả dụng cao. Một dịch vụ thường xuyên gọi các module khác, có thể là một dịch vụ từ xa, cơ sở dữ liệu hoặc API của bên thứ ba. Ví dụ, khi thực hiện thanh toán, có thể cần gọi API do UnionPay cung cấp từ xa; hoặc khi tra cứu giá sản phẩm, có thể cần thực hiện truy vấn cơ sở dữ liệu. Tuy nhiên, tính ổn định của các dịch vụ phụ thuộc này không được đảm bảo. Nếu dịch vụ phụ thuộc gặp vấn đề không ổn định, thời gian phản hồi của yêu cầu sẽ kéo dài, gây ra tình trạng dồn ứ các luồng và cuối cùng có thể làm cạn kiệt thread pool của dịch vụ chính, khiến dịch vụ không khả dụng.</p><figure><img src="https://user-images.githubusercontent.com/9434884/62410811-cd871680-b61d-11e9-9df7-3ee41c618644.png" alt="image.png" tabindex="0" loading="lazy"><figcaption>image.png</figcaption></figure><p>Kiến trúc microservice hiện đại đều là hệ thống phân tán, bao gồm rất nhiều dịch vụ khác nhau. Các dịch vụ này gọi lẫn nhau, tạo thành chuỗi gọi phức tạp. Các vấn đề như trên có thể phóng đại trong chuỗi gọi này. Một điểm không ổn định trong chuỗi có thể gây ra phản ứng dây chuyền, làm cho toàn bộ chuỗi không khả dụng. Do đó, chúng ta cần cắt giảm và hạ cấp các dịch vụ phụ thuộc yếu để tạm thời ngắt kết nối các gọi không ổn định, ngăn ngừa sự bất ổn cục bộ gây ra &quot;hiệu ứng tuyết lở&quot; cho toàn hệ thống. Việc cắt giảm và hạ cấp này thường được cấu hình ở phía khách hàng (đầu gọi).</p><h3 id="cat-giam-va-ha-cap-trong-sentinel" tabindex="-1"><a class="header-anchor" href="#cat-giam-va-ha-cap-trong-sentinel"><span>Cắt giảm và hạ cấp trong Sentinel</span></a></h3><p>Những ai quen thuộc với microservice đều biết rằng trước đây, Hystrix là thành phần phổ biến để cắt giảm và hạ cấp dịch vụ. Tuy nhiên, Netflix đã thông báo vào cuối năm 2018 rằng họ sẽ không tiếp tục phát triển Hystrix và dự án này sẽ chuyển sang chế độ bảo trì. Vì vậy, <strong>Sentinel</strong>, một sản phẩm mã nguồn mở của Alibaba, đã trở thành giải pháp thay thế phổ biến.</p><div class="hint-container info"><p class="hint-container-title">Info</p><p>Tất nhiên, Resilience4J cũng là một sản phẩm thay thế được đề xuất chính thức cho Hystrix. Nó nhẹ, đơn giản, và tài liệu rất rõ ràng, phong phú.</p></div><blockquote><p>Vì vậy, những ai vẫn còn dạy bạn Hystrix có lẽ chưa nắm bắt được xu hướng công nghệ mới.</p></blockquote><p>Sentinel là một thành phần quản lý lưu lượng hướng đến kiến trúc dịch vụ phân tán, không đồng nhất và đa ngôn ngữ. Nó chủ yếu tập trung vào lưu lượng, từ điều khiển lưu lượng, định hình lưu lượng, cắt giảm và hạ cấp dịch vụ, bảo vệ quá tải thích ứng hệ thống, đến bảo vệ lưu lượng điểm nóng, giúp các nhà phát triển đảm bảo tính ổn định của microservice.</p><p>Những ai đã tìm hiểu về lịch sử của Sentinel chắc chắn sẽ cảm thấy ngưỡng mộ. Một framework phổ biến và cộng đồng phát triển mạnh mẽ không thể chỉ đạt được trong một sớm một chiều, mà đó là kết quả của sự phát triển liên tục.</p><h3 id="nguyen-ly-sentinel" tabindex="-1"><a class="header-anchor" href="#nguyen-ly-sentinel"><span>Nguyên lý Sentinel</span></a></h3><p>Trong Sentinel, mọi tài nguyên đều tương ứng với một tên tài nguyên và một <strong>Entry</strong>. Entry có thể được tạo tự động thông qua việc thích ứng với các framework chính hoặc tạo rõ ràng thông qua annotation hoặc gọi API. Mỗi khi một Entry được tạo, một chuỗi chức năng (slot chain) cũng sẽ được tạo.</p><p>Tổng thể kiến trúc như sau:</p><figure><img src="https://user-images.githubusercontent.com/9434884/69955207-1e5d3c00-1538-11ea-9ab2-297efff32809.png" alt="image.png" tabindex="0" loading="lazy"><figcaption>image.png</figcaption></figure><p>Sentinel mở rộng ProcessorSlot như là một interface SPI (phiên bản trước 1.7.2 thì SlotChainBuilder là SPI), giúp Slot Chain có khả năng mở rộng. Bạn có thể tự thêm các slot tùy chỉnh và sắp xếp thứ tự giữa chúng, từ đó thêm các chức năng tùy chỉnh cho Sentinel.</p><figure><img src="https://raw.githubusercontent.com/vanhung4499/images/master/snap/20240918203157.png" alt="image.png" tabindex="0" loading="lazy"><figcaption>image.png</figcaption></figure><h2 id="tai-va-cai-đat-sentinel" tabindex="-1"><a class="header-anchor" href="#tai-va-cai-đat-sentinel"><span>Tải và cài đặt Sentinel</span></a></h2><div class="hint-container info"><p class="hint-container-title">Info</p><p>**<!----></p></div><p>Địa chỉ tải xuống: <a href="https://github.com/alibaba/Sentinel/releases" target="_blank" rel="noopener noreferrer">https://github.com/alibaba/Sentinel/releases</a><br> Tài liệu: <a href="https://sentinelguard.io/en-us/docs/introduction.html" target="_blank" rel="noopener noreferrer">https://sentinelguard.io/en-us/docs/introduction.html</a></p><blockquote><p>Tôi sử dụng phiên bản 1.8.7. Bạn có thể tải theo nhu cầu của mình, nhưng nên tải phiên bản phát hành ổn định.</p></blockquote><p>Sentinel thực chất là một tệp jar, vì vậy chúng ta có thể chạy trực tiếp bằng lệnh Java, nhưng hãy đảm bảo cổng 8080 không bị chiếm dụng. Bạn có thể kiểm tra xem cổng có bị chiếm dụng không.</p><div class="language-java" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#abb2bf;--shiki-dark:#abb2bf;--shiki-light-bg:#282c34;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">lsof </span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;">-</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">i </span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">:</span><span style="--shiki-light:#D19A66;--shiki-dark:#D19A66;">8080</span></span></code></pre></div><p>Chạy lệnh khởi động:</p><div class="language-java" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#abb2bf;--shiki-dark:#abb2bf;--shiki-light-bg:#282c34;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">java </span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;">-</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">jar sentinel</span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;">-</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">dashboard</span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;">-</span><span style="--shiki-light:#D19A66;--shiki-dark:#D19A66;">1.8</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#FFFFFF;--shiki-dark:#FFFFFF;">7</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">jar</span></span></code></pre></div><p>Truy cập giao diện quản lý, nhập địa chỉ: <a href="http://localhost:8080/" target="_blank" rel="noopener noreferrer">http://localhost:8080/</a></p><p>Tên đăng nhập và mật khẩu mặc định đều là: sentinel</p><h2 id="su-dung-sentinel-ket-hop-gateway-va-sentinel-đe-gioi-han-luu-luong-truy-cap-gateway" tabindex="-1"><a class="header-anchor" href="#su-dung-sentinel-ket-hop-gateway-va-sentinel-đe-gioi-han-luu-luong-truy-cap-gateway"><span>Sử dụng Sentinel - Kết hợp Gateway và Sentinel để giới hạn lưu lượng truy cập Gateway</span></a></h2><blockquote><p>Ở đây sẽ lấy ví dụ về việc tích hợp module gateway của PmHub, các module khác cũng có thể tham khảo cách này. 🔔</p></blockquote><p>Sentinel hỗ trợ giới hạn lưu lượng truy cập đối với các API Gateway chính như Spring Cloud Gateway, Zuul.</p><figure><img src="https://user-images.githubusercontent.com/9434884/70883552-4ce61700-200e-11ea-8324-e803d0753a20.png" alt="Sơ đồ kiến trúc tích hợp Gateway của Sentinel (trang chính)" tabindex="0" loading="lazy"><figcaption>Sơ đồ kiến trúc tích hợp Gateway của Sentinel (trang chính)</figcaption></figure><p>Kể từ phiên bản 1.6.0, Sentinel đã cung cấp mô-đun tương thích với Spring Cloud Gateway, cho phép giới hạn lưu lượng truy cập theo hai cấp độ tài nguyên:</p><ul><li><strong>Cấp độ route</strong>: Tức là các mục route được cấu hình trong tệp cấu hình Spring, với tên tài nguyên là <code>routeId</code> tương ứng.</li><li><strong>Cấp độ API tùy chỉnh</strong>: Người dùng có thể sử dụng API của Sentinel để tùy chỉnh các nhóm API.</li></ul><p>Trong PmHub, chủ yếu sử dụng cấp độ route, tức là tên của các microservice tương ứng. Dưới đây là các bước cụ thể, hiểu rõ chúng, bạn sẽ nắm vững hơn.</p><h3 id="them-cac-dependency" tabindex="-1"><a class="header-anchor" href="#them-cac-dependency"><span>Thêm các dependency</span></a></h3><div class="language-xml line-numbers-mode" data-highlighter="shiki" data-ext="xml" data-title="xml" style="--shiki-light:#abb2bf;--shiki-dark:#abb2bf;--shiki-light-bg:#282c34;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">&lt;!-- Phụ thuộc chính của SpringCloud Alibaba Sentinel --&gt;</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">dependency</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">  &lt;</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">groupId</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">&gt;com.alibaba.cloud&lt;/</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">groupId</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">  &lt;</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">artifactId</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">&gt;spring-cloud-starter-alibaba-sentinel&lt;/</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">artifactId</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">&lt;/</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">dependency</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">&lt;!-- Phụ thuộc của SpringCloud Alibaba Sentinel Gateway, không cần nếu không sử dụng gateway --&gt;</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">dependency</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">  &lt;</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">groupId</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">&gt;com.alibaba.cloud&lt;/</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">groupId</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">  &lt;</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">artifactId</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">&gt;spring-cloud-alibaba-sentinel-gateway&lt;/</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">artifactId</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">&lt;/</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">dependency</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">&lt;!-- Sentinel Datasource Nacos dùng để lưu trữ dữ liệu vĩnh viễn --&gt;</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">dependency</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">  &lt;</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">groupId</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">&gt;com.alibaba.csp&lt;/</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">groupId</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">  &lt;</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">artifactId</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">&gt;sentinel-datasource-nacos&lt;/</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">artifactId</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">&lt;/</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">dependency</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">&gt;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="chinh-sua-tep-yml" tabindex="-1"><a class="header-anchor" href="#chinh-sua-tep-yml"><span>Chỉnh sửa tệp <code>yml</code></span></a></h3><div class="language-yaml line-numbers-mode" data-highlighter="shiki" data-ext="yaml" data-title="yaml" style="--shiki-light:#abb2bf;--shiki-dark:#abb2bf;--shiki-light-bg:#282c34;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">spring</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">: </span></span>
<span class="line"><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;"> cloud</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">: </span></span>
<span class="line"><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">   sentinel</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">      # Tắt lazy loading của bảng điều khiển</span></span>
<span class="line"><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">      eager</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#D19A66;--shiki-dark:#D19A66;">true</span></span>
<span class="line"><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">      transport</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        # Cấu hình địa chỉ dịch vụ bảng điều khiển</span></span>
<span class="line"><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">        dashboard</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#98C379;--shiki-dark:#98C379;">127.0.0.1:8080</span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        # Mặc định là cổng 8719, nếu bị chiếm dụng sẽ tự động tìm cổng trống từ 8719 trở lên</span></span>
<span class="line"><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">        port</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#D19A66;--shiki-dark:#D19A66;">8719</span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">      # Cấu hình lưu trữ Nacos</span></span>
<span class="line"><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">      datasource</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">        ds1</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">          nacos</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">            server-addr</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#98C379;--shiki-dark:#98C379;">127.0.0.1:8848</span></span>
<span class="line"><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">            dataId</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#98C379;--shiki-dark:#98C379;">sentinel-pmhub-gateway</span></span>
<span class="line"><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">            groupId</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#98C379;--shiki-dark:#98C379;">DEFAULT_GROUP</span></span>
<span class="line"><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">            data-type</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#98C379;--shiki-dark:#98C379;">json</span></span>
<span class="line"><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">            rule-type</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#98C379;--shiki-dark:#98C379;">gw-flow</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="cau-hinh-luu-tru-nacos" tabindex="-1"><a class="header-anchor" href="#cau-hinh-luu-tru-nacos"><span>Cấu hình lưu trữ Nacos</span></a></h3><p>Mặc định, cấu hình của Sentinel được lưu trữ trong bộ nhớ, nếu dịch vụ bị khởi động lại, các quy tắc đã được cấu hình sẽ bị mất. Để ngăn chặn điều này, cần cấu hình lưu trữ dữ liệu. Trong PmHub, Nacos đã được cấu hình để lưu trữ dữ liệu vào cơ sở dữ liệu MySQL.</p><p>Chỉ cần đưa cấu hình của Sentinel vào Nacos để quản lý tập trung. Trong bước trước, đã cấu hình lưu trữ, bạn có thể thấy tệp <code>sentinel-pmhub-gateway</code>. Tệp mặc định đã được cấu hình sẵn, bạn có thể mở Nacos để xem.</p><p>Đây chủ yếu là cấu hình quy tắc kiểm soát lưu lượng, dùng để giới hạn lưu lượng truy cập tại gateway.</p><h3 id="xem-bang-đieu-khien-sentinel" tabindex="-1"><a class="header-anchor" href="#xem-bang-đieu-khien-sentinel"><span>Xem bảng điều khiển Sentinel</span></a></h3><p>Khởi động dịch vụ gateway và mở bảng điều khiển.</p><figure><img src="https://cdn.nlark.com/yuque/0/2024/png/29495295/1718927860066-b10632b1-ad29-4e48-8f84-3c4db5a27471.png" alt="Bảng điều khiển Sentinel" tabindex="0" loading="lazy"><figcaption>Bảng điều khiển Sentinel</figcaption></figure><h3 id="gioi-thieu-ve-quy-tac-kiem-soat-luu-luong" tabindex="-1"><a class="header-anchor" href="#gioi-thieu-ve-quy-tac-kiem-soat-luu-luong"><span>Giới thiệu về quy tắc kiểm soát lưu lượng</span></a></h3><p>Sentinel có thể kiểm soát lưu lượng, chủ yếu giám sát <strong>QPS (số lượng truy vấn mỗi giây) hoặc số lượng luồng đồng thời</strong>. Nếu các chỉ số đạt đến ngưỡng đã định, lưu lượng sẽ bị kiểm soát để tránh tình trạng dịch vụ bị sụp đổ do lưu lượng truy cập cao đột ngột, từ đó đảm bảo tính ổn định của hệ thống. Ở đây lấy ví dụ về quy tắc kiểm soát lưu lượng của gateway pmhub-gateway, các tham số được mô tả dưới đây:</p><figure><img src="https://cdn.nlark.com/yuque/0/2024/png/29495295/1718929039666-f0de17a3-66dd-447f-9382-6329a6737b7e.png" alt="Quy tắc kiểm soát lưu lượng của Gateway" tabindex="0" loading="lazy"><figcaption>Quy tắc kiểm soát lưu lượng của Gateway</figcaption></figure><table><thead><tr><th>Tên tham số</th><th>Ví dụ giá trị</th><th>Giải thích</th></tr></thead><tbody><tr><td>Loại API</td><td>Route ID / Nhóm API</td><td>Chỉ định loại API mà quy tắc giới hạn áp dụng, có thể là Route ID hoặc nhóm API.</td></tr><tr><td>Tên API</td><td>pmhub-system</td><td>Tên cụ thể của API bị giới hạn lưu lượng.</td></tr><tr><td>Theo thuộc tính yêu cầu</td><td>Hộp kiểm</td><td>Có giới hạn lưu lượng theo thuộc tính yêu cầu như địa chỉ IP, danh tính người dùng hay không.</td></tr><tr><td>Loại ngưỡng</td><td>QPS / Số lượng luồng</td><td>Loại giới hạn lưu lượng, có thể là QPS hoặc số lượng luồng đồng thời.</td></tr><tr><td>Ngưỡng QPS</td><td>1000</td><td>Số lượng yêu cầu tối đa được phép trong mỗi giây. Nếu vượt qua giá trị này, giới hạn lưu lượng sẽ được kích hoạt.</td></tr><tr><td>Khoảng thời gian</td><td>1</td><td>Khoảng thời gian giới hạn lưu lượng, như 1 giây hoặc 1 phút.</td></tr><tr><td>Cách kiểm soát</td><td>Thất bại nhanh / Xếp hàng đồng đều</td><td>Khi đạt đến ngưỡng giới hạn, hệ thống sẽ từ chối yêu cầu ngay lập tức hoặc xếp hàng để xử lý yêu cầu.</td></tr><tr><td>Burst size</td><td>0</td><td>Số lượng yêu cầu cho phép vượt qua giới hạn trong một thời gian ngắn. Giá trị 0 nghĩa là không cho phép lưu lượng bùng nổ.</td></tr></tbody></table><p>Nếu loại ngưỡng là QPS, khi số lượng yêu cầu QPS đạt ngưỡng, hệ thống sẽ thực hiện giới hạn lưu lượng. Nếu loại ngưỡng là số lượng luồng, hệ thống sẽ giới hạn lưu lượng khi số luồng đồng thời đạt ngưỡng.</p><p>Trong cấu hình của <code>pmhub-system</code>, giá trị 1000 đại diện cho việc mỗi giây chỉ có thể xử lý tối đa 1000 yêu cầu.</p><h2 id="tich-hop-openfeign-va-sentinel-đe-thuc-hien-fallback-tuy-chinh-khi-ha-cap-dich-vu" tabindex="-1"><a class="header-anchor" href="#tich-hop-openfeign-va-sentinel-đe-thuc-hien-fallback-tuy-chinh-khi-ha-cap-dich-vu"><span>Tích hợp OpenFeign và Sentinel để thực hiện fallback tùy chỉnh khi hạ cấp dịch vụ</span></a></h2><h3 id="annotation-sentinelresource" tabindex="-1"><a class="header-anchor" href="#annotation-sentinelresource"><span>Annotation <code>@SentinelResource</code></span></a></h3><p>annotation <code>@SentinelResource</code> là một annotation bảo vệ tài nguyên của Sentinel, dùng để chỉ định tài nguyên được bảo vệ và thực hiện các chức năng như kiểm soát lưu lượng, cắt giảm hoặc hạ cấp dịch vụ.</p><p>Nói cách khác, nó được thêm vào các API để thực hiện các chức năng kiểm soát lưu lượng, cắt giảm, và hạ cấp dịch vụ cho từng API. Trong PmHub, API lấy thông tin người dùng trong dịch vụ hệ thống có sử dụng annotation <code>@SentinelResource</code> và đã cấu hình quy tắc kiểm soát lưu lượng, bao gồm thông báo giới hạn lưu lượng tùy chỉnh và trả về fallback khi có lỗi.</p><p>Dưới đây là quy trình tương tác dịch vụ liên quan đến API đăng nhập:</p><figure><img src="https://raw.githubusercontent.com/vanhung4499/images/master/snap/pmhub-login-flow.png" alt="pmhub-login-flow.png" tabindex="0" loading="lazy"><figcaption>pmhub-login-flow.png</figcaption></figure><p>Thêm annotation này vào API sẽ cho phép thực hiện thông báo giới hạn lưu lượng tùy chỉnh và trả về fallback khi có lỗi.</p><figure><img src="https://cdn.nlark.com/yuque/0/2024/png/29495295/1718934610770-55fa2bc1-99e6-4eef-9c13-4fabe5a486bb.png" alt="Minh họa" tabindex="0" loading="lazy"><figcaption>Minh họa</figcaption></figure><h3 id="giai-thich-nghiep-vu" tabindex="-1"><a class="header-anchor" href="#giai-thich-nghiep-vu"><span>Giải thích nghiệp vụ</span></a></h3><p>Fallback khi hạ cấp dịch vụ có nghĩa là khi một microservice gặp sự cố, người dùng sẽ nhận được thông báo về tình trạng hạ cấp, chẳng hạn như: “Dịch vụ đang bận, vui lòng thử lại sau!” Điều này nhằm tránh người dùng tiếp tục gửi yêu cầu và làm tăng gánh nặng cho microservice.</p><p>Trong ví dụ trên, fallback được thêm trực tiếp vào phương thức <code>@SentinelResource</code> của API, nhưng với các phương thức khác nhau khi gọi qua Feign, nếu thêm một phương thức fallback cho mỗi API thì mã sẽ trở nên phức tạp và khó quản lý.</p><h3 id="pmhub-thuc-chien" tabindex="-1"><a class="header-anchor" href="#pmhub-thuc-chien"><span>PmHub Thực Chiến</span></a></h3><p>Một phương pháp hiệu quả là: cấu hình thống nhất bằng thuộc tính <code>fallback</code>, tất cả các phương thức trong interface Feign đều sẽ thực hiện hạ cấp dịch vụ thông qua một phương thức chung, chỉ cần cấu hình một lần là xong.</p><p>Vậy làm sao để định nghĩa <code>fallback</code> này?</p><p>Trong PmHub, cách làm là thế này: Đối với quá trình đăng nhập, dịch vụ xác thực không thể trực tiếp gọi đến giao diện người dùng của dịch vụ hệ thống (nếu gọi trực tiếp thì sẽ không an toàn). Vì vậy, một gói chung đã được tách ra và tất cả các giao diện người dùng được đặt trong đó. Thông qua việc gọi bằng Feign, phía gọi sẽ không nhận biết được điều này. Do đó, chúng ta thực hiện hạ cấp dịch vụ chung trong module <code>pmhub-api</code>. Dưới đây là quy trình cụ thể:</p><figure><img src="https://raw.githubusercontent.com/vanhung4499/images/master/snap/pmhub-login-degrade.drawio.png" alt="pmhub-login-degrade.drawio.png" tabindex="0" loading="lazy"><figcaption>pmhub-login-degrade.drawio.png</figcaption></figure><p>Trong lớp <code>UserFeignService</code>, chỉ cần thêm thuộc tính <code>fallbackFactory</code> tùy chỉnh vào chú thích <code>@FeignClient</code> là có thể đạt được chức năng mà chúng ta mong muốn. Dưới đây là mã cụ thể.</p><p><strong>UserFeignService:</strong></p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#abb2bf;--shiki-dark:#abb2bf;--shiki-light-bg:#282c34;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">@</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">FeignClient</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#D19A66;--shiki-dark:#D19A66;">contextId</span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#98C379;--shiki-dark:#98C379;"> &quot;userFeignService&quot;</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#D19A66;--shiki-dark:#D19A66;"> value</span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> ServiceNameConstants</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">SYSTEM_SERVICE</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#D19A66;--shiki-dark:#D19A66;"> fallbackFactory</span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> UserFeginFallbackFactory</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">class</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">)</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> interface</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> UserFeignService</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    /**</span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">     * Get the current user information based on the username.</span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">     */</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">    @</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">GetMapping</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#98C379;--shiki-dark:#98C379;">&quot;/system/user/info/{username}&quot;</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">)</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">    R</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">LoginUser</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> info</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(@</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">PathVariable</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#98C379;--shiki-dark:#98C379;">&quot;username&quot;</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> username</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">, @</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">RequestHeader</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">SecurityConstants</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">FROM_SOURCE</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> source</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    /**</span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">     * Register user information.</span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">     *</span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">     * </span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">@param</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> sysUser</span><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> User information</span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">     * </span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">@param</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> source</span><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> Request source</span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">     * </span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">@return</span><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> Result</span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">     */</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">    @</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">PostMapping</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#98C379;--shiki-dark:#98C379;">&quot;/system/user/register&quot;</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">)</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">    R</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">Boolean</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> registerUserInfo</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(@</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">RequestBody</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> SysUser</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> sysUser</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">, @</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">RequestHeader</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">SecurityConstants</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">FROM_SOURCE</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> source</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Xử lý hạ cấp dịch vụ trong <code>UserFeginFallbackFactory</code>:</strong></p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#abb2bf;--shiki-dark:#abb2bf;--shiki-light-bg:#282c34;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">@</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">Component</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> UserFeginFallbackFactory</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> implements</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> FallbackFactory</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">UserFeignService</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> static</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> final</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> Logger</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;"> log </span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> LoggerFactory</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">getLogger</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">UserFeginFallbackFactory</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">class</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">    @</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">Override</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> UserFeignService</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> create</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">Throwable</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> throwable</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">        log</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">error</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#98C379;--shiki-dark:#98C379;">&quot;User service call failed: {}&quot;</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">throwable</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">getMessage</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">());</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> UserFeignService</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">() {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">            @</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">Override</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">            public</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> R</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">LoginUser</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> info</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> username</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> source</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">                return</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> R</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">fail</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#98C379;--shiki-dark:#98C379;">&quot;Failed to retrieve user: &quot;</span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;"> +</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> throwable</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">getMessage</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">());</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">            }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">            @</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">Override</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">            public</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> R</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">Boolean</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> registerUserInfo</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">SysUser</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> sysUser</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> source</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">                return</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> R</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">fail</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#98C379;--shiki-dark:#98C379;">&quot;Failed to register user: &quot;</span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;"> +</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> throwable</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">getMessage</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">());</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">            }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">        };</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Như vậy, chúng ta đã hoàn thành tích hợp OpenFeign và Sentinel để thực hiện hạ cấp dịch vụ fallback tùy chỉnh. Hiểu lý thuyết là một chuyện, nhưng thao tác thực tế không quá phức tạp.</p><h2 id="cau-hoi-phong-van" tabindex="-1"><a class="header-anchor" href="#cau-hoi-phong-van"><span>Câu hỏi phỏng vấn</span></a></h2><p><strong>Người phỏng vấn: Hãy giải thích khái niệm cache xuyên thấu, cache bị phá vỡ và cache tuyết lở là gì? Làm thế nào để giải quyết?</strong></p><p>Tôi: Cache xuyên thấu đơn giản là khi một số lượng lớn các request có key không hợp lệ, không tồn tại trong cache hoặc trong cơ sở dữ liệu. Điều này dẫn đến việc các request trực tiếp truy cập cơ sở dữ liệu, không qua lớp cache, gây ra áp lực lớn lên cơ sở dữ liệu và có thể làm hệ thống sập do quá tải request.<br><strong>Người phỏng vấn: Hãy giải thích về hiện tượng dịch vụ bị tuyết lở?</strong></p><p>Tôi: Khi nhiều microservices gọi nhau, giả sử microservice A gọi microservice B và C, trong khi B và C lại gọi các microservice khác, điều này được gọi là hiện tượng “phân tán” (fan-out). Nếu một microservice trong chuỗi này có thời gian phản hồi quá lâu hoặc không khả dụng, điều này sẽ chiếm dụng ngày càng nhiều tài nguyên hệ thống của microservice A, dẫn đến sụp đổ hệ thống, hay còn gọi là &quot;hiệu ứng tuyết lở&quot;. Đối với các ứng dụng có lưu lượng truy cập cao, việc một dịch vụ phụ thuộc vào backend duy nhất có thể khiến toàn bộ tài nguyên trên các máy chủ bị quá tải trong vài giây. Tệ hơn là việc này còn có thể gây ra sự tăng độ trễ giữa các dịch vụ, làm tắc nghẽn hàng đợi, hết tài nguyên hệ thống như luồng và gây ra các lỗi nối tiếp trên toàn hệ thống. Điều này đòi hỏi việc cách ly và quản lý lỗi cũng như độ trễ để một lỗi đơn lẻ không ảnh hưởng đến toàn bộ ứng dụng hay hệ thống.</p><p>Do đó, thường khi phát hiện một instance trong một module gặp sự cố, module đó vẫn sẽ tiếp tục nhận lưu lượng và tiếp tục gọi các module khác, dẫn đến lỗi dây chuyền, hay còn gọi là tuyết lở. Trong kiến trúc phân tán phức tạp, các ứng dụng có hàng chục sự phụ thuộc, và chắc chắn tại một số thời điểm sẽ có những sự cố không thể tránh khỏi.</p><p><strong>Người phỏng vấn: Hãy nói về hạ cấp dịch vụ (service degradation)?</strong></p><p>Tôi: Hạ cấp dịch vụ, nói đơn giản là một giải pháp dự phòng khi dịch vụ không thể thực hiện quy trình gọi thông thường, hệ thống sẽ sử dụng phương án dự phòng mặc định để trả về dữ liệu.</p><p>Ví dụ, trong trang chi tiết sản phẩm, thông tin mô tả sản phẩm thường được hiển thị. Nếu hệ thống trang chi tiết sản phẩm gặp sự cố và không thể gọi dữ liệu, hệ thống sẽ lấy thông tin sản phẩm từ bộ nhớ đệm và trả lại cho giao diện người dùng.</p><p><strong>Người phỏng vấn: Hãy nói về dịch vụ ngắt mạch (service circuit breaker)?</strong></p><p>Tôi: Trong hệ thống phân tán và microservices, khi dịch vụ phía dưới gặp phải áp lực quá lớn dẫn đến phản hồi chậm hoặc thất bại liên tục, dịch vụ phía trên sẽ tạm thời ngắt kết nối với dịch vụ phía dưới để đảm bảo tính khả dụng của toàn hệ thống. Cách này được gọi là ngắt mạch. Tương tự như cầu chì, khi đạt tới giới hạn dịch vụ, hệ thống sẽ từ chối truy cập, sau đó sử dụng phương pháp hạ cấp dịch vụ và trả về thông báo thân thiện.</p><p>Ngắt mạch thường có ba trạng thái: đóng, mở và bán ngắt mạch.</p><ul><li>Trạng thái đóng (cầu chì hoạt động bình thường): Khi hệ thống hoạt động ổn định, không có lỗi xảy ra, dịch vụ phía trên gọi dịch vụ phía dưới mà không gặp hạn chế nào.</li><li>Trạng thái mở (cầu chì bị ngắt): Dịch vụ phía trên không gọi dịch vụ phía dưới nữa mà trả về phương thức dự phòng đã được định trước.</li><li>Trạng thái bán ngắt mạch: Khi ở trạng thái mở, dịch vụ phía trên sẽ thử khôi phục kết nối với dịch vụ phía dưới theo một số quy tắc. Trong lúc này, dịch vụ phía trên sẽ giới hạn lưu lượng gọi dịch vụ phía dưới và giám sát tỷ lệ thành công. Nếu tỷ lệ thành công đạt yêu cầu, hệ thống sẽ trở lại trạng thái đóng. Nếu không đạt, nó sẽ quay lại trạng thái mở.</li></ul><p><strong>Người phỏng vấn: Hãy nói về giới hạn lưu lượng dịch vụ (rate limit)?</strong></p><p>Tôi: Giới hạn lưu lượng là cách hạn chế số lượng yêu cầu truy cập vào hệ thống nhằm ngăn chặn tình trạng quá tải và gây sập hệ thống. Mục tiêu chính là bảo vệ các nút dịch vụ hoặc các nút dữ liệu phía sau, tránh việc lưu lượng đột ngột quá lớn dẫn đến sự cố không thể sử dụng. Giới hạn lưu lượng cũng giúp làm mượt các yêu cầu, ví dụ như trong trường hợp bán hàng flash với lưu lượng truy cập cao, hệ thống sẽ tổ chức hàng đợi để xử lý các yêu cầu một cách có trật tự.</p><p>Có hai loại thuật toán giới hạn lưu lượng chính: đếm tổng số yêu cầu hoặc giới hạn theo cửa sổ thời gian (thường là 1 giây). Thuật toán bucket token và bucket leak là những ví dụ của giới hạn lưu lượng theo cửa sổ thời gian.</p><p><strong>Người phỏng vấn: Hãy nói về cách cô lập dịch vụ?</strong></p><p>Tôi: Cô lập dịch vụ tương tự như việc phân chia hệ thống theo chiều dọc, hệ thống sẽ được chia thành nhiều module dịch vụ riêng biệt theo các quy tắc nhất định. Mỗi module dịch vụ hoạt động độc lập, không phụ thuộc lẫn nhau. Nếu một module gặp sự cố, ảnh hưởng của sự cố đó sẽ bị giới hạn trong module cụ thể đó và không lan sang các dịch vụ khác, đảm bảo không gây ảnh hưởng nghiêm trọng đến toàn bộ hệ thống.</p><p>Các phương pháp cách ly dịch vụ phổ biến trong ngành internet bao gồm cách ly bằng thread pool và cách ly bằng semaphore.</p><p><strong>Người phỏng vấn: Hãy giải thích về dịch vụ quá thời gian (timeout)?</strong></p><p>Tôi: Sau khi hệ thống chuyển sang kiến trúc phân tán và microservices, hệ thống được chia thành nhiều dịch vụ nhỏ và các dịch vụ này sẽ gọi lẫn nhau, tạo thành chuỗi gọi dịch vụ.</p><p>Trong chuỗi gọi dịch vụ, dịch vụ gọi đến một dịch vụ khác được coi là dịch vụ phía trên, trong khi dịch vụ cung cấp interface cho dịch vụ khác gọi là dịch vụ phía dưới. Dịch vụ quá thời gian xảy ra khi dịch vụ phía trên gọi dịch vụ phía dưới nhưng không nhận được phản hồi trong khoảng thời gian tối đa được thiết lập. Khi đó, hệ thống sẽ ngắt kết nối giữa hai dịch vụ để giải phóng tài nguyên.</p><p><strong>Người phỏng vấn: Sentinel là gì và nó giải quyết vấn đề gì?</strong></p><p>Tôi: Sentinel là một thành phần quản lý lưu lượng trong hệ thống phân tán được phát triển bởi Alibaba, dùng để bảo vệ sự ổn định của dịch vụ. Nó thông qua việc giám sát thời gian thực, ngắt mạch, hạ cấp, giới hạn lưu lượng, và bảo vệ tải hệ thống để ngăn chặn các vấn đề như lưu lượng đột ngột hoặc sự không ổn định từ các phụ thuộc bên ngoài gây ra sự cố dịch vụ, đảm bảo tính khả dụng và ổn định của hệ thống.</p><p><strong>Người phỏng vấn: Làm thế nào để tích hợp OpenFeign với Sentinel? Các bước cụ thể là gì?</strong></p><p>Tôi: Theo dự án PmHub, hãy tự sắp xếp câu trả lời và giải thích.</p><p><strong>Người phỏng vấn: Trong dự án của bạn, làm thế nào để thực hiện dịch vụ hạ cấp tùy chỉnh với fallback?</strong></p><p>Tôi: Theo dự án PmHub, hãy tự sắp xếp câu trả lời và giải thích.</p><p><strong>Người phỏng vấn: Bạn đã gặp những thách thức nào trong quá trình triển khai và bạn đã giải quyết chúng như thế nào?</strong></p><p>Tôi: Các vấn đề như xung đột phụ thuộc hoặc không tương thích phiên bản khi tích hợp. Tôi đã giải quyết bằng cách tham khảo tài liệu chính thức và các nguồn tài nguyên từ cộng đồng để điều chỉnh phiên bản phụ thuộc.</p><p>Việc thiết kế và triển khai logic hạ cấp cũng cần đảm bảo rằng phản hồi sau khi hạ cấp vẫn đáp ứng yêu cầu kinh doanh. Tôi đã làm điều này bằng cách thảo luận với bên kinh doanh để làm rõ yêu cầu về logic hạ cấp và tiến hành kiểm thử đầy đủ.</p><p>Ngoài ra, tôi cũng đã điều chỉnh và tối ưu hóa các quy tắc giới hạn lưu lượng để tránh ảnh hưởng tới các yêu cầu hợp lệ, thông qua giám sát thời gian thực và phân tích nhật ký, dần dần tối ưu hóa chiến lược giới hạn lưu lượng.</p></div><!----><footer class="vp-page-meta"><div class="vp-meta-item edit-link"><a class="auto-link external-link vp-meta-label" href="https://github.com/vanhung4499/my-wiki/edit/main/src/project/pmhub/degrade.md" aria-label="Edit this page on GitHub" rel="noopener noreferrer" target="_blank"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon" name="edit"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->Edit this page on GitHub<!----></a></div><div class="vp-meta-item git-info"><div class="update-time"><span class="vp-meta-label">Last update: </span><!----></div><div class="contributors"><span class="vp-meta-label">Contributors: </span><!--[--><!--[--><span class="vp-meta-info" title="email: vanhung4499@gmail.com">Hung Nguyen Van</span><!--]--><!--]--></div></div></footer><!----><!----><!----><!--]--></main><!--]--><footer class="footer-wrapper" style="display:none;--1ea755b8:;"><div class="footer-content"><div class="footer">Made with ❤️ by Hung Nguyen</div><div class="copyright">Copyright © 2016-2024 Hung Nguyen</div></div><span id="runtime_span"></span></footer></div><!--]--><!--[--><!----><!----><!----><!----><!--]--><!--]--></div>
    <script type="module" src="/assets/app-CIGQMwlz.js" defer></script>
  </body>
</html>
