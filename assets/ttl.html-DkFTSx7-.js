import{_ as h,g as l,o as k,c as e,a as n,e as s,h as a,f as p,w as B}from"./app-CmlOSuIY.js";const r={};function d(g,i){const t=l("font");return k(),e("div",null,[i[6]||(i[6]=n('<h1 id="pmhub-save-user-information-with-transmittablethreadlocal" tabindex="-1"><a class="header-anchor" href="#pmhub-save-user-information-with-transmittablethreadlocal"><span>PmHub - Save user information with TransmittableThreadLocal</span></a></h1><div class="hint-container info"><p class="hint-container-title">Info</p><ul><li>D·ª±a tr√™n <strong>TransmittableThreadLocal (TTL)</strong> ƒë·ªÉ t√πy ch·ªânh tr√¨nh ch·∫∑n request header, ƒë√≥ng g√≥i d·ªØ li·ªáu header v√†o bi·∫øn lu·ªìng ƒë·ªÉ d·ªÖ d√†ng truy xu·∫•t, gi·∫£m s·ªë l·∫ßn truy v·∫•n c∆° s·ªü d·ªØ li·ªáu v·ªÅ th√¥ng tin ng∆∞·ªùi d√πng, ƒë·ªìng th·ªùi x√°c minh v√† t·ª± ƒë·ªông l√†m m·ªõi th·ªùi gian hi·ªáu l·ª±c c·ªßa ng∆∞·ªùi d√πng hi·ªán t·∫°i.</li></ul></div><h1 id="kien-thuc-ly-thuyet" tabindex="-1"><a class="header-anchor" href="#kien-thuc-ly-thuyet"><span>Ki·∫øn th·ª©c l√Ω thuy·∫øt</span></a></h1><p><strong>TransmittableThreadLocal (TTL)</strong> l√† phi√™n b·∫£n n√¢ng cao c·ªßa ThreadLocal, v√¨ v·∫≠y ƒë·ªÉ hi·ªÉu TTL, tr∆∞·ªõc ti√™n c·∫ßn √¥n l·∫°i ki·∫øn th·ª©c c∆° b·∫£n v·ªÅ ThreadLocal.</p><h2 id="gioi-thieu-threadlocal" tabindex="-1"><a class="header-anchor" href="#gioi-thieu-threadlocal"><span>Gi·ªõi thi·ªáu ThreadLocal</span></a></h2><h3 id="threadlocal-la-gi" tabindex="-1"><a class="header-anchor" href="#threadlocal-la-gi"><span>ThreadLocal l√† g√¨?</span></a></h3>',6)),s("p",null,[i[1]||(i[1]=s("strong",null,"ThreadLocal",-1)),i[2]||(i[2]=a(" l√† m·ªôt l·ªõp trong g√≥i ")),i[3]||(i[3]=s("strong",null,"lang",-1)),i[4]||(i[4]=a(" c·ªßa Java, ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ ")),s("strong",null,[p(t,{style:{color:"#DF2A3F"}},{default:B(()=>i[0]||(i[0]=[a("ƒë·ªìng th·ªùi khi chia s·∫ª bi·∫øn")])),_:1})]),i[5]||(i[5]=a(" gi·ªØa nhi·ªÅu lu·ªìng. Chia s·∫ª bi·∫øn nghƒ©a l√† c√πng m·ªôt bi·∫øn c√≥ th·ªÉ ƒë∆∞·ª£c g√°n c√°c gi√° tr·ªã kh√°c nhau trong c√°c lu·ªìng kh√°c nhau."))]),i[7]||(i[7]=n(`<p>ThreadLocal duy tr√¨ <strong>b·∫£n sao bi·∫øn ri√™ng bi·ªát</strong> cho m·ªói lu·ªìng trong m√¥i tr∆∞·ªùng ƒëa lu·ªìng, cho ph√©p m·ªói lu·ªìng c√≥ b·∫£n sao d·ªØ li·ªáu c·ªßa ri√™ng m√¨nh, tr√°nh xung ƒë·ªôt khi nhi·ªÅu lu·ªìng c√πng truy c·∫≠p v√†o m·ªôt bi·∫øn.</p><figure><img src="https://raw.githubusercontent.com/vanhung4499/images/master/snap/20200930144753491.png" alt="20200930144753491.png" tabindex="0" loading="lazy"><figcaption>20200930144753491.png</figcaption></figure><h3 id="su-khac-biet-giua-threadlocal-va-synchronized" tabindex="-1"><a class="header-anchor" href="#su-khac-biet-giua-threadlocal-va-synchronized"><span>S·ª± kh√°c bi·ªát gi·ªØa ThreadLocal v√† Synchronized?</span></a></h3><p><strong>Synchronized</strong> d·ª±a tr√™n c∆° ch·∫ø kh√≥a, ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ ki·ªÉm so√°t vi·ªác truy c·∫≠p v√†o t√†i nguy√™n chia s·∫ª, ƒë·∫£m b·∫£o t√≠nh nh·∫•t qu√°n v√† an to√†n c·ªßa d·ªØ li·ªáu gi·ªØa c√°c lu·ªìng, b·∫±ng c√°ch cho ph√©p c√°c lu·ªìng truy c·∫≠p m·ªôt c√°ch tu·∫ßn t·ª±.</p><p><strong>Synchronized d√πng th·ªùi gian ƒë·ªÉ ƒë·ªïi l·∫•y kh√¥ng gian b·∫±ng c√°ch x·∫øp h√†ng c√°c lu·ªìng ƒë·ªÉ truy c·∫≠p, trong khi ThreadLocal d√πng kh√¥ng gian ƒë·ªÉ ƒë·ªïi l·∫•y th·ªùi gian b·∫±ng c√°ch cung c·∫•p m·ªôt b·∫£n sao bi·∫øn cho m·ªói lu·ªìng, t·ª´ ƒë√≥ ƒë·∫°t ƒë∆∞·ª£c c√°ch ly gi·ªØa c√°c lu·ªìng.</strong> (B·∫°n c√≥ th·ªÉ n√≥i tr·ª±c ti·∫øp ƒëi·ªÅu n√†y v·ªõi ng∆∞·ªùi ph·ªèng v·∫•n üëä).</p><h3 id="cac-truong-hop-su-dung-threadlocal" tabindex="-1"><a class="header-anchor" href="#cac-truong-hop-su-dung-threadlocal"><span>C√°c tr∆∞·ªùng h·ª£p s·ª≠ d·ª•ng ThreadLocal</span></a></h3><p><strong>ThreadLocal</strong> ch·ªß y·∫øu ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ th·ª±c hi·ªán vi·ªác c√°ch ly d·ªØ li·ªáu gi·ªØa c√°c lu·ªìng. D∆∞·ªõi ƒë√¢y l√† m·ªôt s·ªë tr∆∞·ªùng h·ª£p s·ª≠ d·ª•ng ph·ªï bi·∫øn:</p><p><strong>1. Th√¥ng tin phi√™n ng∆∞·ªùi d√πng</strong></p><p>Trong c√°c ·ª©ng d·ª•ng web, m·ªói y√™u c·∫ßu th∆∞·ªùng ƒë∆∞·ª£c x·ª≠ l√Ω trong m·ªôt lu·ªìng ri√™ng bi·ªát. B·∫°n c√≥ th·ªÉ s·ª≠ d·ª•ng ThreadLocal ƒë·ªÉ l∆∞u tr·ªØ th√¥ng tin phi√™n c·ªßa m·ªói ng∆∞·ªùi d√πng, tr√°nh s·ª± nh·∫ßm l·∫´n d·ªØ li·ªáu gi·ªØa c√°c lu·ªìng y√™u c·∫ßu kh√°c nhau.</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#abb2bf;--shiki-dark:#abb2bf;--shiki-light-bg:#282c34;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> UserContext</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> static</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> ThreadLocal</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;"> userHolder </span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> ThreadLocal</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">withInitial</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(() </span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">-&gt;</span><span style="--shiki-light:#D19A66;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> static</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> setUser</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> user</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">        userHolder</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">set</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(user);</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> static</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> String</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> getUser</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">()</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> userHolder</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">get</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> static</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> clear</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">()</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">        userHolder</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">remove</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// S·ª≠ d·ª•ng trong m·ªôt lu·ªìng x·ª≠ l√Ω y√™u c·∫ßu</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">UserContext</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">setUser</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#98C379;--shiki-dark:#98C379;">&quot;UserA&quot;</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;"> currentUser </span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> UserContext</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">getUser</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">System</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">out</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">println</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#98C379;--shiki-dark:#98C379;">&quot;Ng∆∞·ªùi d√πng hi·ªán t·∫°i: &quot;</span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;"> +</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> currentUser);</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">UserContext</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">clear</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">();</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>2. Qu·∫£n l√Ω k·∫øt n·ªëi c∆° s·ªü d·ªØ li·ªáu</strong></p><p>L∆∞u tr·ªØ k·∫øt n·ªëi c∆° s·ªü d·ªØ li·ªáu trong lu·ªìng, ƒë·ªÉ m·ªói lu·ªìng c√≥ m·ªôt th·ªÉ hi·ªán k·∫øt n·ªëi c∆° s·ªü d·ªØ li·ªáu ri√™ng, tr√°nh v·∫•n ƒë·ªÅ chia s·∫ª k·∫øt n·ªëi v√† c·∫£i thi·ªán hi·ªáu su·∫•t.</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#abb2bf;--shiki-dark:#abb2bf;--shiki-light-bg:#282c34;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> ConnectionManager</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> static</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> ThreadLocal</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">Connection</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;"> connectionHolder </span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> ThreadLocal</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">withInitial</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(() </span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">-&gt;</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">        try</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">            return</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> DriverManager</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">getConnection</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#98C379;--shiki-dark:#98C379;">&quot;jdbc:your_database_url&quot;</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">        } </span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">catch</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">SQLException</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> e</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">            throw</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> RuntimeException</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(e);</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">    });</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> static</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> Connection</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> getConnection</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">()</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> connectionHolder</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">get</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> static</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> closeConnection</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">()</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> throws</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> SQLException</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">        connectionHolder</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">get</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">().</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">close</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">        connectionHolder</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">remove</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// S·ª≠ d·ª•ng trong m·ªôt lu·ªìng</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">Connection</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;"> connection </span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> ConnectionManager</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">getConnection</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// Th·ª±c hi·ªán thao t√°c v·ªõi c∆° s·ªü d·ªØ li·ªáu</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">ConnectionManager</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">closeConnection</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">();</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>3. C√¥ng c·ª• ƒë·ªãnh d·∫°ng</strong></p><p>V√≠ d·ª• nh∆∞ <code>SimpleDateFormat</code> kh√¥ng an to√†n khi s·ª≠ d·ª•ng trong ƒëa lu·ªìng, b·∫°n c√≥ th·ªÉ s·ª≠ d·ª•ng <code>ThreadLocal</code> ƒë·ªÉ cung c·∫•p m·ªôt th·ªÉ hi·ªán <code>SimpleDateFormat</code> ƒë·ªôc l·∫≠p cho m·ªói lu·ªìng, tr√°nh v·∫•n ƒë·ªÅ an to√†n lu·ªìng.</p><div class="language-java" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#abb2bf;--shiki-dark:#abb2bf;--shiki-light-bg:#282c34;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> DateFormatter</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> static</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> ThreadLocal</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">SimpleDateFormat</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;"> dateFormatHolder </span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> ThreadLocal</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">withInitial</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(() </span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">-&gt;</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> SimpleDateFormat</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#98C379;--shiki-dark:#98C379;">&quot;yyyy-MM-dd&quot;</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">));</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> static</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> String</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> format</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">Date</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> date</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> dateFormatHolder</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">get</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">().</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">format</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(date);</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// S·ª≠ d·ª•ng trong m·ªôt lu·ªìng</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;"> formattedDate </span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> DateFormatter</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">format</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">new</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> Date</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">());</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">System</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">out</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">println</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#98C379;--shiki-dark:#98C379;">&quot;Ng√†y ƒë·ªãnh d·∫°ng: &quot;</span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;"> +</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> formattedDate);</span></span></code></pre></div><p><strong>4. Truy·ªÅn th√¥ng tin ng·ªØ c·∫£nh nh·∫≠t k√Ω</strong></p><p>Trong ghi nh·∫≠t k√Ω, b·∫°n c√≥ th·ªÉ s·ª≠ d·ª•ng <code>ThreadLocal</code> ƒë·ªÉ l∆∞u tr·ªØ m·ªôt s·ªë th√¥ng tin ng·ªØ c·∫£nh (nh∆∞ request ID, user ID, v.v.), ƒë·ªÉ c√≥ th·ªÉ chia s·∫ª th√¥ng tin ng·ªØ c·∫£nh n√†y trong c√°c ghi nh·∫≠t k√Ω kh√°c nhau.</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#abb2bf;--shiki-dark:#abb2bf;--shiki-light-bg:#282c34;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> LogContext</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> static</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> ThreadLocal</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;"> requestIdHolder </span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> ThreadLocal</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">withInitial</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(() </span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">-&gt;</span><span style="--shiki-light:#D19A66;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> static</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> setRequestId</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> requestId</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">        requestIdHolder</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">set</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(requestId);</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> static</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> String</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> getRequestId</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">()</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> requestIdHolder</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">get</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> static</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> clear</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">()</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">        requestIdHolder</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">remove</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// S·ª≠ d·ª•ng trong m·ªôt lu·ªìng x·ª≠ l√Ω y√™u c·∫ßu</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">LogContext</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">setRequestId</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#98C379;--shiki-dark:#98C379;">&quot;123456&quot;</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;"> requestId </span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> LogContext</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">getRequestId</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">System</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">out</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">println</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#98C379;--shiki-dark:#98C379;">&quot;Request ID: &quot;</span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;"> +</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> requestId);</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">LogContext</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">clear</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">();</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="nguyen-ly-cua-threadlocal" tabindex="-1"><a class="header-anchor" href="#nguyen-ly-cua-threadlocal"><span>Nguy√™n l√Ω c·ªßa ThreadLocal</span></a></h2><h3 id="cau-truc-noi-bo-cua-threadlocal" tabindex="-1"><a class="header-anchor" href="#cau-truc-noi-bo-cua-threadlocal"><span>C·∫•u tr√∫c n·ªôi b·ªô c·ªßa ThreadLocal</span></a></h3><p><code>ThreadLocal</code> l√† m·ªôt l·ªõp generic, m·ª•c ƒë√≠ch ch√≠nh c·ªßa n√≥ l√† cung c·∫•p m·ªôt container ƒë·ªÉ l∆∞u tr·ªØ c√°c bi·∫øn c·ª•c b·ªô theo t·ª´ng lu·ªìng. M·ªói lu·ªìng c√≥ m·ªôt ƒë·ªëi t∆∞·ª£ng <code>ThreadLocalMap</code>, c√≥ th·ªÉ ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ l∆∞u tr·ªØ t·∫•t c·∫£ c√°c ƒë·ªëi t∆∞·ª£ng <code>ThreadLocal</code> v√† gi√° tr·ªã t∆∞∆°ng ·ª©ng c·ªßa ch√∫ng trong lu·ªìng ƒë√≥.</p><p>Vi·ªác tri·ªÉn khai n·ªôi b·ªô c·ªßa <code>ThreadLocal</code> r·∫•t ƒë∆°n gi·∫£n, ch·ªß y·∫øu l√† ba ph∆∞∆°ng th·ª©c sau:</p><ul><li><code>get()</code>: L·∫•y <code>ThreadLocalMap</code> c·ªßa lu·ªìng hi·ªán t·∫°i, n·∫øu t√¨m th·∫•y gi√° tr·ªã t∆∞∆°ng ·ª©ng v·ªõi key (hi·ªán t·∫°i l√† <code>ThreadLocal</code>) th√¨ tr·∫£ v·ªÅ gi√° tr·ªã ƒë√≥. N·∫øu <code>ThreadLocalMap</code> tr·ªëng ho·∫∑c kh√¥ng t√¨m th·∫•y gi√° tr·ªã, th√¨ tr·∫£ v·ªÅ gi√° tr·ªã m·∫∑c ƒë·ªãnh.</li><li><code>set(T value)</code>: L·∫•y lu·ªìng hi·ªán t·∫°i, l·∫•y <code>ThreadLocalMap</code> c·ªßa lu·ªìng (n·∫øu kh√¥ng c√≥ th√¨ t·∫°o m·ªôt <code>map</code> m·ªõi), sau ƒë√≥ thi·∫øt l·∫≠p <code>ThreadLocal</code> hi·ªán t·∫°i l√† key v√† <code>value</code> l√† gi√° tr·ªã v√†o trong <code>map</code>.</li><li><code>initialValue</code>: Gi√° tr·ªã kh·ªüi t·∫°o, c√≥ th·ªÉ ƒë∆∞·ª£c k·∫ø th·ª´a, thi·∫øt l·∫≠p gi√° tr·ªã m·∫∑c ƒë·ªãnh khi kh·ªüi t·∫°o.</li></ul><figure><img src="https://raw.githubusercontent.com/vanhung4499/images/master/snap/20240917004006.png" alt="image.png" tabindex="0" loading="lazy"><figcaption>image.png</figcaption></figure><h3 id="cau-truc-co-ban-cua-threadlocalmap" tabindex="-1"><a class="header-anchor" href="#cau-truc-co-ban-cua-threadlocalmap"><span>C·∫•u tr√∫c c∆° b·∫£n c·ªßa ThreadLocalMap</span></a></h3><p>Bao g·ªìm 2 th√†nh ph·∫ßn:</p><ol><li>L·ªõp n·ªôi b·ªô tƒ©nh <code>ThreadLocal</code>.</li><li>Key l√† ƒë·ªëi t∆∞·ª£ng <code>ThreadLocal</code> v·ªõi ki·ªÉu tham chi·∫øu y·∫øu, m·ª•c ƒë√≠ch l√† ƒë·ªÉ g·ª° r·ªëi m·ªëi quan h·ªá gi·ªØa v√≤ng ƒë·ªùi c·ªßa ƒë·ªëi t∆∞·ª£ng <code>ThreadLocal</code> v√† v√≤ng ƒë·ªùi c·ªßa lu·ªìng.</li></ol><figure><img src="https://raw.githubusercontent.com/vanhung4499/images/master/snap/20240917004109.png" alt="image.png" tabindex="0" loading="lazy"><figcaption>image.png</figcaption></figure><h2 id="gioi-thieu-ve-transmittablethreadlocal-ttl" tabindex="-1"><a class="header-anchor" href="#gioi-thieu-ve-transmittablethreadlocal-ttl"><span>Gi·ªõi thi·ªáu v·ªÅ TransmittableThreadLocal (TTL)</span></a></h2><h3 id="ttl-la-gi" tabindex="-1"><a class="header-anchor" href="#ttl-la-gi"><span>TTL l√† g√¨?</span></a></h3><p>TransmittableThreadLocal (TTL) l√† m·ªôt th∆∞ vi·ªán m√£ ngu·ªìn m·ªü do Alibaba ph√°t tri·ªÉn, nh·∫±m gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ <strong>kh√¥ng th·ªÉ truy·ªÅn th√¥ng tin ng·ªØ c·∫£nh t·ª´ lu·ªìng cha ƒë·∫øn lu·ªìng con</strong> khi s·ª≠ d·ª•ng ThreadLocal trong Java v·ªõi c√°c khung ƒëa lu·ªìng ho·∫∑c c√°c c√¥ng c·ª• nh∆∞ Executors, ForkJoinPool, v.v. TTL m·ªü r·ªông InheritableThreadLocal ƒë·ªÉ cho ph√©p truy·ªÅn th√¥ng tin ng·ªØ c·∫£nh qua c√°c lu·ªìng trong pool.</p><blockquote><p>ƒê·ªãa ch·ªâ m√£ ngu·ªìn m·ªü c·ªßa TTL: <a href="https://github.com/alibaba/transmittable-thread-local" target="_blank" rel="noopener noreferrer">https://github.com/alibaba/transmittable-thread-local</a></p></blockquote><p>To√†n b·ªô th∆∞ vi·ªán TransmittableThreadLocal c√≥ ch·ª©c nƒÉng c·ªët l√µi r·∫•t nh·ªè g·ªçn (~1000 d√≤ng m√£), bao g·ªìm API ng∆∞·ªùi d√πng, wrapper cho ExecutorService/ForkJoinPool/TimerTask v√† c√°c API t√≠ch h·ª£p cho framework/middleware. üëç</p><h3 id="nguyen-ly-hoat-ƒëong-cua-ttl" tabindex="-1"><a class="header-anchor" href="#nguyen-ly-hoat-ƒëong-cua-ttl"><span>Nguy√™n l√Ω ho·∫°t ƒë·ªông c·ªßa TTL</span></a></h3><p>Trong l·∫≠p tr√¨nh ƒëa lu·ªìng Java, ThreadLocal th∆∞·ªùng ƒë∆∞·ª£c d√πng ƒë·ªÉ l∆∞u tr·ªØ bi·∫øn c·ª•c b·ªô c·ªßa lu·ªìng. Tuy nhi√™n, khi s·ª≠ d·ª•ng thread pool, c√°c lu·ªìng c√≥ th·ªÉ ƒë∆∞·ª£c t√°i s·ª≠ d·ª•ng, d·∫´n ƒë·∫øn vi·ªác c√°c bi·∫øn ThreadLocal kh√¥ng ƒë∆∞·ª£c truy·ªÅn ƒë√∫ng c√°ch gi·ªØa c√°c lu·ªìng cha v√† con, g√¢y ra m·∫•t d·ªØ li·ªáu ho·∫∑c kh√¥ng nh·∫•t qu√°n d·ªØ li·ªáu. M·∫∑c d√π InheritableThreadLocal c√≥ th·ªÉ truy·ªÅn bi·∫øn c·ªßa lu·ªìng cha cho lu·ªìng con, nh∆∞ng v·∫´n kh√¥ng gi·∫£i quy·∫øt ƒë∆∞·ª£c v·∫•n ƒë·ªÅ t√°i s·ª≠ d·ª•ng lu·ªìng trong m√¥i tr∆∞·ªùng thread pool.</p><p>Nguy√™n l√Ω ho·∫°t ƒë·ªông ch√≠nh c·ªßa TTL bao g·ªìm ba b∆∞·ªõc:</p><ul><li><strong>Sao ch√©p ng·ªØ c·∫£nh</strong>: Khi nhi·ªám v·ª• ƒë∆∞·ª£c n·ªôp, TTL s·∫Ω sao ch√©p ng·ªØ c·∫£nh c·ªßa lu·ªìng hi·ªán t·∫°i v√†o nhi·ªám v·ª•.</li><li><strong>Thi·∫øt l·∫≠p ng·ªØ c·∫£nh tr∆∞·ªõc khi th·ª±c hi·ªán nhi·ªám v·ª•</strong>: Tr∆∞·ªõc khi nhi·ªám v·ª• ƒë∆∞·ª£c th·ª±c hi·ªán, TTL s·∫Ω thi·∫øt l·∫≠p ng·ªØ c·∫£nh ƒë√£ sao ch√©p v√†o lu·ªìng hi·ªán t·∫°i.</li><li><strong>D·ªçn d·∫πp ng·ªØ c·∫£nh sau khi th·ª±c hi·ªán nhi·ªám v·ª•</strong>: Sau khi nhi·ªám v·ª• ho√†n t·∫•t, TTL s·∫Ω d·ªçn d·∫πp ng·ªØ c·∫£nh trong lu·ªìng ƒë·ªÉ tr√°nh r√≤ r·ªâ b·ªô nh·ªõ.</li></ul><p>D∆∞·ªõi ƒë√¢y l√† h√¨nh minh h·ªça r√µ r√†ng v·ªÅ nguy√™n l√Ω ho·∫°t ƒë·ªông c·ªßa TTL:</p><figure><img src="https://raw.githubusercontent.com/vanhung4499/images/master/snap/20240917004325.png" alt="image.png" tabindex="0" loading="lazy"><figcaption>image.png</figcaption></figure><h3 id="cac-truong-hop-su-dung-chinh-cua-ttl" tabindex="-1"><a class="header-anchor" href="#cac-truong-hop-su-dung-chinh-cua-ttl"><span>C√°c tr∆∞·ªùng h·ª£p s·ª≠ d·ª•ng ch√≠nh c·ªßa TTL</span></a></h3><p>C√°c t√¨nh hu·ªëng c·∫ßn s·ª≠ d·ª•ng ThreadLocal ch√≠nh l√† c√°c t√¨nh hu·ªëng ti·ªÅm nƒÉng c·∫ßn TransmittableThreadLocal, n·∫øu c√¥ng vi·ªác c·ªßa b·∫°n y√™u c·∫ßu ‚Äútruy·ªÅn gi√° tr·ªã ThreadLocal khi s·ª≠ d·ª•ng c√°c th√†nh ph·∫ßn th·ª±c thi c√≥ th·ªÉ t√°i s·ª≠ d·ª•ng lu·ªìng nh∆∞ thread pool‚Äù, th√¨ ƒë√≥ l√† m·ª•c ti√™u c·ªßa TransmittableThreadLocal.</p><ul><li><strong>Theo d√µi ph√¢n t√°n</strong>: Truy·ªÅn ID theo d√µi trong h·ªá th·ªëng ph√¢n t√°n ƒë·ªÉ d·ªÖ d√†ng li√™n k·∫øt log v√† x·ª≠ l√Ω s·ª± c·ªë.</li><li><strong>Qu·∫£n l√Ω giao d·ªãch</strong>: Truy·ªÅn ng·ªØ c·∫£nh giao d·ªãch trong c√°c giao d·ªãch ph√¢n t√°n ƒë·ªÉ ƒë·∫£m b·∫£o t√≠nh nh·∫•t qu√°n c·ªßa giao d·ªãch.</li><li><strong>Truy·ªÅn th√¥ng tin ng·ªØ c·∫£nh</strong>: Truy·ªÅn th√¥ng tin v·ªÅ phi√™n ng∆∞·ªùi d√πng, ng·ªØ c·∫£nh y√™u c·∫ßu, v.v., trong m√¥i tr∆∞·ªùng ƒëa lu·ªìng.</li></ul><h2 id="uu-ƒëiem-cua-ttl-so-voi-threadlocal" tabindex="-1"><a class="header-anchor" href="#uu-ƒëiem-cua-ttl-so-voi-threadlocal"><span>∆Øu ƒëi·ªÉm c·ªßa TTL so v·ªõi ThreadLocal</span></a></h2><p>D∆∞·ªõi ƒë√¢y l√† so s√°nh ∆∞u ƒëi·ªÉm gi·ªØa TTL (TransmittableThreadLocal) v√† ThreadLocal:</p><table><thead><tr><th>ƒê·∫∑c ƒëi·ªÉm</th><th>ThreadLocal</th><th>TTL (TransmittableThreadLocal)</th></tr></thead><tbody><tr><td><strong>Truy·ªÅn th√¥ng tin ng·ªØ c·∫£nh</strong></td><td>Ch·ªâ l∆∞u tr·ªØ trong lu·ªìng hi·ªán t·∫°i, kh√¥ng th·ªÉ truy·ªÅn qua lu·ªìng kh√°c</td><td>C√≥ th·ªÉ truy·ªÅn th√¥ng tin ng·ªØ c·∫£nh trong c√°c khung ƒëa lu·ªìng v√† c√°c c√¥ng c·ª• qu·∫£n l√Ω lu·ªìng</td></tr><tr><td><strong>H·ªó tr·ª£ t√°i s·ª≠ d·ª•ng lu·ªìng</strong></td><td>Khi lu·ªìng ƒë∆∞·ª£c t√°i s·ª≠ d·ª•ng trong thread pool, kh√¥ng ƒë·∫£m b·∫£o t√≠nh nh·∫•t qu√°n c·ªßa bi·∫øn</td><td>H·ªó tr·ª£ t√°i s·ª≠ d·ª•ng lu·ªìng, ƒë·∫£m b·∫£o r·∫±ng bi·∫øn ƒë∆∞·ª£c truy·ªÅn v√† gi·ªØ nh·∫•t qu√°n gi·ªØa c√°c t√°c v·ª•</td></tr><tr><td><strong>Kh√¥ng x√¢m l·∫•n</strong></td><td>C·∫ßn qu·∫£n l√Ω vi·ªác thi·∫øt l·∫≠p v√† x√≥a bi·∫øn th·ªß c√¥ng, d·ªÖ x·∫£y ra l·ªói</td><td>Thay th·∫ø ThreadLocal l√† c√≥ th·ªÉ t·ª± ƒë·ªông qu·∫£n l√Ω vi·ªác truy·ªÅn v√† x√≥a ng·ªØ c·∫£nh</td></tr><tr><td><strong>D·ªÖ t√≠ch h·ª£p</strong></td><td>Ph√π h·ª£p v·ªõi m√¥i tr∆∞·ªùng lu·ªìng ƒë∆°n gi·∫£n</td><td>C√≥ th·ªÉ t√≠ch h·ª£p li·ªÅn m·∫°ch v·ªõi nhi·ªÅu lo·∫°i thread pool v√† khung ƒëa lu·ªìng</td></tr><tr><td><strong>T√¨nh hu·ªëng s·ª≠ d·ª•ng</strong></td><td>Ph√π h·ª£p v·ªõi m√¥i tr∆∞·ªùng ƒë∆°n lu·ªìng ho·∫∑c kh√¥ng c·∫ßn truy·ªÅn th√¥ng tin ng·ªØ c·∫£nh qua c√°c lu·ªìng</td><td>Ph√π h·ª£p v·ªõi m√¥i tr∆∞·ªùng ƒëa lu·ªìng ph·ª©c t·∫°p, ƒë·∫∑c bi·ªát l√† khi c·∫ßn truy·ªÅn th√¥ng tin ng·ªØ c·∫£nh qua c√°c lu·ªìng</td></tr></tbody></table><p>Nh·ªØng l·ª£i th·∫ø n√†y khi·∫øn TTL tr·ªü n√™n th·ª±c ti·ªÖn h∆°n trong c√°c m√¥i tr∆∞·ªùng ƒëa lu·ªìng ph·ª©c t·∫°p, ƒë·∫∑c bi·ªát l√† trong c√°c t√¨nh hu·ªëng c·∫ßn truy·ªÅn th√¥ng tin ng·ªØ c·∫£nh qua c√°c lu·ªìng, ch·∫≥ng h·∫°n nh∆∞ ID theo d√µi trong h·ªá th·ªëng ph√¢n t√°n, th√¥ng tin phi√™n ng∆∞·ªùi d√πng, v.v.</p><h2 id="thuc-hanh-du-an" tabindex="-1"><a class="header-anchor" href="#thuc-hanh-du-an"><span>Th·ª±c H√†nh D·ª± √Ån</span></a></h2><p>ƒê√£ n√≥i nhi·ªÅu v·ªÅ l√Ω thuy·∫øt c∆° b·∫£n, hy v·ªçng c√°c b·∫°n c√≥ th·ªÉ hi·ªÉu r√µ, ti·∫øp theo ch√∫ng ta s·∫Ω ƒëi v√†o ph·∫ßn th·ª±c h√†nh, trong PmHub, l√†m th·∫ø n√†o ƒë·ªÉ s·ª≠ d·ª•ng TransmittableThreadLocal (TTL) ƒë·ªÉ l∆∞u tr·ªØ d·ªØ li·ªáu ng∆∞·ªùi d√πng v√† truy·ªÅn gi·ªØa c√°c lu·ªìng.</p><div class="hint-container info"><p class="hint-container-title">Info</p><p>T√¨nh hu·ªëng y√™u c·∫ßu:</p><p>Trong ki·∫øn tr√∫c vi d·ªãch v·ª•, t√¥i mu·ªën l∆∞u tr·ªØ th√¥ng tin ng∆∞·ªùi d√πng sau khi ƒëƒÉng nh·∫≠p v√†o bi·∫øn ng·ªØ c·∫£nh v√† truy·ªÅn qua c√°c lu·ªìng.</p></div><img src="https://www.plantuml.com/plantuml/svg/jLR9Rjim4BtpAmREeQUYToCDaYPDKy0eqYotN6Xf9BELI9LB4lzzXujMkcbIe1U38cVUB6_uw5DZkRQkRHXtLadNRb4pnWkhDApk3UeLS0D-mJeo58NekBIm-gJLKt-Qrd2aiPnRVQk5V8PRr8_9D6uSASrbZNFRBzpY4zy7ixI6ereZohdT5VAIWdsL5dM17IKQNEBsP7VkTURi3ixH7mTp_psty3M6L4M1Gz7fUsvvhTKFBEpCEEtrzgpModK10ZQAYlOj5OzKLkmb2oVlJ_hUhU6pJmtkRpPW5JIg1Y7zwhgzSjlHEPaprlUS849Frt23lnmQwvrCQ3YJYZoqg7SMLDMRRHGlOSiRBWiXwn4v73CM2IBKHC4QBfL-uhe4FUAdiqM0mQDdhugU9kH3NUaXng0z4EjTAB1dPXqxr_ZEvLw1EnOO9Vi9JMluxb3lmNbd8Ib-owrGY-OF74q-ni0tQ9sMEKI9Xq7wD0OY4q3CdMwNTGQuBAblFt464yiOY4obU81IQ3zVrEcTQh7ZDGAl_7WOLnHeJEMQY3-56qO3ALWOltuApu8Jd0M8E8tv_2MZ_prlRnkmoLWCvhvjbwBnjH0xK2SJagyTNMzHHBfUuIdyZQiuaMz5Yu4gOGZ0_CtPe3NPWFYq-mfsGOl--NfCusUorYj5uOnLxI9ah2dftq1YBetPpXz2tT8lvgLMEely88yhHU9Og4RfZojw2LOdDFztTvlZ3_xWX1qEEjVDsLHrIMPJUyPw5bex_pm4UZr70Xvc7Ss3p4gBLw_PnnhpcWhQm6SxBUpjyQb4BNpumcbDGniw_CuC5KzrvxLKdJV8IRQwd2sY8Q_ZnVoNMlP2UXC1oiTiShXy7tFPkn2cQ_Z-XM3WbN0fn8SaSB8LdxN9nl3aZ39vIalw1_GR" alt=""><p>Sau khi ng∆∞·ªùi d√πng ƒëƒÉng nh·∫≠p, h·ªá th·ªëng s·∫Ω tr·∫£ v·ªÅ m·ªôt token. C√°c y√™u c·∫ßu sau ƒë√≥ s·∫Ω mang theo token n√†y, v√† token ch·ª©a th√¥ng tin c·ªßa ng∆∞·ªùi d√πng. T·∫•t c·∫£ c√°c y√™u c·∫ßu s·∫Ω ƒëi qua b·ªô l·ªçc AuthFilter c·ªßa gateway ƒë·∫ßu ti√™n. Trong b·ªô l·ªçc, th√¥ng tin ng∆∞·ªùi d√πng s·∫Ω ƒë∆∞·ª£c ƒë∆∞a v√†o header c·ªßa y√™u c·∫ßu. Sau khi y√™u c·∫ßu ƒëi qua gateway, n√≥ s·∫Ω ƒë·∫øn b·ªô l·ªçc header t√πy ch·ªânh HeaderInterceptor. Trong b·ªô l·ªçc n√†y, th√¥ng tin ng∆∞·ªùi d√πng t·ª´ header s·∫Ω ƒë∆∞·ª£c ƒë∆∞a v√†o TTL, v√¨ v·∫≠y c√°c d·ªãch v·ª• tr√™n chu·ªói c√≥ th·ªÉ tr·ª±c ti·∫øp l·∫•y th√¥ng tin ng∆∞·ªùi d√πng t·ª´ TTL.</p><p>Tr√™n ƒë√¢y l√† quy tr√¨nh th·ª±c hi·ªán. B·∫°n c·∫ßn ph·∫£i t·ª± l√†m quen v·ªõi n√≥, n·∫Øm r√µ v√† c√≥ th·ªÉ gi·∫£i th√≠ch ƒë∆∞·ª£c th√¨ m·ªõi coi l√† ƒë√£ hi·ªÉu. D∆∞·ªõi ƒë√¢y l√† m√£ ngu·ªìn th·ª±c t·∫ø:</p><p><strong>AuthFilter:</strong></p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#abb2bf;--shiki-dark:#abb2bf;--shiki-light-bg:#282c34;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">/**</span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> * Gateway Authentication Filter</span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> */</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">@</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">Component</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> AuthFilter</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> implements</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> GlobalFilter</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> Ordered</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> static</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> final</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> Logger</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;"> log </span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> LoggerFactory</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">getLogger</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">AuthFilter</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">class</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> static</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> final</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> String</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;"> BEGIN_VISIT_TIME </span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#98C379;--shiki-dark:#98C379;"> &quot;begin_visit_time&quot;</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> // Start visit time</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // URIs to be excluded from filtering, add in nacos</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">    @</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">Autowired</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> IgnoreWhiteProperties</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;"> ignoreWhite</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">    @</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">Autowired</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> RedisService</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;"> redisService</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">    @</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">Override</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> Mono</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">Void</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> filter</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">ServerWebExchange</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> exchange</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">GatewayFilterChain</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> chain</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">        ServerHttpRequest</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;"> request</span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> exchange</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">getRequest</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">        ServerHttpRequest</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">Builder</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;"> mutate</span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> request</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">mutate</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">        String</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;"> url</span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> request</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">getURI</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">().</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">getPath</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // Skip paths that do not require validation</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">StringUtils</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">matches</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(url, </span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">ignoreWhite</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">getWhites</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">())) {</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">            return</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> chain</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">filter</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(exchange);</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">        String</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;"> token</span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> getToken</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(request);</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">StringUtils</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">isEmpty</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(token)) {</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">            return</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> unauthorizedResponse</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(exchange, </span><span style="--shiki-light:#98C379;--shiki-dark:#98C379;">&quot;Token cannot be empty&quot;</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">        Claims</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;"> claims</span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> JwtUtils</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">parseToken</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(token);</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> (claims </span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#D19A66;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">            return</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> unauthorizedResponse</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(exchange, </span><span style="--shiki-light:#98C379;--shiki-dark:#98C379;">&quot;Token is expired or invalid!&quot;</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">        String</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;"> userkey</span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> JwtUtils</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">getUserKey</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(claims);</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">        boolean</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;"> islogin</span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> redisService</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">hasKey</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">getTokenKey</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(userkey));</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;">!</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">islogin) {</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">            return</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> unauthorizedResponse</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(exchange, </span><span style="--shiki-light:#98C379;--shiki-dark:#98C379;">&quot;Login status has expired&quot;</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">        String</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;"> userid</span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> JwtUtils</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">getUserId</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(claims);</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">        String</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;"> username</span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> JwtUtils</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">getUserName</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(claims);</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">StringUtils</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">isEmpty</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(userid) </span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;">||</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> StringUtils</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">isEmpty</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(username)) {</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">            return</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> unauthorizedResponse</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(exchange, </span><span style="--shiki-light:#98C379;--shiki-dark:#98C379;">&quot;Token validation failed&quot;</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // Set user information to the request</span></span>
<span class="line"><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">        addHeader</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(mutate, </span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">SecurityConstants</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">USER_KEY</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">, userkey);</span></span>
<span class="line"><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">        addHeader</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(mutate, </span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">SecurityConstants</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">DETAILS_USER_ID</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">, userid);</span></span>
<span class="line"><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">        addHeader</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(mutate, </span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">SecurityConstants</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">DETAILS_USERNAME</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">, username);</span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // Clear internal request source parameters (to prevent security risks)</span></span>
<span class="line"><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">        removeHeader</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(mutate, </span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">SecurityConstants</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">FROM_SOURCE</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // Record the start time of the request</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">        exchange</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">getAttributes</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">().</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">put</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(BEGIN_VISIT_TIME, </span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">System</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">currentTimeMillis</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">());</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> chain</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">filter</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">exchange</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">mutate</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">().</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">request</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">mutate</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">build</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">()).</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">build</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">());</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> addHeader</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">ServerHttpRequest</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">Builder</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> mutate</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> name</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">Object</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> value</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> (value </span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#D19A66;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">            return</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">        String</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;"> valueStr</span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> value</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">toString</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">        String</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;"> valueEncode</span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> ServletUtils</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">urlEncode</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(valueStr);</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">        mutate</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">header</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(name, valueEncode);</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> removeHeader</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">ServerHttpRequest</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">Builder</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> mutate</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> name</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">        mutate</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">headers</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(httpHeaders </span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">-&gt;</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> httpHeaders</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">remove</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(name)).</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">build</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> Mono</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">Void</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> unauthorizedResponse</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">ServerWebExchange</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> exchange</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> msg</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">        log</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">error</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#98C379;--shiki-dark:#98C379;">&quot;[Authentication Error Handling] Request Path: {}&quot;</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">exchange</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">getRequest</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">().</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">getPath</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">());</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> ServletUtils</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">webFluxResponseWriter</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">exchange</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">getResponse</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(), msg, </span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">HttpStatus</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">UNAUTHORIZED</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    /**</span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">     * Get cache key</span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">     */</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> String</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> getTokenKey</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> token</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> CacheConstants</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">LOGIN_TOKEN_KEY</span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;"> +</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> token;</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    /**</span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">     * Get token from request</span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">     */</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> String</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> getToken</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">ServerHttpRequest</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> request</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">        String</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;"> token</span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> request</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">getHeaders</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">().</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">getFirst</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">TokenConstants</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">AUTHENTICATION</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // If a token prefix is set, remove it</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">StringUtils</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">isNotEmpty</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(token) </span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;">&amp;&amp;</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> token</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">startsWith</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">TokenConstants</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">PREFIX</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">)) {</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">            token </span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> token</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">replaceFirst</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">TokenConstants</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">PREFIX</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">StringUtils</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">EMPTY</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> token;</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">    @</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">Override</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> getOrder</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">()</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;"> -</span><span style="--shiki-light:#D19A66;--shiki-dark:#D19A66;">200</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>HeaderInterceptor:</strong></p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#abb2bf;--shiki-dark:#abb2bf;--shiki-light-bg:#282c34;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">/**</span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> * Custom header interceptor to encapsulate Header data into thread variables for easy access</span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> * Note: This interceptor will also validate and automatically refresh the current user&#39;s validity period</span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> * </span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> * </span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">@author</span><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> canghe</span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> */</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> HeaderInterceptor</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> implements</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> AsyncHandlerInterceptor</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // Set of paths that do not require login</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> static</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> final</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> Set</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;"> EXEMPTED_PATHS </span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> HashSet</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">&lt;&gt;</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">()</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">    static</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;"> {</span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // Add paths that do not require login here</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">        EXEMPTED_PATHS</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">add</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#98C379;--shiki-dark:#98C379;">&quot;/system/user/getInfo&quot;</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">        EXEMPTED_PATHS</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">add</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#98C379;--shiki-dark:#98C379;">&quot;/project/statistics&quot;</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">        EXEMPTED_PATHS</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">add</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#98C379;--shiki-dark:#98C379;">&quot;/project/doing&quot;</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">        EXEMPTED_PATHS</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">add</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#98C379;--shiki-dark:#98C379;">&quot;/project/queryMyTaskList&quot;</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">        EXEMPTED_PATHS</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">add</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#98C379;--shiki-dark:#98C379;">&quot;/project/select&quot;</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">        EXEMPTED_PATHS</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">add</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#98C379;--shiki-dark:#98C379;">&quot;/system/menu/getRouters&quot;</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">    @</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">Override</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> boolean</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> preHandle</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">HttpServletRequest</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> request</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">HttpServletResponse</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> response</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">Object</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> handler</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> throws</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> Exception</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;">!</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(handler </span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">instanceof</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> HandlerMethod)) {</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">            return</span><span style="--shiki-light:#D19A66;--shiki-dark:#D19A66;"> true</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">        SecurityContextHolder</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">setUserId</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">ServletUtils</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">getHeader</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(request, </span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">SecurityConstants</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">DETAILS_USER_ID</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">));</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">        SecurityContextHolder</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">setUserName</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">ServletUtils</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">getHeader</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(request, </span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">SecurityConstants</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">DETAILS_USERNAME</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">));</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">        SecurityContextHolder</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">setUserKey</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">ServletUtils</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">getHeader</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(request, </span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">SecurityConstants</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">USER_KEY</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">));</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">        String</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;"> token</span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> SecurityUtils</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">getToken</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">StringUtils</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">isNotEmpty</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(token)) {</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">            LoginUser</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;"> loginUser</span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> AuthUtil</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">getLoginUser</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(token);</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">            if</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">StringUtils</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">isNotNull</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(loginUser)) {</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">                AuthUtil</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">verifyLoginUserExpire</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(loginUser);</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">                SecurityContextHolder</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">set</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">SecurityConstants</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">LOGIN_USER</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">, loginUser);</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">            }</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">        } </span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">else</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">            // Display for non-login scenario</span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">            // Check if the request path matches specific paths</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">            String</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;"> requestURI</span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> request</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">getRequestURI</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">            if</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">isExemptedPath</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(requestURI)) {</span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">                // Create a default LoginUser object</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">                LoginUser</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;"> defaultLoginUser</span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> createDefaultLoginUser</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">                SecurityContextHolder</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">set</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">SecurityConstants</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">LOGIN_USER</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">, defaultLoginUser);</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">            }</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#D19A66;--shiki-dark:#D19A66;"> true</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // Determine if the request path matches specific paths</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> boolean</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> isExemptedPath</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> requestURI</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // Adjust the path matching logic as needed</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> EXEMPTED_PATHS</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">stream</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">().</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">anyMatch</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(requestURI</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">::</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">startsWith);</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    // Create a default LoginUser object</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> LoginUser</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> createDefaultLoginUser</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">()</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">        LoginUser</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;"> defaultLoginUser</span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> LoginUser</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">        defaultLoginUser</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">setUserId</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#D19A66;--shiki-dark:#D19A66;">173L</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">);  </span><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// Set default user ID</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">        defaultLoginUser</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">setUsername</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">Constants</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">DEMO_ACCOUNT</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">);  </span><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// Set default username</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">        SysUser</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;"> demoSysUser</span><span style="--shiki-light:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> SysUser</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">        demoSysUser</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">setUserId</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#D19A66;--shiki-dark:#D19A66;">173L</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">        demoSysUser</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">setUserName</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">Constants</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">DEMO_ACCOUNT</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">        demoSysUser</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">setDeptId</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#D19A66;--shiki-dark:#D19A66;">100L</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">        demoSysUser</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">setStatus</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#98C379;--shiki-dark:#98C379;">&quot;0&quot;</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">        defaultLoginUser</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">setUser</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(demoSysUser);</span></span>
<span class="line"><span style="--shiki-light:#7F848E;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        // Set other necessary default properties</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> defaultLoginUser;</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">    @</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">Override</span></span>
<span class="line"><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;"> afterCompletion</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">HttpServletRequest</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> request</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">HttpServletResponse</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> response</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">Object</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> handler</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">Exception</span><span style="--shiki-light:#E06C75;--shiki-dark:#E06C75;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> ex</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#C678DD;--shiki-dark:#C678DD;"> throws</span><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;"> Exception</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E5C07B;--shiki-dark:#E5C07B;">        SecurityContextHolder</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#61AFEF;--shiki-dark:#61AFEF;">remove</span><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#ABB2BF;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="cac-cau-hoi-phong-van-du-ƒëoan" tabindex="-1"><a class="header-anchor" href="#cac-cau-hoi-phong-van-du-ƒëoan"><span>C√°c c√¢u h·ªèi ph·ªèng v·∫•n d·ª± ƒëo√°n</span></a></h1><div class="hint-container info"><p class="hint-container-title">Info</p><p>D∆∞·ªõi ƒë√¢y l√† c√°c c√¢u h·ªèi ph·ªèng v·∫•n c√≥ th·ªÉ g√¢y kh√≥ khƒÉn m√† b·∫°n c√≥ th·ªÉ g·∫∑p ph·∫£i.</p></div><h3 id="cac-cau-hoi-ƒëao-sau" tabindex="-1"><a class="header-anchor" href="#cac-cau-hoi-ƒëao-sau"><span>C√°c c√¢u h·ªèi ƒë√†o s√¢u:</span></a></h3><ol><li><strong>TransmittableThreadLocal (TTL) l√† g√¨ v√† m·ª•c ƒë√≠ch ch√≠nh c·ªßa n√≥ l√† g√¨?</strong></li><li><strong>TTL c√≥ nh·ªØng ∆∞u ƒëi·ªÉm g√¨ so v·ªõi ThreadLocal ti√™u chu·∫©n?</strong></li><li><strong>Trong d·ª± √°n c·ªßa b·∫°n, TTL ƒë√£ gi·∫£i quy·∫øt nh·ªØng v·∫•n ƒë·ªÅ c·ª• th·ªÉ n√†o?</strong></li><li><strong>TTL duy tr√¨ th√¥ng tin ng·ªØ c·∫£nh nh∆∞ th·∫ø n√†o trong m√¥i tr∆∞·ªùng thread pool?</strong></li><li><strong>B·∫°n ƒë√£ g·∫∑p ph·∫£i nh·ªØng v·∫•n ƒë·ªÅ g√¨ khi s·ª≠ d·ª•ng TTL? B·∫°n ƒë√£ gi·∫£i quy·∫øt ch√∫ng nh∆∞ th·∫ø n√†o?</strong></li><li><strong>TTL c√≥ ·∫£nh h∆∞·ªüng ƒë·∫øn hi·ªáu su·∫•t kh√¥ng? N·∫øu c√≥, b·∫°n ƒë√£ t·ªëi ∆∞u h√≥a hi·ªáu su·∫•t nh∆∞ th·∫ø n√†o?</strong></li><li><strong>B·∫°n c√≥ c√¢n nh·∫Øc c√°c gi·∫£i ph√°p kh√°c kh√¥ng? T·∫°i sao b·∫°n ch·ªçn TTL?</strong></li><li><strong>L√†m th·∫ø n√†o ƒë·ªÉ tri·ªÉn khai TTL ƒë·ªÉ l∆∞u tr·ªØ d·ªØ li·ªáu ng∆∞·ªùi d√πng? H√£y m√¥ t·∫£ chi ti·∫øt c√°c b∆∞·ªõc th·ª±c hi·ªán.</strong></li><li><strong>TTL x·ª≠ l√Ω t√¨nh hu·ªëng ƒë·ªìng th·ªùi nh∆∞ th·∫ø n√†o? B·∫°n ƒë√£ g·∫∑p v·∫•n ƒë·ªÅ v·ªÅ an to√†n lu·ªìng ch∆∞a?</strong></li><li><strong>Nguy√™n nh√¢n th·ª±c s·ª± c·ªßa r√≤ r·ªâ b·ªô nh·ªõ v·ªõi ThreadLocal l√† g√¨?</strong></li><li><strong>S·ª± kh√°c bi·ªát gi·ªØa r√≤ r·ªâ b·ªô nh·ªõ v√† tr√†n b·ªô nh·ªõ l√† g√¨?</strong></li><li><strong>ThreadLocalMap gi·∫£i quy·∫øt xung ƒë·ªôt nh∆∞ th·∫ø n√†o?</strong></li></ol><h3 id="vi-du-ve-ƒëoi-thoai" tabindex="-1"><a class="header-anchor" href="#vi-du-ve-ƒëoi-thoai"><span>V√≠ d·ª• v·ªÅ ƒë·ªëi tho·∫°i:</span></a></h3><p><strong>Nh√† tuy·ªÉn d·ª•ng:</strong> Ch√†o m·ª´ng b·∫°n ƒë·∫øn ph·ªèng v·∫•n. H√£y gi·ªõi thi·ªáu ng·∫Øn g·ªçn v·ªÅ b·ªëi c·∫£nh v√† tr√°ch nhi·ªám ch√≠nh khi s·ª≠ d·ª•ng TransmittableThreadLocal (TTL) ƒë·ªÉ l∆∞u tr·ªØ d·ªØ li·ªáu ng∆∞·ªùi d√πng trong d·ª± √°n c·ªßa b·∫°n.</p><p><strong>·ª®ng vi√™n:</strong> T·∫°i PmHub, v√¨ c·∫ßn ph·∫£i truy·ªÅn th√¥ng tin ng·ªØ c·∫£nh ng∆∞·ªùi d√πng gi·ªØa c√°c h·ªá th·ªëng vi d·ªãch v·ª•, ch√∫ng t√¥i ƒë√£ ch·ªçn s·ª≠ d·ª•ng TTL ƒë·ªÉ th·ª±c hi·ªán ch·ª©c nƒÉng n√†y. T√¥i ch·ªß y·∫øu ph·ª• tr√°ch vi·ªác ƒë∆∞a TTL v√†o s·ª≠ d·ª•ng v√† tri·ªÉn khai c·ª• th·ªÉ, bao g·ªìm vi·ªác truy·ªÅn th√¥ng tin ng·ªØ c·∫£nh v√† l∆∞u tr·ªØ d·ªØ li·ªáu ng∆∞·ªùi d√πng.</p><p><strong>Nh√† tuy·ªÉn d·ª•ng:</strong> B·∫°n c√≥ th·ªÉ gi·∫£i th√≠ch chi ti·∫øt TTL l√† g√¨ kh√¥ng? N√≥ kh√°c g√¨ so v·ªõi ThreadLocal ti√™u chu·∫©n?</p><p><strong>·ª®ng vi√™n:</strong> TTL l√† phi√™n b·∫£n n√¢ng cao c·ªßa ThreadLocal, ch·ªß y·∫øu ƒë∆∞·ª£c thi·∫øt k·∫ø ƒë·ªÉ gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ kh√¥ng th·ªÉ truy·ªÅn th√¥ng tin ng·ªØ c·∫£nh gi·ªØa c√°c lu·ªìng cha v√† con trong c√°c khung ƒëa lu·ªìng nh∆∞ thread pool. Kh√°c v·ªõi ThreadLocal ti√™u chu·∫©n, TTL cho ph√©p c√°c lu·ªìng con k·∫ø th·ª´a c√°c bi·∫øn ThreadLocal t·ª´ lu·ªìng cha.</p><p><strong>Nh√† tuy·ªÉn d·ª•ng:</strong> B·∫°n ƒë√£ ƒë·ªÅ c·∫≠p ƒë·∫øn ThreadLocal. B·∫°n c√≥ th·ªÉ m√¥ t·∫£ c·∫•u tr√∫c n·ªôi b·ªô c·ªßa n√≥ kh√¥ng?</p><p><strong>·ª®ng vi√™n:</strong> Trong ThreadLocal, m·ªói lu·ªìng duy tr√¨ m·ªôt ThreadLocalMap. Map n√†y ƒë∆∞·ª£c qu·∫£n l√Ω b·ªüi ThreadLocal, v·ªõi c√°c kh√≥a l√† c√°c ƒë·ªëi t∆∞·ª£ng ThreadLocal v√† c√°c gi√° tr·ªã l√† c√°c b·∫£n sao bi·∫øn. Map ch·ªß y·∫øu cung c·∫•p c√°c ph∆∞∆°ng th·ª©c <code>set</code> v√† <code>get</code>.</p><p><strong>Nh√† tuy·ªÉn d·ª•ng:</strong> B·∫°n c√≥ hi·ªÉu c·∫•u tr√∫c c∆° b·∫£n c·ªßa ThreadLocalMap kh√¥ng?</p><p><strong>·ª®ng vi√™n:</strong> ThreadLocalMap l√† l·ªõp n·ªôi b·ªô tƒ©nh c·ªßa ThreadLocal, v·ªõi c√°c kh√≥a l√† tham chi·∫øu y·∫øu ƒë·∫øn c√°c ƒë·ªëi t∆∞·ª£ng ThreadLocal. Thi·∫øt k·∫ø n√†y nh·∫±m t√°ch bi·ªát v√≤ng ƒë·ªùi c·ªßa c√°c ƒë·ªëi t∆∞·ª£ng ThreadLocal kh·ªèi v√≤ng ƒë·ªùi c·ªßa c√°c lu·ªìng.</p><p><strong>Nh√† tuy·ªÉn d·ª•ng:</strong> B·∫°n ƒë√£ n√≥i r·∫±ng c√°c kh√≥a trong ThreadLocalMap s·ª≠ d·ª•ng tham chi·∫øu y·∫øu. ƒêi·ªÅu n√†y c√≥ th·ªÉ g√¢y ra v·∫•n ƒë·ªÅ g√¨?</p><p><strong>·ª®ng vi√™n:</strong> Vi·ªác s·ª≠ d·ª•ng tham chi·∫øu y·∫øu cho c√°c kh√≥a trong ThreadLocalMap c√≥ th·ªÉ d·∫´n ƒë·∫øn r√≤ r·ªâ b·ªô nh·ªõ.</p><p><strong>Nh√† tuy·ªÉn d·ª•ng:</strong> R√≤ r·ªâ b·ªô nh·ªõ l√† g√¨? N√≥ kh√°c g√¨ so v·ªõi tr√†n b·ªô nh·ªõ?</p><p><strong>·ª®ng vi√™n:</strong> R√≤ r·ªâ b·ªô nh·ªõ x·∫£y ra khi c√°c ƒë·ªëi t∆∞·ª£ng kh√¥ng c√≤n s·ª≠ d·ª•ng ƒë∆∞·ª£c kh√¥ng th·ªÉ ƒë∆∞·ª£c GC thu h·ªìi v√† ti·∫øp t·ª•c chi·∫øm b·ªô nh·ªõ, d·∫´n ƒë·∫øn l√£ng ph√≠ kh√¥ng gian v√† cu·ªëi c√πng c√≥ th·ªÉ g√¢y ra tr√†n b·ªô nh·ªõ. Tr√†n b·ªô nh·ªõ x·∫£y ra khi ch∆∞∆°ng tr√¨nh y√™u c·∫ßu b·ªô nh·ªõ m√† kh√¥ng c√≤n ƒë·ªß kh√¥ng gian, d·∫´n ƒë·∫øn l·ªói <code>OutOfMemoryError</code>.</p><p><strong>Nh√† tuy·ªÉn d·ª•ng:</strong> OK, b·∫°n c√≥ bi·∫øt nguy√™n nh√¢n th·ª±c s·ª± c·ªßa vi·ªác r√≤ r·ªâ b·ªô nh·ªõ v·ªõi ThreadLocal l√† g√¨ kh√¥ng?</p><p><strong>·ª®ng vi√™n:</strong> Th·ª© nh·∫•t, n·∫øu kh√¥ng x√≥a c√°c ƒë·ªëi t∆∞·ª£ng Entry th·ªß c√¥ng, b·∫°n c√≥ th·ªÉ g·ªçi ph∆∞∆°ng th·ª©c <code>remove</code> c·ªßa ThreadLocal sau khi s·ª≠ d·ª•ng ƒë·ªÉ x√≥a Entry t∆∞∆°ng ·ª©ng v√† tr√°nh r√≤ r·ªâ b·ªô nh·ªõ. Th·ª© hai, vi·ªác s·ª≠ d·ª•ng ThreadLocal c·∫ßn ƒë∆∞·ª£c d·ªçn d·∫πp khi lu·ªìng k·∫øt th√∫c.</p><p>Nguy√™n nh√¢n g·ªëc r·ªÖ l√† v√≤ng ƒë·ªùi c·ªßa ThreadLocalMap v√† lu·ªìng l√† nh∆∞ nhau.</p><p><strong>Nh√† tuy·ªÉn d·ª•ng:</strong> OK, b·∫°n c√≥ bi·∫øt ThreadLocalMap gi·∫£i quy·∫øt xung ƒë·ªôt hash nh∆∞ th·∫ø n√†o kh√¥ng?</p><p><strong>·ª®ng vi√™n:</strong> N·∫øu c√≥ xung ƒë·ªôt hash, ch·ªâ s·ªë trong m·∫£ng s·∫Ω ƒë∆∞·ª£c tƒÉng l√™n 1. N·∫øu xung ƒë·ªôt v·∫´n c√≤n, t√≠nh to√°n ti·∫øp cho ƒë·∫øn khi v∆∞·ª£t qu√° ch·ªâ s·ªë m·∫£ng, l√∫c n√†y s·∫Ω quay l·∫°i b·∫Øt ƒë·∫ßu, t∆∞∆°ng t·ª± nh∆∞ m·ªôt m·∫£ng v√≤ng tr√≤n.</p><p><strong>Nh√† tuy·ªÉn d·ª•ng:</strong> B·∫°n c√≥ th·ªÉ m√¥ t·∫£ chi ti·∫øt c√°c b∆∞·ªõc tri·ªÉn khai TTL ƒë·ªÉ l∆∞u tr·ªØ d·ªØ li·ªáu ng∆∞·ªùi d√πng kh√¥ng?</p><p><strong>·ª®ng vi√™n:</strong> Sau khi ng∆∞·ªùi d√πng ƒëƒÉng nh·∫≠p, m·ªôt m√£ th√¥ng b√°o s·∫Ω ƒë∆∞·ª£c tr·∫£ v·ªÅ v√† c√°c y√™u c·∫ßu sau ƒë√≥ s·∫Ω mang theo m√£ th√¥ng b√°o n√†y. M√£ th√¥ng b√°o ch·ª©a th√¥ng tin ng∆∞·ªùi d√πng. T·∫•t c·∫£ c√°c y√™u c·∫ßu ƒë·∫ßu ti√™n ƒëi qua b·ªô l·ªçc AuthFilter c·ªßa gateway, trong b·ªô l·ªçc n√†y, th√¥ng tin ng∆∞·ªùi d√πng ƒë∆∞·ª£c ƒë·∫∑t v√†o ti√™u ƒë·ªÅ y√™u c·∫ßu. Sau khi ƒëi qua gateway, c√°c y√™u c·∫ßu ƒë·∫øn b·ªô l·ªçc ti√™u ƒë·ªÅ HeaderInterceptor t√πy ch·ªânh, n∆°i th√¥ng tin ng∆∞·ªùi d√πng t·ª´ ti√™u ƒë·ªÅ y√™u c·∫ßu ƒë∆∞·ª£c ƒë∆∞a v√†o TTL. Nh∆∞ v·∫≠y, c√°c d·ªãch v·ª• tr√™n chu·ªói c√≥ th·ªÉ tr·ª±c ti·∫øp l·∫•y th√¥ng tin ng∆∞·ªùi d√πng t·ª´ TTL.</p><p><strong>Nh√† tuy·ªÉn d·ª•ng:</strong> TTL c√≥ ·∫£nh h∆∞·ªüng ƒë·∫øn hi·ªáu su·∫•t kh√¥ng? B·∫°n ƒë√£ t·ªëi ∆∞u h√≥a hi·ªáu su·∫•t nh∆∞ th·∫ø n√†o?</p><p><strong>·ª®ng vi√™n:</strong> Vi·ªác s·ª≠ d·ª•ng TTL th·ª±c s·ª± c√≥ m·ªôt s·ªë chi ph√≠ hi·ªáu su·∫•t, ƒë·∫∑c bi·ªát trong c√°c k·ªãch b·∫£n t·∫°o v√† h·ªßy lu·ªìng th∆∞·ªùng xuy√™n. ƒê·ªÉ t·ªëi ∆∞u h√≥a hi·ªáu su·∫•t, ch√∫ng t√¥i ƒë√£ gi·∫£m thi·ªÉu s·ªë l·∫ßn t·∫°o v√† h·ªßy lu·ªìng v√† theo d√µi vi·ªác s·ª≠ d·ª•ng TTL ƒë·ªÉ ƒë·∫£m b·∫£o kh√¥ng g√¢y ra r√≤ r·ªâ b·ªô nh·ªõ ho·∫∑c t·∫Øc ngh·∫Ωn hi·ªáu su·∫•t.</p><p><strong>Nh√† tuy·ªÉn d·ª•ng:</strong> Trong d·ª± √°n c·ªßa b·∫°n, b·∫°n ƒë√£ g·∫∑p ph·∫£i v·∫•n ƒë·ªÅ r√≤ r·ªâ b·ªô nh·ªõ do TTL g√¢y ra ch∆∞a? N·∫øu c√≥, b·∫°n ƒë√£ gi·∫£i quy·∫øt nh∆∞ th·∫ø n√†o?</p><p><strong>·ª®ng vi√™n:</strong> C√≥, ch√∫ng t√¥i ƒë√£ g·∫∑p ph·∫£i m·ªôt v·∫•n ƒë·ªÅ r√≤ r·ªâ b·ªô nh·ªõ do s·ª≠ d·ª•ng TTL kh√¥ng ƒë√∫ng c√°ch. Nguy√™n nh√¢n l√† m·ªôt s·ªë lu·ªìng ch·∫°y l√¢u d√†i kh√¥ng d·ªçn d·∫πp c√°c bi·∫øn ThreadLocal m√† ch√∫ng gi·ªØ. ƒê·ªÉ gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ n√†y, ch√∫ng t√¥i ƒë√£ ƒë·∫£m b·∫£o d·ªçn d·∫πp c√°c bi·∫øn ThreadLocal li√™n quan sau m·ªói y√™u c·∫ßu trong ph∆∞∆°ng th·ª©c <code>afterCompletion</code> c·ªßa HeaderInterceptor. Ch√∫ng t√¥i c≈©ng th√™m c∆° ch·∫ø ki·ªÉm tra v√† d·ªçn d·∫πp ƒë·ªãnh k·ª≥ ƒë·ªÉ ngƒÉn ng·ª´a r√≤ r·ªâ b·ªô nh·ªõ.</p><p><strong>Nh√† tuy·ªÉn d·ª•ng:</strong> Khi s·ª≠ d·ª•ng TTL, b·∫°n ƒë√£ g·∫∑p ph·∫£i v·∫•n ƒë·ªÅ ƒë·ªìng th·ªùi ch∆∞a? N·∫øu c√≥, b·∫°n ƒë√£ x·ª≠ l√Ω nh∆∞ th·∫ø n√†o?</p><p><strong>·ª®ng vi√™n:</strong> Khi s·ª≠ d·ª•ng TTL, v√¨ m·ªói lu·ªìng c√≥ m·ªôt th·ªÉ hi·ªán bi·∫øn ThreadLocal ri√™ng bi·ªát, n√™n v·∫•n ƒë·ªÅ ƒë·ªìng th·ªùi th∆∞·ªùng kh√¥ng x·∫£y ra. Tuy nhi√™n, ch√∫ng t√¥i ƒë√£ g·∫∑p ph·∫£i t√¨nh tr·∫°ng gi√° tr·ªã TTL b·ªã s·ª≠a ƒë·ªïi sai trong c√°c t√¨nh hu·ªëng ƒë·ªìng th·ªùi cao. ƒê·ªÉ gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ n√†y, ch√∫ng t√¥i ƒë√£ th√™m c∆° ch·∫ø ƒë·ªìng b·ªô h√≥a trong c√°c ƒëo·∫°n m√£ quan tr·ªçng v√† s·ª≠ d·ª•ng c√°c t·∫≠p h·ª£p an to√†n lu·ªìng ƒë·ªÉ l∆∞u tr·ªØ d·ªØ li·ªáu chia s·∫ª, nh·∫±m tr√°nh vi·ªác s·ª≠a ƒë·ªïi ƒë·ªìng th·ªùi.</p><p><strong>Nh√† tuy·ªÉn d·ª•ng:</strong> B·∫°n c√≥ th·ªÉ n√™u m·ªôt s·ªë v√≠ d·ª• c·ª• th·ªÉ v·ªÅ c√°c t√¨nh hu·ªëng s·ª≠ d·ª•ng TTL trong d·ª± √°n c·ªßa b·∫°n kh√¥ng?</p><p><strong>·ª®ng vi√™n:</strong> T·∫•t nhi√™n. Trong d·ª± √°n c·ªßa ch√∫ng t√¥i, c√≥ m·ªôt t√¨nh hu·ªëng l√† ghi l·∫°i nh·∫≠t k√Ω ho·∫°t ƒë·ªông sau khi ng∆∞·ªùi d√πng ƒëƒÉng nh·∫≠p. B·∫±ng c√°ch s·ª≠ d·ª•ng TTL, ch√∫ng t√¥i c√≥ th·ªÉ l·∫•y th√¥ng tin chi ti·∫øt c·ªßa ng∆∞·ªùi d√πng khi ghi nh·∫≠t k√Ω ƒë·ªìng th·ªùi, ƒë·∫£m b·∫£o t√≠nh ch√≠nh x√°c c·ªßa nh·∫≠t k√Ω. M·ªôt v√≠ d·ª• kh√°c l√† qu·∫£n l√Ω giao d·ªãch ph√¢n t√°n, th√¥ng qua TTL ƒë·ªÉ truy·ªÅn b·ªëi c·∫£nh giao d·ªãch, ƒë·∫£m b·∫£o t√≠nh nh·∫•t qu√°n c·ªßa giao d·ªãch gi·ªØa c√°c d·ªãch v·ª•. Th√™m v√†o ƒë√≥, trong m·ªôt s·ªë t√¨nh hu·ªëng c·∫ßn truy·ªÅn d·ªØ li·ªáu qua c√°c lu·ªìng, nh∆∞ x√°c th·ª±c ng∆∞·ªùi d√πng trong c√°c t√°c v·ª• b·∫•t ƒë·ªìng b·ªô, ch√∫ng t√¥i c≈©ng s·ª≠ d·ª•ng TTL ƒë·ªÉ truy·ªÅn v√† l∆∞u tr·ªØ d·ªØ li·ªáu ng∆∞·ªùi d√πng.</p>`,89))])}const F=h(r,[["render",d],["__file","ttl.html.vue"]]),y=JSON.parse('{"path":"/project/pmhub/ttl.html","title":"TransmittableThreadLocal","lang":"en-US","frontmatter":{"title":"TransmittableThreadLocal","tags":["java","microservice"],"categories":["project"],"order":4,"description":"PmHub - Save user information with TransmittableThreadLocal Info D·ª±a tr√™n TransmittableThreadLocal (TTL) ƒë·ªÉ t√πy ch·ªânh tr√¨nh ch·∫∑n request header, ƒë√≥ng g√≥i d·ªØ li·ªáu header v√†o bi·∫øn...","head":[["meta",{"property":"og:url","content":"https://vanhung4499.github.io/project/pmhub/ttl.html"}],["meta",{"property":"og:site_name","content":"VanHung4499"}],["meta",{"property":"og:title","content":"TransmittableThreadLocal"}],["meta",{"property":"og:description","content":"PmHub - Save user information with TransmittableThreadLocal Info D·ª±a tr√™n TransmittableThreadLocal (TTL) ƒë·ªÉ t√πy ch·ªânh tr√¨nh ch·∫∑n request header, ƒë√≥ng g√≥i d·ªØ li·ªáu header v√†o bi·∫øn..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"https://raw.githubusercontent.com/vanhung4499/images/master/snap/20200930144753491.png"}],["meta",{"property":"og:locale","content":"en-US"}],["meta",{"property":"og:updated_time","content":"2024-10-02T17:20:50.000Z"}],["meta",{"property":"article:author","content":"Hung Nguyen"}],["meta",{"property":"article:tag","content":"java"}],["meta",{"property":"article:tag","content":"microservice"}],["meta",{"property":"article:modified_time","content":"2024-10-02T17:20:50.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"TransmittableThreadLocal\\",\\"image\\":[\\"https://raw.githubusercontent.com/vanhung4499/images/master/snap/20200930144753491.png\\",\\"https://raw.githubusercontent.com/vanhung4499/images/master/snap/20240917004006.png\\",\\"https://raw.githubusercontent.com/vanhung4499/images/master/snap/20240917004109.png\\",\\"https://raw.githubusercontent.com/vanhung4499/images/master/snap/20240917004325.png\\"],\\"dateModified\\":\\"2024-10-02T17:20:50.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"Hung Nguyen\\",\\"url\\":\\"https://vanhung4499.github.io\\"}]}"]]},"headers":[{"level":2,"title":"Gi·ªõi thi·ªáu ThreadLocal","slug":"gioi-thieu-threadlocal","link":"#gioi-thieu-threadlocal","children":[{"level":3,"title":"ThreadLocal l√† g√¨?","slug":"threadlocal-la-gi","link":"#threadlocal-la-gi","children":[]},{"level":3,"title":"S·ª± kh√°c bi·ªát gi·ªØa ThreadLocal v√† Synchronized?","slug":"su-khac-biet-giua-threadlocal-va-synchronized","link":"#su-khac-biet-giua-threadlocal-va-synchronized","children":[]},{"level":3,"title":"C√°c tr∆∞·ªùng h·ª£p s·ª≠ d·ª•ng ThreadLocal","slug":"cac-truong-hop-su-dung-threadlocal","link":"#cac-truong-hop-su-dung-threadlocal","children":[]}]},{"level":2,"title":"Nguy√™n l√Ω c·ªßa ThreadLocal","slug":"nguyen-ly-cua-threadlocal","link":"#nguyen-ly-cua-threadlocal","children":[{"level":3,"title":"C·∫•u tr√∫c n·ªôi b·ªô c·ªßa ThreadLocal","slug":"cau-truc-noi-bo-cua-threadlocal","link":"#cau-truc-noi-bo-cua-threadlocal","children":[]},{"level":3,"title":"C·∫•u tr√∫c c∆° b·∫£n c·ªßa ThreadLocalMap","slug":"cau-truc-co-ban-cua-threadlocalmap","link":"#cau-truc-co-ban-cua-threadlocalmap","children":[]}]},{"level":2,"title":"Gi·ªõi thi·ªáu v·ªÅ TransmittableThreadLocal (TTL)","slug":"gioi-thieu-ve-transmittablethreadlocal-ttl","link":"#gioi-thieu-ve-transmittablethreadlocal-ttl","children":[{"level":3,"title":"TTL l√† g√¨?","slug":"ttl-la-gi","link":"#ttl-la-gi","children":[]},{"level":3,"title":"Nguy√™n l√Ω ho·∫°t ƒë·ªông c·ªßa TTL","slug":"nguyen-ly-hoat-ƒëong-cua-ttl","link":"#nguyen-ly-hoat-ƒëong-cua-ttl","children":[]},{"level":3,"title":"C√°c tr∆∞·ªùng h·ª£p s·ª≠ d·ª•ng ch√≠nh c·ªßa TTL","slug":"cac-truong-hop-su-dung-chinh-cua-ttl","link":"#cac-truong-hop-su-dung-chinh-cua-ttl","children":[]}]},{"level":2,"title":"∆Øu ƒëi·ªÉm c·ªßa TTL so v·ªõi ThreadLocal","slug":"uu-ƒëiem-cua-ttl-so-voi-threadlocal","link":"#uu-ƒëiem-cua-ttl-so-voi-threadlocal","children":[]},{"level":2,"title":"Th·ª±c H√†nh D·ª± √Ån","slug":"thuc-hanh-du-an","link":"#thuc-hanh-du-an","children":[{"level":3,"title":"C√°c c√¢u h·ªèi ƒë√†o s√¢u:","slug":"cac-cau-hoi-ƒëao-sau","link":"#cac-cau-hoi-ƒëao-sau","children":[]},{"level":3,"title":"V√≠ d·ª• v·ªÅ ƒë·ªëi tho·∫°i:","slug":"vi-du-ve-ƒëoi-thoai","link":"#vi-du-ve-ƒëoi-thoai","children":[]}]}],"git":{"createdTime":1727889650000,"updatedTime":1727889650000,"contributors":[{"name":"Hung Nguyen Van","email":"vanhung4499@gmail.com","commits":1}]},"readingTime":{"minutes":18.06,"words":5417},"filePathRelative":"project/pmhub/ttl.md","localizedDate":"October 2, 2024","excerpt":"\\n<div class=\\"hint-container info\\">\\n<p class=\\"hint-container-title\\">Info</p>\\n<ul>\\n<li>D·ª±a tr√™n <strong>TransmittableThreadLocal (TTL)</strong> ƒë·ªÉ t√πy ch·ªânh tr√¨nh ch·∫∑n request header, ƒë√≥ng g√≥i d·ªØ li·ªáu header v√†o bi·∫øn lu·ªìng ƒë·ªÉ d·ªÖ d√†ng truy xu·∫•t, gi·∫£m s·ªë l·∫ßn truy v·∫•n c∆° s·ªü d·ªØ li·ªáu v·ªÅ th√¥ng tin ng∆∞·ªùi d√πng, ƒë·ªìng th·ªùi x√°c minh v√† t·ª± ƒë·ªông l√†m m·ªõi th·ªùi gian hi·ªáu l·ª±c c·ªßa ng∆∞·ªùi d√πng hi·ªán t·∫°i.</li>\\n</ul>\\n</div>","autoDesc":true}');export{F as comp,y as data};
