import{_ as s,o as n,c as a,d as e}from"./app-BsgpqssW.js";const i={},t=e(`<h1 id="quan-tri-redis" tabindex="-1"><a class="header-anchor" href="#quan-tri-redis"><span>Quản trị Redis</span></a></h1><blockquote><p><strong>Redis</strong> là một cơ sở dữ liệu key-value có hiệu suất cao.</p><p>Thao tác SET có thể đạt tới 110.000 lần mỗi giây; thao tác GET có thể đạt tới 81.000 lần mỗi giây.</p></blockquote><h2 id="_1-cai-đat-redis" tabindex="-1"><a class="header-anchor" href="#_1-cai-đat-redis"><span>1. Cài đặt Redis</span></a></h2><h3 id="cai-đat-tren-windows" tabindex="-1"><a class="header-anchor" href="#cai-đat-tren-windows"><span>Cài đặt trên Windows</span></a></h3><p><strong>Đường dẫn tải về:</strong> <a href="https://github.com/MSOpenTech/redis/releases" target="_blank" rel="noopener noreferrer">https://github.com/MSOpenTech/redis/releases</a>.</p><p>Redis hỗ trợ cả phiên bản 32-bit và 64-bit. Bạn cần chọn phiên bản phù hợp với hệ điều hành của bạn. Tại đây, chúng ta tải xuống tệp nén <strong>Redis-x64-xxx.zip</strong> và giải nén vào ổ đĩa C, sau đó đổi tên thư mục thành <strong>redis</strong>.</p><p>Mở cửa sổ <strong>cmd</strong> và sử dụng lệnh cd để chuyển đến thư mục <strong>C:\\redis</strong>, chạy lệnh <strong>redis-server.exe redis.windows.conf</strong>.</p><p>Nếu muốn tiện lợi hơn, bạn có thể thêm đường dẫn của Redis vào biến môi trường hệ thống, điều này sẽ giúp bạn không cần phải nhập đường dẫn mỗi lần sử dụng. Bạn có thể bỏ qua phần redis.windows.conf nếu muốn, nếu bỏ qua, Redis sẽ sử dụng cấu hình mặc định.</p><p>Bây giờ mở một cửa sổ cmd mới, không đóng cửa sổ cũ, vì nếu đóng thì bạn sẽ không thể truy cập vào máy chủ dịch vụ nữa.</p><p>Chuyển đến thư mục redis và chạy lệnh <strong>redis-cli.exe -h 127.0.0.1 -p 6379</strong>.</p><h3 id="cai-đat-tren-linux" tabindex="-1"><a class="header-anchor" href="#cai-đat-tren-linux"><span>Cài đặt trên Linux</span></a></h3><p><strong>Đường dẫn tải về:</strong> <a href="http://redis.io/download" target="_blank" rel="noopener noreferrer">http://redis.io/download</a>, tải phiên bản mới nhất.</p><p>Tải xuống, giải nén và biên dịch Redis:</p><div class="language-shell" data-ext="shell" data-title="shell"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">wget</span><span style="color:#98C379;--shiki-dark:#98C379;"> http://download.redis.io/releases/redis-5.0.4.tar.gz</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">tar</span><span style="color:#98C379;--shiki-dark:#98C379;"> xzf</span><span style="color:#98C379;--shiki-dark:#98C379;"> redis-5.0.4.tar.gz</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">cd</span><span style="color:#98C379;--shiki-dark:#98C379;"> redis-5.0.4</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">make</span></span></code></pre></div><p>Để biên dịch mã nguồn Redis, bạn cần cài đặt gcc-c++ và tcl. Nếu bạn đang sử dụng CentOS, bạn có thể cài đặt bằng lệnh <code>yum install -y gcc-c++ tcl</code>.</p><p>Sau khi giải nén, điều hướng đến thư mục <code>src</code> và khởi động Redis bằng lệnh sau:</p><div class="language-shell" data-ext="shell" data-title="shell"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">src/redis-server</span></span></code></pre></div><p>Bạn có thể sử dụng client tích hợp để tương tác với Redis:</p><div class="language-shell" data-ext="shell" data-title="shell"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">$</span><span style="color:#98C379;--shiki-dark:#98C379;"> src/redis-cli</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">redis</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">&gt; </span><span style="color:#98C379;--shiki-dark:#98C379;">set</span><span style="color:#98C379;--shiki-dark:#98C379;"> foo</span><span style="color:#98C379;--shiki-dark:#98C379;"> bar</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">OK</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">redis</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">&gt; </span><span style="color:#98C379;--shiki-dark:#98C379;">get</span><span style="color:#98C379;--shiki-dark:#98C379;"> foo</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">&quot;bar&quot;</span></span></code></pre></div><h3 id="cai-đat-tren-ubuntu" tabindex="-1"><a class="header-anchor" href="#cai-đat-tren-ubuntu"><span>Cài đặt trên Ubuntu</span></a></h3><p>Trên hệ điều hành Ubuntu, bạn có thể cài đặt Redis bằng các lệnh sau:</p><div class="language-shell" data-ext="shell" data-title="shell"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">sudo</span><span style="color:#98C379;--shiki-dark:#98C379;"> apt-get</span><span style="color:#98C379;--shiki-dark:#98C379;"> update</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">sudo</span><span style="color:#98C379;--shiki-dark:#98C379;"> apt-get</span><span style="color:#98C379;--shiki-dark:#98C379;"> install</span><span style="color:#98C379;--shiki-dark:#98C379;"> redis-server</span></span></code></pre></div><h3 id="tu-đong-khoi-đong-khi-may-khoi-đong" tabindex="-1"><a class="header-anchor" href="#tu-đong-khoi-đong-khi-may-khoi-đong"><span>Tự động khởi động khi máy khởi động</span></a></h3><ul><li>Cấu hình tự động khởi động: <code>echo &quot;/usr/local/bin/redis-server /etc/redis.conf&quot; &gt;&gt; /etc/rc.local</code></li></ul><h3 id="mo-cong-tren-tuong-lua" tabindex="-1"><a class="header-anchor" href="#mo-cong-tren-tuong-lua"><span>Mở cổng trên tường lửa</span></a></h3><ul><li>Thêm quy tắc: <code>iptables -I INPUT -p tcp -m tcp --dport 6379 -j ACCEPT</code></li><li>Lưu quy tắc: <code>service iptables save</code></li><li>Khởi động lại iptables: <code>service iptables restart</code></li></ul><h3 id="kich-ban-cai-đat-redis" tabindex="-1"><a class="header-anchor" href="#kich-ban-cai-đat-redis"><span>Kịch bản cài đặt Redis</span></a></h3><blockquote><p>Kịch bản cài đặt cho môi trường CentOS 7</p></blockquote><p><strong>Hướng dẫn cài đặt</strong></p><ul><li>Cài đặt Redis bằng cách biên dịch và đăng ký nó như một dịch vụ systemd</li><li>Đường dẫn cài đặt là: <code>/usr/local/redis</code></li><li>Phiên bản mặc định là <code>5.0.4</code>, cổng mặc định là <code>6379</code>, mật khẩu truy cập là trống</li></ul><p><strong>Cách sử dụng</strong></p><ul><li>Cài đặt mặc định - Chạy bất kỳ lệnh nào sau đây:</li></ul><div class="language-shell" data-ext="shell" data-title="shell"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">curl</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> -o-</span><span style="color:#98C379;--shiki-dark:#98C379;"> https://gitee.com/turnon/linux-tutorial/raw/master/codes/linux/soft/redis-install.sh</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> | </span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">bash</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">wget</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> -qO-</span><span style="color:#98C379;--shiki-dark:#98C379;"> https://gitee.com/turnon/linux-tutorial/raw/master/codes/linux/soft/redis-install.sh</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> | </span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">bash</span></span></code></pre></div><ul><li>Cài đặt tùy chỉnh - Tải xuống kịch bản và chạy theo định dạng sau:</li></ul><div class="language-shell" data-ext="shell" data-title="shell"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">sh</span><span style="color:#98C379;--shiki-dark:#98C379;"> redis-install.sh</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> [version] [port] [password]</span></span></code></pre></div><p>Giải thích các tham số:</p><ul><li><code>version</code> - số phiên bản Redis</li><li><code>port</code> - số cổng dịch vụ Redis</li><li><code>password</code> - mật khẩu truy cập</li></ul><h2 id="_2-su-dung-va-cau-hinh-redis-đon" tabindex="-1"><a class="header-anchor" href="#_2-su-dung-va-cau-hinh-redis-đon"><span>2. Sử dụng và cấu hình Redis đơn</span></a></h2><h3 id="khoi-đong-redis" tabindex="-1"><a class="header-anchor" href="#khoi-đong-redis"><span>Khởi động Redis</span></a></h3><p><strong>Khởi động dịch vụ Redis</strong></p><div class="language-shell" data-ext="shell" data-title="shell"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">cd</span><span style="color:#98C379;--shiki-dark:#98C379;"> /usr/local/redis/src</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">./redis-server</span></span></code></pre></div><p><strong>Khởi động client Redis</strong></p><div class="language-shell" data-ext="shell" data-title="shell"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">cd</span><span style="color:#98C379;--shiki-dark:#98C379;"> /usr/local/redis/src</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">./redis-cli</span></span></code></pre></div><p><strong>Kiểm tra Redis đã khởi động chưa</strong></p><div class="language-shell" data-ext="shell" data-title="shell"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">redis-cli</span></span></code></pre></div><p>Lệnh trên sẽ mở một terminal như sau:</p><div class="language-shell" data-ext="shell" data-title="shell"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">redis</span><span style="color:#98C379;--shiki-dark:#98C379;"> 127.0.0.1:637</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">9&gt;</span></span></code></pre></div><p>127.0.0.1 là địa chỉ IP của máy local, 6379 là cổng của dịch vụ Redis. Bây giờ chúng ta gõ lệnh PING.</p><div class="language-shell" data-ext="shell" data-title="shell"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">redis</span><span style="color:#98C379;--shiki-dark:#98C379;"> 127.0.0.1:637</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">9&gt; </span><span style="color:#98C379;--shiki-dark:#98C379;">ping</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">PONG</span></span></code></pre></div><p>Điều này chứng tỏ chúng ta đã khởi động Redis thành công.</p><h3 id="cau-hinh-redis-thong-thuong" tabindex="-1"><a class="header-anchor" href="#cau-hinh-redis-thong-thuong"><span>Cấu hình Redis thông thường</span></a></h3><blockquote><p>Tệp cấu hình mặc định của Redis là <code>redis.conf</code> trong thư mục gốc.</p><p>Nếu bạn muốn chỉ định một tệp cấu hình cụ thể, bạn cần sử dụng lệnh: <code>./redis-server -c xxx.conf</code></p><p>Sau mỗi lần thay đổi cấu hình, bạn cần khởi động lại Redis để áp dụng thay đổi.</p><p>Cấu hình mặc định của Redis:</p><ul><li>Tài liệu mô tả bản thân <a href="https://raw.githubusercontent.com/antirez/redis/2.8/redis.conf" target="_blank" rel="noopener noreferrer">redis.conf cho Redis 2.8</a></li><li>Tài liệu mô tả bản thân <a href="https://raw.githubusercontent.com/antirez/redis/2.6/redis.conf" target="_blank" rel="noopener noreferrer">redis.conf cho Redis 2.6</a>.</li><li>Tài liệu mô tả bản thân <a href="https://raw.githubusercontent.com/antirez/redis/2.4/redis.conf" target="_blank" rel="noopener noreferrer">redis.conf cho Redis 2.4</a>.</li></ul><p>Từ Redis 2.6 trở đi, bạn có thể truyền các tham số cấu hình Redis trực tiếp từ dòng lệnh. Phương pháp này có thể được sử dụng cho mục đích kiểm tra.</p></blockquote><h3 id="đat-redis-lam-tien-trinh-nen" tabindex="-1"><a class="header-anchor" href="#đat-redis-lam-tien-trinh-nen"><span>Đặt Redis làm tiến trình nền</span></a></h3><p>Redis mặc định không chạy như một tiến trình nền, nhưng thông thường chúng ta sẽ đặt Redis làm tiến trình nền. Cấu hình: <code>daemonize yes</code></p><h4 id="truy-cap-tu-xa" tabindex="-1"><a class="header-anchor" href="#truy-cap-tu-xa"><span>Truy cập từ xa</span></a></h4><p>Redis mặc định ràng buộc với địa chỉ 127.0.0.1, điều này chỉ cho phép truy cập từ máy cục bộ. Nếu bạn muốn cho phép truy cập từ xa vào Redis, bạn cần cấu hình: <code>bind 0.0.0.0</code></p><h4 id="đat-mat-khau" tabindex="-1"><a class="header-anchor" href="#đat-mat-khau"><span>Đặt mật khẩu</span></a></h4><p>Redis mặc định không yêu cầu mật khẩu khi truy cập. Nếu bạn muốn đặt mật khẩu, bạn cần cấu hình như sau:</p><ul><li><code>protected-mode yes</code></li><li><code>requirepass &lt;mật khẩu&gt;</code></li></ul><h4 id="bang-tham-so-cau-hinh" tabindex="-1"><a class="header-anchor" href="#bang-tham-so-cau-hinh"><span>Bảng tham số cấu hình</span></a></h4><table><thead><tr><th style="text-align:left;">Cấu hình</th><th style="text-align:left;">Mô tả</th></tr></thead><tbody><tr><td style="text-align:left;"><code>daemonize no</code></td><td style="text-align:left;">Redis mặc định không chạy như một tiến trình nền, bạn có thể sử dụng cấu hình này để thay đổi. Sử dụng <code>yes</code> để bật chế độ tiến trình nền (Windows không hỗ trợ cấu hình tiến trình nền).</td></tr><tr><td style="text-align:left;"><code>pidfile /var/run/redis.pid</code></td><td style="text-align:left;">Khi Redis chạy như một tiến trình nền, Redis mặc định sẽ ghi pid vào tệp /var/run/redis.pid. Bạn có thể chỉ định pidfile để thay đổi vị trí ghi pid.</td></tr><tr><td style="text-align:left;"><code>port 6379</code></td><td style="text-align:left;">Chỉ định cổng mà Redis lắng nghe, mặc định là cổng 6379. Nguyên tắc chọn cổng mặc định là 6379 được giải thích trong bài viết của tác giả, vì 6379 tương ứng với MERZ trên bàn phím điện thoại di động, MERZ lấy từ tên của nữ ca sĩ Alessia Merz của Ý.</td></tr><tr><td style="text-align:left;"><code>bind 127.0.0.1</code></td><td style="text-align:left;">Địa chỉ IP của máy chủ được ràng buộc</td></tr><tr><td style="text-align:left;"><code>timeout 300</code></td><td style="text-align:left;">Thời gian chờ tối đa (giây) trước khi đóng kết nối với khách hàng. Nếu đặt thành 0, chức năng này sẽ bị tắt.</td></tr><tr><td style="text-align:left;"><code>loglevel notice</code></td><td style="text-align:left;">Chỉ định cấp độ ghi nhật ký, Redis hỗ trợ bốn cấp độ: debug, verbose, notice, warning. Mặc định là notice.</td></tr><tr><td style="text-align:left;"><code>logfile stdout</code></td><td style="text-align:left;">Chỉ định cách ghi nhật ký, mặc định là ghi vào đầu ra tiêu chuẩn. Nếu cấu hình Redis chạy như một tiến trình nền và bạn cấu hình ghi nhật ký vào đầu ra tiêu chuẩn, nhật ký sẽ được gửi đến /dev/null.</td></tr><tr><td style="text-align:left;"><code>databases 16</code></td><td style="text-align:left;">Đặt số lượng cơ sở dữ liệu, mặc định là 0. Bạn có thể sử dụng lệnh SELECT trên kết nối để chỉ định id cơ sở dữ liệu.</td></tr><tr><td style="text-align:left;"><code>save &lt;seconds&gt; &lt;changes&gt;</code> Tệp cấu hình mặc định của Redis cung cấp ba điều kiện: <strong>save 900 1</strong>, <strong>save 300 10</strong>, <strong>save 60 10000</strong>.</td><td style="text-align:left;">Chỉ định thời gian và số lần thay đổi để đồng bộ dữ liệu với tệp dữ liệu trong một khoảng thời gian nhất định. Bạn có thể kết hợp nhiều điều kiện để cấu hình.</td></tr><tr><td style="text-align:left;"><code>rdbcompression yes</code></td><td style="text-align:left;">Chỉ định xem liệu dữ liệu có nén khi lưu trữ trong cơ sở dữ liệu cục bộ hay không. Mặc định là yes. Redis sử dụng phương pháp nén LZF. Nếu bạn muốn tiết kiệm thời gian CPU, bạn có thể tắt tùy chọn này, nhưng điều này sẽ làm cho tệp cơ sở dữ liệu trở nên rất lớn.</td></tr><tr><td style="text-align:left;"><code>dbfilename dump.rdb</code></td><td style="text-align:left;">Chỉ định tên tệp cơ sở dữ liệu cục bộ, mặc định là dump.rdb.</td></tr><tr><td style="text-align:left;"><code>dir ./</code></td><td style="text-align:left;">Chỉ định thư mục lưu trữ cơ sở dữ liệu cục bộ, mặc định là thư mục hiện tại.</td></tr><tr><td style="text-align:left;"><code>slaveof &lt;masterip&gt; &lt;masterport&gt;</code></td><td style="text-align:left;">Đặt Redis làm dịch vụ slave, chỉ định địa chỉ IP và cổng của dịch vụ master. Khi Redis khởi động, nó sẽ tự động đồng bộ dữ liệu từ master.</td></tr><tr><td style="text-align:left;"><code>masterauth &lt;master-password&gt;</code></td><td style="text-align:left;">Khi dịch vụ master được bảo vệ bằng mật khẩu, chỉ định mật khẩu kết nối từ slave đến master.</td></tr><tr><td style="text-align:left;"><code>requirepass foobared</code></td><td style="text-align:left;">Đặt mật khẩu kết nối Redis. Nếu cấu hình mật khẩu kết nối, khách hàng phải cung cấp mật khẩu bằng lệnh <code>AUTH &lt;password&gt;</code> khi kết nối Redis. Mặc định là không yêu cầu mật khẩu.</td></tr><tr><td style="text-align:left;"><code>maxclients 128</code></td><td style="text-align:left;">Đặt số lượng kết nối khách hàng tối đa cùng một thời điểm, mặc định là không giới hạn. Redis có thể mở cùng một lúc số lượng kết nối khách hàng bằng với số lượng mô tả tệp tin cấu hình Redis. Nếu đặt maxclients thành 0, không có giới hạn. Khi số lượng kết nối khách hàng đạt đến giới hạn, Redis sẽ đóng kết nối mới và trả về thông báo lỗi &quot;max number of clients reached&quot;.</td></tr><tr><td style="text-align:left;"><code>maxmemory &lt;bytes&gt;</code></td><td style="text-align:left;">Chỉ định giới hạn bộ nhớ tối đa cho Redis. Khi Redis khởi động, dữ liệu sẽ được tải vào bộ nhớ. Khi đạt đến giới hạn bộ nhớ tối đa, Redis sẽ cố gắng xóa các khóa đã hết hạn hoặc sắp hết hạn. Nếu vẫn không đủ, Redis sẽ không thể ghi dữ liệu mới, nhưng vẫn cho phép đọc dữ liệu. Redis sử dụng cơ chế vm để lưu trữ các khóa trong bộ nhớ và các giá trị trong swap.</td></tr><tr><td style="text-align:left;"><code>appendonly no</code></td><td style="text-align:left;">Chỉ định xem liệu Redis có ghi nhật ký sau mỗi lần cập nhật hay không. Mặc định, Redis sẽ ghi dữ liệu vào đĩa bất đồng bộ. Nếu không bật tùy chọn này, dữ liệu có thể bị mất trong một khoảng thời gian khi mất điện. Vì Redis đồng bộ dữ liệu với tệp dữ liệu theo các điều kiện save đã cấu hình, nên một số dữ liệu chỉ tồn tại trong bộ nhớ trong một khoảng thời gian. Mặc định là no.</td></tr><tr><td style="text-align:left;"><code>appendfilename appendonly.aof</code></td><td style="text-align:left;">Chỉ định tên tệp ghi nhật ký cập nhật, mặc định là appendonly.aof.</td></tr><tr><td style="text-align:left;"><code>appendfsync everysec</code></td><td style="text-align:left;">Chỉ định điều kiện ghi nhật ký cập nhật, có 3 giá trị có thể chọn: <strong>no</strong>: dữ liệu được đồng bộ hóa với bộ nhớ đệm của hệ điều hành (nhanh). <strong>always</strong>: sau mỗi lần cập nhật, Redis sẽ gọi thủ công fsync() để ghi dữ liệu vào đĩa (chậm, an toàn). <strong>everysec</strong>: đồng bộ dữ liệu mỗi giây (giữa hai giá trị trên, mặc định).</td></tr><tr><td style="text-align:left;"><code>vm-enabled no</code></td><td style="text-align:left;">Chỉ định xem Redis có sử dụng bộ nhớ ảo hay không, mặc định là no. Bài viết này sẽ phân tích cơ chế bộ nhớ ảo của Redis sau.</td></tr><tr><td style="text-align:left;"><code>vm-swap-file /tmp/redis.swap</code></td><td style="text-align:left;">Đường dẫn tệp swap, mặc định là /tmp/redis.swap, không thể chia sẻ giữa nhiều phiên bản Redis.</td></tr><tr><td style="text-align:left;"><code>vm-max-memory 0</code></td><td style="text-align:left;">Lưu trữ tất cả các giá trị lớn hơn vm-max-memory vào bộ nhớ ảo, bất kể vm-max-memory được đặt thành bao nhiêu, tất cả các chỉ mục dữ liệu (keys) đều được lưu trữ trong bộ nhớ (Redis chỉ lưu trữ các giá trị trong swap). Mặc định là 0.</td></tr><tr><td style="text-align:left;"><code>vm-page-size 32</code></td><td style="text-align:left;">Tệp swap Redis được chia thành nhiều trang, một đối tượng có thể được lưu trữ trên nhiều trang, nhưng một trang không thể được chia sẻ bởi nhiều đối tượng. Vì vậy, vm-page-size phải được đặt dựa trên kích thước dữ liệu được lưu trữ. Tác giả đề xuất nếu lưu trữ nhiều đối tượng nhỏ, hãy đặt kích thước trang là 32 hoặc 64 byte; nếu lưu trữ đối tượng lớn, hãy sử dụng trang lớn hơn. Nếu không chắc chắn, hãy sử dụng giá trị mặc định.</td></tr><tr><td style="text-align:left;"><code>vm-pages 134217728</code></td><td style="text-align:left;">Đặt số lượng trang trong tệp swap, vì bảng trang (bitmap biểu thị trang trống hoặc sử dụng) được lưu trữ trong bộ nhớ, mỗi 8 trang trên đĩa sẽ sử dụng 1 byte bộ nhớ.</td></tr><tr><td style="text-align:left;"><code>vm-max-threads 4</code></td><td style="text-align:left;">Đặt số luồng truy cập vào tệp swap, tốt nhất không vượt quá số lõi của máy, nếu đặt thành 0, tất cả các hoạt động trên tệp swap sẽ tuần tự, có thể gây ra độ trễ lâu. Mặc định là 4.</td></tr><tr><td style="text-align:left;"><code>glueoutputbuf yes</code></td><td style="text-align:left;">Đặt xem liệu Redis có gộp các gói nhỏ thành một gói lớn khi trả lời khách hàng hay không. Mặc định là bật.</td></tr><tr><td style="text-align:left;"><code>hash-max-zipmap-entries 64 hash-max-zipmap-value 512</code></td><td style="text-align:left;">Chỉ định xem liệu Redis có sử dụng thuật toán băm đặc biệt khi số lượng mục vượt quá một ngưỡng nhất định hoặc giá trị lớn nhất vượt quá một ngưỡng nhất định hay không.</td></tr><tr><td style="text-align:left;"><code>activerehashing yes</code></td><td style="text-align:left;">Chỉ định xem Redis có kích hoạt việc băm lại dữ liệu hay không. Mặc định là bật (sẽ được giải thích cụ thể khi phân tích thuật toán băm Redis).</td></tr><tr><td style="text-align:left;"><code>include /path/to/local.conf</code></td><td style="text-align:left;">Chỉ định tệp cấu hình bao gồm, bạn có thể sử dụng cùng một tệp cấu hình cho nhiều phiên bản Redis trên cùng một máy, nhưng mỗi phiên bản Redis vẫn có tệp cấu hình riêng của mình.</td></tr></tbody></table><h3 id="kiem-tra-hieu-suat" tabindex="-1"><a class="header-anchor" href="#kiem-tra-hieu-suat"><span>Kiểm tra hiệu suất</span></a></h3><blockquote><p>Tham khảo tài liệu chính thức: <a href="https://redis.io/topics/benchmarks" target="_blank" rel="noopener noreferrer">How fast is Redis?</a></p></blockquote><p>Redis đi kèm với một công cụ kiểm tra hiệu suất: <code>redis-benchmark</code></p><p><strong>(1) Kiểm tra cơ bản</strong></p><div class="language-shell" data-ext="shell" data-title="shell"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">redis-benchmark</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> -q</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> -n</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 100000</span></span></code></pre></div><ul><li><code>-q</code> thực hiện ở chế độ yên lặng</li><li><code>-n 100000</code> yêu cầu 100.000 lần</li></ul><p><strong>(2) Kiểm tra các lệnh đọc và ghi cụ thể</strong></p><div class="language-shell" data-ext="shell" data-title="shell"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">$</span><span style="color:#98C379;--shiki-dark:#98C379;"> redis-benchmark</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> -t</span><span style="color:#98C379;--shiki-dark:#98C379;"> set,lpush</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> -n</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 100000</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> -q</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">SET:</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 74239.05</span><span style="color:#98C379;--shiki-dark:#98C379;"> requests</span><span style="color:#98C379;--shiki-dark:#98C379;"> per</span><span style="color:#98C379;--shiki-dark:#98C379;"> second</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">LPUSH:</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 79239.30</span><span style="color:#98C379;--shiki-dark:#98C379;"> requests</span><span style="color:#98C379;--shiki-dark:#98C379;"> per</span><span style="color:#98C379;--shiki-dark:#98C379;"> second</span></span></code></pre></div><p><strong>(3) Kiểm tra chế độ pipeline với các lệnh đọc và ghi cụ thể</strong></p><div class="language-shell" data-ext="shell" data-title="shell"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">redis-benchmark</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> -n</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 1000000</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> -t</span><span style="color:#98C379;--shiki-dark:#98C379;"> set,get</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> -P</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 16</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> -q</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">SET:</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 403063.28</span><span style="color:#98C379;--shiki-dark:#98C379;"> requests</span><span style="color:#98C379;--shiki-dark:#98C379;"> per</span><span style="color:#98C379;--shiki-dark:#98C379;"> second</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">GET:</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 508388.41</span><span style="color:#98C379;--shiki-dark:#98C379;"> requests</span><span style="color:#98C379;--shiki-dark:#98C379;"> per</span><span style="color:#98C379;--shiki-dark:#98C379;"> second</span></span></code></pre></div><h2 id="_3-su-dung-va-cau-hinh-redis-cluster" tabindex="-1"><a class="header-anchor" href="#_3-su-dung-va-cau-hinh-redis-cluster"><span>3. Sử dụng và cấu hình Redis Cluster</span></a></h2><p>Redis từ phiên bản 3.0 trở đi hỗ trợ chế độ Cluster.</p><h3 id="qui-hoach-cluster" tabindex="-1"><a class="header-anchor" href="#qui-hoach-cluster"><span>Qui hoạch Cluster</span></a></h3><p>Redis Cluster thường được hình thành từ <strong>nhiều node</strong>, số lượng node ít nhất phải là 6 để đảm bảo hình thành một Cluster <strong>hoàn chỉnh và có khả năng sẵn sàng cao</strong>.</p><p>Trong trường hợp lý tưởng, mỗi node sẽ được đặt trên các máy chủ khác nhau. Tuy nhiên, trong trường hợp tài nguyên hạn chế, tôi chỉ có 3 máy chủ khi triển khai Redis Cluster. Vì vậy, tôi đã lên kế hoạch triển khai 2 node Redis trên mỗi máy chủ.</p><p>【Ví dụ】Kế hoạch triển khai Redis Cluster đơn giản nhưng có khả năng sẵn sàng cao nhất</p><p>Cấu hình máy chủ: 16G RAM + 8 nhân CPU + 1T ổ cứng</p><p>Mỗi quá trình Redis được cấp phát 10G RAM. Trong môi trường sản xuất trực tuyến, hãy cố gắng không vượt quá 10G RAM cho Redis, vì vượt quá 10G có thể gây ra vấn đề.</p><p>Topology của Cluster: Ba master và ba slave; ba Sentinel, mỗi Sentinel lắng nghe tất cả các master node.</p><p>Ước tính hiệu suất:</p><ul><li>Dung lượng: Ba master chiếm 30G RAM, do đó dung lượng lưu trữ tối đa là 30G. Giả sử kích thước trung bình của mỗi bản ghi dữ liệu là 10K, điều này có nghĩa là tối đa có thể lưu trữ 3 triệu bản ghi dữ liệu.</li><li>Thông lượng: Trên một máy chủ, TPS/QPS thông thường là khoảng 50.000 đến 80.000. Giả sử là 50.000, vậy ba master và ba slave lý thuyết có thể đạt được TPS 150.000 và QPS 300.000.</li></ul><h3 id="trien-khai-cluster" tabindex="-1"><a class="header-anchor" href="#trien-khai-cluster"><span>Triển khai Cluster</span></a></h3><blockquote><p>Việc cài đặt các node trong Redis Cluster tương tự như cài đặt dịch vụ đơn lẻ, khác biệt chỉ nằm ở cách triển khai.</p><p>Lưu ý: Để tiện cho việc trình bày, ví dụ này sẽ triển khai tất cả các node Redis Cluster trên cùng một máy chủ. Tuy nhiên, trong môi trường sản xuất thực tế, thì thường sẽ triển khai các node trên các máy chủ khác nhau. Đối với yêu cầu cao hơn, có thể cần xem xét triển khai trên nhiều trung tâm dữ liệu.</p></blockquote><p>(1) Tạo thư mục cho các node</p><p>Tôi thường đặt phần mềm trong thư mục <code>/opt</code>, trên máy tính của tôi, Redis được cài đặt trong thư mục <code>/usr/local/redis</code>. Vì vậy, các lệnh và cấu hình dưới đây giả định rằng thư mục cài đặt Redis là <code>/usr/local/redis</code>.</p><p>Đảm bảo rằng máy chủ đã cài đặt Redis, thực hiện các lệnh sau để tạo thư mục cho các instance của node Redis Cluster:</p><div class="language-shell" data-ext="shell" data-title="shell"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">sudo</span><span style="color:#98C379;--shiki-dark:#98C379;"> mkdir</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> -p</span><span style="color:#98C379;--shiki-dark:#98C379;"> /usr/local/redis/conf/7001</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">sudo</span><span style="color:#98C379;--shiki-dark:#98C379;"> mkdir</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> -p</span><span style="color:#98C379;--shiki-dark:#98C379;"> /usr/local/redis/conf/7002</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">sudo</span><span style="color:#98C379;--shiki-dark:#98C379;"> mkdir</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> -p</span><span style="color:#98C379;--shiki-dark:#98C379;"> /usr/local/redis/conf/7003</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">sudo</span><span style="color:#98C379;--shiki-dark:#98C379;"> mkdir</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> -p</span><span style="color:#98C379;--shiki-dark:#98C379;"> /usr/local/redis/conf/7004</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">sudo</span><span style="color:#98C379;--shiki-dark:#98C379;"> mkdir</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> -p</span><span style="color:#98C379;--shiki-dark:#98C379;"> /usr/local/redis/conf/7005</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">sudo</span><span style="color:#98C379;--shiki-dark:#98C379;"> mkdir</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> -p</span><span style="color:#98C379;--shiki-dark:#98C379;"> /usr/local/redis/conf/7006</span></span></code></pre></div><p>(2) Cấu hình các node Cluster</p><p>Trong mỗi thư mục instance, tạo tệp cấu hình <code>redis.conf</code>.</p><p>Dưới đây là mẫu cấu hình cho node 7001 (thay thế số cổng 7001 bằng số cổng của các node khác):</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;--shiki-dark:#7F848E;font-style:italic;--shiki-dark-font-style:italic;"># Số cổng</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">port</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 7001</span></span>
<span class="line"><span style="color:#7F848E;--shiki-dark:#7F848E;font-style:italic;--shiki-dark-font-style:italic;"># Số cổng máy chủ được ràng buộc (0.0.0.0 cho phép truy cập từ xa)</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">bind</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 0.0.0.0</span></span>
<span class="line"><span style="color:#7F848E;--shiki-dark:#7F848E;font-style:italic;--shiki-dark-font-style:italic;"># Khởi động dưới dạng tiến trình nền</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">daemonize</span><span style="color:#98C379;--shiki-dark:#98C379;"> yes</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;--shiki-dark:#7F848E;font-style:italic;--shiki-dark-font-style:italic;"># Bật chế độ Cluster</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">cluster-enabled</span><span style="color:#98C379;--shiki-dark:#98C379;"> yes</span></span>
<span class="line"><span style="color:#7F848E;--shiki-dark:#7F848E;font-style:italic;--shiki-dark-font-style:italic;"># Tệp cấu hình cho Cluster, tệp cấu hình sẽ được tạo tự động khi khởi động lần đầu</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">cluster-config-file</span><span style="color:#98C379;--shiki-dark:#98C379;"> /usr/local/redis/conf/7001/7001.conf</span></span>
<span class="line"><span style="color:#7F848E;--shiki-dark:#7F848E;font-style:italic;--shiki-dark-font-style:italic;"># Thời gian chờ yêu cầu, thiết lập 10 giây</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">cluster-node-timeout</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 10000</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;--shiki-dark:#7F848E;font-style:italic;--shiki-dark-font-style:italic;"># Bật chế độ AOF</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">appendonly</span><span style="color:#98C379;--shiki-dark:#98C379;"> yes</span></span>
<span class="line"><span style="color:#7F848E;--shiki-dark:#7F848E;font-style:italic;--shiki-dark-font-style:italic;"># Thư mục lưu trữ dữ liệu</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">dir</span><span style="color:#98C379;--shiki-dark:#98C379;"> /usr/local/redis/conf/7001</span></span>
<span class="line"><span style="color:#7F848E;--shiki-dark:#7F848E;font-style:italic;--shiki-dark-font-style:italic;"># Tệp tiến trình</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">pidfile</span><span style="color:#98C379;--shiki-dark:#98C379;"> /usr/local/redis/conf/7001/7001.pid</span></span>
<span class="line"><span style="color:#7F848E;--shiki-dark:#7F848E;font-style:italic;--shiki-dark-font-style:italic;"># Tệp nhật ký</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">logfile</span><span style="color:#98C379;--shiki-dark:#98C379;"> /usr/local/redis/conf/7001/7001.log</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>(3) Khởi động các node Redis</p><p>Redis đi kèm với một tập lệnh <code>create-cluster</code> trong thư mục utils/create-cluster, nó cho phép tạo, khởi động, dừng và khởi động lại các node Redis.</p><p>Có một số tham số quan trọng trong tập lệnh này:</p><ul><li><code>PORT</code>=30000 - Số cổng ban đầu</li><li><code>TIMEOUT</code>=2000 - Thời gian chờ</li><li><code>NODES</code>=6 - Số node</li><li><code>REPLICAS</code>=1 - Số bản sao</li></ul><p>Mỗi lệnh trong tập lệnh này sẽ thực hiện các thao tác dựa trên số cổng ban đầu và số node đã được cấu hình.</p><p>Vì các cổng của các node đã được lên kế hoạch từ 7001 đến 7006, nên cần thay đổi biến PORT thành 7000.</p><p>Để khởi động các node Redis, chúng ta cần sửa đổi như sau:</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">PORT</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">7000</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">TIMEOUT</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">2000</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">NODES</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">6</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">ENDPORT</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">$((</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">PORT+NODES</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;--shiki-dark:#7F848E;font-style:italic;--shiki-dark-font-style:italic;"># ...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> [ </span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;</span><span style="color:#E06C75;--shiki-dark:#E06C75;font-style:italic;--shiki-dark-font-style:italic;">$1</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> ==</span><span style="color:#98C379;--shiki-dark:#98C379;"> &quot;start&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ]</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">then</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    while</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> [ $((</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">PORT</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> &lt; </span><span style="color:#98C379;--shiki-dark:#98C379;">ENDPORT</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)) </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">!=</span><span style="color:#98C379;--shiki-dark:#98C379;"> &quot;0&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> ]; </span><span style="color:#C678DD;--shiki-dark:#C678DD;">do</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">        PORT</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">$((</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">PORT+1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">))</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        echo</span><span style="color:#98C379;--shiki-dark:#98C379;"> &quot;Starting </span><span style="color:#E06C75;--shiki-dark:#E06C75;">$PORT</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">        /usr/local/redis/src/redis-server</span><span style="color:#98C379;--shiki-dark:#98C379;"> /usr/local/redis/conf/</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">\${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">PORT</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">}</span><span style="color:#98C379;--shiki-dark:#98C379;">/redis.conf</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    done</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    exit</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 0</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">fi</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Sau đó, trên mỗi máy chủ, chạy <code>./create-cluster start</code> để khởi động các node.</p><p>Sau đó, sử dụng lệnh <code>ps</code> để kiểm tra xem tiến trình Redis đã hoạt động chưa:</p><div class="language-shell" data-ext="shell" data-title="shell"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">$</span><span style="color:#98C379;--shiki-dark:#98C379;"> ps</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> -ef</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> | </span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">grep</span><span style="color:#98C379;--shiki-dark:#98C379;"> redis</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">root</span><span style="color:#D19A66;--shiki-dark:#D19A66;">      4604</span><span style="color:#D19A66;--shiki-dark:#D19A66;">     1</span><span style="color:#D19A66;--shiki-dark:#D19A66;">  0</span><span style="color:#98C379;--shiki-dark:#98C379;"> 11:07</span><span style="color:#98C379;--shiki-dark:#98C379;"> ?</span><span style="color:#98C379;--shiki-dark:#98C379;">        00:00:00</span><span style="color:#98C379;--shiki-dark:#98C379;"> /opt/redis/src/redis-server</span><span style="color:#98C379;--shiki-dark:#98C379;"> 0.0.0.0:7001</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> [cluster]</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">root</span><span style="color:#D19A66;--shiki-dark:#D19A66;">      4609</span><span style="color:#D19A66;--shiki-dark:#D19A66;">     1</span><span style="color:#D19A66;--shiki-dark:#D19A66;">  0</span><span style="color:#98C379;--shiki-dark:#98C379;"> 11:07</span><span style="color:#98C379;--shiki-dark:#98C379;"> ?</span><span style="color:#98C379;--shiki-dark:#98C379;">        00:00:00</span><span style="color:#98C379;--shiki-dark:#98C379;"> /opt/redis/src/redis-server</span><span style="color:#98C379;--shiki-dark:#98C379;"> 0.0.0.0:7002</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> [cluster]</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">root</span><span style="color:#D19A66;--shiki-dark:#D19A66;">      4614</span><span style="color:#D19A66;--shiki-dark:#D19A66;">     1</span><span style="color:#D19A66;--shiki-dark:#D19A66;">  0</span><span style="color:#98C379;--shiki-dark:#98C379;"> 11:07</span><span style="color:#98C379;--shiki-dark:#98C379;"> ?</span><span style="color:#98C379;--shiki-dark:#98C379;">        00:00:00</span><span style="color:#98C379;--shiki-dark:#98C379;"> /opt/redis/src/redis-server</span><span style="color:#98C379;--shiki-dark:#98C379;"> 0.0.0.0:7003</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> [cluster]</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">root</span><span style="color:#D19A66;--shiki-dark:#D19A66;">      4619</span><span style="color:#D19A66;--shiki-dark:#D19A66;">     1</span><span style="color:#D19A66;--shiki-dark:#D19A66;">  0</span><span style="color:#98C379;--shiki-dark:#98C379;"> 11:07</span><span style="color:#98C379;--shiki-dark:#98C379;"> ?</span><span style="color:#98C379;--shiki-dark:#98C379;">        00:00:00</span><span style="color:#98C379;--shiki-dark:#98C379;"> /opt/redis/src/redis-server</span><span style="color:#98C379;--shiki-dark:#98C379;"> 0.0.0.0:7004</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> [cluster]</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">root</span><span style="color:#D19A66;--shiki-dark:#D19A66;">      4624</span><span style="color:#D19A66;--shiki-dark:#D19A66;">     1</span><span style="color:#D19A66;--shiki-dark:#D19A66;">  0</span><span style="color:#98C379;--shiki-dark:#98C379;"> 11:07</span><span style="color:#98C379;--shiki-dark:#98C379;"> ?</span><span style="color:#98C379;--shiki-dark:#98C379;">        00:00:00</span><span style="color:#98C379;--shiki-dark:#98C379;"> /opt/redis/src/redis-server</span><span style="color:#98C379;--shiki-dark:#98C379;"> 0.0.0.0:7005</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> [cluster]</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">root</span><span style="color:#D19A66;--shiki-dark:#D19A66;">      4629</span><span style="color:#D19A66;--shiki-dark:#D19A66;">     1</span><span style="color:#D19A66;--shiki-dark:#D19A66;">  0</span><span style="color:#98C379;--shiki-dark:#98C379;"> 11:07</span><span style="color:#98C379;--shiki-dark:#98C379;"> ?</span><span style="color:#98C379;--shiki-dark:#98C379;">        00:00:00</span><span style="color:#98C379;--shiki-dark:#98C379;"> /opt/redis/src/redis-server</span><span style="color:#98C379;--shiki-dark:#98C379;"> 0.0.0.0:7006</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> [cluster]</span></span></code></pre></div><p>(4) Khởi động Cluster</p><p>Sử dụng lệnh <code>redis-cli --cluster create</code> để tự động cấu hình Cluster:</p><div class="language-shell" data-ext="shell" data-title="shell"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">./redis-cli</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> --cluster</span><span style="color:#98C379;--shiki-dark:#98C379;"> create</span><span style="color:#98C379;--shiki-dark:#98C379;"> 127.0.0.1:7001</span><span style="color:#98C379;--shiki-dark:#98C379;"> 127.0.0.1:7002</span><span style="color:#98C379;--shiki-dark:#98C379;"> 127.0.0.2:7003</span><span style="color:#98C379;--shiki-dark:#98C379;"> 127.0.0.2:7004</span><span style="color:#98C379;--shiki-dark:#98C379;"> 127.0.0.3:7005</span><span style="color:#98C379;--shiki-dark:#98C379;"> 127.0.0.3:7006</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> --cluster-replicas</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 1</span></span></code></pre></div><p>Redis Cluster sẽ tự động phân chia các slot (hash slot) dựa trên số node và số bản sao đã được cấu hình. Nếu bạn hài lòng với kết quả, nhập &quot;yes&quot; để bắt đầu phân chia.</p><div class="language- line-numbers-mode" data-ext="" data-title=""><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span>&gt;&gt;&gt; Performing hash slots allocation on 6 nodes...</span></span>
<span class="line"><span>Master[0] -&gt; Slots 0 - 5460</span></span>
<span class="line"><span>Master[1] -&gt; Slots 5461 - 10922</span></span>
<span class="line"><span>Master[2] -&gt; Slots 10923 - 16383</span></span>
<span class="line"><span>Adding replica 127.0.0.2:7004 to 127.0.0.1:7001</span></span>
<span class="line"><span>Adding replica 127.0.0.3:7006 to 127.0.0.2:7003</span></span>
<span class="line"><span>Adding replica 127.0.0.1:7002 to 127.0.0.3:7005</span></span>
<span class="line"><span>M: b721235997deb6b9a7a2be690b5b9663db8057c6 127.0.0.1:7001</span></span>
<span class="line"><span>   slots:[0-5460] (5461 slots) master</span></span>
<span class="line"><span>S: bda9b7036df0bbefe601bda4ce45d3787a2e9bd9 127.0.0.1:7002</span></span>
<span class="line"><span>   replicates 3623fff69b5243ed18c02a2fbb6f53069b0f1505</span></span>
<span class="line"><span>M: 91523c0391a044da6cc9f53bb965aabe89502187 127.0.0.2:7003</span></span>
<span class="line"><span>   slots:[5461-10922] (5462 slots) master</span></span>
<span class="line"><span>S: 9d899cbe49dead7b8c4f769920cdb75714a441ae 127.0.0.2:7004</span></span>
<span class="line"><span>   replicates b721235997deb6b9a7a2be690b5b9663db8057c6</span></span>
<span class="line"><span>M: 3623fff69b5243ed18c02a2fbb6f53069b0f1505 127.0.0.3:7005</span></span>
<span class="line"><span>   slots:[10923-16383] (5461 slots) master</span></span>
<span class="line"><span>S: a2869dc153ea4977ca790b76483574a5d56cb40e 127.0.0.3:7006</span></span>
<span class="line"><span>   replicates 91523c0391a044da6cc9f53bb965aabe89502187</span></span>
<span class="line"><span>Can I set the above configuration? (type &#39;yes&#39; to accept): yes</span></span>
<span class="line"><span>&gt;&gt;&gt; Nodes configuration updated</span></span>
<span class="line"><span>&gt;&gt;&gt; Assign a different config epoch to each node</span></span>
<span class="line"><span>&gt;&gt;&gt; Sending CLUSTER MEET messages to join the cluster</span></span>
<span class="line"><span>Waiting for the cluster to join</span></span>
<span class="line"><span>....</span></span>
<span class="line"><span>&gt;&gt;&gt; Performing Cluster Check (using node 127.0.0.1:7001)</span></span>
<span class="line"><span>M: b721235997deb6b9a7a2be690b5b9663db8057c6 127.0.0.1:7001</span></span>
<span class="line"><span>   slots:[0-5460] (5461 slots) master</span></span>
<span class="line"><span>   1 additional replica(s)</span></span>
<span class="line"><span>S: a2869dc153ea4977ca790b76483574a5d56cb40e 127.0.0.1:7006</span></span>
<span class="line"><span>   slots: (0 slots) slave</span></span>
<span class="line"><span>   replicates 91523c0391a044da6cc9f53bb965aabe89502187</span></span>
<span class="line"><span>M: 91523c0391a044da6cc9f53bb965aabe89502187 127.0.0.1:7003</span></span>
<span class="line"><span>   slots:[5461-10922] (5462 slots) master</span></span>
<span class="line"><span>   1 additional replica(s)</span></span>
<span class="line"><span>M: 3623fff69b5243ed18c02a2fbb6f53069b0f1505 127.0.0.1:7005</span></span>
<span class="line"><span>   slots:[10923-16383] (5461 slots) master</span></span>
<span class="line"><span>   1 additional replica(s)</span></span>
<span class="line"><span>S: 9d899cbe49dead7b8c4f769920cdb75714a441ae 127.0.0.1:7004</span></span>
<span class="line"><span>   slots: (0 slots) slave</span></span>
<span class="line"><span>   replicates b721235997deb6b9a7a2be690b5b9663db8057c6</span></span>
<span class="line"><span>S: bda9b7036df0bbefe601bda4ce45d3787a2e9bd9 127.0.0.1:7002</span></span>
<span class="line"><span>   slots: (0 slots) slave</span></span>
<span class="line"><span>   replicates 3623fff69b5243ed18c02a2fbb6f53069b0f1505</span></span>
<span class="line"><span>[OK] All nodes agree about slots configuration.</span></span>
<span class="line"><span>&gt;&gt;&gt; Check for open slots...</span></span>
<span class="line"><span>&gt;&gt;&gt; Check slots coverage...</span></span>
<span class="line"><span>[OK] All 16384 slots covered.</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>(5) Thao tác bảo trì hàng ngày</p><ul><li>Dừng Cluster - <code>./create-cluster stop</code></li><li>Kiểm tra sức khỏe của Cluster (chỉ cần chỉ định một node bất kỳ): <code>./redis-cli --cluster check &lt;ip:port&gt;</code></li><li>Thử sửa chữa các node trong Cluster: <code>./redis-cli --cluster fix &lt;ip:port&gt;</code></li></ul><h3 id="trien-khai-sentinel" tabindex="-1"><a class="header-anchor" href="#trien-khai-sentinel"><span>Triển khai Sentinel</span></a></h3><p>Redis Cluster đã giải quyết vấn đề phân tán và sao chép dữ liệu trong Redis.</p><p>Tuy nhiên, Redis Cluster không giải quyết vấn đề chuyển giao lỗi. Khi một node Master bị sự cố, mất kết nối mạng, Redis Cluster sẽ không hoạt động. Để giải quyết vấn đề này, Redis cung cấp Redis Sentinel để giám sát trạng thái của các node Redis và tổ chức cuộc bầu cử để chọn một Slave node làm Master khi Master gặp sự cố.</p><p>(1) Tạo thư mục cho các node</p><p>Tôi thường đặt phần mềm trong thư mục <code>/opt</code>, trên máy tính của tôi, Redis được cài đặt trong thư mục <code>/usr/local/redis</code>. Vì vậy, các lệnh và cấu hình dưới đây giả định rằng thư mục cài đặt Redis là <code>/usr/local/redis</code>.</p><p>Đảm bảo rằng máy chủ đã cài đặt Redis, thực hiện các lệnh sau để tạo thư mục cho các instance của node Sentinel:</p><div class="language-shell" data-ext="shell" data-title="shell"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">sudo</span><span style="color:#98C379;--shiki-dark:#98C379;"> mkdir</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> -p</span><span style="color:#98C379;--shiki-dark:#98C379;"> /usr/local/redis/conf/27001</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">sudo</span><span style="color:#98C379;--shiki-dark:#98C379;"> mkdir</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> -p</span><span style="color:#98C379;--shiki-dark:#98C379;"> /usr/local/redis/conf/27002</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">sudo</span><span style="color:#98C379;--shiki-dark:#98C379;"> mkdir</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> -p</span><span style="color:#98C379;--shiki-dark:#98C379;"> /usr/local/redis/conf/27003</span></span></code></pre></div><p>(2) Cấu hình các node Sentinel</p><p>Trong mỗi thư mục instance, tạo tệp cấu hình <code>sentinel.conf</code>.</p><p>Dưới đây là mẫu cấu hình cho node 27001 (thay thế số cổng 27001 bằng số cổng của các node khác):</p><div class="language-shell" data-ext="shell" data-title="shell"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">port</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 27001</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">daemonize</span><span style="color:#98C379;--shiki-dark:#98C379;"> yes</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">sentinel</span><span style="color:#98C379;--shiki-dark:#98C379;"> monitor</span><span style="color:#98C379;--shiki-dark:#98C379;"> redis-master</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 172.22.6.3</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 7001</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 2</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">sentinel</span><span style="color:#98C379;--shiki-dark:#98C379;"> down-after-milliseconds</span><span style="color:#98C379;--shiki-dark:#98C379;"> redis-master</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 5000</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">sentinel</span><span style="color:#98C379;--shiki-dark:#98C379;"> failover-timeout</span><span style="color:#98C379;--shiki-dark:#98C379;"> redis-master</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 900000</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">sentinel</span><span style="color:#98C379;--shiki-dark:#98C379;"> parallel-syncs</span><span style="color:#98C379;--shiki-dark:#98C379;"> redis-master</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 1</span></span>
<span class="line"><span style="color:#7F848E;--shiki-dark:#7F848E;font-style:italic;--shiki-dark-font-style:italic;">#sentinel auth-pass redis-master 123456</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">logfile</span><span style="color:#98C379;--shiki-dark:#98C379;"> /usr/local/redis/conf/27001/27001.log</span></span></code></pre></div><p>(3) Khởi động các node Sentinel</p><div class="language-" data-ext="" data-title=""><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span>/opt/redis/src/redis-sentinel /usr/local/redis/conf/27001/sentinel.conf</span></span>
<span class="line"><span>/opt/redis/src/redis-sentinel /usr/local/redis/conf/27002/sentinel.conf</span></span>
<span class="line"><span>/opt/redis/src/redis-sentinel /usr/local/redis/conf/27003/sentinel.conf</span></span></code></pre></div><h3 id="mo-rong-cluster" tabindex="-1"><a class="header-anchor" href="#mo-rong-cluster"><span>Mở rộng Cluster</span></a></h3><p>(1) Xem thông tin</p><p>Truy cập vào bất kỳ nút nào</p><div class="language-" data-ext="" data-title=""><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span>./redis-cli -h 172.22.6.3 -p 7001</span></span></code></pre></div><p>cluster info để xem trạng thái các nút trong cụm</p><div class="language-" data-ext="" data-title=""><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span>172.22.6.3:7001&gt; cluster nodes</span></span>
<span class="line"><span>f158bf70bb2767cac271ce4efcfc14ba0b7ca98b 172.22.6.3:7006@17006 slave e7aa182e756b76ec85b471797db9b66e4b2da725 0 1594528179000 6 connected</span></span>
<span class="line"><span>f348e67648460c7a800120d69b4977bf2e4524cb 172.22.6.3:7001@17001 myself,master - 0 1594528179000 1 connected 0-5460</span></span>
<span class="line"><span>52601e2d4af0e64b83f4cc6d20e8316d0ac38b99 172.22.6.3:7004@17004 slave 4802fafe897160c46392c6e569d6f5e466cca696 0 1594528178000 4 connected</span></span>
<span class="line"><span>c6c6a68674ae8aac3c6ec792c8af4dc1228c6c31 172.22.6.3:7005@17005 slave f348e67648460c7a800120d69b4977bf2e4524cb 0 1594528179852 5 connected</span></span>
<span class="line"><span>e7aa182e756b76ec85b471797db9b66e4b2da725 172.22.6.3:7002@17002 master - 0 1594528178000 2 connected 5461-10922</span></span>
<span class="line"><span>4802fafe897160c46392c6e569d6f5e466cca696 172.22.6.3:7003@17003 master - 0 1594528178000 3 connected 10923-16383</span></span></code></pre></div><p>cluster info để xem thông tin cụm</p><div class="language- line-numbers-mode" data-ext="" data-title=""><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span>172.22.6.3:7001&gt; cluster info</span></span>
<span class="line"><span>cluster_state:ok</span></span>
<span class="line"><span>cluster_slots_assigned:16384</span></span>
<span class="line"><span>cluster_slots_ok:16384</span></span>
<span class="line"><span>cluster_slots_pfail:0</span></span>
<span class="line"><span>cluster_slots_fail:0</span></span>
<span class="line"><span>cluster_known_nodes:6</span></span>
<span class="line"><span>cluster_size:3</span></span>
<span class="line"><span>cluster_current_epoch:6</span></span>
<span class="line"><span>cluster_my_epoch:1</span></span>
<span class="line"><span>cluster_stats_messages_ping_sent:3406</span></span>
<span class="line"><span>cluster_stats_messages_pong_sent:3569</span></span>
<span class="line"><span>cluster_stats_messages_publish_sent:5035</span></span>
<span class="line"><span>cluster_stats_messages_sent:12010</span></span>
<span class="line"><span>cluster_stats_messages_ping_received:3564</span></span>
<span class="line"><span>cluster_stats_messages_pong_received:3406</span></span>
<span class="line"><span>cluster_stats_messages_meet_received:5</span></span>
<span class="line"><span>cluster_stats_messages_publish_received:5033</span></span>
<span class="line"><span>cluster_stats_messages_received:12008</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>(2) Thêm nút vào cụm</p><p>Thêm các phiên bản nút đã được khởi động vào cụm</p><div class="language-" data-ext="" data-title=""><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span>redis-cli --cluster add-node 127.0.0.1:7007 127.0.0.1:7008</span></span></code></pre></div><p><strong>Thêm nút chính</strong></p><p>Thêm một nhóm nút chính</p><div class="language-" data-ext="" data-title=""><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span>./redis-cli --cluster add-node 172.22.6.3:7007 172.22.6.3:7001</span></span>
<span class="line"><span>./redis-cli --cluster add-node 172.22.6.3:7008 172.22.6.3:7001</span></span>
<span class="line"><span>./redis-cli --cluster add-node 172.22.6.3:7009 172.22.6.3:7001</span></span></code></pre></div><p>Xem trạng thái nút</p><div class="language-" data-ext="" data-title=""><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span>172.22.6.3:7001&gt; cluster nodes</span></span>
<span class="line"><span>f158bf70bb2767cac271ce4efcfc14ba0b7ca98b 172.22.6.3:7006@17006 slave e7aa182e756b76ec85b471797db9b66e4b2da725 0 1594529342575 6 connected</span></span>
<span class="line"><span>f348e67648460c7a800120d69b4977bf2e4524cb 172.22.6.3:7001@17001 myself,master - 0 1594529340000 1 connected 0-5460</span></span>
<span class="line"><span>55cacf121662833a4a19dbeb4a5df712cfedf77f 172.22.6.3:7009@17009 master - 0 1594529342000 0 connected</span></span>
<span class="line"><span>c6c6a68674ae8aac3c6ec792c8af4dc1228c6c31 172.22.6.3:7005@17005 slave f348e67648460c7a800120d69b4977bf2e4524cb 0 1594529341573 5 connected</span></span>
<span class="line"><span>4802fafe897160c46392c6e569d6f5e466cca696 172.22.6.3:7003@17003 master - 0 1594529343577 3 connected 10923-16383</span></span>
<span class="line"><span>e7aa182e756b76ec85b471797db9b66e4b2da725 172.22.6.3:7002@17002 master - 0 1594529342000 2 connected 5461-10922</span></span>
<span class="line"><span>e5ba78fe629115977a74fbbe1478caf8868d6d55 172.22.6.3:7007@17007 master - 0 1594529341000 0 connected</span></span>
<span class="line"><span>52601e2d4af0e64b83f4cc6d20e8316d0ac38b99 172.22.6.3:7004@17004 slave 4802fafe897160c46392c6e569d6f5e466cca696 0 1594529340000 4 connected</span></span>
<span class="line"><span>79d4fffc2cec210556c3b4c44e63ab506e87eda3 172.22.6.3:7008@17008 master - 0 1594529340000 7 connected</span></span></code></pre></div><p>Có thể thấy, ba nút chính mới được thêm vào vẫn chưa được phân chia các hash slot, vì vậy tạm thời vẫn không thể truy cập.</p><p><strong>Thêm nút phụ</strong></p><p>--slave: Đặt tham số này, sau đó nút mới sẽ tham gia vào cụm với vai trò slave<br> --master-id: Tham số này cần được đặt khi đã đặt --slave, --master-id được sử dụng để chỉ định nút chủ cho nút mới. Nếu không đặt tham số này, nút sẽ được chọn ngẫu nhiên cho nút chủ.</p><p>Cú pháp</p><div class="language-" data-ext="" data-title=""><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span>redis-cli --cluster add-node  Địa chỉ IP của nút mới: Cổng    Địa chỉ IP của nút hiện có: Cổng --cluster-slave (nút phụ) --cluster-master-id (ID của nút chính)</span></span>
<span class="line"><span>redis-cli --cluster add-node   10.42.141.119:6379  10.42.166.105:6379  --cluster-slave   --cluster-master-id  dfa238fff8a7a49230cff7eb74f573f5645c8ec5</span></span></code></pre></div><p>Ví dụ</p><div class="language-" data-ext="" data-title=""><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span>./redis-cli --cluster add-node 172.22.6.3:7010 172.22.6.3:7007 --cluster-slave</span></span>
<span class="line"><span>./redis-cli --cluster add-node 172.22.6.3:7011 172.22.6.3:7008 --cluster-slave</span></span>
<span class="line"><span>./redis-cli --cluster add-node 172.22.6.3:7012 172.22.6.3:7009 --cluster-slave</span></span></code></pre></div><p>Xem trạng thái</p><div class="language-" data-ext="" data-title=""><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span>172.22.6.3:7001&gt; cluster nodes</span></span>
<span class="line"><span>ef5c1b9ce4cc795dc12b2c1e8736a572647b4c3e 172.22.6.3:7011@17011 slave 79d4fffc2cec210556c3b4c44e63ab506e87eda3 0 1594529492043 7 connected</span></span>
<span class="line"><span>f158bf70bb2767cac271ce4efcfc14ba0b7ca98b 172.22.6.3:7006@17006 slave e7aa182e756b76ec85b471797db9b66e4b2da725 0 1594529491943 6 connected</span></span>
<span class="line"><span>f348e67648460c7a800120d69b4977bf2e4524cb 172.22.6.3:7001@17001 myself,master - 0 1594529488000 1 connected 0-5460</span></span>
<span class="line"><span>5140d1129ed850df59c51cf818c4eb74545d9959 172.22.6.3:7010@17010 slave e5ba78fe629115977a74fbbe1478caf8868d6d55 0 1594529488000 0 connected</span></span>
<span class="line"><span>55cacf121662833a4a19dbeb4a5df712cfedf77f 172.22.6.3:7009@17009 master - 0 1594529488000 8 connected</span></span>
<span class="line"><span>c6c6a68674ae8aac3c6ec792c8af4dc1228c6c31 172.22.6.3:7005@17005 slave f348e67648460c7a800120d69b4977bf2e4524cb 0 1594529490000 5 connected</span></span>
<span class="line"><span>4802fafe897160c46392c6e569d6f5e466cca696 172.22.6.3:7003@17003 master - 0 1594529489939 3 connected 10923-16383</span></span>
<span class="line"><span>e7aa182e756b76ec85b471797db9b66e4b2da725 172.22.6.3:7002@17002 master - 0 1594529491000 2 connected 5461-10922</span></span>
<span class="line"><span>e5ba78fe629115977a74fbbe1478caf8868d6d55 172.22.6.3:7007@17007 master - 0 1594529490942 0 connected</span></span>
<span class="line"><span>52601e2d4af0e64b83f4cc6d20e8316d0ac38b99 172.22.6.3:7004@17004 slave 4802fafe897160c46392c6e569d6f5e466cca696 0 1594529491000 4 connected</span></span>
<span class="line"><span>02e9f57b5b45c350dc57acf1c8efa8db136db7b7 172.22.6.3:7012@17012 master - 0 1594529489000 0 connected</span></span>
<span class="line"><span>79d4fffc2cec210556c3b4c44e63ab506e87eda3 172.22.6.3:7008@17008 master - 0 1594529489000 7 connected</span></span></code></pre></div><p>Phân chia hash slot</p><p>Chạy <code>./redis-cli --cluster rebalance 172.22.6.3:7001 --cluster-threshold 1 --cluster-use-empty-masters</code></p><p>Giải thích các tham số:</p><p>rebalance: Cho phép Redis tự động cân bằng phân chia hash slot dựa trên số lượng nút.</p><p>--cluster-use-empty-masters: Chỉ định rằng các nút chủ trống sẽ được sử dụng.</p><figure><img src="https://raw.githubusercontent.com/vanhung4499/images/master/snap/20230725005340.png" alt="image.png" tabindex="0" loading="lazy"><figcaption>image.png</figcaption></figure><p>Sau khi thực hiện xong, kiểm tra trạng thái:</p><figure><img src="https://raw.githubusercontent.com/vanhung4499/images/master/snap/20230725005345.png" alt="image.png" tabindex="0" loading="lazy"><figcaption>image.png</figcaption></figure><h2 id="_4-lenh-redis" tabindex="-1"><a class="header-anchor" href="#_4-lenh-redis"><span>4. Lệnh Redis</span></a></h2><h3 id="lenh-chung" tabindex="-1"><a class="header-anchor" href="#lenh-chung"><span>Lệnh chung</span></a></h3><blockquote><p>Để biết chi tiết về cách sử dụng các lệnh, vui lòng tham khảo <a href="https://redis.io/commands" target="_blank" rel="noopener noreferrer"><strong>Tài liệu chính thức về lệnh Redis</strong></a></p><p>Di chuyển hai hình cheat sheet, nguồn: <a href="https://www.cheatography.com/tasjaevan/cheat-sheets/redis/" target="_blank" rel="noopener noreferrer">https://www.cheatography.com/tasjaevan/cheat-sheets/redis/</a></p></blockquote><h3 id="lenh-cum" tabindex="-1"><a class="header-anchor" href="#lenh-cum"><span>Lệnh cụm</span></a></h3><ul><li><strong>Cụm</strong><ul><li><code>cluster info</code> - In thông tin về cụm</li><li><code>cluster nodes</code> - Liệt kê tất cả các nút hiện có trong cụm và thông tin liên quan đến các nút này.</li></ul></li><li><strong>Nút</strong><ul><li><code>cluster meet &lt;ip&gt; &lt;port&gt;</code> - Thêm nút được chỉ định bởi ip và port vào cụm, biến nó thành một thành viên của cụm.</li><li><code>cluster forget &lt;node_id&gt;</code> - Xóa nút được chỉ định bởi node_id khỏi cụm.</li><li><code>cluster replicate &lt;node_id&gt;</code> - Đặt nút hiện tại là một nút con của nút được chỉ định bởi node_id.</li><li><code>cluster saveconfig</code> - Lưu cấu hình của nút vào đĩa cứng.</li></ul></li><li><strong>Khe (slot)</strong><ul><li><code>cluster addslots &lt;slot&gt; [slot …]</code> - Gán một hoặc nhiều khe (slot) cho nút hiện tại.</li><li><code>cluster delslots &lt;slot&gt; [slot …]</code> - Xóa gán khe (slot) cho nút hiện tại.</li><li><code>cluster flushslots</code> - Xóa tất cả các khe (slot) đã gán cho nút hiện tại, biến nút hiện tại thành một nút không có khe nào được gán.</li><li><code>cluster setslot &lt;slot&gt; node &lt;node_id&gt;</code> - Gán khe (slot) cho nút được chỉ định bởi node_id. Nếu khe (slot) đã được gán cho một nút khác, trước tiên hãy yêu cầu nút khác xóa khe (slot) đó, sau đó mới gán.</li><li><code>cluster setslot &lt;slot&gt; migrating &lt;node_id&gt;</code> - Di chuyển khe (slot) của nút hiện tại sang nút được chỉ định bởi node_id.</li><li><code>cluster setslot &lt;slot&gt; importing &lt;node_id&gt;</code> - Nhập khe (slot) từ nút được chỉ định bởi node_id vào nút hiện tại.</li><li><code>cluster setslot &lt;slot&gt; stable</code> - Hủy bỏ việc nhập (import) hoặc di chuyển (migrate) khe (slot) đã gán.</li></ul></li><li><strong>Khóa</strong><ul><li><code>cluster keyslot &lt;key&gt;</code> - Tính toán khe (slot) mà khóa key nên được đặt vào.</li><li><code>cluster countkeysinslot &lt;slot&gt;</code> - Trả về số lượng cặp khóa-giá trị hiện có trong khe (slot) được chỉ định.</li><li><code>cluster getkeysinslot &lt;slot&gt; &lt;count&gt;</code> - Trả về count khóa trong khe (slot) được chỉ định.</li></ul></li></ul><h4 id="tai-phan-vung" tabindex="-1"><a class="header-anchor" href="#tai-phan-vung"><span>Tái phân vùng</span></a></h4><p>Thêm nút:</p><div class="language-" data-ext="" data-title=""><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span>./redis-cli --cluster add-node 192.168.1.136:7007 192.168.1.136:7001 --cluster-slave</span></span>
<span class="line"><span></span></span>
<span class="line"><span>redis-cli --cluster reshard 172.22.6.3 7001</span></span></code></pre></div><h2 id="_5-client" tabindex="-1"><a class="header-anchor" href="#_5-client"><span>5. Client</span></a></h2><p>Đề xuất sử dụng <a href="https://github.com/uglide/RedisDesktopManager" target="_blank" rel="noopener noreferrer"><strong>RedisDesktopManager</strong></a></p>`,166),l=[t];function c(r,d){return n(),a("div",null,l)}const p=s(i,[["render",c],["__file","operations.html.vue"]]),h=JSON.parse('{"path":"/database/redis/operations.html","title":"Redis Operations","lang":"en-US","frontmatter":{"title":"Redis Operations","tags":["redis","nosql"],"categories":["redis"],"icon":"devicon:redis","date created":"2023-07-24T00:00:00.000Z","date modified":"2023-07-25T00:00:00.000Z","order":15,"description":"Quản trị Redis Redis là một cơ sở dữ liệu key-value có hiệu suất cao. Thao tác SET có thể đạt tới 110.000 lần mỗi giây; thao tác GET có thể đạt tới 81.000 lần mỗi giây. 1. Cài đ...","head":[["meta",{"property":"og:url","content":"https://vanhung4499.github.io/database/redis/operations.html"}],["meta",{"property":"og:site_name","content":"VanHung4499"}],["meta",{"property":"og:title","content":"Redis Operations"}],["meta",{"property":"og:description","content":"Quản trị Redis Redis là một cơ sở dữ liệu key-value có hiệu suất cao. Thao tác SET có thể đạt tới 110.000 lần mỗi giây; thao tác GET có thể đạt tới 81.000 lần mỗi giây. 1. Cài đ..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"https://raw.githubusercontent.com/vanhung4499/images/master/snap/20230725005340.png"}],["meta",{"property":"og:locale","content":"en-US"}],["meta",{"property":"og:updated_time","content":"2024-06-28T15:54:38.000Z"}],["meta",{"property":"article:author","content":"Hung Nguyen"}],["meta",{"property":"article:tag","content":"redis"}],["meta",{"property":"article:tag","content":"nosql"}],["meta",{"property":"article:modified_time","content":"2024-06-28T15:54:38.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Redis Operations\\",\\"image\\":[\\"https://raw.githubusercontent.com/vanhung4499/images/master/snap/20230725005340.png\\",\\"https://raw.githubusercontent.com/vanhung4499/images/master/snap/20230725005345.png\\"],\\"dateModified\\":\\"2024-06-28T15:54:38.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"Hung Nguyen\\",\\"url\\":\\"https://vanhung4499.github.io\\"}]}"]]},"headers":[{"level":2,"title":"1. Cài đặt Redis","slug":"_1-cai-đat-redis","link":"#_1-cai-đat-redis","children":[{"level":3,"title":"Cài đặt trên Windows","slug":"cai-đat-tren-windows","link":"#cai-đat-tren-windows","children":[]},{"level":3,"title":"Cài đặt trên Linux","slug":"cai-đat-tren-linux","link":"#cai-đat-tren-linux","children":[]},{"level":3,"title":"Cài đặt trên Ubuntu","slug":"cai-đat-tren-ubuntu","link":"#cai-đat-tren-ubuntu","children":[]},{"level":3,"title":"Tự động khởi động khi máy khởi động","slug":"tu-đong-khoi-đong-khi-may-khoi-đong","link":"#tu-đong-khoi-đong-khi-may-khoi-đong","children":[]},{"level":3,"title":"Mở cổng trên tường lửa","slug":"mo-cong-tren-tuong-lua","link":"#mo-cong-tren-tuong-lua","children":[]},{"level":3,"title":"Kịch bản cài đặt Redis","slug":"kich-ban-cai-đat-redis","link":"#kich-ban-cai-đat-redis","children":[]}]},{"level":2,"title":"2. Sử dụng và cấu hình Redis đơn","slug":"_2-su-dung-va-cau-hinh-redis-đon","link":"#_2-su-dung-va-cau-hinh-redis-đon","children":[{"level":3,"title":"Khởi động Redis","slug":"khoi-đong-redis","link":"#khoi-đong-redis","children":[]},{"level":3,"title":"Cấu hình Redis thông thường","slug":"cau-hinh-redis-thong-thuong","link":"#cau-hinh-redis-thong-thuong","children":[]},{"level":3,"title":"Đặt Redis làm tiến trình nền","slug":"đat-redis-lam-tien-trinh-nen","link":"#đat-redis-lam-tien-trinh-nen","children":[]},{"level":3,"title":"Kiểm tra hiệu suất","slug":"kiem-tra-hieu-suat","link":"#kiem-tra-hieu-suat","children":[]}]},{"level":2,"title":"3. Sử dụng và cấu hình Redis Cluster","slug":"_3-su-dung-va-cau-hinh-redis-cluster","link":"#_3-su-dung-va-cau-hinh-redis-cluster","children":[{"level":3,"title":"Qui hoạch Cluster","slug":"qui-hoach-cluster","link":"#qui-hoach-cluster","children":[]},{"level":3,"title":"Triển khai Cluster","slug":"trien-khai-cluster","link":"#trien-khai-cluster","children":[]},{"level":3,"title":"Triển khai Sentinel","slug":"trien-khai-sentinel","link":"#trien-khai-sentinel","children":[]},{"level":3,"title":"Mở rộng Cluster","slug":"mo-rong-cluster","link":"#mo-rong-cluster","children":[]}]},{"level":2,"title":"4. Lệnh Redis","slug":"_4-lenh-redis","link":"#_4-lenh-redis","children":[{"level":3,"title":"Lệnh chung","slug":"lenh-chung","link":"#lenh-chung","children":[]},{"level":3,"title":"Lệnh cụm","slug":"lenh-cum","link":"#lenh-cum","children":[]}]},{"level":2,"title":"5. Client","slug":"_5-client","link":"#_5-client","children":[]}],"git":{"createdTime":1719590078000,"updatedTime":1719590078000,"contributors":[{"name":"Hung Nguyen Van","email":"vanhung4499@gmail.com","commits":1}]},"readingTime":{"minutes":20.74,"words":6222},"filePathRelative":"database/redis/operations.md","localizedDate":"June 28, 2024","excerpt":"\\n<blockquote>\\n<p><strong>Redis</strong> là một cơ sở dữ liệu key-value có hiệu suất cao.</p>\\n<p>Thao tác SET có thể đạt tới 110.000 lần mỗi giây; thao tác GET có thể đạt tới 81.000 lần mỗi giây.</p>\\n</blockquote>\\n<h2>1. Cài đặt Redis</h2>\\n<h3>Cài đặt trên Windows</h3>\\n<p><strong>Đường dẫn tải về:</strong> <a href=\\"https://github.com/MSOpenTech/redis/releases\\" target=\\"_blank\\" rel=\\"noopener noreferrer\\">https://github.com/MSOpenTech/redis/releases</a>.</p>","autoDesc":true}');export{p as comp,h as data};
