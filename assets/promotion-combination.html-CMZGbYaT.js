import{_ as i,o as a,c as e,a as s}from"./app-5QVbWi7Z.js";const d={};function c(p,n){return a(),e("div",null,n[0]||(n[0]=[s('<h1 id="【营销】拼团活动" tabindex="-1"><a class="header-anchor" href="#【营销】拼团活动"><span>【营销】拼团活动</span></a></h1><p>拼团，主要由 <code>yudao-module-promotion-biz</code> 后端模块的 <code>promotion</code> 实现，包括两部分：拼团活动、拼团记录。如下图所示：</p><figure><img src="https://cloud.iocoder.cn/img/商城手册/拼团活动/表关系.png" alt="表关系" tabindex="0" loading="lazy"><figcaption>表关系</figcaption></figure><h2 id="_1-拼团活动" tabindex="-1"><a class="header-anchor" href="#_1-拼团活动"><span><a href="#_1-%E6%8B%BC%E5%9B%A2%E6%B4%BB%E5%8A%A8">#</a> 1. 拼团活动</span></a></h2><p>拼团活动，由卖家在管理后台配置，提供给买家参与拼团，由 CombinationActivityService 类实现。</p><h3 id="_1-1-表结构" tabindex="-1"><a class="header-anchor" href="#_1-1-表结构"><span><a href="#_1-1-%E8%A1%A8%E7%BB%93%E6%9E%84">#</a> 1.1 表结构</span></a></h3><p>一个拼团活动，对应一条 <code>promotion_combination_activity</code> 表记录，对应一个商品 SPU。而每个商品 SKU 在该拼团下可以单独配置拼团价格，所以会有多条 <code>promotion_combination_activity_sku</code> 子表记录。</p><blockquote><p>省略 creator/create_time/updater/update_time/deleted/tenant_id 等通用字段</p></blockquote><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#abb2bf;--shiki-dark:#abb2bf;--shiki-light-bg:#282c34;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code"><code><span class="line"><span>CREATE TABLE `promotion_combination_activity` (</span></span>\n<span class="line"><span>  `id` bigint NOT NULL AUTO_INCREMENT COMMENT &#39;活动编号&#39;,</span></span>\n<span class="line"><span>  `name` varchar(50) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NOT NULL DEFAULT &#39;&#39; COMMENT &#39;拼团名称&#39;,</span></span>\n<span class="line"><span>  </span></span>\n<span class="line"><span>  `spu_id` bigint NOT NULL COMMENT &#39;商品 SPU ID&#39;,</span></span>\n<span class="line"><span>  </span></span>\n<span class="line"><span>  `status` tinyint NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;活动状态：0开启 1关闭&#39;,</span></span>\n<span class="line"><span></span></span>\n<span class="line"><span>  `total_limit_count` int NOT NULL COMMENT &#39;总限购数量&#39;,</span></span>\n<span class="line"><span>  `single_limit_count` int NOT NULL COMMENT &#39;单次限购数量&#39;,</span></span>\n<span class="line"><span>  `start_time` datetime NOT NULL COMMENT &#39;开始时间&#39;,</span></span>\n<span class="line"><span>  `end_time` datetime NOT NULL COMMENT &#39;结束时间&#39;,</span></span>\n<span class="line"><span>  </span></span>\n<span class="line"><span>  `user_size` int DEFAULT NULL COMMENT &#39;购买人数&#39;,</span></span>\n<span class="line"><span>  `virtual_group` int NOT NULL COMMENT &#39;虚拟成团&#39;,</span></span>\n<span class="line"><span>  `limit_duration` int NOT NULL COMMENT &#39;限制时长（小时）&#39;,</span></span>\n<span class="line"><span>  PRIMARY KEY (`id`) USING BTREE</span></span>\n<span class="line"><span>) ENGINE=InnoDB AUTO_INCREMENT=9 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci COMMENT=&#39;拼团活动&#39;;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>① <code>spu_id</code> 字段：商品 SPU ID，对应商品 SPU 表的 <code>id</code> 字段。</p><p>注意：一个拼团活动，只能对应一个商品 SPU，不能对应多个商品 SPU！！！</p><p>② <code>status</code> 字段：活动状态，由 CommonStatusEnum 枚举，只有开启、禁用两个状态。禁用时，无法参与拼团。</p><p>③ <code>user_size</code> 字段：每个拼团需要的人数，例如说，3 人团、5 人团。</p><p>如果超过 <code>limit_duration</code> 时长，还没凑齐人数，就会自动拼团失败。当然，如果希望虚拟成团，则可以设置 <code>virtual_group</code> 字段，此时只要 <code>user_size - virtual_group</code> 人即可拼团成功。这块逻辑，由 CombinationRecordExpireJob 定时任务实现。</p><hr><div class="language-" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#abb2bf;--shiki-dark:#abb2bf;--shiki-light-bg:#282c34;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code"><code><span class="line"><span>CREATE TABLE `promotion_combination_product` (</span></span>\n<span class="line"><span>  `id` bigint NOT NULL AUTO_INCREMENT COMMENT &#39;编号&#39;,</span></span>\n<span class="line"><span>  </span></span>\n<span class="line"><span>  `activity_id` bigint DEFAULT NULL COMMENT &#39;拼团活动编号&#39;,</span></span>\n<span class="line"><span>  `activity_status` tinyint NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;拼团商品状态&#39;,</span></span>\n<span class="line"><span>  `activity_start_time` datetime NOT NULL COMMENT &#39;活动开始时间点&#39;,</span></span>\n<span class="line"><span>  `activity_end_time` datetime NOT NULL COMMENT &#39;活动结束时间点&#39;,</span></span>\n<span class="line"><span>  `spu_id` bigint DEFAULT NULL COMMENT &#39;商品 SPU 编号&#39;,</span></span>\n<span class="line"><span>  </span></span>\n<span class="line"><span>  `sku_id` bigint DEFAULT NULL COMMENT &#39;商品 SKU 编号&#39;,</span></span>\n<span class="line"><span></span></span>\n<span class="line"><span>  `combination_price` int NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;拼团价格，单位分&#39;,</span></span>\n<span class="line"><span>  PRIMARY KEY (`id`) USING BTREE</span></span>\n<span class="line"><span>) ENGINE=InnoDB AUTO_INCREMENT=32 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci COMMENT=&#39;拼团商品&#39;;</span></span></code></pre></div><p>① 【活动信息】<code>activity_id</code> 字段：拼团活动编号，对应 <code>promotion_combination_activity</code> 表的 <code>id</code> 字段。其它 <code>activity_*</code> + <code>spu_id</code> 字段，都是冗余字段，方便查询。</p><p>② 【SKU 信息】<code>sku_id</code> 字段：商品 SKU 编号，对应商品 SKU 表的 <code>id</code> 字段。<code>combination_price</code> 字段：拼团价格，单位分。</p><h3 id="_1-2-管理后台" tabindex="-1"><a class="header-anchor" href="#_1-2-管理后台"><span><a href="#_1-2-%E7%AE%A1%E7%90%86%E5%90%8E%E5%8F%B0">#</a> 1.2 管理后台</span></a></h3><p>对应 [商城系统 -&gt; 营销中心 -&gt; 拼团活动 -&gt; 拼团商品] 菜单，对应 <code>yudao-ui-admin-vue3</code> 项目的 <code>views/mall/promotion/combination/activity</code> 目录。如下图所示：</p><figure><img src="https://cloud.iocoder.cn/img/商城手册/拼团活动/拼团活动-管理后台.png" alt="拼团活动" tabindex="0" loading="lazy"><figcaption>拼团活动</figcaption></figure><h3 id="_1-3-移动端" tabindex="-1"><a class="header-anchor" href="#_1-3-移动端"><span><a href="#_1-3-%E7%A7%BB%E5%8A%A8%E7%AB%AF">#</a> 1.3 移动端</span></a></h3><p>① 点击 uni-app 首页的 [拼团] 菜单，进入拼团列表页，对应 <code>pages/activity/groupon/list.vue</code> 目录。如下图所示：</p><figure><img src="https://cloud.iocoder.cn/img/商城手册/拼团活动/拼团活动-移动端-列表.png" alt="拼团列表" tabindex="0" loading="lazy"><figcaption>拼团列表</figcaption></figure><p>② 点击某个拼团，进入拼团详情页，对应 <code>pages/goods/groupon.vue</code> 目录。如下图所示：</p><figure><img src="https://cloud.iocoder.cn/img/商城手册/拼团活动/拼团活动-移动端-详情.png" alt="拼团详情" tabindex="0" loading="lazy"><figcaption>拼团详情</figcaption></figure><h2 id="_2-拼团记录" tabindex="-1"><a class="header-anchor" href="#_2-拼团记录"><span><a href="#_2-%E6%8B%BC%E5%9B%A2%E8%AE%B0%E5%BD%95">#</a> 2. 拼团记录</span></a></h2><p>拼团记录，由买家参与拼团时生成，分成团长和团员，由 CombinationRecordService 类实现。</p><h3 id="_2-1-表结构" tabindex="-1"><a class="header-anchor" href="#_2-1-表结构"><span><a href="#_2-1-%E8%A1%A8%E7%BB%93%E6%9E%84">#</a> 2.1 表结构</span></a></h3><blockquote><p>省略 creator/create_time/updater/update_time/deleted/tenant_id 等通用字段</p></blockquote><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#abb2bf;--shiki-dark:#abb2bf;--shiki-light-bg:#282c34;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code"><code><span class="line"><span>CREATE TABLE `promotion_combination_record` (</span></span>\n<span class="line"><span>  `id` bigint NOT NULL AUTO_INCREMENT COMMENT &#39;编号&#39;,</span></span>\n<span class="line"><span>  </span></span>\n<span class="line"><span>  `activity_id` bigint DEFAULT NULL COMMENT &#39;拼团活动编号&#39;,</span></span>\n<span class="line"><span>  `spu_id` bigint DEFAULT NULL COMMENT &#39;商品 SPU 编号&#39;,</span></span>\n<span class="line"><span>  `pic_url` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NOT NULL COMMENT &#39;商品图片&#39;,</span></span>\n<span class="line"><span>  `spu_name` varchar(64) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NOT NULL COMMENT &#39;商品名称&#39;,</span></span>\n<span class="line"><span>  `sku_id` bigint DEFAULT NULL COMMENT &#39;商品 SKU 编号&#39;,</span></span>\n<span class="line"><span>  `count` int DEFAULT NULL COMMENT &#39;购买的商品数量&#39;,</span></span>\n<span class="line"><span>  `combination_price` int NOT NULL COMMENT &#39;拼团商品单价，单位分&#39;,</span></span>\n<span class="line"><span>  `user_size` int NOT NULL COMMENT &#39;可参团人数&#39;,</span></span>\n<span class="line"><span>  </span></span>\n<span class="line"><span>  `user_id` bigint DEFAULT NULL COMMENT &#39;用户编号&#39;,</span></span>\n<span class="line"><span>  `nickname` varchar(64) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci DEFAULT &#39;&#39; COMMENT &#39;用户昵称&#39;,</span></span>\n<span class="line"><span>  `avatar` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci DEFAULT &#39;&#39; COMMENT &#39;用户头像&#39;,</span></span>\n<span class="line"><span></span></span>\n<span class="line"><span>  `status` tinyint NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;参与状态：1进行中 2已完成 3未完成&#39;,  </span></span>\n<span class="line"><span>  `head_id` bigint DEFAULT NULL COMMENT &#39;团长编号&#39;,</span></span>\n<span class="line"><span>  `user_count` int NOT NULL COMMENT &#39;已参团人数&#39;,</span></span>\n<span class="line"><span>  `virtual_group` bit(1) DEFAULT NULL COMMENT &#39;是否虚拟拼团&#39;,</span></span>\n<span class="line"><span>  `expire_time` datetime NOT NULL COMMENT &#39;过期时间&#39;,</span></span>\n<span class="line"><span>  `start_time` datetime DEFAULT NULL COMMENT &#39;开始时间 (订单付款后开始的时间)&#39;,</span></span>\n<span class="line"><span>  `end_time` datetime DEFAULT NULL COMMENT &#39;结束时间（成团时间/失败时间）&#39;,</span></span>\n<span class="line"><span>  </span></span>\n<span class="line"><span>  `order_id` bigint DEFAULT NULL COMMENT &#39;订单编号&#39;,</span></span>\n<span class="line"><span>  PRIMARY KEY (`id`) USING BTREE</span></span>\n<span class="line"><span>) ENGINE=InnoDB AUTO_INCREMENT=13 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci COMMENT=&#39;拼团记录&#39;;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>① 【活动信息】<code>activity_id</code> 字段：拼团活动编号，对应 <code>promotion_combination_activity</code> 表的 <code>id</code> 字段。</p><p>其它 <code>spu_id</code>、<code>pic_url</code>、<code>spu_name</code>、<code>sku_id</code>、<code>count</code>、<code>combination_price</code>、<code>user_size</code> 字段，都是冗余字段，方便查询。</p><p>② 【用户信息】<code>user_id</code> 字段：用户编号，就是拼团的买家。</p><p>其它 <code>nickname</code>、<code>avatar</code> 字段，都是冗余字段，方便查询。</p><p>③ 【拼团信息】<code>status</code> 字段：参与状态，由 CombinationRecordStatusEnum 枚举，分成 3 种情况：进行中、拼团成功、拼团失败。</p><p><code>head_id</code> 字段：团长“编号”。分成两种情况：</p><ul><li>团长：则该字段为 <code>0</code>，表示它是团长的拼团记录。</li><li>团员：则该字段为团队拼团记录的 <code>id</code>，表示它是团长的拼团记录的团员。</li></ul><p>其它 <code>user_count</code>、<code>virtual_group</code>、<code>expire_time</code>、<code>start_time</code>、<code>end_time</code> 字段，就是拼团的一些信息。</p><p>④ 【订单信息】<code>order_id</code> 字段：订单编号，对应订单表的 <code>id</code> 字段。每个拼团记录，都会生成一个订单。</p><h3 id="_2-2-管理后台" tabindex="-1"><a class="header-anchor" href="#_2-2-管理后台"><span><a href="#_2-2-%E7%AE%A1%E7%90%86%E5%90%8E%E5%8F%B0">#</a> 2.2 管理后台</span></a></h3><p>对应 [商城系统 -&gt; 营销中心 -&gt; 拼团活动 -&gt; 拼团记录] 菜单，对应 <code>yudao-ui-admin-vue3</code> 项目的 <code>views/mall/promotion/combination/record</code> 目录。如下图所示：</p><figure><img src="https://cloud.iocoder.cn/img/商城手册/拼团活动/拼团记录-管理后台.png" alt="拼团记录" tabindex="0" loading="lazy"><figcaption>拼团记录</figcaption></figure><h3 id="_2-3-移动端【团长】" tabindex="-1"><a class="header-anchor" href="#_2-3-移动端【团长】"><span><a href="#_2-3-%E7%A7%BB%E5%8A%A8%E7%AB%AF%E3%80%90%E5%9B%A2%E9%95%BF%E3%80%91">#</a> 2.3 移动端【团长】</span></a></h3><p>友情提示：本小节，我们会“发起”一次拼团，扮演【团长】的角色</p><p>① 在 uni-app 拼团详情页，点击「立即购买」按钮，选择商品后，进入确认订单页，如下图所示：</p><figure><img src="https://cloud.iocoder.cn/img/商城手册/拼团活动/拼团记录-团长-订单确认页.png" alt="确认订单" tabindex="0" loading="lazy"><figcaption>确认订单</figcaption></figure><p>点击「提交订单」按钮后，会创建一条 <code>trade_order</code> 订单记录。此时，并未创建 <code>promotion_combination_record</code> 拼团记录：</p><ul><li><code>trade_order</code> 的 <code>type</code> 字段为拼团类型，<code>combination_activity_id</code> 字段为拼团活动编号，<code>head_id</code> 字段为 0 表示它是团长，<code>combination_head_id</code> 字段为 0 因为此时还没拼团记录</li><li>拼团优惠金额的计算，由 TradeCombinationActivityPriceCalculator 类实现</li><li>拼团在订单的自定义处理逻辑，由 TradeCombinationOrderHandler 类实现</li></ul><p>② 之后，会跳转到支付页。完成支付后，在 <code>trade_order</code> 订单记录为“已支付”的同时，会创建一条 <code>promotion_combination_record</code> 拼团记录，此时，拼团记录的状态为“进行中”，如下图所示：</p><figure><img src="https://cloud.iocoder.cn/img/商城手册/拼团活动/拼团记录-团长-支付成功.png" alt="支付成功" tabindex="0" loading="lazy"><figcaption>支付成功</figcaption></figure><ul><li>相关的逻辑处理，也是由 TradeCombinationOrderHandler 类实现</li><li><code>trade_order</code> 的 <code>combination_head_id</code> 字段为拼团记录的 <code>id</code></li></ul><p>③ 点击「我的拼团」按钮，进入拼团列表页，对应 <code>yudao-mall-unipp</code> 项目的 <code>pages/activity/groupon/order.vue</code> 目录。如下图所示：</p><figure><img src="https://cloud.iocoder.cn/img/商城手册/拼团活动/拼团记录-团长-拼团列表.png" alt="拼团列表" tabindex="0" loading="lazy"><figcaption>拼团列表</figcaption></figure><p>④ 点击「邀请拼团」按钮，进入拼团详情页，对应 <code>yudao-mall-unipp</code> 项目的 <code>pages/activity/groupon/detail.vue</code> 目录。如下图所示：</p><figure><img src="https://cloud.iocoder.cn/img/商城手册/拼团活动/拼团记录-团长-拼团详情.png" alt="拼团详情" tabindex="0" loading="lazy"><figcaption>拼团详情</figcaption></figure><h3 id="_2-4-移动端【团员】" tabindex="-1"><a class="header-anchor" href="#_2-4-移动端【团员】"><span><a href="#_2-4-%E7%A7%BB%E5%8A%A8%E7%AB%AF%E3%80%90%E5%9B%A2%E5%91%98%E3%80%91">#</a> 2.4 移动端【团员】</span></a></h3><p>友情提示：本小节，我们会“参与”一次拼团，扮演【团员】的角色</p><p>① 注册一个新的买家账号，然后在 uni-app 拼团详情页。如下图所示：</p><figure><img src="https://cloud.iocoder.cn/img/商城手册/拼团活动/拼团记录-团长-订单确认页.png" alt="拼团详情" tabindex="0" loading="lazy"><figcaption>拼团详情</figcaption></figure><p>② 点击拼团记录后面的「去参团」按钮，选择商品后，进入确认订单页，如下图所示：</p><figure><img src="https://cloud.iocoder.cn/img/商城手册/拼团活动/拼团记录-团员-订单确认页.png" alt="确认订单" tabindex="0" loading="lazy"><figcaption>确认订单</figcaption></figure><p>整体流程和【团长】的流程一致，只是在 <code>trade_order</code> 订单记录的 <code>combination_head_id</code> 字段为拼团记录的 <code>id</code>。</p><p>③ 之后，会跳转到支付页。完成支付后，在 <code>trade_order</code> 订单记录为“已支付”的同时，会创建一条 <code>promotion_combination_record</code> 拼团记录，此时，拼团记录的状态为“拼团成功”。</p><figure><img src="https://cloud.iocoder.cn/img/商城手册/拼团活动/拼团记录-团员-拼团列表.png" alt="拼团列表" tabindex="0" loading="lazy"><figcaption>拼团列表</figcaption></figure><p>为什么是“拼团成功”呢？因为该拼团是 2 人团，此时显然已经满足，所以拼团成功。具体逻辑，可见 CombinationRecordService 类的 <code>#createCombinationRecord(...)</code> 方法，它会更新拼团进展（状态）。</p><hr><p>至此，我们已经完成了拼团流程，可以 debug 调试调试哈~~~</p>',68)]))}const l=i(d,[["render",c],["__file","promotion-combination.html.vue"]]),t=JSON.parse('{"path":"/project/yudao-cloud/mall/promotion-combination.html","title":"【营销】拼团活动","lang":"en-US","frontmatter":{"title":"【营销】拼团活动","tags":["project","java","spring-boot","spring-cloud"],"categories":["project"],"order":106,"feed":false,"seo":false,"head":[]},"headers":[{"level":2,"title":"# 1. 拼团活动","slug":"_1-拼团活动","link":"#_1-拼团活动","children":[{"level":3,"title":"# 1.1 表结构","slug":"_1-1-表结构","link":"#_1-1-表结构","children":[]},{"level":3,"title":"# 1.2 管理后台","slug":"_1-2-管理后台","link":"#_1-2-管理后台","children":[]},{"level":3,"title":"# 1.3 移动端","slug":"_1-3-移动端","link":"#_1-3-移动端","children":[]}]},{"level":2,"title":"# 2. 拼团记录","slug":"_2-拼团记录","link":"#_2-拼团记录","children":[{"level":3,"title":"# 2.1 表结构","slug":"_2-1-表结构","link":"#_2-1-表结构","children":[]},{"level":3,"title":"# 2.2 管理后台","slug":"_2-2-管理后台","link":"#_2-2-管理后台","children":[]},{"level":3,"title":"# 2.3 移动端【团长】","slug":"_2-3-移动端【团长】","link":"#_2-3-移动端【团长】","children":[]},{"level":3,"title":"# 2.4 移动端【团员】","slug":"_2-4-移动端【团员】","link":"#_2-4-移动端【团员】","children":[]}]}],"git":{"createdTime":1720365235000,"updatedTime":1720365235000,"contributors":[{"name":"Hung Nguyen Van","email":"vanhung4499@gmail.com","commits":1}]},"readingTime":{"minutes":8.72,"words":2615},"filePathRelative":"project/yudao-cloud/mall/promotion-combination.md","localizedDate":"July 7, 2024"}');export{l as comp,t as data};
