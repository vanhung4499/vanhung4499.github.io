import{_ as c,g as l,o as r,c as p,e,f as a,w as t,h as o,a as n}from"./app-BRTHG7K9.js";const d={},s=e("h1",{id:"微信公众号登录",tabindex:"-1"},[e("a",{class:"header-anchor",href:"#微信公众号登录"},[e("span",null,"微信公众号登录")])],-1),g=e("p",null,"前置阅读文章：",-1),h=e("br",null,null,-1),u=e("a",{href:"https://github.com/yudaocode/yudao-mall-uniapp",target:"_blank",rel:"noopener noreferrer"},[e("code",null,"yudao-mall-uniapp")],-1),f=e("strong",null,"公众号",-1),_=n('<h2 id="_1-公众号准备" tabindex="-1"><a class="header-anchor" href="#_1-公众号准备"><span><a href="#_1-%E5%85%AC%E4%BC%97%E5%8F%B7%E5%87%86%E5%A4%87">#</a> 1. 公众号准备</span></a></h2><p>友情提示：</p><p>本文，我们以“测试公众号”举例子，方便大家操作，认证一个公众号太难了！！！</p><p>① 参考 <a href="https://mp.weixin.qq.com/debug/cgi-bin/sandbox?t=sandbox/login" target="_blank" rel="noopener noreferrer">微信公众平台接口测试帐号申请</a> 链接，申请一个测试公众号。</p><p>② 将 <code>appID</code> 和 <code>appSecret</code> 配置，设置到后端项目 <code>application-local.yaml</code> 的 <code>wx.mp</code> 配置项中。如下图所示：</p><figure><img src="https://doc.iocoder.cn/img/会员手册/公众号登录/测试公众号-密钥.png" alt="测试公众号 - 密钥" tabindex="0" loading="lazy"><figcaption>测试公众号 - 密钥</figcaption></figure><figure><img src="https://doc.iocoder.cn/img/会员手册/公众号登录/后端配置项.png" alt=" 配置项" tabindex="0" loading="lazy"><figcaption> 配置项</figcaption></figure><p>③ 修改“JS接口安全域名”，设置为前端的访问地址。例如说，现在本地是 <code>http://127.0.0.1:3000</code>。如下图所示：</p><figure><img src="https://doc.iocoder.cn/img/会员手册/公众号登录/JS接口安全域名.png" alt="JS 接口安全域名.png" tabindex="0" loading="lazy"><figcaption>JS 接口安全域名.png</figcaption></figure><p>注意：自己需要关注下自己的测试公众号！！！</p><p>④ 修改“网页授权获取用户基本信息”，设置为前端的访问地址。例如说，现在本地是 <code>http://127.0.0.1:3000</code>。如下图所示：</p><figure><img src="https://doc.iocoder.cn/img/会员手册/公众号登录/网页授权获取用户基本信息.png" alt="网页授权获取用户基本信息" tabindex="0" loading="lazy"><figcaption>网页授权获取用户基本信息</figcaption></figure><p>补充说明：如果你是正式的公众号，需要额外看下这部分的内容：</p><p>① 设置“IP白名单”，在公众号的 [设置与开发 - 安全中心] 菜单，如下图所示：</p><figure><img src="https://doc.iocoder.cn/img/会员手册/公众号登录/IP白名单.png" alt="IP 白名单" tabindex="0" loading="lazy"><figcaption>IP 白名单</figcaption></figure><p>② 在公众号的 [设置与开发 - 公众号设置] 菜单，设置“JS接口安全域名”、“JS接口安全域名”、“网页授权域名”，如下图所示：</p><figure><img src="https://doc.iocoder.cn/img/会员手册/公众号登录/公众号设置.png" alt="公众号设置" tabindex="0" loading="lazy"><figcaption>公众号设置</figcaption></figure>',17),m=e("li",null,[o("上图的 "),e("code",null,"MP_verify_XXXXXXXXXXXXXXXX.txt"),o(" 文件，可以直接放在 "),e("code",null,"yudao-mall-uniapp"),o(" 商城项目的根目录")],-1),x=n('<h2 id="_2-代码实现" tabindex="-1"><a class="header-anchor" href="#_2-代码实现"><span><a href="#_2-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0">#</a> 2. 代码实现</span></a></h2><h3 id="_2-1-项目启动" tabindex="-1"><a class="header-anchor" href="#_2-1-项目启动"><span><a href="#_2-1-%E9%A1%B9%E7%9B%AE%E5%90%AF%E5%8A%A8">#</a> 2.1 项目启动</span></a></h3>',2),b=e("code",null,"yudao-mall-uniapp",-1),E=n('<p>② 下载 <a href="https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html" target="_blank" rel="noopener noreferrer">微信开发者工具</a>，并进行安装。安装后，选择「公众号网页项目」。如下图所示：</p><figure><img src="https://doc.iocoder.cn/img/会员手册/公众号登录/公众号网页项目.png" alt="公众号网页项目" tabindex="0" loading="lazy"><figcaption>公众号网页项目</figcaption></figure><h3 id="_2-2-微信-jssdk" tabindex="-1"><a class="header-anchor" href="#_2-2-微信-jssdk"><span><a href="#_2-2-%E5%BE%AE%E4%BF%A1-jssdk">#</a> 2.2 微信 JSSDK</span></a></h3><p>访问 <code>http://127.0.0.1:3000/</code> 地址（其它地址也可以），它会触发 <a href="https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/JS-SDK.html" target="_blank" rel="noopener noreferrer">微信 JSSDK</a> 初始化的逻辑，对应前端 <code>sheep/libs/sdk-h5-weixin.js</code> 文件的 <code>#init(...)</code> 方法中。</p><p>微信 JSSDK 所需要的签名，由后端的 AppAuthController 的 <code>#createWeixinMpJsapiSignature(...)</code> 方法所提供。</p><h3 id="_2-3-登录流程" tabindex="-1"><a class="header-anchor" href="#_2-3-登录流程"><span><a href="#_2-3-%E7%99%BB%E5%BD%95%E6%B5%81%E7%A8%8B">#</a> 2.3 登录流程</span></a></h3><p>友情提示：</p><p>可以简单阅读下 <a href="https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/Wechat_webpage_authorization.html" target="_blank" rel="noopener noreferrer">《微信官方文档 —— 网页授权》</a> 文章。</p><p>① 访问 <code>http://127.0.0.1:3000/#/pages/user/info</code> 地址，触发弹出“登录窗口”，对应前端 <code>sheep/components/s-auth-modal/s-auth-modal.vue</code> 组件。如下图所示：</p><figure><img src="https://doc.iocoder.cn/img/会员手册/公众号登录/登录弹窗.png" alt="登录弹窗" tabindex="0" loading="lazy"><figcaption>登录弹窗</figcaption></figure><p>② 点击「微信登录」图标，触发微信公众号登录。前端核心实现都在 <code>sheep/platform/provider/wechat/officialAccount.js</code> 的 <code>#login(...)</code> 方法中。它一共包含 2 个步骤。</p><p>③ 【第一步】前端调用后端的 AppAuthController 的 <code>#socialAuthRedirect(...)</code> 方法，获得微信公众号的登录地址，并进行跳转。效果如下图：</p><figure><img src="https://doc.iocoder.cn/img/会员手册/公众号登录/微信公众号的登录地址.png" alt="微信公众号的登录地址" tabindex="0" loading="lazy"><figcaption>微信公众号的登录地址</figcaption></figure><p>ps：为了在微信登录成功后，可以回到登陆前的 URL 地址，会将该 URL 存储到 <code>uni.setStorageSync(&#39;returnUrl&#39;, location.href)</code> 中。</p><p>④ 【第二步】点击「同意」按钮，跳转回前端的 <code>pages/index/login.vue</code> 页面，进行 <strong>真正的</strong> 微信登录逻辑。</p><p>此时，前端从 URL 中解析到微信回调提供的 <code>code</code> 授权码参数，调用后端的 AppAuthController 的 <code>#socialLogin(...)</code> 方法，进行登录逻辑。注意：</p><ul><li>情况一：如果该微信用户已经绑定会员用户，则直接进行登录</li><li>情况二：如果该微信用户没有绑定会员用户，则会自动创建一个会员用户，并进行登录。下次重新登录时，就走【情况一】的逻辑。</li></ul><p>ps：登录成功后，通过 <code>uni.getStorageSync(&#39;returnUrl&#39;)</code> 获得登录前的 URL 地址，进行跳转。</p>',18);function A(S,v){const i=l("RouteLink");return r(),p("div",null,[s,g,e("ul",null,[e("li",null,[a(i,{to:"/user-center/"},{default:t(()=>[o("《用户体系》")]),_:1})]),e("li",null,[a(i,{to:"/social-user/"},{default:t(()=>[o("《三方登录》")]),_:1}),h,o(" 本文是 "),a(i,{to:"/social-user/"},{default:t(()=>[o("《三方登录》")]),_:1}),o(" 的延伸，讲解 "),u,o(" 商城小程序如何实现微信 "),f,o(" 登录的功能。")])]),_,e("ul",null,[e("li",null,[o("设置时，需要外网可访问，可以需要使用 "),a(i,{to:"/natapp/"},{default:t(()=>[o("natapp")]),_:1}),o(" 进行内网穿透")]),m]),x,e("p",null,[o("① 参考 "),a(i,{to:"/quick-start-front/"},{default:t(()=>[o("《快速启动【前端】》")]),_:1}),o(" 文档的「2. uni-app 商城移动端」小节，将 "),b,o(" 商城项目跑起来。")]),E])}const k=c(d,[["render",A],["__file","weixin-mp-login.html.vue"]]),B=JSON.parse('{"path":"/project/rouyi-vue-pro/member/weixin-mp-login.html","title":"微信公众号登录","lang":"en-US","frontmatter":{"title":"微信公众号登录","tags":["project","java","spring-boot","spring-cloud"],"categories":["project"],"order":84,"feed":false,"seo":false,"head":[]},"headers":[{"level":2,"title":"# 1. 公众号准备","slug":"_1-公众号准备","link":"#_1-公众号准备","children":[]},{"level":2,"title":"# 2. 代码实现","slug":"_2-代码实现","link":"#_2-代码实现","children":[{"level":3,"title":"# 2.1 项目启动","slug":"_2-1-项目启动","link":"#_2-1-项目启动","children":[]},{"level":3,"title":"# 2.2 微信 JSSDK","slug":"_2-2-微信-jssdk","link":"#_2-2-微信-jssdk","children":[]},{"level":3,"title":"# 2.3 登录流程","slug":"_2-3-登录流程","link":"#_2-3-登录流程","children":[]}]}],"git":{"createdTime":1720365235000,"updatedTime":1720365235000,"contributors":[{"name":"Hung Nguyen Van","email":"vanhung4499@gmail.com","commits":1}]},"readingTime":{"minutes":4.78,"words":1435},"filePathRelative":"project/rouyi-vue-pro/member/weixin-mp-login.md","localizedDate":"July 7, 2024"}');export{k as comp,B as data};
