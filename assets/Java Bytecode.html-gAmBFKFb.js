import{_ as s,o as a,c as n,a as i}from"./app-B9pwkC50.js";const l={},t=i(`<h1 id="java-bytecode" tabindex="-1"><a class="header-anchor" href="#java-bytecode"><span>Java Bytecode</span></a></h1><h2 id="gioi-thieu-ve-bytecode" tabindex="-1"><a class="header-anchor" href="#gioi-thieu-ve-bytecode"><span>Giới thiệu về Bytecode</span></a></h2><h3 id="bytecode-la-gi" tabindex="-1"><a class="header-anchor" href="#bytecode-la-gi"><span>Bytecode là gì?</span></a></h3><p>Java bytecode là một định dạng lệnh mà máy ảo Java (JVM) thực thi. Java bytecode được gọi là &quot;bytecode&quot; vì: <strong>Tệp Java bytecode (<code>.class</code>) là một luồng dữ liệu nhị phân được cấu trúc gọn gàng với đơn vị cơ bản là byte 8 bit</strong>, các mục dữ liệu được sắp xếp chặt chẽ theo thứ tự trong tệp .class mà không có bất kỳ ký tự phân tách nào. <strong>Toàn bộ tệp .class thực chất là một bảng</strong>.</p><p>Java có thể thực hiện &quot;compile once, run anywhere&quot; (một lần biên dịch, chạy ở bất kỳ đâu) vì: JVM đã được tùy chỉnh cho các hệ điều hành, nền tảng khác nhau; và bất kể nền tảng nào, bạn cũng có thể biên dịch và tạo ra tệp Java bytecode (.class) có định dạng cố định.</p><figure><img src="https://raw.githubusercontent.com/vanhung4499/images/master/snap/20230719115010.png" alt="image.png" tabindex="0" loading="lazy"><figcaption>image.png</figcaption></figure><h3 id="giai-ma-bytecode" tabindex="-1"><a class="header-anchor" href="#giai-ma-bytecode"><span>Giải mã bytecode</span></a></h3><p>Chúng ta sẽ sử dụng một ví dụ để giải thích cách giải mã tệp bytecode.</p><p>(1) Đầu tiên, tạo một tệp <code>Demo.java</code> với nội dung như sau:</p><div class="language-java" data-ext="java" data-title="java"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">public</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> class</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;"> Demo</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    public</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> static</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> void</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;"> main</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">String</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">[] </span><span style="color:#E06C75;--shiki-dark:#E06C75;font-style:italic;--shiki-dark-font-style:italic;">args</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#E5C07B;--shiki-dark:#E5C07B;">        System</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">out</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">println</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;hello world&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">}</span></span></code></pre></div><p>(2) Biên dịch tệp <code>Demo.java</code> bằng cách chạy <code>javac Demo.java</code>, tệp <code>Demo.class</code> sẽ được tạo ra trong thư mục hiện tại.</p><p>Nội dung tệp là một chuỗi số hexa:</p><div class="language- line-numbers-mode" data-ext="" data-title=""><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span>cafe babe 0000 0034 001d 0a00 0600 0f09</span></span>
<span class="line"><span>0010 0011 0800 120a 0013 0014 0700 1507</span></span>
<span class="line"><span>0016 0100 063c 696e 6974 3e01 0003 2829</span></span>
<span class="line"><span>5601 0004 436f 6465 0100 0f4c 696e 654e</span></span>
<span class="line"><span>756d 6265 7254 6162 6c65 0100 046d 6169</span></span>
<span class="line"><span>6e01 0016 285b 4c6a 6176 612f 6c61 6e67</span></span>
<span class="line"><span>2f53 7472 696e 673b 2956 0100 0a53 6f75</span></span>
<span class="line"><span>7263 6546 696c 6501 0009 4465 6d6f 2e6a</span></span>
<span class="line"><span>6176 610c 0007 0008 0700 170c 0018 0019</span></span>
<span class="line"><span>0100 0b68 656c 6c6f 2077 6f72 6c64 0700</span></span>
<span class="line"><span>1a0c 001b 001c 0100 1b63 6f6d 2f68 6e76</span></span>
<span class="line"><span>3939 2f6a 6176 6163 6f72 652f 6a76 6d2f</span></span>
<span class="line"><span>4465 6d6f 0100 106a 6176 612f 6c61 6e67</span></span>
<span class="line"><span>2f4f 626a 6563 7401 0010 6a61 7661 2f6c</span></span>
<span class="line"><span>616e 672f 5379 7374 656d 0100 036f 7574</span></span>
<span class="line"><span>0100 154c 6a61 7661 2f69 6f2f 5072 696e</span></span>
<span class="line"><span>7453 7472 6561 6d3b 0100 136a 6176 612f</span></span>
<span class="line"><span>696f 2f50 7269 6e74 5374 7265 616d 0100</span></span>
<span class="line"><span>0770 7269 6e74 6c6e 0100 1528 4c6a 6176</span></span>
<span class="line"><span>612f 6c61 6e67 2f53 7472 696e 673b 2956</span></span>
<span class="line"><span>0021 0005 0006 0000 0000 0002 0001 0007</span></span>
<span class="line"><span>0008 0001 0009 0000 001d 0001 0001 0000</span></span>
<span class="line"><span>0005 2ab7 0001 b100 0000 0100 0a00 0000</span></span>
<span class="line"><span>0600 0100 0000 0300 0900 0b00 0c00 0100</span></span>
<span class="line"><span>0900 0000 2500 0200 0100 0000 09b2 0002</span></span>
<span class="line"><span>1203 b600 04b1 0000 0001 000a 0000 000a</span></span>
<span class="line"><span>0002 0000 0006 0008 0007 0001 000d 0000</span></span>
<span class="line"><span>0002 000e</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Trước đó đã đề cập: Tệp Java bytecode (<code>.class</code>) là một luồng dữ liệu nhị phân được cấu trúc gọn gàng với đơn vị cơ bản là byte 8 bit, các mục dữ liệu được sắp xếp chặt chẽ theo thứ tự trong tệp .class mà không có bất kỳ ký tự phân tách nào.</p><p>(3) Chúng ta có thể <strong>giải mã</strong> tệp bytecode bằng công cụ giải mã tích hợp sẵn trong Java, <code>javap</code>.</p><p>Chạy <code>javap -verbose -p Demo.class</code>, kết quả sẽ hiển thị các hướng dẫn tương đối dễ hiểu trên cửa sổ điều khiển. Kết quả đầu ra gần như như sau:</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">Classfile </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">Users</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">kirito4499</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">Desktop</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">Learn</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">Java</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">javacore</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">src</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">main</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">java</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">com</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">hnv99</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">javacore</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">jvm</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">/</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">Demo</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">class</span></span>
<span class="line"><span style="color:#E5C07B;--shiki-dark:#E5C07B;">  Last</span><span style="color:#E06C75;--shiki-dark:#E06C75;"> modified Jul </span><span style="color:#D19A66;--shiki-dark:#D19A66;">19</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 2023</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span><span style="color:#E06C75;--shiki-dark:#E06C75;"> size </span><span style="color:#D19A66;--shiki-dark:#D19A66;">436</span><span style="color:#E06C75;--shiki-dark:#E06C75;"> bytes</span></span>
<span class="line"><span style="color:#E5C07B;--shiki-dark:#E5C07B;">  MD5</span><span style="color:#E06C75;--shiki-dark:#E06C75;"> checksum 1048b81da0c1b88301731243e6c260c1</span></span>
<span class="line"><span style="color:#E5C07B;--shiki-dark:#E5C07B;">  Compiled</span><span style="color:#E06C75;--shiki-dark:#E06C75;"> from </span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;Demo.java&quot;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">public</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> class</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;"> com</span><span style="color:#E06C75;--shiki-dark:#E06C75;">.hnv99.javacore.jvm.Demo</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">  minor version: 0</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">  major version: 52</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">  flags: ACC_PUBLIC, ACC_SUPER</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">Constant pool:</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">   #1 = Methodref          #6.#15         </span><span style="color:#7F848E;--shiki-dark:#7F848E;font-style:italic;--shiki-dark-font-style:italic;">// java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">   #2 = Fieldref           #16.#17        </span><span style="color:#7F848E;--shiki-dark:#7F848E;font-style:italic;--shiki-dark-font-style:italic;">// java/lang/System.out:Ljava/io/PrintStream;</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">   #3 = String             #18            </span><span style="color:#7F848E;--shiki-dark:#7F848E;font-style:italic;--shiki-dark-font-style:italic;">// hello world</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">   #4 = Methodref          #19.#20        </span><span style="color:#7F848E;--shiki-dark:#7F848E;font-style:italic;--shiki-dark-font-style:italic;">// java/io/PrintStream.println:(Ljava/lang/String;)V</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">   #5 = Class              #21            </span><span style="color:#7F848E;--shiki-dark:#7F848E;font-style:italic;--shiki-dark-font-style:italic;">// com/hnv99/javacore/jvm/Demo</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">   #6 = Class              #22            </span><span style="color:#7F848E;--shiki-dark:#7F848E;font-style:italic;--shiki-dark-font-style:italic;">// java/lang/Object</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">   #7 = Utf8               </span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">&lt;</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">init</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">   #8 = Utf8               ()V</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">   #9 = Utf8               Code</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">  #10 = Utf8               LineNumberTable</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">  #11 = Utf8               main</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">  #12 = Utf8               ([Ljava/lang/String;)V</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">  #13 = Utf8               SourceFile</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">  #14 = Utf8               Demo.java</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">  #15 = NameAndType        #7:#8          </span><span style="color:#7F848E;--shiki-dark:#7F848E;font-style:italic;--shiki-dark-font-style:italic;">// &quot;&lt;init&gt;&quot;:()V</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">  #16 = Class              #23            </span><span style="color:#7F848E;--shiki-dark:#7F848E;font-style:italic;--shiki-dark-font-style:italic;">// java/lang/System</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">  #17 = NameAndType        #24:#25        </span><span style="color:#7F848E;--shiki-dark:#7F848E;font-style:italic;--shiki-dark-font-style:italic;">// out:Ljava/io/PrintStream;</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">  #18 = Utf8               hello world</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">  #19 = Class              #26            </span><span style="color:#7F848E;--shiki-dark:#7F848E;font-style:italic;--shiki-dark-font-style:italic;">// java/io/PrintStream</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">  #20 = NameAndType        #27:#28        </span><span style="color:#7F848E;--shiki-dark:#7F848E;font-style:italic;--shiki-dark-font-style:italic;">// println:(Ljava/lang/String;)V</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">  #21 = Utf8               com/hnv99/javacore/jvm/Demo</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">  #22 = Utf8               java/lang/Object</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">  #23 = Utf8               java/lang/System</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">  #24 = Utf8               out</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">  #25 = Utf8               Ljava/io/PrintStream;</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">  #26 = Utf8               java/io/PrintStream</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">  #27 = Utf8               println</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">  #28 = Utf8               (Ljava/lang/String;)V</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">  public</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;"> com.hnv99.javacore.jvm.Demo</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">    descriptor: ()V</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">    flags: ACC_PUBLIC</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">    Code:</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">      stack=1, locals=1, args_size=1</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">         0: aload_0</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">         1: invokespecial #1                  </span><span style="color:#7F848E;--shiki-dark:#7F848E;font-style:italic;--shiki-dark-font-style:italic;">// Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">         4: return</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">      LineNumberTable:</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">        line 3: 0</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">  public</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> static</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> void</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;"> main</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">java</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">lang</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">String</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">[]);</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">    descriptor: ([Ljava/lang/String</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">)</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">V</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">    flags</span><span style="color:#C678DD;--shiki-dark:#C678DD;">:</span><span style="color:#E06C75;--shiki-dark:#E06C75;"> ACC_PUBLIC</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;"> ACC_STATIC</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">    Code</span><span style="color:#C678DD;--shiki-dark:#C678DD;">:</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">      stack</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#E06C75;--shiki-dark:#E06C75;"> locals</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#E06C75;--shiki-dark:#E06C75;"> args_size</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">         0</span><span style="color:#C678DD;--shiki-dark:#C678DD;">:</span><span style="color:#E06C75;--shiki-dark:#E06C75;"> getstatic     #</span><span style="color:#D19A66;--shiki-dark:#D19A66;">2</span><span style="color:#7F848E;--shiki-dark:#7F848E;font-style:italic;--shiki-dark-font-style:italic;">                  // Field java/lang/System.out:Ljava/io/PrintStream;</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">         3</span><span style="color:#C678DD;--shiki-dark:#C678DD;">:</span><span style="color:#E06C75;--shiki-dark:#E06C75;"> ldc           #</span><span style="color:#D19A66;--shiki-dark:#D19A66;">3</span><span style="color:#7F848E;--shiki-dark:#7F848E;font-style:italic;--shiki-dark-font-style:italic;">                  // String hello world</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">         5</span><span style="color:#C678DD;--shiki-dark:#C678DD;">:</span><span style="color:#E06C75;--shiki-dark:#E06C75;"> invokevirtual #</span><span style="color:#D19A66;--shiki-dark:#D19A66;">4</span><span style="color:#7F848E;--shiki-dark:#7F848E;font-style:italic;--shiki-dark-font-style:italic;">                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">         8</span><span style="color:#C678DD;--shiki-dark:#C678DD;">:</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> return</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">      LineNumberTable</span><span style="color:#C678DD;--shiki-dark:#C678DD;">:</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">        line </span><span style="color:#D19A66;--shiki-dark:#D19A66;">6</span><span style="color:#C678DD;--shiki-dark:#C678DD;">:</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 0</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">        line </span><span style="color:#D19A66;--shiki-dark:#D19A66;">7</span><span style="color:#C678DD;--shiki-dark:#C678DD;">:</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 8</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">}</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">SourceFile</span><span style="color:#C678DD;--shiki-dark:#C678DD;">:</span><span style="color:#98C379;--shiki-dark:#98C379;"> &quot;Demo.java&quot;</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="cau-truc-tep-bytecode" tabindex="-1"><a class="header-anchor" href="#cau-truc-tep-bytecode"><span>Cấu trúc tệp bytecode</span></a></h3><p>Tệp bytecode có vẻ lộn xộn và không có thứ tự, nhưng thực tế nó được cấu thành từ các yêu cầu định dạng nghiêm ngặt.</p><figure><img src="https://raw.githubusercontent.com/vanhung4499/images/master/snap/20230719120335.png" alt="image.png" tabindex="0" loading="lazy"><figcaption>image.png</figcaption></figure><h4 id="magic-number" tabindex="-1"><a class="header-anchor" href="#magic-number"><span>Magic Number</span></a></h4><p>4 byte đầu tiên của mỗi tệp <code>.class</code> được gọi là <strong><code>Magic Number</code></strong>, nó chỉ ra xem tệp này có phải là một tệp <code>.class</code> được JVM chấp nhận hay không. Giá trị cố định của magic number là: <code>0xCAFEBABE</code>.</p><h4 id="version" tabindex="-1"><a class="header-anchor" href="#version"><span>Version</span></a></h4><p>Số phiên bản (version) có 4 byte, <strong>2 byte đầu tiên đại diện cho số phiên bản phụ (Minor Version), 2 byte cuối cùng đại diện cho số phiên bản chính (Major Version)</strong>.</p><p>Ví dụ, nếu số phiên bản là &quot;00 00 00 34&quot;. Khi đó, số phiên bản phụ chuyển đổi sang hệ thập phân là 0, số phiên bản chính chuyển đổi sang hệ thập phân là 52. Tìm kiếm số phiên bản chính tương ứng với số phiên bản 52 trên trang web chính thức của Oracle, ta có số phiên bản chính 52 tương ứng với phiên bản Java 1.8, vì vậy phiên bản Java mà tệp được biên dịch là 1.8.0.</p><h4 id="constant-pool" tabindex="-1"><a class="header-anchor" href="#constant-pool"><span>Constant Pool</span></a></h4><p>Ngay sau version chính là Constant Pool, constant pool có thể được hiểu như một kho lưu trữ tài nguyên trong tệp <code>.class</code>.</p><p>Constant Pool chia thành hai phần chính: Constant Pool Count và Constant Pool Data.</p><ul><li><p><strong>Constant Pool Count</strong> - Vì số lượng hằng số không cố định, nên cần hai byte đầu tiên để đại diện cho giá trị đếm số lượng hằng số trong constant pool.</p></li><li><p><strong>Constant Pool Data</strong> - Mỗi hằng số trong khu vực dữ liệu là một bảng và có cấu trúc khác nhau.</p></li></ul><p>Constant Pool chủ yếu chứa hai loại hằng số:</p><ul><li><strong>Hằng số kí tự</strong> - Ví dụ như chuỗi văn bản, giá trị hằng số được khai báo là <code>final</code>.</li><li><strong>Tham chiếu tượng trưng</strong><ul><li>Tên đầy đủ của lớp và interface</li><li>Tên và mô tả của trường</li><li>Tên và mô tả của phương thức</li></ul></li></ul><h4 id="access-flags" tabindex="-1"><a class="header-anchor" href="#access-flags"><span>Access Flags</span></a></h4><p>Ngay sau Constant Pool là 2 byte đại diện cho Access Flags, cờ này <strong>được sử dụng để nhận dạng thông tin truy cập của một số lớp hoặc interface</strong>, mô tả xem Class này là lớp hay interface,và có được <code>public</code>, <code>abstract</code>, <code>final</code> hay các từ khóa khác điều chỉnh không.</p><p>Access Flags có các loại sau:</p><table><thead><tr><th>Tên Access Flags</th><th>Giá trị cờ</th><th>Ý nghĩa</th></tr></thead><tbody><tr><td><strong>ACC_PUBLIC</strong></td><td>0x0001</td><td>Có phải là loại Public hay không</td></tr><tr><td><strong>ACC_FINAL</strong></td><td>0x0010</td><td>Được khai báo là final, chỉ có lớp mới có thể đặt</td></tr><tr><td><strong>ACC_SUPER</strong></td><td>0x0020</td><td>Cho phép sử dụng cú pháp mới của lệnh invokespecial</td></tr><tr><td><strong>ACC_INTERFACE</strong></td><td>0x0200</td><td>Đây là một interface</td></tr><tr><td><strong>ACC_ABSTRACT</strong></td><td>0x0400</td><td>Có phải là loại abstract hay không, đối với interface hoặc lớp trừu tượng</td></tr><tr><td><strong>ACC_SYNTHETIC</strong></td><td>0x1000</td><td>Lớp này không được tạo ra bởi mã nguồn người dùng</td></tr><tr><td><strong>ACC_ANNOTATION</strong></td><td>0x2000</td><td>Đây là một chú thích</td></tr><tr><td><strong>ACC_ENUM</strong></td><td>0x4000</td><td>Đây là một enum</td></tr></tbody></table><h4 id="this-class-super-class-interface-class" tabindex="-1"><a class="header-anchor" href="#this-class-super-class-interface-class"><span>This Class, Super Class, Interface Class</span></a></h4><p>This Class và Super Class đều là dữ liệu 2 byte, trong khi chỉ mục interface là một tập hợp dữ liệu 2 byte. <strong>Trong tệp <code>.class</code>, 3 dữ liệu này được sử dụng để xác định mối quan hệ kế thừa của lớp này</strong>.</p><blockquote><p>Java chỉ hỗ trợ đơn kế thừa nhưng có thể triển khai nhiều interface -&gt; Super Class tối đa một bản ghi, interface thì có thể có nhiều bản ghi hơn</p></blockquote><h4 id="field-table" tabindex="-1"><a class="header-anchor" href="#field-table"><span>Field Table</span></a></h4><p><strong>Field Table (Bảng trường) được sử dụng để mô tả các biến được khai báo trong lớp và interface</strong>. Bao gồm biến cấp lớp và biến cấp thể hiện, nhưng không bao gồm biến cục bộ được khai báo trong phạm vi phương thức.</p><p>Bảng trường cũng được chia thành hai phần, phần đầu tiên là Fields Count (2 byte), mô tả số lượng trường; phần thứ hai là thông tin chi tiết về từng trường (Field Entries).</p><h4 id="method-table" tabindex="-1"><a class="header-anchor" href="#method-table"><span>Method Table</span></a></h4><p>Sau Field Table là Method Table (bảng phương thức), cấu trúc bảng phương thức tương tự như bảng trường, bao gồm cờ truy cập, chỉ mục tên, chỉ mục mô tả và tập hợp thuộc tính.</p><h4 id="attribues" tabindex="-1"><a class="header-anchor" href="#attribues"><span>Attribues</span></a></h4><p>Tập hợp thuộc tính chứa thông tin cơ bản về các thuộc tính (field, method, class) được định nghĩa trong lớp hoặc interface trong tệp này.</p><p>Các thuộc tính được sử dụng để đại diện cho:</p><ul><li>Code</li><li>Local variables, constant value, information about the stack and exceptions</li><li>Inner Classes, Bootstrap Methods, Enclosing methods</li><li>Annotations</li><li>Information for debug/decompilation</li><li>Complementary information (Deprecated, Signature…)</li></ul><h3 id="cac-chi-thi-bytecode" tabindex="-1"><a class="header-anchor" href="#cac-chi-thi-bytecode"><span>Các chỉ thị bytecode</span></a></h3><p>Các chỉ thị bytecode được tạo thành từ một số nhận dạng độ dài 1 byte (gọi là mã chỉ thị, Opcode) và một hoặc nhiều tham số theo sau đại diện cho hành động cụ thể của chỉ thị đó. Vì JVM sử dụng kiến trúc dựa trên ngăn xếp toán hạng thay vì kiến trúc dựa trên thanh ghi, nên hầu hết các chỉ thị không bao gồm các toán hạng, chỉ có một mã chỉ thị.</p><p>Độ dài của mã chỉ thị JVM là 1 byte, vì vậy tập hợp mã chỉ thị có tối đa 256 chỉ thị.</p><p>Các chỉ thị bytecode chia thành khoảng 9 loại:</p><ul><li>Chỉ thị tải và lưu trữ</li><li>Chỉ thị tính toán</li><li>Chỉ thị chuyển đổi kiểu</li><li>Chỉ thị tạo và truy cập đối tượng</li><li>Chỉ thị quản lý ngăn xếp toán hạng</li><li>Chỉ thị điều khiển chuyển đổi</li><li>Chỉ thị gọi và trả về phương thức</li><li>Chỉ thị xử lý ngoại lệ</li><li>Chỉ thị đồng bộ</li></ul><h2 id="tang-cuong-bytecode" tabindex="-1"><a class="header-anchor" href="#tang-cuong-bytecode"><span>Tăng cường bytecode</span></a></h2><p>Kỹ thuật tăng cường bytecode là một loại kỹ thuật để sửa đổi hoặc tạo ra các tệp bytecode hoàn toàn mới.</p><p>Các framework tăng cường bytecode phổ biến bao gồm:</p><ul><li><a href="https://asm.ow2.io/" target="_blank" rel="noopener noreferrer">asm</a> - ASM là một thư viện mã bytecode Java nhỏ gọn và hiệu quả, được sử dụng để đọc, viết và biên dịch bytecode Java. Nó cung cấp các API cho việc tạo, sửa đổi và phân tích cú pháp bytecode Java.</li><li><a href="https://github.com/jboss-javassist/javassist" target="_blank" rel="noopener noreferrer">javassist</a> - Javassist cho phép thay đổi các lớp trong thời gian chạy bằng cách kiểm soát bytecode cơ bản. Nó cung cấp một API dễ sử dụng để tạo ra và sửa đổi bytecode Java.</li><li><a href="https://github.com/raphw/byte-buddy" target="_blank" rel="noopener noreferrer">Byte Buddy</a> - Byte Buddy là một thư viện tạo bytecode Java hiệu quả và dễ sử dụng. Nó cho phép tạo ra và sửa đổi bytecode Java trong thời gian chạy một cách linh hoạt và mạnh mẽ.</li></ul><h3 id="asm" tabindex="-1"><a class="header-anchor" href="#asm"><span>Asm</span></a></h3><p>Đối với yêu cầu thay đổi bytecode một cách thủ công, bạn có thể sử dụng Asm, nó có thể tạo ra tệp bytecode <code>.class</code> trực tiếp hoặc thay đổi hành vi của lớp trước khi nó được tải vào JVM.</p><p>Asm có hai loại API: Core API và Tree API</p><ul><li><strong>Core API</strong> - Asm Core API có thể được so sánh với cách phân tích cú pháp XML bằng cách sử dụng SAX, không cần đọc toàn bộ cấu trúc của lớp này vào bộ nhớ, bạn có thể xử lý tệp bytecode theo cách dòng chảy. Lợi ích của nó là tiết kiệm bộ nhớ rất nhiều, nhưng độ khó lập trình cao. Tuy nhiên, vì lý do hiệu suất, thường sử dụng Core API để lập trình. Trong Core API, có một số lớp quan trọng sau: <ul><li><strong><code>ClassReader</code></strong> - Đọc tệp <code>.class</code> đã được biên dịch.</li><li><strong><code>ClassWriter</code></strong> - Xây dựng lại lớp đã biên dịch, như thay đổi tên lớp, thuộc tính và phương thức, hoặc tạo tệp bytecode mới cho một lớp.</li><li>Các lớp <strong><code>Visitor</code></strong> khác - Core API xử lý bytecode từ trên xuống dưới theo thứ tự, với mỗi vùng khác nhau trong tệp bytecode, có một Visitor khác nhau, ví dụ: MethodVisitor để truy cập phương thức, FieldVisitor để truy cập biến, AnnotationVisitor để truy cập chú thích, vv. Để thực hiện AOP, cần sử dụng MethodVisitor.</li></ul></li><li><strong>Tree API</strong> - Asm Tree API có thể được so sánh với cách phân tích cú pháp XML bằng cách sử dụng DOM, nó đọc toàn bộ cấu trúc của lớp vào bộ nhớ, nhược điểm là tiêu tốn nhiều bộ nhớ hơn, nhưng lập trình đơn giản hơn. Tree API khác với Core API, Tree API ánh xạ các vùng khác nhau của bytecode thành các nút, tương tự như các nút DOM, để lập trình dễ hiểu hơn.</li></ul><h3 id="javassist" tabindex="-1"><a class="header-anchor" href="#javassist"><span>Javassist</span></a></h3><p>Khi sử dụng Javassist để thực hiện tăng cường bytecode, bạn không cần quan tâm đến cấu trúc cứng nhắc của bytecode, ưu điểm của Javassist nằm ở việc lập trình đơn giản. Bạn có thể sử dụng mã Java trực tiếp mà không cần hiểu về các chỉ thị máy ảo, để thay đổi cấu trúc của lớp hoặc tạo lớp động.</p><p>Các lớp cốt lõi của Javassist bao gồm:</p><ul><li><code>CtClass (compile-time class)</code> - Thông tin lớp tại thời gian biên dịch. Nó là một trừu tượng của tệp <code>class</code> trong mã nguồn, bạn có thể lấy một đối tượng <code>CtClass</code> bằng cách sử dụng tên đầy đủ của lớp để đại diện cho tệp lớp đó.</li><li><code>ClassPool</code> - <code>ClassPool</code> có thể được coi như một bảng băm lưu trữ thông tin <code>CtClass</code>, với khóa là tên lớp và giá trị là đối tượng <code>CtClass</code> tương ứng với tên lớp đó. Khi bạn muốn thay đổi một lớp cụ thể, bạn có thể sử dụng phương thức <code>pool.getCtClass(&quot;className&quot;)</code> để lấy <code>CtClass</code> tương ứng từ pool.</li><li><code>CtMethod</code>, <code>CtField</code> - Tương ứng với các phương thức và thuộc tính trong lớp.</li></ul><h2 id="overloading-runtime-class" tabindex="-1"><a class="header-anchor" href="#overloading-runtime-class"><span>Overloading Runtime Class</span></a></h2><h3 id="instrument" tabindex="-1"><a class="header-anchor" href="#instrument"><span>Instrument</span></a></h3><p>Instrument là một thư viện được cung cấp bởi JVM để sửa đổi các lớp đã được tải, đặc biệt hỗ trợ cho việc viết mã gắn kết cho ngôn ngữ Java. Nó phụ thuộc vào cơ chế Attach API của JVMTI để thực hiện. Trước JDK 1.6, Instrument chỉ hoạt động khi lớp được tải lên JVM khi khởi động, nhưng từ JDK 1.6 trở đi, Instrument hỗ trợ sửa đổi lớp trong quá trình chạy. Để sử dụng chức năng sửa đổi lớp của Instrument, chúng ta cần triển khai interface ClassFileTransformer và định nghĩa một trình biên dịch tệp lớp. Phương thức transform() trong interface này sẽ được gọi khi tệp lớp được tải, và trong phương thức transform, chúng ta có thể sử dụng ASM hoặc Javassist để sửa đổi hoặc thay thế bytecode được truyền vào và trả về một mảng bytecode mới.</p><h2 id="javaagent" tabindex="-1"><a class="header-anchor" href="#javaagent"><span>JavaAgent</span></a></h2><p><strong>JavaAgent là gì?</strong></p><p>JavaAgent là một tham số của lệnh java. Tham số javaagent có thể được sử dụng để chỉ định một tệp jar, nó sử dụng API Instrumentation của JVM để thay đổi bytecode của các lớp đã tải trong JVM.</p><ol><li>Tệp jar này phải chỉ định mục Premain-Class trong MANIFEST.MF.</li><li>Lớp được chỉ định bởi Premain-Class phải triển khai phương thức premain().</li></ol><p>Phương thức premain, dựa trên ý nghĩa của nó, là một lớp chạy trước khi main. Khi máy ảo Java khởi động, trước khi thực hiện main, JVM sẽ chạy phương thức premain của lớp được chỉ định trong tệp jar bằng cách sử dụng tham số -javaagent.</p><p>Trong terminal, nhập <code>java</code> để xem các tham số tương ứng, trong đó có liên quan đến java agent:</p><div class="language-shell" data-ext="shell" data-title="shell"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">-agentlib:</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">&lt;libname&gt;[=&lt;options&gt;]</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">			  Load</span><span style="color:#98C379;--shiki-dark:#98C379;"> native</span><span style="color:#98C379;--shiki-dark:#98C379;"> agent</span><span style="color:#98C379;--shiki-dark:#98C379;"> library</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> &lt;</span><span style="color:#98C379;--shiki-dark:#98C379;">libnam</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">e&gt;</span><span style="color:#98C379;--shiki-dark:#98C379;">,</span><span style="color:#98C379;--shiki-dark:#98C379;"> e.g.</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> -agentlib:hprof</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">			  See</span><span style="color:#98C379;--shiki-dark:#98C379;"> also</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> -agentlib:jdwp=help</span><span style="color:#98C379;--shiki-dark:#98C379;"> and</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> -agentlib:hprof=help</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">-agentpath:</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">&lt;pathname&gt;[=&lt;options&gt;]</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">			  Load</span><span style="color:#98C379;--shiki-dark:#98C379;"> native</span><span style="color:#98C379;--shiki-dark:#98C379;"> agent</span><span style="color:#98C379;--shiki-dark:#98C379;"> library</span><span style="color:#98C379;--shiki-dark:#98C379;"> by</span><span style="color:#98C379;--shiki-dark:#98C379;"> full</span><span style="color:#98C379;--shiki-dark:#98C379;"> pathname</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">-javaagent:</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">&lt;jarpath&gt;[=&lt;options&gt;]</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">			  Load</span><span style="color:#98C379;--shiki-dark:#98C379;"> Java</span><span style="color:#98C379;--shiki-dark:#98C379;"> programming</span><span style="color:#98C379;--shiki-dark:#98C379;"> language</span><span style="color:#98C379;--shiki-dark:#98C379;"> agent,</span><span style="color:#98C379;--shiki-dark:#98C379;"> see</span><span style="color:#98C379;--shiki-dark:#98C379;"> java.lang.instrument</span></span></code></pre></div><h3 id="gioi-thieu-ve-java-agent" tabindex="-1"><a class="header-anchor" href="#gioi-thieu-ve-java-agent"><span>Giới thiệu về Java Agent</span></a></h3><p>Java Agent, còn được gọi là Java Proxy được giới thiệu từ JDK1.5, đây là một công nghệ cho phép chỉnh sửa bytecode của Java một cách linh hoạt. Trong Java, các lớp được biên dịch thành bytecode và được thực thi bởi JVM. Trước khi JVM thực thi bytecode này, Java Agent có thể lấy thông tin về mã bytecode này và sử dụng trình biên dịch bytecode để thay đổi nó, từ đó thực hiện các chức năng bổ sung.</p><p>Java Agent không thể chạy riêng lẻ như một tệp jar, mà nó hoạt động bằng cách gắn kết vào quá trình JVM của chương trình mục tiêu. Khi khởi động, chỉ cần thêm tùy chọn -javaagent và ClassFileTransformer (trình biên dịch bytecode) vào các thông số khởi động của chương trình mục tiêu, tương tự như việc gắn kết interceptor trước phương thức main.</p><h3 id="chuc-nang-cua-java-agent" tabindex="-1"><a class="header-anchor" href="#chuc-nang-cua-java-agent"><span>Chức năng của Java Agent</span></a></h3><p>Java Agent chủ yếu có các chức năng sau:</p><ul><li>Java Agent có thể chặn và sửa đổi mã bytecode trước khi nó được tải vào JVM.</li><li>Java Agent có thể sửa đổi mã bytecode đã được tải vào JVM trong quá trình chạy.</li></ul><p>Java Agent được sử dụng trong các trường hợp sau:</p><ul><li>Các tính năng gỡ lỗi của các IDE như Eclipse, IntelliJ IDEA.</li><li>Tính năng triển khai nóng (hot deployment) như JRebel, XRebel, spring-loaded, …</li><li>Các công cụ chẩn đoán trực tuyến như Btrace, Greys, Arthas của Alibaba, …</li><li>Các công cụ phân tích hiệu suất như Visual VM, JConsole, …</li><li>Các công cụ kiểm tra hiệu suất toàn bộ hệ thống như Skywalking, Pinpoint, …</li></ul><h3 id="nguyen-ly-hoat-đong-cua-java-agent" tabindex="-1"><a class="header-anchor" href="#nguyen-ly-hoat-đong-cua-java-agent"><span>Nguyên lý hoạt động của Java Agent</span></a></h3><p>Trước khi hiểu nguyên lý hoạt động của Java Agent, cần có một hiểu biết rõ về cơ chế tải lớp trong Java. Java Agent có hai cách thực hiện: một là thông qua premain trước khi phương thức main được thực thi, hai là thông qua JVM Attach trong quá trình chạy, dựa trên JVMTI.</p><p>Chủ yếu là chặn trước quá trình tải lớp và sửa đổi mã bytecode.</p><p>Dưới đây, chúng ta sẽ giới thiệu các thuật ngữ quan trọng:</p><ul><li><p><strong>JVMTI</strong> (JVM Tool Interface) là một tập hợp các interface mà JVM cung cấp cho người dùng mở rộng. JVMTI hoạt động dựa trên sự kiện, mỗi khi JVM thực hiện một số logic, nó sẽ kích hoạt các interface gọi lại tương ứng, người dùng có thể mở rộng thông qua các interface gọi lại này.</p><p>JVMTI là nền tảng chung để triển khai các công cụ như Debugger, Profiler, Monitor, Thread Analyser,… và được hỗ trợ trên hầu hết các máy ảo Java phổ biến.</p></li><li><p><strong>JVMTIAgent</strong> là một thư viện động, sử dụng các interface mà JVMTI cung cấp để thực hiện các tác vụ mà thông thường không thể thực hiện. Thông thường, nó triển khai một hoặc nhiều hàm sau:</p><ul><li>Hàm Agent_OnLoad: được gọi khi agent được tải vào trong quá trình khởi động.</li><li>Hàm Agent_OnAttach: được gọi khi agent được tải vào trong quá trình chạy thông qua JVM Attach.</li><li>Hàm Agent_OnUnload: được gọi khi agent bị gỡ bỏ.</li></ul></li><li><p><strong>javaagent</strong> phụ thuộc vào JVMTIAgent của instrument (trên Linux, thư viện động tương ứng là <a href="http://libinstrument.so" target="_blank" rel="noopener noreferrer">libinstrument.so</a>), còn được gọi là JPLISAgent (Java Programming Language Instrumentation Services Agent), hỗ trợ việc gắn kết cho các dịch vụ gắn kết ngôn ngữ Java.</p></li><li><p><strong>instrument</strong> triển khai các phương thức Agent_OnLoad và Agent_OnAttach, có nghĩa là agent có thể được tải vào trong quá trình khởi động hoặc được tải vào trong quá trình chạy. Trong quá trình khởi động, agent có thể được tải vào gián tiếp thông qua cách như -javaagent: đường dẫn tới file jar. Trong quá trình chạy, việc tải động phụ thuộc vào cơ chế attach của JVM, thông qua việc gửi lệnh load để tải agent.</p></li><li><p><strong>JVM Attach</strong> là một tính năng của JVM cho phép giao tiếp giữa các tiến trình, cho phép một tiến trình gửi lệnh cho tiến trình khác và thực hiện một số hoạt động nội bộ, ví dụ như thực hiện thread dump, cần thực hiện jstack và truyền các tham số như pid cho luồng cần dump.</p></li></ul><h3 id="vi-du-ve-java-agent" tabindex="-1"><a class="header-anchor" href="#vi-du-ve-java-agent"><span>Ví dụ về Java Agent</span></a></h3><h4 id="chan-truoc-qua-trinh-tai-lop-java" tabindex="-1"><a class="header-anchor" href="#chan-truoc-qua-trinh-tai-lop-java"><span>Chặn trước quá trình tải lớp Java</span></a></h4><h5 id="du-an-app" tabindex="-1"><a class="header-anchor" href="#du-an-app"><span>Dự án App</span></a></h5><p>(1) Tạo một dự án Maven có tên <code>javacore-javaagent-app</code></p><div class="language-xml line-numbers-mode" data-ext="xml" data-title="xml"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">&lt;?</span><span style="color:#E06C75;--shiki-dark:#E06C75;">xml</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> version</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;1.0&quot;</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> encoding</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;UTF-8&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">?&gt;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">&lt;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">project</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> xmlns</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">         xmlns:xsi</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">         xsi:schemaLocation</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    &lt;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">modelVersion</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">&gt;4.0.0&lt;/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">modelVersion</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    &lt;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">groupId</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">&gt;com.hnv99&lt;/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">groupId</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    &lt;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">artifactId</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">&gt;javacore-javaagent-app&lt;/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">artifactId</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    &lt;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">version</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">&gt;1.0-SNAPSHOT&lt;/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">version</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    &lt;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">properties</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        &lt;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">maven.compiler.source</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">&gt;8&lt;/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">maven.compiler.source</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        &lt;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">maven.compiler.target</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">&gt;8&lt;/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">maven.compiler.target</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        &lt;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">project.build.sourceEncoding</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">&gt;UTF-8&lt;/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">project.build.sourceEncoding</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    &lt;/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">properties</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">&lt;/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">project</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">&gt;</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>(2) Tạo một lớp khởi chạy ứng dụng</p><div class="language-java" data-ext="java" data-title="java"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">public</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> class</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;"> AppMain</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    public</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> static</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> void</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;"> main</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">String</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">[] </span><span style="color:#E06C75;--shiki-dark:#E06C75;font-style:italic;--shiki-dark-font-style:italic;">args</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#E5C07B;--shiki-dark:#E5C07B;">        System</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">out</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">println</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;Khởi động ứng dụng!!!&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#E5C07B;--shiki-dark:#E5C07B;">        AppInit</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">init</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">}</span></span></code></pre></div><p>(3) Tạo một lớp mô phỏng quá trình khởi tạo ứng dụng</p><div class="language-java" data-ext="java" data-title="java"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">public</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> class</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;"> AppInit</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    public</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> static</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> void</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;"> init</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">()</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        try</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#E5C07B;--shiki-dark:#E5C07B;">            System</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">out</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">println</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;Đang khởi tạo ứng dụng...&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#E5C07B;--shiki-dark:#E5C07B;">            Thread</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">sleep</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1000</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        } </span><span style="color:#C678DD;--shiki-dark:#C678DD;">catch</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">InterruptedException</span><span style="color:#E06C75;--shiki-dark:#E06C75;font-style:italic;--shiki-dark-font-style:italic;"> e</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#E5C07B;--shiki-dark:#E5C07B;">            e</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">printStackTrace</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">}</span></span></code></pre></div><p>(4) Kết quả đầu ra</p><div class="language-" data-ext="" data-title=""><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span>Khởi động ứng dụng!!!</span></span>
<span class="line"><span>Đang khởi tạo ứng dụng...</span></span></code></pre></div><h5 id="du-an-agent" tabindex="-1"><a class="header-anchor" href="#du-an-agent"><span>Dự án Agent</span></a></h5><p>(1) Tạo một dự án Maven có tên <code>javacore-javaagent-agent</code></p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&lt;</span><span style="color:#C678DD;--shiki-dark:#C678DD;">?</span><span style="color:#E06C75;--shiki-dark:#E06C75;">xml version</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;1.0&quot;</span><span style="color:#E06C75;--shiki-dark:#E06C75;"> encoding</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;UTF-8&quot;</span><span style="color:#C678DD;--shiki-dark:#C678DD;">?</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&lt;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">project xmlns</span><span style="color:#C678DD;--shiki-dark:#C678DD;">:</span><span style="color:#E06C75;--shiki-dark:#E06C75;">xsi</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><span style="color:#E06C75;--shiki-dark:#E06C75;"> xmlns</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">  xsi</span><span style="color:#C678DD;--shiki-dark:#C678DD;">:</span><span style="color:#E06C75;--shiki-dark:#E06C75;">schemaLocation</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">  &lt;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">modelVersion</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#D19A66;--shiki-dark:#D19A66;">4.0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#FFFFFF;--shiki-dark:#FFFFFF;">0</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&lt;/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">modelVersion</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">  &lt;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">groupId</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">io</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">github</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">dunwu</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">javacore</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&lt;/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">groupId</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">  &lt;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">artifactId</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">javacore</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">-</span><span style="color:#E06C75;--shiki-dark:#E06C75;">javaagent</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">-</span><span style="color:#E06C75;--shiki-dark:#E06C75;">agent</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&lt;/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">artifactId</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">  &lt;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">version</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1.0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#FFFFFF;--shiki-dark:#FFFFFF;">1</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&lt;/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">version</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">  &lt;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">name</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">JavaCore </span><span style="color:#C678DD;--shiki-dark:#C678DD;">::</span><span style="color:#E06C75;--shiki-dark:#E06C75;"> JavaAgent </span><span style="color:#C678DD;--shiki-dark:#C678DD;">::</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;"> Agent</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&lt;/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">name</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">  &lt;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">properties</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    &lt;</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">project</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">build</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">sourceEncoding</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">UTF</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">-</span><span style="color:#D19A66;--shiki-dark:#D19A66;">8</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&lt;/</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">project</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">build</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">sourceEncoding</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    &lt;</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">java</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">version</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1.8</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&lt;/</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">java</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">version</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    &lt;</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">maven</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">compiler</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">source</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">\${</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">java</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">version</span><span style="color:#E06C75;--shiki-dark:#E06C75;">}</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&lt;/</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">maven</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">compiler</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">source</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    &lt;</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">maven</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">compiler</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">target</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">\${</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">java</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">version</span><span style="color:#E06C75;--shiki-dark:#E06C75;">}</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&lt;/</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">maven</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">compiler</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">target</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">  &lt;/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">properties</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">  &lt;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">dependencies</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    &lt;!</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">--</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">Gói</span><span style="color:#E06C75;--shiki-dark:#E06C75;"> công cụ javaagent</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">--</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    &lt;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">dependency</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">      &lt;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">groupId</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">org</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">javassist</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&lt;/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">groupId</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">      &lt;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">artifactId</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">javassist</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&lt;/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">artifactId</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">      &lt;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">version</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#D19A66;--shiki-dark:#D19A66;">3.26</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#FFFFFF;--shiki-dark:#FFFFFF;">0</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">-</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">GA</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&lt;/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">version</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    &lt;/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">dependency</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">  &lt;/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">dependencies</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">  &lt;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">build</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    &lt;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">plugins</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">      &lt;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">plugin</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        &lt;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">groupId</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">org</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">apache</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">maven</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">plugins</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&lt;/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">groupId</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        &lt;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">artifactId</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">maven</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">-</span><span style="color:#E06C75;--shiki-dark:#E06C75;">compiler</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">-</span><span style="color:#E06C75;--shiki-dark:#E06C75;">plugin</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&lt;/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">artifactId</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        &lt;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">version</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#D19A66;--shiki-dark:#D19A66;">3.5</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#FFFFFF;--shiki-dark:#FFFFFF;">1</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&lt;/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">version</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        &lt;!</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">--</span><span style="color:#E06C75;--shiki-dark:#E06C75;">Chỉ định phiên bản jdk cho việc biên dịch </span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">maven</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;"> Nếu</span><span style="color:#E06C75;--shiki-dark:#E06C75;"> không chỉ định</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span><span style="color:#E06C75;--shiki-dark:#E06C75;"> maven3 mặc định sử dụng jdk </span><span style="color:#D19A66;--shiki-dark:#D19A66;">1.5</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span><span style="color:#E06C75;--shiki-dark:#E06C75;"> maven2 mặc định sử dụng jdk </span><span style="color:#D19A66;--shiki-dark:#D19A66;">1.3</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">--</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        &lt;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">configuration</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">          &lt;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">source</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#D19A66;--shiki-dark:#D19A66;">8</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&lt;/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">source</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">          &lt;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">target</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#D19A66;--shiki-dark:#D19A66;">8</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&lt;/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">target</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        &lt;/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">configuration</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">      &lt;/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">plugin</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">      &lt;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">plugin</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        &lt;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">groupId</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">org</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">apache</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">maven</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">plugins</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&lt;/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">groupId</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        &lt;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">artifactId</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">maven</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">-</span><span style="color:#E06C75;--shiki-dark:#E06C75;">jar</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">-</span><span style="color:#E06C75;--shiki-dark:#E06C75;">plugin</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&lt;/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">artifactId</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        &lt;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">version</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#D19A66;--shiki-dark:#D19A66;">3.2</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#FFFFFF;--shiki-dark:#FFFFFF;">0</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&lt;/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">version</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        &lt;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">configuration</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">          &lt;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">archive</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">            &lt;!</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">--</span><span style="color:#E06C75;--shiki-dark:#E06C75;">Tự động thêm META</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">-</span><span style="color:#E06C75;--shiki-dark:#E06C75;">INF</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">/</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">MANIFEST</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">MF</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> --</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">            &lt;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">manifest</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">              &lt;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">addClasspath</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#D19A66;--shiki-dark:#D19A66;">true</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&lt;/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">addClasspath</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">            &lt;/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">manifest</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">            &lt;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">manifestEntries</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">              &lt;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">Menifest</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">-</span><span style="color:#E06C75;--shiki-dark:#E06C75;">Version</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#D19A66;--shiki-dark:#D19A66;">1.0</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&lt;/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">Menifest</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">-</span><span style="color:#E06C75;--shiki-dark:#E06C75;">Version</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">              &lt;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">Premain</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">-</span><span style="color:#E06C75;--shiki-dark:#E06C75;">Class</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">io</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">github</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">dunwu</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">javacore</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">javaagent</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">RunTimeAgent</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&lt;/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">Premain</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">-</span><span style="color:#E06C75;--shiki-dark:#E06C75;">Class</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">              &lt;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">Can</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">-</span><span style="color:#E06C75;--shiki-dark:#E06C75;">Redefine</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">-</span><span style="color:#E06C75;--shiki-dark:#E06C75;">Classes</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#D19A66;--shiki-dark:#D19A66;">true</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&lt;/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">Can</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">-</span><span style="color:#E06C75;--shiki-dark:#E06C75;">Redefine</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">-</span><span style="color:#E06C75;--shiki-dark:#E06C75;">Classes</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">              &lt;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">Can</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">-</span><span style="color:#E06C75;--shiki-dark:#E06C75;">Retransform</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">-</span><span style="color:#E06C75;--shiki-dark:#E06C75;">Classes</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#D19A66;--shiki-dark:#D19A66;">true</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&lt;/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">Can</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">-</span><span style="color:#E06C75;--shiki-dark:#E06C75;">Retransform</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">-</span><span style="color:#E06C75;--shiki-dark:#E06C75;">Classes</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">            &lt;/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">manifestEntries</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">          &lt;/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">archive</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">        &lt;/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">configuration</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">      &lt;/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">plugin</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">    &lt;/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">plugins</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">  &lt;/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">build</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span></span>
<span class="line"><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&lt;/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">project</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">&gt;</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>(2) Tạo một lớp khởi chạy Agent</p><div class="language-java" data-ext="java" data-title="java"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">public</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> class</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;"> RunTimeAgent</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    public</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> static</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> void</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;"> premain</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">String</span><span style="color:#E06C75;--shiki-dark:#E06C75;font-style:italic;--shiki-dark-font-style:italic;"> arg</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">, </span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">Instrumentation</span><span style="color:#E06C75;--shiki-dark:#E06C75;font-style:italic;--shiki-dark-font-style:italic;"> instrumentation</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#E5C07B;--shiki-dark:#E5C07B;">        System</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">out</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">println</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;Khởi động chương trình chặn trước quá trình tải lớp!!!&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#E5C07B;--shiki-dark:#E5C07B;">        System</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">out</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">println</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;Tham số truyền vào của chương trình chặn trước quá trình tải lớp: &quot;</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> +</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> arg);</span></span>
<span class="line"><span style="color:#E5C07B;--shiki-dark:#E5C07B;">        instrumentation</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">addTransformer</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">new</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;"> RunTimeTransformer</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">}</span></span></code></pre></div><p>Ở đây, mỗi lần tải lớp, chúng ta sẽ đi qua phương thức này, chúng ta có thể chỉ định lớp cần chặn bằng cách sử dụng className, sau đó sử dụng công cụ javassist để xử lý lớp. Ý tưởng ở đây tương tự như reflection, nhưng mạnh mẽ hơn về khả năng sửa đổi bytecode.</p><p>(3) Sử dụng javassist để chặn lớp chỉ định và tăng cường mã</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">package</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> com.hnv99.javacore.javaagent</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">import</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;"> javassist.ClassPool</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">import</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;"> javassist.CtClass</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">import</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;"> javassist.CtMethod</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">import</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;"> java.lang.instrument.ClassFileTransformer</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">import</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;"> java.lang.instrument.IllegalClassFormatException</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">import</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;"> java.security.ProtectionDomain</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">public</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> class</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;"> RunTimeTransformer</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> implements</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;"> ClassFileTransformer</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    private</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> static</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> final</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;"> String</span><span style="color:#E06C75;--shiki-dark:#E06C75;"> INJECTED_CLASS </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;"> &quot;com.hnv99.javacore.javaagent.AppInit&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    @</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">Override</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    public</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> byte</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">[] transform</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">ClassLoader</span><span style="color:#E06C75;--shiki-dark:#E06C75;font-style:italic;--shiki-dark-font-style:italic;"> loader</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">, </span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">String</span><span style="color:#E06C75;--shiki-dark:#E06C75;font-style:italic;--shiki-dark-font-style:italic;"> className</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">, </span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">Class</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">&lt;</span><span style="color:#C678DD;--shiki-dark:#C678DD;">?</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">&gt; </span><span style="color:#E06C75;--shiki-dark:#E06C75;font-style:italic;--shiki-dark-font-style:italic;">classBeingRedefined</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E5C07B;--shiki-dark:#E5C07B;">                            ProtectionDomain</span><span style="color:#E06C75;--shiki-dark:#E06C75;font-style:italic;--shiki-dark-font-style:italic;"> protectionDomain</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">, </span><span style="color:#C678DD;--shiki-dark:#C678DD;">byte</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">[] </span><span style="color:#E06C75;--shiki-dark:#E06C75;font-style:italic;--shiki-dark-font-style:italic;">classfileBuffer</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> throws</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;"> IllegalClassFormatException</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#E5C07B;--shiki-dark:#E5C07B;">        String</span><span style="color:#E06C75;--shiki-dark:#E06C75;"> realClassName</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;"> className</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">replace</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;/&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">, </span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;.&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">realClassName</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">equals</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(INJECTED_CLASS)) {</span></span>
<span class="line"><span style="color:#E5C07B;--shiki-dark:#E5C07B;">            System</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">out</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">println</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;Lớp bị chặn: &quot;</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> +</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> realClassName);</span></span>
<span class="line"><span style="color:#E5C07B;--shiki-dark:#E5C07B;">            CtClass</span><span style="color:#E06C75;--shiki-dark:#E06C75;"> ctClass</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">            try</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#7F848E;--shiki-dark:#7F848E;font-style:italic;--shiki-dark-font-style:italic;">                // Sử dụng javassist để lấy lớp bytecode</span></span>
<span class="line"><span style="color:#E5C07B;--shiki-dark:#E5C07B;">                ClassPool</span><span style="color:#E06C75;--shiki-dark:#E06C75;"> classPool</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;"> ClassPool</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">getDefault</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">                ctClass </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;"> classPool</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">get</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(realClassName);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;--shiki-dark:#7F848E;font-style:italic;--shiki-dark-font-style:italic;">                // Lấy tất cả các phương thức của lớp và tăng cường mã</span></span>
<span class="line"><span style="color:#E5C07B;--shiki-dark:#E5C07B;">                CtMethod</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">[] </span><span style="color:#E06C75;--shiki-dark:#E06C75;">declaredMethods</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;"> ctClass</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">getDeclaredMethods</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">                for</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">CtMethod</span><span style="color:#E06C75;--shiki-dark:#E06C75;"> method</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> :</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> declaredMethods) {</span></span>
<span class="line"><span style="color:#E5C07B;--shiki-dark:#E5C07B;">                    System</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">out</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">println</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;Phương thức bị chặn: &quot;</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> +</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;"> method</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">getName</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#E5C07B;--shiki-dark:#E5C07B;">                    method</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">addLocalVariable</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;time&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">, </span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">CtClass</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">longType</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#E5C07B;--shiki-dark:#E5C07B;">                    method</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">insertBefore</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;System.out.println(</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">\\&quot;</span><span style="color:#98C379;--shiki-dark:#98C379;">---Bắt đầu thực thi---</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">\\&quot;</span><span style="color:#98C379;--shiki-dark:#98C379;">);&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#E5C07B;--shiki-dark:#E5C07B;">                    method</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">insertBefore</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;time = System.currentTimeMillis();&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#E5C07B;--shiki-dark:#E5C07B;">                    method</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">insertAfter</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;System.out.println(</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">\\&quot;</span><span style="color:#98C379;--shiki-dark:#98C379;">---Kết thúc thực thi---</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">\\&quot;</span><span style="color:#98C379;--shiki-dark:#98C379;">);&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#E5C07B;--shiki-dark:#E5C07B;">                    method</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">insertAfter</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;System.out.println(</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">\\&quot;</span><span style="color:#98C379;--shiki-dark:#98C379;">Thời gian chạy: </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">\\&quot;</span><span style="color:#98C379;--shiki-dark:#98C379;"> + (System.currentTimeMillis() - time));&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">                }</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">                return</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;"> ctClass</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">toBytecode</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">            } </span><span style="color:#C678DD;--shiki-dark:#C678DD;">catch</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">Throwable</span><span style="color:#E06C75;--shiki-dark:#E06C75;font-style:italic;--shiki-dark-font-style:italic;"> e</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) { </span><span style="color:#7F848E;--shiki-dark:#7F848E;font-style:italic;--shiki-dark-font-style:italic;">// Ở đây phải sử dụng Throwable, không sử dụng Exception</span></span>
<span class="line"><span style="color:#E5C07B;--shiki-dark:#E5C07B;">                System</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">out</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">println</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">e</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">getMessage</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#E5C07B;--shiki-dark:#E5C07B;">                e</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">printStackTrace</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">            }</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        return</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> classfileBuffer;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>(4) Kết quả đầu ra</p><p>Chỉ định tham số VM <code>-javaagent:/Users/kirito4499/Desktop/Learn/Java/javacore-javaagent-agent/target/javacore-javaagent-agent-1.0-SNAPSHOT.jar=hello</code>, chạy AppMain</p><div class="language-" data-ext="" data-title=""><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span>Khởi động chương trình chặn trước quá trình tải lớp!!!</span></span>
<span class="line"><span>Tham số truyền vào của chương trình chặn trước quá trình tải lớp: hello</span></span>
<span class="line"><span>Khởi động ứng dụng!!!</span></span>
<span class="line"><span>Lớp bị chặn: io.github.dunwu.javacore.javaagent.AppInit</span></span>
<span class="line"><span>Phương thức bị chặn: init</span></span>
<span class="line"><span>---Bắt đầu thực thi---</span></span>
<span class="line"><span>Đang khởi tạo ứng dụng...</span></span>
<span class="line"><span>---Kết thúc thực thi---</span></span>
<span class="line"><span>Thời gian chạy: 1014</span></span></code></pre></div><h4 id="chan-trong-qua-trinh-chay-jdk-1-6-tro-len" tabindex="-1"><a class="header-anchor" href="#chan-trong-qua-trinh-chay-jdk-1-6-tro-len"><span>Chặn trong quá trình chạy (JDK 1.6 trở lên)</span></a></h4><p>Làm thế nào để thực hiện sửa đổi bytecode động trong quá trình chạy chương trình?</p><p>Để thực hiện sửa đổi bytecode động, chúng ta cần phụ thuộc vào công cụ JVM mà JDK cung cấp cho chúng ta, đó là Attach, thông qua nó để tải chương trình đại diện của chúng ta.</p><p>Trước tiên, chúng ta cần định nghĩa một phương thức có tên là agentmain trong chương trình đại diện của chúng ta, nó có thể giống với premain mà chúng ta đã đề cập ở trên, hoặc có thể phát triển theo logic của riêng mình dựa trên tính năng của agentmain.</p><div class="language-java" data-ext="java" data-title="java"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;--shiki-dark:#7F848E;font-style:italic;--shiki-dark-font-style:italic;">/**</span></span>
<span class="line"><span style="color:#7F848E;--shiki-dark:#7F848E;font-style:italic;--shiki-dark-font-style:italic;"> * agentmain được khởi chạy sau khi main bắt đầu chạy (phụ thuộc vào cơ chế Attach)</span></span>
<span class="line"><span style="color:#7F848E;--shiki-dark:#7F848E;font-style:italic;--shiki-dark-font-style:italic;"> */</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">public</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> class</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;"> RunTimeAgent</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    public</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> static</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> void</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;"> agentmain</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">String</span><span style="color:#E06C75;--shiki-dark:#E06C75;font-style:italic;--shiki-dark-font-style:italic;"> arg</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">, </span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">Instrumentation</span><span style="color:#E06C75;--shiki-dark:#E06C75;font-style:italic;--shiki-dark-font-style:italic;"> instrumentation</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#E5C07B;--shiki-dark:#E5C07B;">        System</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">out</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">println</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;Khởi động chương trình chặn trong quá trình chạy!!!&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#E5C07B;--shiki-dark:#E5C07B;">        System</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">out</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">println</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;Tham số truyền vào của chương trình chặn trong quá trình chạy: &quot;</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> +</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> arg);</span></span>
<span class="line"><span style="color:#E5C07B;--shiki-dark:#E5C07B;">        instrumentation</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">addTransformer</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#C678DD;--shiki-dark:#C678DD;">new</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;"> RunTimeTransformer</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">}</span></span></code></pre></div><p>Tiếp theo, chúng ta cần cấu hình để cho nó biết rằng chương trình đại diện của chúng ta cần được tải, trong Maven, chúng ta có thể cấu hình như sau, tương tự với tệp META-INF/MANIFEST.MF.</p><div class="language-xml" data-ext="xml" data-title="xml"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;--shiki-dark:#7F848E;font-style:italic;--shiki-dark-font-style:italic;">&lt;!--&lt;Premain-Class&gt;com.zhj.agent.agentmain.RunTimeAgent&lt;/Premain-Class&gt;--&gt;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">&lt;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">Agent-Class</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">&gt;com.zhj.agent.agentmain.RunTimeAgent&lt;/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">Agent-Class</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">&gt;</span></span></code></pre></div><p>Thực tế, chúng ta đã hoàn thành việc cải tiến chương trình đại diện của chúng ta. Sau đó, chúng ta cần chèn một số mã vào phương thức main của chương trình mục tiêu để nó có thể đọc chương trình đại diện của chúng ta, từ đó chúng ta không cần cấu hình tham số JVM mà vẫn có thể tải chương trình đại diện.</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">public</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> class</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;"> APPMain</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    public</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> static</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> void</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;"> main</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">String</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">[] </span><span style="color:#E06C75;--shiki-dark:#E06C75;font-style:italic;--shiki-dark-font-style:italic;">args</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#E5C07B;--shiki-dark:#E5C07B;">        System</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">out</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">println</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;Khởi động ứng dụng!!!&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">        for</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">VirtualMachineDescriptor</span><span style="color:#E06C75;--shiki-dark:#E06C75;"> vmd</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> :</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;"> VirtualMachine</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">list</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">()) {</span></span>
<span class="line"><span style="color:#7F848E;--shiki-dark:#7F848E;font-style:italic;--shiki-dark-font-style:italic;">            // Chỉ tải chương trình đại diện cho VM đã chỉ định</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">            if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span><span style="color:#D19A66;--shiki-dark:#D19A66;">true</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#E5C07B;--shiki-dark:#E5C07B;">                System</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">out</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">println</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;VM này là VM đại diện đã chỉ định&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#E5C07B;--shiki-dark:#E5C07B;">                System</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">out</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">println</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">vmd</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">displayName</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">                try</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#E5C07B;--shiki-dark:#E5C07B;">                    VirtualMachine</span><span style="color:#E06C75;--shiki-dark:#E06C75;"> vm</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;"> VirtualMachine</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">attach</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">vmd</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#E5C07B;--shiki-dark:#E5C07B;">                    vm</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">loadAgent</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;D:/Code/java/idea_project/agent-test/runtime-agent/target/runtime-agent-1.0-SNAPSHOT.jar=hello&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#E5C07B;--shiki-dark:#E5C07B;">                    vm</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">detach</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">                } </span><span style="color:#C678DD;--shiki-dark:#C678DD;">catch</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">Exception</span><span style="color:#E06C75;--shiki-dark:#E06C75;font-style:italic;--shiki-dark-font-style:italic;"> e</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#E5C07B;--shiki-dark:#E5C07B;">                    e</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">printStackTrace</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">                }</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">            }</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="color:#E5C07B;--shiki-dark:#E5C07B;">        AppInit</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">init</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Ở đây, VirtualMachine là một lớp trong gói công cụ JDK, nếu biến môi trường hệ thống không được cấu hình, bạn cần tự đưa nó vào Maven.</p><div class="language-xml" data-ext="xml" data-title="xml"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">&lt;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">dependency</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    &lt;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">groupId</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">&gt;com.sun&lt;/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">groupId</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    &lt;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">artifactId</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">&gt;tools&lt;/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">artifactId</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    &lt;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">version</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">&gt;1.8&lt;/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">version</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    &lt;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">scope</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">&gt;system&lt;/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">scope</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">	&lt;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">systemPath</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">&gt;/Library/Java/JavaVirtualMachines/adoptopenjdk-8.jdk/Contents/Home/lib/tools.jar&lt;/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">systemPath</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">&lt;/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">dependency</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">&gt;</span></span></code></pre></div><p>Như vậy, chúng ta đã hoàn thành một ví dụ đơn giản về việc sửa đổi bytecode động trong quá trình chạy chương trình.</p><h2 id="cong-cu-bytecode" tabindex="-1"><a class="header-anchor" href="#cong-cu-bytecode"><span>Công cụ bytecode</span></a></h2><ul><li><a href="https://plugins.jetbrains.com/plugin/9248-jclasslib-bytecode-viewer" target="_blank" rel="noopener noreferrer">jclasslib</a> - Plugin cho IDEA, cho phép xem thông tin lớp, hằng số, vùng phương thức và các thông tin khác của bytecode hiện tại.</li><li><a href="https://github.com/zxh0/classpy" target="_blank" rel="noopener noreferrer">classpy</a> - Classpy là một công cụ GUI để nghiên cứu các tệp lớp Java, khối nhị phân Lua, mã nhị phân Wasm và các định dạng tệp nhị phân khác.</li><li><a href="https://plugins.jetbrains.com/plugin/5918-asm-bytecode-outline" target="_blank" rel="noopener noreferrer">ASM ByteCode Outline</a> - Khi viết bytecode bằng tay với ASM, bạn cần sử dụng một loạt các phương thức visitXXXXInsn() để viết các hướng dẫn tương ứng. Vì vậy, bạn cần chuyển mỗi dòng mã nguồn thành một hướng dẫn, sau đó chuyển đổi cú pháp ASM thành visitXXXXInsn(). Điều đầu tiên là chuyển mã nguồn thành hướng dẫn đã đủ phức tạp, nếu bạn không quen với tập hợp hướng dẫn bytecode, bạn cần biên dịch mã nguồn và sau đó giải mã để có được các hướng dẫn tương ứng. Thứ hai là cách truyền tham số khi viết bytecode bằng ASM cũng là một vấn đề khó khăn. Cộng đồng ASM cũng nhận thức được hai vấn đề này, vì vậy họ cung cấp công cụ này.</li></ul>`,123),p=[t];function r(e,o){return a(),n("div",null,p)}const k=s(l,[["render",r],["__file","Java Bytecode.html.vue"]]),B=JSON.parse('{"path":"/programming/java/JVM/Java%20Bytecode.html","title":"Java Bytecode","lang":"en-US","frontmatter":{"title":"Java Bytecode","tags":["java","javase","jvm","bytecode","javaagent","asm","javassist"],"categories":["java","javase","jvm"],"date created":"2023-07-19T00:00:00.000Z","date modified":"2023-07-19T00:00:00.000Z","description":"Java Bytecode Giới thiệu về Bytecode Bytecode là gì? Java bytecode là một định dạng lệnh mà máy ảo Java (JVM) thực thi. Java bytecode được gọi là \\"bytecode\\" vì: Tệp Java bytecod...","head":[["meta",{"property":"og:url","content":"https://vanhung4499.github.io/programming/java/JVM/Java%20Bytecode.html"}],["meta",{"property":"og:site_name","content":"VanHung4499"}],["meta",{"property":"og:title","content":"Java Bytecode"}],["meta",{"property":"og:description","content":"Java Bytecode Giới thiệu về Bytecode Bytecode là gì? Java bytecode là một định dạng lệnh mà máy ảo Java (JVM) thực thi. Java bytecode được gọi là \\"bytecode\\" vì: Tệp Java bytecod..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"https://raw.githubusercontent.com/vanhung4499/images/master/snap/20230719115010.png"}],["meta",{"property":"og:locale","content":"en-US"}],["meta",{"property":"og:updated_time","content":"2024-07-04T09:37:15.000Z"}],["meta",{"property":"article:author","content":"Hung Nguyen"}],["meta",{"property":"article:tag","content":"java"}],["meta",{"property":"article:tag","content":"javase"}],["meta",{"property":"article:tag","content":"jvm"}],["meta",{"property":"article:tag","content":"bytecode"}],["meta",{"property":"article:tag","content":"javaagent"}],["meta",{"property":"article:tag","content":"asm"}],["meta",{"property":"article:tag","content":"javassist"}],["meta",{"property":"article:modified_time","content":"2024-07-04T09:37:15.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Java Bytecode\\",\\"image\\":[\\"https://raw.githubusercontent.com/vanhung4499/images/master/snap/20230719115010.png\\",\\"https://raw.githubusercontent.com/vanhung4499/images/master/snap/20230719120335.png\\"],\\"dateModified\\":\\"2024-07-04T09:37:15.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"Hung Nguyen\\",\\"url\\":\\"https://vanhung4499.github.io\\"}]}"]]},"headers":[{"level":2,"title":"Giới thiệu về Bytecode","slug":"gioi-thieu-ve-bytecode","link":"#gioi-thieu-ve-bytecode","children":[{"level":3,"title":"Bytecode là gì?","slug":"bytecode-la-gi","link":"#bytecode-la-gi","children":[]},{"level":3,"title":"Giải mã bytecode","slug":"giai-ma-bytecode","link":"#giai-ma-bytecode","children":[]},{"level":3,"title":"Cấu trúc tệp bytecode","slug":"cau-truc-tep-bytecode","link":"#cau-truc-tep-bytecode","children":[]},{"level":3,"title":"Các chỉ thị bytecode","slug":"cac-chi-thi-bytecode","link":"#cac-chi-thi-bytecode","children":[]}]},{"level":2,"title":"Tăng cường bytecode","slug":"tang-cuong-bytecode","link":"#tang-cuong-bytecode","children":[{"level":3,"title":"Asm","slug":"asm","link":"#asm","children":[]},{"level":3,"title":"Javassist","slug":"javassist","link":"#javassist","children":[]}]},{"level":2,"title":"Overloading Runtime Class","slug":"overloading-runtime-class","link":"#overloading-runtime-class","children":[{"level":3,"title":"Instrument","slug":"instrument","link":"#instrument","children":[]}]},{"level":2,"title":"JavaAgent","slug":"javaagent","link":"#javaagent","children":[{"level":3,"title":"Giới thiệu về Java Agent","slug":"gioi-thieu-ve-java-agent","link":"#gioi-thieu-ve-java-agent","children":[]},{"level":3,"title":"Chức năng của Java Agent","slug":"chuc-nang-cua-java-agent","link":"#chuc-nang-cua-java-agent","children":[]},{"level":3,"title":"Nguyên lý hoạt động của Java Agent","slug":"nguyen-ly-hoat-đong-cua-java-agent","link":"#nguyen-ly-hoat-đong-cua-java-agent","children":[]},{"level":3,"title":"Ví dụ về Java Agent","slug":"vi-du-ve-java-agent","link":"#vi-du-ve-java-agent","children":[]}]},{"level":2,"title":"Công cụ bytecode","slug":"cong-cu-bytecode","link":"#cong-cu-bytecode","children":[]}],"git":{"createdTime":1719590078000,"updatedTime":1720085835000,"contributors":[{"name":"Hung Nguyen","email":"vanhung4499@gmail.com","commits":1},{"name":"Hung Nguyen Van","email":"vanhung4499@gmail.com","commits":1}]},"readingTime":{"minutes":20.12,"words":6037},"filePathRelative":"programming/java/JVM/Java Bytecode.md","localizedDate":"June 28, 2024","excerpt":"\\n<h2>Giới thiệu về Bytecode</h2>\\n<h3>Bytecode là gì?</h3>\\n<p>Java bytecode là một định dạng lệnh mà máy ảo Java (JVM) thực thi. Java bytecode được gọi là \\"bytecode\\" vì:&nbsp;<strong>Tệp Java bytecode (<code>.class</code>) là một luồng dữ liệu nhị phân được cấu trúc gọn gàng với đơn vị cơ bản là byte 8 bit</strong>, các mục dữ liệu được sắp xếp chặt chẽ theo thứ tự trong tệp .class mà không có bất kỳ ký tự phân tách nào.&nbsp;<strong>Toàn bộ tệp .class thực chất là một bảng</strong>.</p>","autoDesc":true}');export{k as comp,B as data};
