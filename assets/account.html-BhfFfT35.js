import{_ as i,g as t,o as l,c as p,a as o,e as n,h as a,f as c,w as d}from"./app-5QVbWi7Z.js";const s={};function u(g,e){const r=t("RouteLink");return l(),p("div",null,[e[5]||(e[5]=o('<h1 id="公众号接入" tabindex="-1"><a class="header-anchor" href="#公众号接入"><span>公众号接入</span></a></h1><p>本章节，讲解如果将你的公众号，接入到系统中。步骤如下：</p><ul><li>第一步，申请公众号（可选）</li><li>第二步，在系统中，添加公众号账号</li><li>第三步，在公众号中，配置接入信息</li></ul><h2 id="_1-配置步骤" tabindex="-1"><a class="header-anchor" href="#_1-配置步骤"><span><a href="#_1-%E9%85%8D%E7%BD%AE%E6%AD%A5%E9%AA%A4">#</a> 1. 配置步骤</span></a></h2><p>本小节，手把手教你如何将公众号接入到系统中。</p><h3 id="第一步-申请公众号-可选" tabindex="-1"><a class="header-anchor" href="#第一步-申请公众号-可选"><span><a href="#%E7%AC%AC%E4%B8%80%E6%AD%A5-%E7%94%B3%E8%AF%B7%E5%85%AC%E4%BC%97%E5%8F%B7-%E5%8F%AF%E9%80%89">#</a> 第一步，申请公众号（可选）</span></a></h3><p>友情提示：如果你已经有公众号，可以忽略这一步。</p><p>① 如果你还没有公众号，可以申请一个测试帐号。</p><figure><img src="https://doc.iocoder.cn/img/公众号手册/公众号接入/第一步-申请测试帐号.png" alt="申请测试账号" tabindex="0" loading="lazy"><figcaption>申请测试账号</figcaption></figure><p>申请地址：<a href="https://mp.weixin.qq.com/debug/cgi-bin/sandbox?t=sandbox/login" target="_blank" rel="noopener noreferrer">微信公众平台接口测试帐号申请</a></p><p>② 申请完成后，获得一个测试号。如下图所示：</p><figure><img src="https://doc.iocoder.cn/img/公众号手册/公众号接入/第一步-测试账号信息.png" alt="测试账号信息" tabindex="0" loading="lazy"><figcaption>测试账号信息</figcaption></figure><h3 id="第二步-添加公众号账号" tabindex="-1"><a class="header-anchor" href="#第二步-添加公众号账号"><span><a href="#%E7%AC%AC%E4%BA%8C%E6%AD%A5-%E6%B7%BB%E5%8A%A0%E5%85%AC%E4%BC%97%E5%8F%B7%E8%B4%A6%E5%8F%B7">#</a> 第二步，添加公众号账号</span></a></h3><p>点击 [公众号管理 -&gt; 账号管理] 菜单，添加一个公众号账号。如下图所示：</p><figure><img src="https://doc.iocoder.cn/img/公众号手册/公众号接入/第二步-添加公众号账号.png" alt="添加公众号账号" tabindex="0" loading="lazy"><figcaption>添加公众号账号</figcaption></figure><h3 id="第三步-配置接入信息" tabindex="-1"><a class="header-anchor" href="#第三步-配置接入信息"><span><a href="#%E7%AC%AC%E4%B8%89%E6%AD%A5-%E9%85%8D%E7%BD%AE%E6%8E%A5%E5%85%A5%E4%BF%A1%E6%81%AF">#</a> 第三步，配置接入信息</span></a></h3>',16)),n("p",null,[e[1]||(e[1]=a("① 由于公众号通知需要外网地址，可参考 ")),c(r,{to:"/natapp/"},{default:d(()=>e[0]||(e[0]=[a("《内网穿透》")])),_:1}),e[2]||(e[2]=a(" 文档，将本地的 48080 端口，转发到外网中。这里，我的域名是 ")),e[3]||(e[3]=n("code",null,"http://yunai.natapp1.cc",-1)),e[4]||(e[4]=a("。"))]),e[6]||(e[6]=o('<p>② 打开微信公众号界面，填写 URL 和 Token 信息。如下图所示：</p><figure><img src="https://doc.iocoder.cn/img/公众号手册/公众号接入/第三步-填写URL和Token.png" alt="填写 URL 和 Token 信息" tabindex="0" loading="lazy"><figcaption>填写 URL 和 Token 信息</figcaption></figure><p>点击提交后，看到“配置成功”提示，说明配置成功。</p><h2 id="_2-实现代码" tabindex="-1"><a class="header-anchor" href="#_2-实现代码"><span><a href="#_2-%E5%AE%9E%E7%8E%B0%E4%BB%A3%E7%A0%81">#</a> 2. 实现代码</span></a></h2><p>本小节，将介绍如何实现公众号接入的代码。</p><h3 id="_2-1-表结构" tabindex="-1"><a class="header-anchor" href="#_2-1-表结构"><span><a href="#_2-1-%E8%A1%A8%E7%BB%93%E6%9E%84">#</a> 2.1 表结构</span></a></h3><p>公众号账号对应 <code>mp_account</code> 表，结构如下图所示：</p><figure><img src="https://doc.iocoder.cn/img/公众号手册/公众号接入/表结构.png" alt="表结构" tabindex="0" loading="lazy"><figcaption>表结构</figcaption></figure><h3 id="_2-2-账号管理界面" tabindex="-1"><a class="header-anchor" href="#_2-2-账号管理界面"><span><a href="#_2-2-%E8%B4%A6%E5%8F%B7%E7%AE%A1%E7%90%86%E7%95%8C%E9%9D%A2">#</a> 2.2 账号管理界面</span></a></h3><ul><li>前端：<a href="https://github.com/yudaocode/yudao-ui-admin-vue2/blob/master/src/views/mp/account/index.vue" target="_blank" rel="noopener noreferrer">/@views/mp/account</a></li><li>后端：<a href="https://github.com/YunaiV/ruoyi-vue-pro/blob/master/yudao-module-mp/yudao-module-mp-biz/src/main/java/cn/iocoder/yudao/module/mp/controller/admin/account/MpAccountController.java" target="_blank" rel="noopener noreferrer">MpAccountController</a></li></ul><h3 id="_2-3-配置接入回调" tabindex="-1"><a class="header-anchor" href="#_2-3-配置接入回调"><span><a href="#_2-3-%E9%85%8D%E7%BD%AE%E6%8E%A5%E5%85%A5%E5%9B%9E%E8%B0%83">#</a> 2.3 配置接入回调</span></a></h3><p>在 <a href="#%E7%AC%AC%E4%B8%89%E6%AD%A5-%E9%85%8D%E7%BD%AE%E6%8E%A5%E5%85%A5%E4%BF%A1%E6%81%AF">第三步，配置接入信息</a> 时，微信公众号会回调系统的 <code>GET /admin-api/mp/open/{appID}</code> 接口，进行接入配置的验证。对应 <a href="https://github.com/YunaiV/ruoyi-vue-pro/blob/master/yudao-module-mp/yudao-module-mp-biz/src/main/java/cn/iocoder/yudao/module/mp/controller/admin/open/MpOpenController.java#L39-L57" target="_blank" rel="noopener noreferrer">MpOpenController</a> 类的 <code>checkSignature</code> 方法，如下图所示：</p><figure><img src="https://doc.iocoder.cn/img/公众号手册/公众号接入/配置接入回调.png" alt="checkSignature 方法" tabindex="0" loading="lazy"><figcaption>checkSignature 方法</figcaption></figure><p>对应 <a href="https://developers.weixin.qq.com/doc/offiaccount/Basic_Information/Access_Overview.html#%E7%AC%AC%E4%BA%8C%E6%AD%A5%EF%BC%9A%E9%AA%8C%E8%AF%81%E6%B6%88%E6%81%AF%E7%9A%84%E7%A1%AE%E6%9D%A5%E8%87%AA%E5%BE%AE%E4%BF%A1%E6%9C%8D%E5%8A%A1%E5%99%A8" target="_blank" rel="noopener noreferrer">《微信公众号官方文档 —— 接入指南》</a> 文档。</p><p>友情提示：</p><p>项目使用的微信工具开发包是 <a href="https://github.com/Wechat-Group/WxJava/tree/develop/weixin-java-mp" target="_blank" rel="noopener noreferrer"><code>weixin-java-mp</code></a>，超级好用！</p><h3 id="_2-4-消息处理" tabindex="-1"><a class="header-anchor" href="#_2-4-消息处理"><span><a href="#_2-4-%E6%B6%88%E6%81%AF%E5%A4%84%E7%90%86">#</a> 2.4 消息处理</span></a></h3><p>配置接入完成后，用户发给公众号的消息，公众号都会回调到 <code>POST /admin-api/mp/open/{appID}</code> 接口，进行消息的处理。对应 <a href="https://github.com/YunaiV/ruoyi-vue-pro/blob/master/yudao-module-mp/yudao-module-mp-biz/src/main/java/cn/iocoder/yudao/module/mp/controller/admin/open/MpOpenController.java#L59-L114" target="_blank" rel="noopener noreferrer">MpOpenController</a> 类的 <code>handleMessage</code> 方法，如下图所示：</p><figure><img src="https://doc.iocoder.cn/img/公众号手册/公众号接入/消息处理.png" alt="handleMessage 方法" tabindex="0" loading="lazy"><figcaption>handleMessage 方法</figcaption></figure><p>核心逻辑是第二步，再解析到消息后，交给 WxMpMessageRouter 进行消息的处理。WxMpMessageRouter 在 <a href="https://github.com/YunaiV/ruoyi-vue-pro/blob/master/yudao-module-mp/yudao-module-mp-biz/src/main/java/cn/iocoder/yudao/module/mp/controller/admin/open/MpOpenController.java#L59-L114" target="_blank" rel="noopener noreferrer">DefaultMpServiceFactory</a> 初始化，设置每种消息对应的 <a href="https://github.com/YunaiV/ruoyi-vue-pro/blob/master/yudao-module-mp/yudao-module-mp-biz/src/main/java/cn/iocoder/yudao/module/mp/service/handler/" target="_blank" rel="noopener noreferrer"><code>handler</code></a> 处理器。如下图所示：</p><figure><img src="https://doc.iocoder.cn/img/公众号手册/公众号接入/消息处理器.png" alt="消息处理器" tabindex="0" loading="lazy"><figcaption>消息处理器</figcaption></figure><p>具体每个处理器的实现，后续每个章节单独详细讲解。</p>',22))])}const m=i(s,[["render",u],["__file","account.html.vue"]]),E=JSON.parse('{"path":"/project/rouyi-vue-pro/mp/account.html","title":"公众号接入","lang":"en-US","frontmatter":{"title":"公众号接入","tags":["project","java","spring-boot","spring-cloud"],"categories":["project"],"order":147,"feed":false,"seo":false,"head":[]},"headers":[{"level":2,"title":"# 1. 配置步骤","slug":"_1-配置步骤","link":"#_1-配置步骤","children":[{"level":3,"title":"# 第一步，申请公众号（可选）","slug":"第一步-申请公众号-可选","link":"#第一步-申请公众号-可选","children":[]},{"level":3,"title":"# 第二步，添加公众号账号","slug":"第二步-添加公众号账号","link":"#第二步-添加公众号账号","children":[]},{"level":3,"title":"# 第三步，配置接入信息","slug":"第三步-配置接入信息","link":"#第三步-配置接入信息","children":[]}]},{"level":2,"title":"# 2. 实现代码","slug":"_2-实现代码","link":"#_2-实现代码","children":[{"level":3,"title":"# 2.1 表结构","slug":"_2-1-表结构","link":"#_2-1-表结构","children":[]},{"level":3,"title":"# 2.2 账号管理界面","slug":"_2-2-账号管理界面","link":"#_2-2-账号管理界面","children":[]},{"level":3,"title":"# 2.3 配置接入回调","slug":"_2-3-配置接入回调","link":"#_2-3-配置接入回调","children":[]},{"level":3,"title":"# 2.4 消息处理","slug":"_2-4-消息处理","link":"#_2-4-消息处理","children":[]}]}],"git":{"createdTime":1720365235000,"updatedTime":1720365235000,"contributors":[{"name":"Hung Nguyen Van","email":"vanhung4499@gmail.com","commits":1}]},"readingTime":{"minutes":4.23,"words":1268},"filePathRelative":"project/rouyi-vue-pro/mp/account.md","localizedDate":"July 7, 2024"}');export{m as comp,E as data};
